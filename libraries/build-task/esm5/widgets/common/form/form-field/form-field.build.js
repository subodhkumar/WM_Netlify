import { getFormMarkupAttr, register } from '@wm/transpiler';
import { FormWidgetType, getFormWidgetTemplate, IDGenerator, isMobileApp } from '@wm/core';
import { ALLFIELDS } from '../../../../utils/data-utils';
import { isDataSetWidget } from '../../../../utils/widget-utils';
var tagName = 'div';
var idGen = new IDGenerator('formfield_');
var getEventsTemplate = function (attrs) {
    var eventAttrs = new Map();
    if (!attrs.has('focus.event')) {
        attrs.set('focus.event', '');
    }
    if (!attrs.has('blur.event')) {
        attrs.set('blur.event', '');
    }
    attrs.forEach(function (value, key) {
        if (key.endsWith('.event')) {
            if (key === 'focus.event') {
                value = "_onFocusField($event);" + value;
            }
            else if (key === 'blur.event') {
                value = "_onBlurField($event);" + value;
            }
            eventAttrs.set(key, value);
            attrs.delete(key);
        }
    });
    return getFormMarkupAttr(eventAttrs);
};
var ɵ0 = getEventsTemplate;
var DEFAULT_PLACEHOLDERS = new Map([
    [FormWidgetType.SELECT, ['Select Min value', 'Select Max value', 'Select value']],
    [FormWidgetType.DATETIME, ['Select Min date time', 'Select Max date time', 'Select date time']],
    [FormWidgetType.TIME, ['Select Min time', 'Select Max time', 'Select time']],
    [FormWidgetType.DATE, ['Select Min date', 'Select Max date', 'Select date']],
    [FormWidgetType.TEXTAREA, ['', '', 'Enter value']],
    [FormWidgetType.RICHTEXT, ['', '', 'Enter value']],
    [FormWidgetType.COLORPICKER, ['Select Color', 'Select Color', 'Select Color']],
    [FormWidgetType.CHIPS, ['', '', 'Type here...']],
    [FormWidgetType.PASSWORD, ['Enter Min value', 'Enter Max value', 'Enter value']],
    [FormWidgetType.NUMBER, ['Enter Min value', 'Enter Max value', 'Enter value']],
    [FormWidgetType.TEXT, ['Enter Min value', 'Enter Max value', 'Enter value']],
    [FormWidgetType.CURRENCY, ['Enter Min value', 'Enter Max value', 'Enter value']],
    [FormWidgetType.AUTOCOMPLETE, ['', '', 'Search']],
]);
var setDefaultPlaceholder = function (attrs, widgetType, index) {
    var prop = index === 1 ? 'maxplaceholder' : 'placeholder';
    var placeholder = attrs.get(prop);
    if (placeholder || placeholder === '') {
        return;
    }
    placeholder = DEFAULT_PLACEHOLDERS.get(widgetType) && DEFAULT_PLACEHOLDERS.get(widgetType)[index];
    if (placeholder) {
        attrs.set(prop, placeholder);
    }
};
var ɵ1 = setDefaultPlaceholder;
var getWidgetTemplate = function (attrs, options) {
    var name = attrs.get('name');
    var fieldName = (attrs.get('key') || name || '').trim();
    var formControl = options.isMaxWidget ? "formControlName=\"" + fieldName + "_max\"" : (options.isInList ? "[formControlName]=\"" + options.counter + "._fieldName\"" : "formControlName=\"" + fieldName + "\"");
    var tmplRef = options.isMaxWidget ? "#formWidgetMax" : "#formWidget";
    var widgetName = name ? (options.isMaxWidget ? "name=\"" + name + "_formWidgetMax\"" : "name=\"" + name + "_formWidget\"") : '';
    var defaultTmpl = "[class.hidden]=\"!" + options.pCounter + ".isUpdateMode && " + options.counter + ".viewmodewidget !== 'default'\" " + formControl + " " + options.eventsTmpl + " " + tmplRef + " " + widgetName;
    return getFormWidgetTemplate(options.widgetType, defaultTmpl, attrs, { counter: options.counter, pCounter: options.pCounter });
};
var ɵ2 = getWidgetTemplate;
var getTemplate = function (attrs, widgetType, eventsTmpl, counter, pCounter, isInList) {
    var isRange = attrs.get('is-range') === 'true';
    if (!isRange) {
        return getWidgetTemplate(attrs, { widgetType: widgetType, eventsTmpl: eventsTmpl, counter: counter, pCounter: pCounter, isInList: isInList });
    }
    var layoutClass = isMobileApp() ? 'col-xs-6' : 'col-sm-6';
    return "<div class=\"" + layoutClass + "\">" + getWidgetTemplate(attrs, { widgetType: widgetType, eventsTmpl: eventsTmpl, counter: counter, pCounter: pCounter }) + "</div>\n                <div class=\"" + layoutClass + "\">" + getWidgetTemplate(attrs, { widgetType: widgetType, eventsTmpl: eventsTmpl, counter: counter, pCounter: pCounter, isMaxWidget: true }) + "</div>";
};
var ɵ3 = getTemplate;
var getCaptionByWidget = function (attrs, widgetType, counter) {
    if (attrs.get('is-related') === 'true') {
        return counter + ".getDisplayExpr()";
    }
    if (widgetType === FormWidgetType.PASSWORD) {
        return '\'********\'';
    }
    var caption = counter + ".value";
    if (widgetType === FormWidgetType.DATETIME || widgetType === FormWidgetType.TIMESTAMP) {
        caption += " | toDate:" + counter + ".formWidget.datepattern || 'yyyy-MM-dd hh:mm:ss a'";
        return caption;
    }
    if (widgetType === FormWidgetType.TIME) {
        caption += " | toDate:" + counter + ".formWidget.timepattern || 'hh:mm a'";
        return caption;
    }
    if (widgetType === FormWidgetType.DATE) {
        caption += " | toDate:" + counter + ".formWidget.datepattern ||  'yyyy-MMM-dd'";
        return caption;
    }
    if (widgetType === FormWidgetType.RATING || widgetType === FormWidgetType.UPLOAD) {
        return '';
    }
    if (isDataSetWidget(widgetType) && attrs.get('datafield') === ALLFIELDS) {
        return counter + ".getDisplayExpr()";
    }
    return counter + ".getCaption()";
};
var ɵ4 = getCaptionByWidget;
var registerFormField = function (isFormField) {
    return {
        requires: ['wm-form', 'wm-liveform', 'wm-livefilter', 'wm-list'],
        pre: function (attrs, shared, parentForm, parentLiveForm, parentFilter, parentList) {
            var counter = idGen.nextUid();
            var parent = parentForm || parentLiveForm || parentFilter;
            var pCounter = (parent && parent.get('form_reference')) || 'form';
            var widgetType = attrs.get('widget') || FormWidgetType.TEXT;
            var dataRole = isFormField ? 'form-field' : 'filter-field';
            var validationMsg = isFormField ? "<p *ngIf=\"" + counter + "._control?.invalid && " + counter + "._control?.touched && " + pCounter + ".isUpdateMode\"\n                                   class=\"help-block text-danger\"\n                                   [textContent]=\"" + counter + ".validationmessage\"></p>" : '';
            var eventsTmpl = widgetType === FormWidgetType.UPLOAD ? '' : getEventsTemplate(attrs);
            var controlLayout = isMobileApp() ? 'col-xs-12' : 'col-sm-12';
            var isInList = pCounter === (parentList && parentList.get('parent_form_reference'));
            attrs.delete('widget');
            shared.set('counter', counter);
            if (attrs.get('is-range') === 'true') {
                setDefaultPlaceholder(attrs, widgetType, 0);
                setDefaultPlaceholder(attrs, widgetType, 1);
            }
            else {
                setDefaultPlaceholder(attrs, widgetType, 2);
            }
            return "<" + tagName + " data-role=\"" + dataRole + "\" [formGroup]=\"" + pCounter + ".ngform\" wmFormField #" + counter + "=\"wmFormField\" widgettype=\"" + widgetType + "\" " + getFormMarkupAttr(attrs) + ">\n                        <div class=\"live-field form-group app-composite-widget clearfix caption-{{" + pCounter + ".captionposition}}\" widget=\"" + widgetType + "\">\n                            <label [hidden]=\"!" + counter + ".displayname\" class=\"app-label control-label formfield-label {{" + pCounter + "._captionClass}}\" [title]=\"" + counter + ".displayname\"\n                                        [ngStyle]=\"{width: " + pCounter + ".captionsize}\" [ngClass]=\"{'text-danger': " + counter + "._control?.invalid && " + counter + "._control?.touched && " + pCounter + ".isUpdateMode,\n                                         required: " + pCounter + ".isUpdateMode && " + counter + ".required}\" [textContent]=\"" + counter + ".displayname\"> </label>\n                            <div [ngClass]=\"" + counter + ".displayname ? " + pCounter + "._widgetClass : '" + controlLayout + "'\">\n                                 <label class=\"form-control-static app-label\"\n                                       [hidden]=\"" + pCounter + ".isUpdateMode || " + counter + ".viewmodewidget === 'default' || " + counter + ".widgettype === 'upload'\" [innerHTML]=\"" + getCaptionByWidget(attrs, widgetType, counter) + "\"></label>\n                                " + getTemplate(attrs, widgetType, eventsTmpl, counter, pCounter, isInList) + "\n                                <p *ngIf=\"!(" + counter + "._control?.invalid && " + counter + "._control?.touched) && " + pCounter + ".isUpdateMode\"\n                                   class=\"help-block\" [textContent]=\"" + counter + ".hint\"></p>\n                                " + validationMsg + "\n                            </div>\n                        </div>";
        },
        post: function () { return "</" + tagName + ">"; },
        provide: function (attrs, shared) {
            var provider = new Map();
            provider.set('form_reference', shared.get('counter'));
            return provider;
        }
    };
};
var ɵ5 = registerFormField;
register('wm-form-field', registerFormField.bind(this, true));
register('wm-filter-field', registerFormField.bind(this, false));
export default (function () { });
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1maWVsZC5idWlsZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsid2lkZ2V0cy9jb21tb24vZm9ybS9mb3JtLWZpZWxkL2Zvcm0tZmllbGQuYnVpbGQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFpQixRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1RSxPQUFPLEVBQUUsY0FBYyxFQUFFLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFM0YsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVqRSxJQUFNLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDdEIsSUFBTSxLQUFLLEdBQUcsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFNUMsSUFBTSxpQkFBaUIsR0FBRyxVQUFDLEtBQUs7SUFDNUIsSUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRTtRQUMzQixLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUNoQztJQUNELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQzFCLEtBQUssQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQy9CO0lBQ0QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxHQUFHO1FBQ3RCLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUN4QixJQUFJLEdBQUcsS0FBSyxhQUFhLEVBQUU7Z0JBQ3ZCLEtBQUssR0FBRywyQkFBeUIsS0FB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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRGb3JtTWFya3VwQXR0ciwgSUJ1aWxkVGFza0RlZiwgcmVnaXN0ZXIgfSBmcm9tICdAd20vdHJhbnNwaWxlcic7XG5pbXBvcnQgeyBGb3JtV2lkZ2V0VHlwZSwgZ2V0Rm9ybVdpZGdldFRlbXBsYXRlLCBJREdlbmVyYXRvciwgaXNNb2JpbGVBcHAgfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IEFMTEZJRUxEUyB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL2RhdGEtdXRpbHMnO1xuaW1wb3J0IHsgaXNEYXRhU2V0V2lkZ2V0IH0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvd2lkZ2V0LXV0aWxzJztcblxuY29uc3QgdGFnTmFtZSA9ICdkaXYnO1xuY29uc3QgaWRHZW4gPSBuZXcgSURHZW5lcmF0b3IoJ2Zvcm1maWVsZF8nKTtcblxuY29uc3QgZ2V0RXZlbnRzVGVtcGxhdGUgPSAoYXR0cnMpID0+IHtcbiAgICBjb25zdCBldmVudEF0dHJzID0gbmV3IE1hcCgpO1xuICAgIGlmICghYXR0cnMuaGFzKCdmb2N1cy5ldmVudCcpKSB7XG4gICAgICAgIGF0dHJzLnNldCgnZm9jdXMuZXZlbnQnLCAnJyk7XG4gICAgfVxuICAgIGlmICghYXR0cnMuaGFzKCdibHVyLmV2ZW50JykpIHtcbiAgICAgICAgYXR0cnMuc2V0KCdibHVyLmV2ZW50JywgJycpO1xuICAgIH1cbiAgICBhdHRycy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgaWYgKGtleS5lbmRzV2l0aCgnLmV2ZW50JykpIHtcbiAgICAgICAgICAgaWYgKGtleSA9PT0gJ2ZvY3VzLmV2ZW50Jykge1xuICAgICAgICAgICAgICAgdmFsdWUgPSBgX29uRm9jdXNGaWVsZCgkZXZlbnQpOyR7dmFsdWV9YDtcbiAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdibHVyLmV2ZW50Jykge1xuICAgICAgICAgICAgICAgdmFsdWUgPSBgX29uQmx1ckZpZWxkKCRldmVudCk7JHt2YWx1ZX1gO1xuICAgICAgICAgICB9XG4gICAgICAgICAgIGV2ZW50QXR0cnMuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgICAgICBhdHRycy5kZWxldGUoa2V5KTtcbiAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGdldEZvcm1NYXJrdXBBdHRyKGV2ZW50QXR0cnMpO1xufTtcblxuY29uc3QgREVGQVVMVF9QTEFDRUhPTERFUlMgPSBuZXcgTWFwKFtcbiAgICBbRm9ybVdpZGdldFR5cGUuU0VMRUNULCBbJ1NlbGVjdCBNaW4gdmFsdWUnLCAnU2VsZWN0IE1heCB2YWx1ZScsICdTZWxlY3QgdmFsdWUnXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLkRBVEVUSU1FLCBbJ1NlbGVjdCBNaW4gZGF0ZSB0aW1lJywgJ1NlbGVjdCBNYXggZGF0ZSB0aW1lJywgJ1NlbGVjdCBkYXRlIHRpbWUnXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLlRJTUUsIFsnU2VsZWN0IE1pbiB0aW1lJywgJ1NlbGVjdCBNYXggdGltZScsICdTZWxlY3QgdGltZSddXSxcbiAgICBbRm9ybVdpZGdldFR5cGUuREFURSwgWydTZWxlY3QgTWluIGRhdGUnLCAnU2VsZWN0IE1heCBkYXRlJywgJ1NlbGVjdCBkYXRlJ11dLFxuICAgIFtGb3JtV2lkZ2V0VHlwZS5URVhUQVJFQSwgWycnLCAnJywgJ0VudGVyIHZhbHVlJ11dLFxuICAgIFtGb3JtV2lkZ2V0VHlwZS5SSUNIVEVYVCwgWycnLCAnJywgJ0VudGVyIHZhbHVlJ11dLFxuICAgIFtGb3JtV2lkZ2V0VHlwZS5DT0xPUlBJQ0tFUiwgWydTZWxlY3QgQ29sb3InLCAnU2VsZWN0IENvbG9yJywgJ1NlbGVjdCBDb2xvciddXSxcbiAgICBbRm9ybVdpZGdldFR5cGUuQ0hJUFMsIFsnJywgJycsICdUeXBlIGhlcmUuLi4nXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLlBBU1NXT1JELCBbJ0VudGVyIE1pbiB2YWx1ZScsICdFbnRlciBNYXggdmFsdWUnLCAnRW50ZXIgdmFsdWUnXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLk5VTUJFUiwgWydFbnRlciBNaW4gdmFsdWUnLCAnRW50ZXIgTWF4IHZhbHVlJywgJ0VudGVyIHZhbHVlJ11dLFxuICAgIFtGb3JtV2lkZ2V0VHlwZS5URVhULCBbJ0VudGVyIE1pbiB2YWx1ZScsICdFbnRlciBNYXggdmFsdWUnLCAnRW50ZXIgdmFsdWUnXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLkNVUlJFTkNZLCBbJ0VudGVyIE1pbiB2YWx1ZScsICdFbnRlciBNYXggdmFsdWUnLCAnRW50ZXIgdmFsdWUnXV0sXG4gICAgW0Zvcm1XaWRnZXRUeXBlLkFVVE9DT01QTEVURSwgWycnLCAnJywgJ1NlYXJjaCddXSxcbl0pO1xuXG5jb25zdCBzZXREZWZhdWx0UGxhY2Vob2xkZXIgPSAoYXR0cnMsIHdpZGdldFR5cGUsIGluZGV4KSA9PiB7XG4gICAgY29uc3QgcHJvcCA9IGluZGV4ID09PSAxID8gJ21heHBsYWNlaG9sZGVyJyA6ICdwbGFjZWhvbGRlcic7XG4gICAgbGV0IHBsYWNlaG9sZGVyID0gYXR0cnMuZ2V0KHByb3ApO1xuICAgIGlmIChwbGFjZWhvbGRlciB8fCBwbGFjZWhvbGRlciA9PT0gJycpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwbGFjZWhvbGRlciA9IERFRkFVTFRfUExBQ0VIT0xERVJTLmdldCh3aWRnZXRUeXBlKSAmJiBERUZBVUxUX1BMQUNFSE9MREVSUy5nZXQod2lkZ2V0VHlwZSlbaW5kZXhdO1xuICAgIGlmIChwbGFjZWhvbGRlcikge1xuICAgICAgICBhdHRycy5zZXQocHJvcCwgcGxhY2Vob2xkZXIpO1xuICAgIH1cbn07XG5cbmNvbnN0IGdldFdpZGdldFRlbXBsYXRlID0gKGF0dHJzLCBvcHRpb25zKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IGF0dHJzLmdldCgnbmFtZScpO1xuICAgIGNvbnN0IGZpZWxkTmFtZSA9IChhdHRycy5nZXQoJ2tleScpIHx8IG5hbWUgfHwgJycpLnRyaW0oKTtcbiAgICBjb25zdCBmb3JtQ29udHJvbCA9IG9wdGlvbnMuaXNNYXhXaWRnZXQgPyBgZm9ybUNvbnRyb2xOYW1lPVwiJHtmaWVsZE5hbWV9X21heFwiYCA6IChvcHRpb25zLmlzSW5MaXN0ID8gYFtmb3JtQ29udHJvbE5hbWVdPVwiJHtvcHRpb25zLmNvdW50ZXJ9Ll9maWVsZE5hbWVcImAgOiBgZm9ybUNvbnRyb2xOYW1lPVwiJHtmaWVsZE5hbWV9XCJgKTtcbiAgICBjb25zdCB0bXBsUmVmID0gb3B0aW9ucy5pc01heFdpZGdldCA/IGAjZm9ybVdpZGdldE1heGAgOiBgI2Zvcm1XaWRnZXRgO1xuICAgIGNvbnN0IHdpZGdldE5hbWUgPSBuYW1lID8gKG9wdGlvbnMuaXNNYXhXaWRnZXQgPyBgbmFtZT1cIiR7bmFtZX1fZm9ybVdpZGdldE1heFwiYCA6IGBuYW1lPVwiJHtuYW1lfV9mb3JtV2lkZ2V0XCJgKSA6ICcnO1xuICAgIGNvbnN0IGRlZmF1bHRUbXBsID0gYFtjbGFzcy5oaWRkZW5dPVwiISR7b3B0aW9ucy5wQ291bnRlcn0uaXNVcGRhdGVNb2RlICYmICR7b3B0aW9ucy5jb3VudGVyfS52aWV3bW9kZXdpZGdldCAhPT0gJ2RlZmF1bHQnXCIgJHtmb3JtQ29udHJvbH0gJHtvcHRpb25zLmV2ZW50c1RtcGx9ICR7dG1wbFJlZn0gJHt3aWRnZXROYW1lfWA7XG4gICAgcmV0dXJuIGdldEZvcm1XaWRnZXRUZW1wbGF0ZShvcHRpb25zLndpZGdldFR5cGUsIGRlZmF1bHRUbXBsLCBhdHRycywge2NvdW50ZXI6IG9wdGlvbnMuY291bnRlciwgcENvdW50ZXI6IG9wdGlvbnMucENvdW50ZXJ9KTtcbn07XG5cblxuY29uc3QgZ2V0VGVtcGxhdGUgPSAoYXR0cnMsIHdpZGdldFR5cGUsIGV2ZW50c1RtcGwsIGNvdW50ZXIsIHBDb3VudGVyLCBpc0luTGlzdCkgPT4ge1xuICAgIGNvbnN0IGlzUmFuZ2UgPSBhdHRycy5nZXQoJ2lzLXJhbmdlJykgPT09ICd0cnVlJztcbiAgICBpZiAoIWlzUmFuZ2UpIHtcbiAgICAgICAgcmV0dXJuIGdldFdpZGdldFRlbXBsYXRlKGF0dHJzLCB7d2lkZ2V0VHlwZSwgZXZlbnRzVG1wbCwgY291bnRlciwgcENvdW50ZXIsIGlzSW5MaXN0fSk7XG4gICAgfVxuICAgIGNvbnN0IGxheW91dENsYXNzID0gaXNNb2JpbGVBcHAoKSA/ICdjb2wteHMtNicgOiAnY29sLXNtLTYnO1xuICAgIHJldHVybiBgPGRpdiBjbGFzcz1cIiR7bGF5b3V0Q2xhc3N9XCI+JHtnZXRXaWRnZXRUZW1wbGF0ZShhdHRycywge3dpZGdldFR5cGUsIGV2ZW50c1RtcGwsIGNvdW50ZXIsIHBDb3VudGVyfSl9PC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cIiR7bGF5b3V0Q2xhc3N9XCI+JHtnZXRXaWRnZXRUZW1wbGF0ZShhdHRycywge3dpZGdldFR5cGUsIGV2ZW50c1RtcGwsIGNvdW50ZXIsIHBDb3VudGVyLCBpc01heFdpZGdldDogdHJ1ZX0pfTwvZGl2PmA7XG59O1xuXG5jb25zdCBnZXRDYXB0aW9uQnlXaWRnZXQgPSAoYXR0cnMsIHdpZGdldFR5cGUsIGNvdW50ZXIpID0+IHtcbiAgICBpZiAoYXR0cnMuZ2V0KCdpcy1yZWxhdGVkJykgPT09ICd0cnVlJykge1xuICAgICAgICByZXR1cm4gYCR7Y291bnRlcn0uZ2V0RGlzcGxheUV4cHIoKWA7XG4gICAgfVxuICAgIGlmICh3aWRnZXRUeXBlID09PSBGb3JtV2lkZ2V0VHlwZS5QQVNTV09SRCkge1xuICAgICAgICByZXR1cm4gJ1xcJyoqKioqKioqXFwnJztcbiAgICB9XG4gICAgbGV0IGNhcHRpb24gPSBgJHtjb3VudGVyfS52YWx1ZWA7XG4gICAgaWYgKHdpZGdldFR5cGUgPT09IEZvcm1XaWRnZXRUeXBlLkRBVEVUSU1FIHx8IHdpZGdldFR5cGUgPT09IEZvcm1XaWRnZXRUeXBlLlRJTUVTVEFNUCkge1xuICAgICAgICBjYXB0aW9uICs9IGAgfCB0b0RhdGU6JHtjb3VudGVyfS5mb3JtV2lkZ2V0LmRhdGVwYXR0ZXJuIHx8ICd5eXl5LU1NLWRkIGhoOm1tOnNzIGEnYDtcbiAgICAgICAgcmV0dXJuIGNhcHRpb247XG4gICAgfVxuICAgIGlmICh3aWRnZXRUeXBlID09PSBGb3JtV2lkZ2V0VHlwZS5USU1FKSB7XG4gICAgICAgIGNhcHRpb24gKz0gYCB8IHRvRGF0ZToke2NvdW50ZXJ9LmZvcm1XaWRnZXQudGltZXBhdHRlcm4gfHwgJ2hoOm1tIGEnYDtcbiAgICAgICAgcmV0dXJuIGNhcHRpb247XG4gICAgfVxuICAgIGlmICh3aWRnZXRUeXBlID09PSBGb3JtV2lkZ2V0VHlwZS5EQVRFKSB7XG4gICAgICAgIGNhcHRpb24gKz0gYCB8IHRvRGF0ZToke2NvdW50ZXJ9LmZvcm1XaWRnZXQuZGF0ZXBhdHRlcm4gfHwgICd5eXl5LU1NTS1kZCdgO1xuICAgICAgICByZXR1cm4gY2FwdGlvbjtcbiAgICB9XG4gICAgaWYgKHdpZGdldFR5cGUgPT09IEZvcm1XaWRnZXRUeXBlLlJBVElORyB8fCB3aWRnZXRUeXBlID09PSBGb3JtV2lkZ2V0VHlwZS5VUExPQUQpIHtcbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgICBpZiAoaXNEYXRhU2V0V2lkZ2V0KHdpZGdldFR5cGUpICYmIGF0dHJzLmdldCgnZGF0YWZpZWxkJykgPT09IEFMTEZJRUxEUykge1xuICAgICAgICByZXR1cm4gYCR7Y291bnRlcn0uZ2V0RGlzcGxheUV4cHIoKWA7XG4gICAgfVxuICAgIHJldHVybiBgJHtjb3VudGVyfS5nZXRDYXB0aW9uKClgO1xufTtcblxuY29uc3QgcmVnaXN0ZXJGb3JtRmllbGQgPSAoaXNGb3JtRmllbGQpOiBJQnVpbGRUYXNrRGVmID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgICByZXF1aXJlczogWyd3bS1mb3JtJywgJ3dtLWxpdmVmb3JtJywgJ3dtLWxpdmVmaWx0ZXInLCAnd20tbGlzdCddLFxuICAgICAgICBwcmU6IChhdHRycywgc2hhcmVkLCBwYXJlbnRGb3JtLCBwYXJlbnRMaXZlRm9ybSwgcGFyZW50RmlsdGVyLCBwYXJlbnRMaXN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb3VudGVyID0gaWRHZW4ubmV4dFVpZCgpO1xuICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gcGFyZW50Rm9ybSB8fCBwYXJlbnRMaXZlRm9ybSB8fCBwYXJlbnRGaWx0ZXI7XG4gICAgICAgICAgICBjb25zdCBwQ291bnRlciA9IChwYXJlbnQgJiYgcGFyZW50LmdldCgnZm9ybV9yZWZlcmVuY2UnKSkgfHwgJ2Zvcm0nO1xuICAgICAgICAgICAgY29uc3Qgd2lkZ2V0VHlwZSA9IGF0dHJzLmdldCgnd2lkZ2V0JykgfHwgRm9ybVdpZGdldFR5cGUuVEVYVDtcbiAgICAgICAgICAgIGNvbnN0IGRhdGFSb2xlID0gaXNGb3JtRmllbGQgPyAnZm9ybS1maWVsZCcgOiAnZmlsdGVyLWZpZWxkJztcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRpb25Nc2cgPSBpc0Zvcm1GaWVsZCA/IGA8cCAqbmdJZj1cIiR7Y291bnRlcn0uX2NvbnRyb2w/LmludmFsaWQgJiYgJHtjb3VudGVyfS5fY29udHJvbD8udG91Y2hlZCAmJiAke3BDb3VudGVyfS5pc1VwZGF0ZU1vZGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz1cImhlbHAtYmxvY2sgdGV4dC1kYW5nZXJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbdGV4dENvbnRlbnRdPVwiJHtjb3VudGVyfS52YWxpZGF0aW9ubWVzc2FnZVwiPjwvcD5gIDogJyc7XG4gICAgICAgICAgICBjb25zdCBldmVudHNUbXBsID0gd2lkZ2V0VHlwZSA9PT0gRm9ybVdpZGdldFR5cGUuVVBMT0FEID8gJycgOiBnZXRFdmVudHNUZW1wbGF0ZShhdHRycyk7XG4gICAgICAgICAgICBjb25zdCBjb250cm9sTGF5b3V0ID0gaXNNb2JpbGVBcHAoKSA/ICdjb2wteHMtMTInIDogJ2NvbC1zbS0xMic7XG4gICAgICAgICAgICBjb25zdCBpc0luTGlzdCA9IHBDb3VudGVyID09PSAocGFyZW50TGlzdCAmJiBwYXJlbnRMaXN0LmdldCgncGFyZW50X2Zvcm1fcmVmZXJlbmNlJykpO1xuICAgICAgICAgICAgYXR0cnMuZGVsZXRlKCd3aWRnZXQnKTtcbiAgICAgICAgICAgIHNoYXJlZC5zZXQoJ2NvdW50ZXInLCBjb3VudGVyKTtcblxuICAgICAgICAgICAgaWYgKGF0dHJzLmdldCgnaXMtcmFuZ2UnKSA9PT0gJ3RydWUnKSB7XG4gICAgICAgICAgICAgICAgc2V0RGVmYXVsdFBsYWNlaG9sZGVyKGF0dHJzLCB3aWRnZXRUeXBlLCAwKTtcbiAgICAgICAgICAgICAgICBzZXREZWZhdWx0UGxhY2Vob2xkZXIoYXR0cnMsIHdpZGdldFR5cGUsIDEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXREZWZhdWx0UGxhY2Vob2xkZXIoYXR0cnMsIHdpZGdldFR5cGUsIDIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYDwke3RhZ05hbWV9IGRhdGEtcm9sZT1cIiR7ZGF0YVJvbGV9XCIgW2Zvcm1Hcm91cF09XCIke3BDb3VudGVyfS5uZ2Zvcm1cIiB3bUZvcm1GaWVsZCAjJHtjb3VudGVyfT1cIndtRm9ybUZpZWxkXCIgd2lkZ2V0dHlwZT1cIiR7d2lkZ2V0VHlwZX1cIiAke2dldEZvcm1NYXJrdXBBdHRyKGF0dHJzKX0+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwibGl2ZS1maWVsZCBmb3JtLWdyb3VwIGFwcC1jb21wb3NpdGUtd2lkZ2V0IGNsZWFyZml4IGNhcHRpb24te3ske3BDb3VudGVyfS5jYXB0aW9ucG9zaXRpb259fVwiIHdpZGdldD1cIiR7d2lkZ2V0VHlwZX1cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgW2hpZGRlbl09XCIhJHtjb3VudGVyfS5kaXNwbGF5bmFtZVwiIGNsYXNzPVwiYXBwLWxhYmVsIGNvbnRyb2wtbGFiZWwgZm9ybWZpZWxkLWxhYmVsIHt7JHtwQ291bnRlcn0uX2NhcHRpb25DbGFzc319XCIgW3RpdGxlXT1cIiR7Y291bnRlcn0uZGlzcGxheW5hbWVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtuZ1N0eWxlXT1cInt3aWR0aDogJHtwQ291bnRlcn0uY2FwdGlvbnNpemV9XCIgW25nQ2xhc3NdPVwieyd0ZXh0LWRhbmdlcic6ICR7Y291bnRlcn0uX2NvbnRyb2w/LmludmFsaWQgJiYgJHtjb3VudGVyfS5fY29udHJvbD8udG91Y2hlZCAmJiAke3BDb3VudGVyfS5pc1VwZGF0ZU1vZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiAke3BDb3VudGVyfS5pc1VwZGF0ZU1vZGUgJiYgJHtjb3VudGVyfS5yZXF1aXJlZH1cIiBbdGV4dENvbnRlbnRdPVwiJHtjb3VudGVyfS5kaXNwbGF5bmFtZVwiPiA8L2xhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgW25nQ2xhc3NdPVwiJHtjb3VudGVyfS5kaXNwbGF5bmFtZSA/ICR7cENvdW50ZXJ9Ll93aWRnZXRDbGFzcyA6ICcke2NvbnRyb2xMYXlvdXR9J1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPVwiZm9ybS1jb250cm9sLXN0YXRpYyBhcHAtbGFiZWxcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2hpZGRlbl09XCIke3BDb3VudGVyfS5pc1VwZGF0ZU1vZGUgfHwgJHtjb3VudGVyfS52aWV3bW9kZXdpZGdldCA9PT0gJ2RlZmF1bHQnIHx8ICR7Y291bnRlcn0ud2lkZ2V0dHlwZSA9PT0gJ3VwbG9hZCdcIiBbaW5uZXJIVE1MXT1cIiR7Z2V0Q2FwdGlvbkJ5V2lkZ2V0KGF0dHJzLCB3aWRnZXRUeXBlLCBjb3VudGVyKX1cIj48L2xhYmVsPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke2dldFRlbXBsYXRlKGF0dHJzLCB3aWRnZXRUeXBlLCBldmVudHNUbXBsLCBjb3VudGVyLCBwQ291bnRlciwgaXNJbkxpc3QpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8cCAqbmdJZj1cIiEoJHtjb3VudGVyfS5fY29udHJvbD8uaW52YWxpZCAmJiAke2NvdW50ZXJ9Ll9jb250cm9sPy50b3VjaGVkKSAmJiAke3BDb3VudGVyfS5pc1VwZGF0ZU1vZGVcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzcz1cImhlbHAtYmxvY2tcIiBbdGV4dENvbnRlbnRdPVwiJHtjb3VudGVyfS5oaW50XCI+PC9wPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3ZhbGlkYXRpb25Nc2d9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj5gO1xuICAgICAgICB9LFxuICAgICAgICBwb3N0OiAoKSA9PiBgPC8ke3RhZ05hbWV9PmAsXG4gICAgICAgIHByb3ZpZGU6IChhdHRycywgc2hhcmVkKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIHByb3ZpZGVyLnNldCgnZm9ybV9yZWZlcmVuY2UnLCBzaGFyZWQuZ2V0KCdjb3VudGVyJykpO1xuICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVyO1xuICAgICAgICB9XG4gICAgfTtcbn07XG5cbnJlZ2lzdGVyKCd3bS1mb3JtLWZpZWxkJywgcmVnaXN0ZXJGb3JtRmllbGQuYmluZCh0aGlzLCB0cnVlKSk7XG5yZWdpc3Rlcignd20tZmlsdGVyLWZpZWxkJywgcmVnaXN0ZXJGb3JtRmllbGQuYmluZCh0aGlzLCBmYWxzZSkpO1xuXG5leHBvcnQgZGVmYXVsdCAoKSA9PiB7fTtcbiJdfQ==