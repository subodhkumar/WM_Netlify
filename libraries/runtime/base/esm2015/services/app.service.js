import { Injectable, Injector } from '@angular/core';
import { AbstractDialogService, AbstractHttpService, AbstractI18nService, AbstractSpinnerService, AbstractToasterService, EventNotifier, FieldTypeService, FieldWidgetService, getWmProjectProperties, isDefined, isString, UtilsService, DynamicComponentRefProvider } from '@wm/core';
import { SecurityService } from '@wm/security';
const injectorMap = {
    DialogService: AbstractDialogService,
    i18nService: AbstractI18nService,
    SpinnerService: AbstractSpinnerService,
    ToasterService: AbstractToasterService,
    Utils: UtilsService,
    FIELD_TYPE: FieldTypeService,
    FIELD_WIDGET: FieldWidgetService,
    DynamicComponentService: DynamicComponentRefProvider
};
const noop = (...args) => { };
const ɵ0 = noop;
// Wraps httpService to behave as angular 1.x $http service.
const getHttpDependency = function () {
    const httpService = this.httpService;
    const fn = function (key, options) {
        const args = Array.from(arguments).slice(1);
        return Promise.resolve(httpService[key].apply(httpService, args));
    };
    const $http = function () {
        return fn.apply(undefined, ['send', ...Array.from(arguments)]);
    };
    ['get', 'post', 'head', 'put', 'delete', 'jsonp', 'patch'].forEach(key => $http[key] = fn.bind(undefined, key));
    return $http;
};
const ɵ1 = getHttpDependency;
export class AppRef {
    constructor(inj, i18nService, httpService, securityService) {
        this.inj = inj;
        this.i18nService = i18nService;
        this.httpService = httpService;
        this.securityService = securityService;
        this.Variables = {};
        this.Actions = {};
        this.onAppVariablesReady = noop;
        this.onSessionTimeout = noop;
        this.onPageReady = noop;
        this.onBeforePageLeave = noop;
        this.onBeforeServiceCall = noop;
        this.onServiceSuccess = noop;
        this.onServiceError = noop;
        this.dynamicComponentContainerRef = {};
        this.changeLocale = this.i18nService.setSelectedLocale.bind(this.i18nService);
        this.getSelectedLocale = this.i18nService.getSelectedLocale.bind(this.i18nService);
        this._eventNotifier = new EventNotifier();
        const wmProjectProperties = getWmProjectProperties();
        this.projectName = wmProjectProperties.name;
        this.isPrefabType = wmProjectProperties.type === "PREFAB" /* PREFAB */;
        this.isApplicationType = wmProjectProperties.type === "APPLICATION" /* APPLICATION */;
        this.isTemplateBundleType = wmProjectProperties.type === "TEMPLATEBUNDLE" /* TEMPLATE_BUNDLE */;
        this.httpService.registerOnSessionTimeout(this.on401.bind(this));
        this.appLocale = this.i18nService.getAppLocale();
        this.httpService.setLocale(this.appLocale);
    }
    reload() {
        window.location.reload();
    }
    notify(eventName, ...data) {
        this._eventNotifier.notify.apply(this._eventNotifier, arguments);
    }
    getDependency(injToken) {
        if (isString(injToken)) {
            if (injToken === 'HttpService') {
                return getHttpDependency.call(this);
            }
            let providerInstance = injectorMap[injToken] && this.inj.get(injectorMap[injToken]);
            if (!providerInstance && this.inj['_providers']) {
                this.inj['_providers'].forEach(e => {
                    if (e && e.__proto__.constructor.toString().indexOf('function ' + injToken + '(') === 0) {
                        providerInstance = this.inj.get(e.__proto__.constructor);
                    }
                });
            }
            return providerInstance;
        }
        return this.inj.get(injToken);
    }
    /**
     * triggers the onSessionTimeout callback in app.js
     */
    on401() {
        const userInfo = _.get(this.securityService.get(), 'userInfo');
        // if a previous user exists, a session time out triggered
        if (!_.isEmpty(userInfo)) {
            this.onSessionTimeout();
        }
    }
    subscribe(eventName, callback) {
        return this._eventNotifier.subscribe(eventName, callback);
    }
    notifyApp(template, type, title) {
        const notificationAction = _.get(this, 'Actions.appNotification');
        if (notificationAction) {
            type = type || 'success';
            notificationAction.invoke({
                message: template,
                title: isDefined(title) ? title : type.toUpperCase(),
                class: type,
                // If the type is error do not close the toastr
                duration: type.toUpperCase() === 'ERROR' ? 0 : undefined
            });
        }
        else {
            console.warn('The default Action "appNotification" doesn\'t exist in the app.');
        }
    }
}
AppRef.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AppRef.ctorParameters = () => [
    { type: Injector },
    { type: AbstractI18nService },
    { type: AbstractHttpService },
    { type: SecurityService }
];
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vcnVudGltZS9iYXNlLyIsInNvdXJjZXMiOlsic2VydmljZXMvYXBwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckQsT0FBTyxFQUNILHFCQUFxQixFQUNyQixtQkFBbUIsRUFDbkIsbUJBQW1CLEVBQ25CLHNCQUFzQixFQUN0QixzQkFBc0IsRUFDdEIsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixrQkFBa0IsRUFDbEIsc0JBQXNCLEVBQ3RCLFNBQVMsRUFDVCxRQUFRLEVBQ1IsWUFBWSxFQUNaLDJCQUEyQixFQUM5QixNQUFNLFVBQVUsQ0FBQztBQUNsQixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBSS9DLE1BQU0sV0FBVyxHQUFHO0lBQ2hCLGFBQWEsRUFBRSxxQkFBcUI7SUFDcEMsV0FBVyxFQUFFLG1CQUFtQjtJQUNoQyxjQUFjLEVBQUUsc0JBQXNCO0lBQ3RDLGNBQWMsRUFBRSxzQkFBc0I7SUFDdEMsS0FBSyxFQUFFLFlBQVk7SUFDbkIsVUFBVSxFQUFFLGdCQUFnQjtJQUM1QixZQUFZLEVBQUUsa0JBQWtCO0lBQ2hDLHVCQUF1QixFQUFFLDJCQUEyQjtDQUN2RCxDQUFDO0FBUUYsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLEdBQUUsQ0FBQyxDQUFDOztBQUU3Qiw0REFBNEQ7QUFDNUQsTUFBTSxpQkFBaUIsR0FBRztJQUN0QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQ3JDLE1BQU0sRUFBRSxHQUFHLFVBQVUsR0FBRyxFQUFFLE9BQVE7UUFDOUIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsT0FB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LENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUMzQjtJQUNMLENBQUM7SUFFTSxTQUFTLENBQUMsU0FBUyxFQUFFLFFBQTZCO1FBQ3JELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFTSxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLO1FBQ2xDLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUseUJBQXlCLENBQUMsQ0FBQztRQUNsRSxJQUFJLGtCQUFrQixFQUFFO1lBQ3BCLElBQUksR0FBRyxJQUFJLElBQUksU0FBUyxDQUFDO1lBQ3pCLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztnQkFDdEIsT0FBTyxFQUFFLFFBQVE7Z0JBQ2pCLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDcEQsS0FBSyxFQUFFLElBQUk7Z0JBQ1gsK0NBQStDO2dCQUMvQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO2FBQzNELENBQUMsQ0FBQztTQUNOO2FBQU07WUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLGlFQUFpRSxDQUFDLENBQUM7U0FDbkY7SUFDTCxDQUFDOzs7WUF2R0osVUFBVTs7OztZQXREVSxRQUFRO1lBS3pCLG1CQUFtQjtZQURuQixtQkFBbUI7WUFhZCxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgICBBYnN0cmFjdERpYWxvZ1NlcnZpY2UsXG4gICAgQWJzdHJhY3RIdHRwU2VydmljZSxcbiAgICBBYnN0cmFjdEkxOG5TZXJ2aWNlLFxuICAgIEFic3RyYWN0U3Bpbm5lclNlcnZpY2UsXG4gICAgQWJzdHJhY3RUb2FzdGVyU2VydmljZSxcbiAgICBFdmVudE5vdGlmaWVyLFxuICAgIEZpZWxkVHlwZVNlcnZpY2UsXG4gICAgRmllbGRXaWRnZXRTZXJ2aWNlLFxuICAgIGdldFdtUHJvamVjdFByb3BlcnRpZXMsXG4gICAgaXNEZWZpbmVkLFxuICAgIGlzU3RyaW5nLFxuICAgIFV0aWxzU2VydmljZSxcbiAgICBEeW5hbWljQ29tcG9uZW50UmVmUHJvdmlkZXJcbn0gZnJvbSAnQHdtL2NvcmUnO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXJ2aWNlIH0gZnJvbSAnQHdtL3NlY3VyaXR5JztcblxuZGVjbGFyZSBjb25zdCBfO1xuXG5jb25zdCBpbmplY3Rvck1hcCA9IHtcbiAgICBEaWFsb2dTZXJ2aWNlOiBBYnN0cmFjdERpYWxvZ1NlcnZpY2UsXG4gICAgaTE4blNlcnZpY2U6IEFic3RyYWN0STE4blNlcnZpY2UsXG4gICAgU3Bpbm5lclNlcnZpY2U6IEFic3RyYWN0U3Bpbm5lclNlcnZpY2UsXG4gICAgVG9hc3RlclNlcnZpY2U6IEFic3RyYWN0VG9hc3RlclNlcnZpY2UsXG4gICAgVXRpbHM6IFV0aWxzU2VydmljZSxcbiAgICBGSUVMRF9UWVBFOiBGaWVsZFR5cGVTZXJ2aWNlLFxuICAgIEZJRUxEX1dJREdFVDogRmllbGRXaWRnZXRTZXJ2aWNlLFxuICAgIER5bmFtaWNDb21wb25lbnRTZXJ2aWNlOiBEeW5hbWljQ29tcG9uZW50UmVmUHJvdmlkZXJcbn07XG5cbmNvbnN0IGVudW0gUFJPSkVDVF9UWVBFIHtcbiAgICBBUFBMSUNBVElPTiA9ICdBUFBMSUNBVElPTicsXG4gICAgUFJFRkFCID0gJ1BSRUZBQicsXG4gICAgVEVNUExBVEVfQlVORExFID0gJ1RFTVBMQVRFQlVORExFJ1xufVxuXG5jb25zdCBub29wID0gKC4uLmFyZ3MpID0+IHt9O1xuXG4vLyBXcmFwcyBodHRwU2VydmljZSB0byBiZWhhdmUgYXMgYW5ndWxhciAxLnggJGh0dHAgc2VydmljZS5cbmNvbnN0IGdldEh0dHBEZXBlbmRlbmN5ID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgaHR0cFNlcnZpY2UgPSB0aGlzLmh0dHBTZXJ2aWNlO1xuICAgIGNvbnN0IGZuID0gZnVuY3Rpb24gKGtleSwgb3B0aW9ucz8pIHtcbiAgICAgICAgY29uc3QgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKS5zbGljZSgxKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShodHRwU2VydmljZVtrZXldLmFwcGx5KGh0dHBTZXJ2aWNlLCBhcmdzKSk7XG4gICAgfTtcbiAgICBjb25zdCAkaHR0cCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHVuZGVmaW5lZCwgWydzZW5kJywgLi4uQXJyYXkuZnJvbShhcmd1bWVudHMpXSk7XG4gICAgfTtcbiAgICBbJ2dldCcsICdwb3N0JywgJ2hlYWQnLCAncHV0JywgJ2RlbGV0ZScsICdqc29ucCcsICdwYXRjaCddLmZvckVhY2goa2V5ID0+ICRodHRwW2tleV0gPSBmbi5iaW5kKHVuZGVmaW5lZCwga2V5KSk7XG4gICAgcmV0dXJuICRodHRwO1xufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcFJlZiB7XG4gICAgVmFyaWFibGVzOiBhbnkgPSB7fTtcbiAgICBBY3Rpb25zOiBhbnkgPSB7fTtcbiAgICBvbkFwcFZhcmlhYmxlc1JlYWR5ID0gbm9vcDtcbiAgICBvblNlc3Npb25UaW1lb3V0ID0gbm9vcDtcbiAgICBvblBhZ2VSZWFkeSA9IG5vb3A7XG4gICAgb25CZWZvcmVQYWdlTGVhdmUgPSBub29wO1xuICAgIG9uQmVmb3JlU2VydmljZUNhbGwgPSAgbm9vcDtcbiAgICBvblNlcnZpY2VTdWNjZXNzID0gIG5vb3A7XG4gICAgb25TZXJ2aWNlRXJyb3IgPSAgbm9vcDtcbiAgICBkeW5hbWljQ29tcG9uZW50Q29udGFpbmVyUmVmID0ge307XG5cbiAgICBwcm9qZWN0TmFtZTogc3RyaW5nO1xuICAgIGlzUHJlZmFiVHlwZTogYm9vbGVhbjtcbiAgICBpc0FwcGxpY2F0aW9uVHlwZTogYm9vbGVhbjtcbiAgICBpc1RhYmxldEFwcGxpY2F0aW9uVHlwZTogYm9vbGVhbjtcbiAgICBpc1RlbXBsYXRlQnVuZGxlVHlwZTogYm9vbGVhbjtcblxuICAgIGFwcExvY2FsZTogYW55O1xuXG4gICAgY2hhbmdlTG9jYWxlID0gdGhpcy5pMThuU2VydmljZS5zZXRTZWxlY3RlZExvY2FsZS5iaW5kKHRoaXMuaTE4blNlcnZpY2UpO1xuICAgIGdldFNlbGVjdGVkTG9jYWxlID0gdGhpcy5pMThuU2VydmljZS5nZXRTZWxlY3RlZExvY2FsZS5iaW5kKHRoaXMuaTE4blNlcnZpY2UpO1xuXG4gICAgcHJpdmF0ZSBfZXZlbnROb3RpZmllciA9IG5ldyBFdmVudE5vdGlmaWVyKCk7XG5cbiAgICBsYW5kaW5nUGFnZU5hbWU6IHN0cmluZztcblxuICAgIHJlbG9hZCgpIHtcbiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGluajogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgaTE4blNlcnZpY2U6IEFic3RyYWN0STE4blNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgaHR0cFNlcnZpY2U6IEFic3RyYWN0SHR0cFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc2VjdXJpdHlTZXJ2aWNlOiBTZWN1cml0eVNlcnZpY2VcbiAgICApIHtcblxuICAgICAgICBjb25zdCB3bVByb2plY3RQcm9wZXJ0aWVzID0gZ2V0V21Qcm9qZWN0UHJvcGVydGllcygpO1xuXG4gICAgICAgIHRoaXMucHJvamVjdE5hbWUgPSB3bVByb2plY3RQcm9wZXJ0aWVzLm5hbWU7XG4gICAgICAgIHRoaXMuaXNQcmVmYWJUeXBlID0gd21Qcm9qZWN0UHJvcGVydGllcy50eXBlID09PSBQUk9KRUNUX1RZUEUuUFJFRkFCO1xuICAgICAgICB0aGlzLmlzQXBwbGljYXRpb25UeXBlID0gd21Qcm9qZWN0UHJvcGVydGllcy50eXBlID09PSBQUk9KRUNUX1RZUEUuQVBQTElDQVRJT047XG4gICAgICAgIHRoaXMuaXNUZW1wbGF0ZUJ1bmRsZVR5cGUgPSB3bVByb2plY3RQcm9wZXJ0aWVzLnR5cGUgPT09IFBST0pFQ1RfVFlQRS5URU1QTEFURV9CVU5ETEU7XG5cbiAgICAgICAgdGhpcy5odHRwU2VydmljZS5yZWdpc3Rlck9uU2Vzc2lvblRpbWVvdXQodGhpcy5vbjQwMS5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLmFwcExvY2FsZSA9IHRoaXMuaTE4blNlcnZpY2UuZ2V0QXBwTG9jYWxlKCk7XG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2Uuc2V0TG9jYWxlKHRoaXMuYXBwTG9jYWxlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbm90aWZ5KGV2ZW50TmFtZTogc3RyaW5nLCAuLi5kYXRhOiBBcnJheTxhbnk+KSB7XG4gICAgICAgIHRoaXMuX2V2ZW50Tm90aWZpZXIubm90aWZ5LmFwcGx5KHRoaXMuX2V2ZW50Tm90aWZpZXIsIGFyZ3VtZW50cyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldERlcGVuZGVuY3koaW5qVG9rZW4pIHtcbiAgICAgICAgaWYgKGlzU3RyaW5nKGlualRva2VuKSkge1xuICAgICAgICAgICAgaWYgKGlualRva2VuID09PSAnSHR0cFNlcnZpY2UnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdldEh0dHBEZXBlbmRlbmN5LmNhbGwodGhpcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgcHJvdmlkZXJJbnN0YW5jZSA9IGluamVjdG9yTWFwW2lualRva2VuXSAmJiB0aGlzLmluai5nZXQoaW5qZWN0b3JNYXBbaW5qVG9rZW5dKTtcbiAgICAgICAgICAgIGlmICghcHJvdmlkZXJJbnN0YW5jZSAmJiB0aGlzLmlualsnX3Byb3ZpZGVycyddKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbmpbJ19wcm92aWRlcnMnXS5mb3JFYWNoKCBlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUgJiYgZS5fX3Byb3RvX18uY29uc3RydWN0b3IudG9TdHJpbmcoKS5pbmRleE9mKCdmdW5jdGlvbiAnICsgaW5qVG9rZW4gKyAnKCcpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlckluc3RhbmNlID0gdGhpcy5pbmouZ2V0KGUuX19wcm90b19fLmNvbnN0cnVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByb3ZpZGVySW5zdGFuY2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaW5qLmdldChpbmpUb2tlbik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogdHJpZ2dlcnMgdGhlIG9uU2Vzc2lvblRpbWVvdXQgY2FsbGJhY2sgaW4gYXBwLmpzXG4gICAgICovXG4gICAgb240MDEoKSB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmZvID0gXy5nZXQodGhpcy5zZWN1cml0eVNlcnZpY2UuZ2V0KCksICd1c2VySW5mbycpO1xuICAgICAgICAvLyBpZiBhIHByZXZpb3VzIHVzZXIgZXhpc3RzLCBhIHNlc3Npb24gdGltZSBvdXQgdHJpZ2dlcmVkXG4gICAgICAgIGlmICghXy5pc0VtcHR5KHVzZXJJbmZvKSkge1xuICAgICAgICAgICAgdGhpcy5vblNlc3Npb25UaW1lb3V0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3Vic2NyaWJlKGV2ZW50TmFtZSwgY2FsbGJhY2s6IChkYXRhOiBhbnkpID0+IHZvaWQpOiAoKSA9PiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50Tm90aWZpZXIuc3Vic2NyaWJlKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgIH1cblxuICAgIHB1YmxpYyBub3RpZnlBcHAodGVtcGxhdGUsIHR5cGUsIHRpdGxlKSB7XG4gICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbkFjdGlvbiA9IF8uZ2V0KHRoaXMsICdBY3Rpb25zLmFwcE5vdGlmaWNhdGlvbicpO1xuICAgICAgICBpZiAobm90aWZpY2F0aW9uQWN0aW9uKSB7XG4gICAgICAgICAgICB0eXBlID0gdHlwZSB8fCAnc3VjY2Vzcyc7XG4gICAgICAgICAgICBub3RpZmljYXRpb25BY3Rpb24uaW52b2tlKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiB0ZW1wbGF0ZSxcbiAgICAgICAgICAgICAgICB0aXRsZTogaXNEZWZpbmVkKHRpdGxlKSA/IHRpdGxlIDogdHlwZS50b1VwcGVyQ2FzZSgpLFxuICAgICAgICAgICAgICAgIGNsYXNzOiB0eXBlLFxuICAgICAgICAgICAgICAgIC8vIElmIHRoZSB0eXBlIGlzIGVycm9yIGRvIG5vdCBjbG9zZSB0aGUgdG9hc3RyXG4gICAgICAgICAgICAgICAgZHVyYXRpb246IHR5cGUudG9VcHBlckNhc2UoKSA9PT0gJ0VSUk9SJyA/IDAgOiB1bmRlZmluZWRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdUaGUgZGVmYXVsdCBBY3Rpb24gXCJhcHBOb3RpZmljYXRpb25cIiBkb2VzblxcJ3QgZXhpc3QgaW4gdGhlIGFwcC4nKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==