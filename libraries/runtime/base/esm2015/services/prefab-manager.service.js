import { Injectable } from '@angular/core';
import { loadScripts, loadStyleSheets, stringStartsWith } from '@wm/core';
import { MetadataService } from '@wm/variables';
import { PrefabConfigProvider } from '../types/types';
import { getPrefabBaseUrl, isPrefabInPreview } from '../util/utils';
const prefabsWithError = new Set();
const inProgress = new Map();
const resolvedPrefabs = new Set();
const getPrefabResourceUrl = (resourcePath, resourceBasePath) => {
    let _url = resourcePath;
    if (!stringStartsWith(resourcePath, 'http://|https://|//')) {
        _url = (resourceBasePath + _url).replace('//', '/');
    }
    return _url;
};
const ɵ0 = getPrefabResourceUrl;
export class PrefabManagerService {
    constructor($metadata, prefabConfigProvider) {
        this.$metadata = $metadata;
        this.prefabConfigProvider = prefabConfigProvider;
    }
    getConfig(prefabName) {
        return this.prefabConfigProvider.getConfig(prefabName);
    }
    loadServiceDefs(prefabName) {
        return isPrefabInPreview(prefabName) ? Promise.resolve() : this.$metadata.load(prefabName);
    }
    loadStyles(prefabName, { resources: { styles } } = { resources: { styles: [] } }) {
        const baseUrl = getPrefabBaseUrl(prefabName);
        const _styles = styles.map(url => {
            if (!_.endsWith(url, '/pages/Main/Main.css')) {
                return getPrefabResourceUrl(url, baseUrl);
            }
            return undefined;
        }).filter(url => !!url);
        loadStyleSheets(_styles);
        return Promise.resolve();
    }
    // TODO [Vinay] - implement onPrefabResourceLoad
    loadScripts(prefabName, { resources: { scripts } } = { resources: { scripts: [] } }) {
        const baseUrl = getPrefabBaseUrl(prefabName);
        const _scripts = scripts.map(url => getPrefabResourceUrl(url, baseUrl));
        return loadScripts(_scripts);
    }
    setInProgress(prefabName) {
        let _res;
        let _rej;
        const _promise = new Promise((res, rej) => {
            _res = res;
            _rej = rej;
        });
        _promise.resolve = _res;
        _promise.reject = _rej;
        inProgress.set(prefabName, _promise);
    }
    resolveInProgress(prefabName) {
        if (inProgress.get(prefabName)) {
            inProgress.get(prefabName).resolve();
            inProgress.delete(prefabName);
        }
    }
    loadDependencies(prefabName) {
        if (resolvedPrefabs.has(prefabName)) {
            return Promise.resolve();
        }
        if (prefabsWithError.has(prefabName)) {
            return Promise.reject('');
        }
        if (inProgress.get(prefabName)) {
            return inProgress.get(prefabName);
        }
        this.setInProgress(prefabName);
        return this.getConfig(prefabName)
            .then(config => {
            return Promise.all([
                this.loadStyles(prefabName, config),
                this.loadScripts(prefabName, config),
                this.loadServiceDefs(prefabName)
            ]).then(() => {
                this.resolveInProgress(prefabName);
                resolvedPrefabs.add(prefabName);
            });
        });
    }
}
PrefabManagerService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PrefabManagerService.ctorParameters = () => [
    { type: MetadataService },
    { type: PrefabConfigProvider }
];
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLW1hbmFnZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9ydW50aW1lL2Jhc2UvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9wcmVmYWItbWFuYWdlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDMUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVoRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJcEUsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0FBQzNDLE1BQU0sVUFBVSxHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO0FBQ25ELE1BQU0sZUFBZSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7QUFFMUMsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxFQUFFO0lBQzVELElBQUksSUFBSSxHQUFHLFlBQVksQ0FBQztJQUN4QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLHFCQUFxQixDQUFDLEVBQUU7UUFDeEQsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztLQUN2RDtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUMsQ0FBQzs7QUFHRixNQUFNLE9BQU8sb0JBQW9CO0lBRTdCLFlBQ1ksU0FBMEIsRUFDMUIsb0JBQTBDO1FBRDFDLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQzFCLHlCQUFvQixHQUFwQixvQkFBb0Is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QUMsQ0FBQztTQUM3QjtRQUVELElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM1QixPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDckM7UUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRS9CLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7YUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ1gsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDO2dCQUNmLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQztnQkFDbkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDO2dCQUNwQyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQzthQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDVCxJQUFJLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ25DLGVBQWUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7OztZQXRGSixVQUFVOzs7O1lBbkJGLGVBQWU7WUFFZixvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGxvYWRTY3JpcHRzLCBsb2FkU3R5bGVTaGVldHMsIHN0cmluZ1N0YXJ0c1dpdGggfSBmcm9tICdAd20vY29yZSc7XG5pbXBvcnQgeyBNZXRhZGF0YVNlcnZpY2UgfSBmcm9tICdAd20vdmFyaWFibGVzJztcblxuaW1wb3J0IHsgUHJlZmFiQ29uZmlnUHJvdmlkZXIgfSBmcm9tICcuLi90eXBlcy90eXBlcyc7XG5pbXBvcnQgeyBnZXRQcmVmYWJCYXNlVXJsLCBpc1ByZWZhYkluUHJldmlldyB9IGZyb20gJy4uL3V0aWwvdXRpbHMnO1xuXG5kZWNsYXJlIGNvbnN0IF87XG5cbmNvbnN0IHByZWZhYnNXaXRoRXJyb3IgPSBuZXcgU2V0PHN0cmluZz4oKTtcbmNvbnN0IGluUHJvZ3Jlc3MgPSBuZXcgTWFwPHN0cmluZywgUHJvbWlzZTxhbnk+PigpO1xuY29uc3QgcmVzb2x2ZWRQcmVmYWJzID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbmNvbnN0IGdldFByZWZhYlJlc291cmNlVXJsID0gKHJlc291cmNlUGF0aCwgcmVzb3VyY2VCYXNlUGF0aCkgPT4ge1xuICAgIGxldCBfdXJsID0gcmVzb3VyY2VQYXRoO1xuICAgIGlmICghc3RyaW5nU3RhcnRzV2l0aChyZXNvdXJjZVBhdGgsICdodHRwOi8vfGh0dHBzOi8vfC8vJykpIHtcbiAgICAgICAgX3VybCA9IChyZXNvdXJjZUJhc2VQYXRoICsgX3VybCkucmVwbGFjZSgnLy8nLCAnLycpO1xuICAgIH1cbiAgICByZXR1cm4gX3VybDtcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcmVmYWJNYW5hZ2VyU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSAkbWV0YWRhdGE6IE1ldGFkYXRhU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBwcmVmYWJDb25maWdQcm92aWRlcjogUHJlZmFiQ29uZmlnUHJvdmlkZXJcbiAgICApIHt9XG5cbiAgICBwdWJsaWMgZ2V0Q29uZmlnKHByZWZhYk5hbWUpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmVmYWJDb25maWdQcm92aWRlci5nZXRDb25maWcocHJlZmFiTmFtZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWRTZXJ2aWNlRGVmcyhwcmVmYWJOYW1lKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIGlzUHJlZmFiSW5QcmV2aWV3KHByZWZhYk5hbWUpID8gUHJvbWlzZS5yZXNvbHZlKCkgOiB0aGlzLiRtZXRhZGF0YS5sb2FkKHByZWZhYk5hbWUpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBsb2FkU3R5bGVzKHByZWZhYk5hbWUsIHtyZXNvdXJjZXM6IHtzdHlsZXN9fSA9IHtyZXNvdXJjZXM6IHtzdHlsZXM6IFtdfX0pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgYmFzZVVybCA9IGdldFByZWZhYkJhc2VVcmwocHJlZmFiTmFtZSk7XG4gICAgICAgIGNvbnN0IF9zdHlsZXMgPSBzdHlsZXMubWFwKHVybCA9PiB7XG4gICAgICAgICAgICBpZiAoIV8uZW5kc1dpdGgodXJsLCAnL3BhZ2VzL01haW4vTWFpbi5jc3MnKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBnZXRQcmVmYWJSZXNvdXJjZVVybCh1cmwsIGJhc2VVcmwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfSkuZmlsdGVyKHVybCA9PiAhIXVybCk7XG5cbiAgICAgICAgbG9hZFN0eWxlU2hlZXRzKF9zdHlsZXMpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICAvLyBUT0RPIFtWaW5heV0gLSBpbXBsZW1lbnQgb25QcmVmYWJSZXNvdXJjZUxvYWRcbiAgICBwcm90ZWN0ZWQgbG9hZFNjcmlwdHMocHJlZmFiTmFtZSwge3Jlc291cmNlczoge3NjcmlwdHN9fSA9IHtyZXNvdXJjZXM6IHtzY3JpcHRzOiBbXX19KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgYmFzZVVybCA9IGdldFByZWZhYkJhc2VVcmwocHJlZmFiTmFtZSk7XG4gICAgICAgIGNvbnN0IF9zY3JpcHRzID0gc2NyaXB0cy5tYXAodXJsID0+IGdldFByZWZhYlJlc291cmNlVXJsKHVybCwgYmFzZVVybCkpO1xuXG4gICAgICAgIHJldHVybiBsb2FkU2NyaXB0cyhfc2NyaXB0cyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRJblByb2dyZXNzKHByZWZhYk5hbWU6IHN0cmluZykge1xuICAgICAgICBsZXQgX3JlcztcbiAgICAgICAgbGV0IF9yZWo7XG4gICAgICAgIGNvbnN0IF9wcm9taXNlOiBhbnkgPSBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHtcbiAgICAgICAgICAgIF9yZXMgPSByZXM7XG4gICAgICAgICAgICBfcmVqID0gcmVqO1xuICAgICAgICB9KTtcblxuICAgICAgICBfcHJvbWlzZS5yZXNvbHZlID0gX3JlcztcbiAgICAgICAgX3Byb21pc2UucmVqZWN0ID0gX3JlajtcblxuICAgICAgICBpblByb2dyZXNzLnNldChwcmVmYWJOYW1lLCBfcHJvbWlzZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNvbHZlSW5Qcm9ncmVzcyhwcmVmYWJOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGluUHJvZ3Jlc3MuZ2V0KHByZWZhYk5hbWUpKSB7XG4gICAgICAgICAgICAoaW5Qcm9ncmVzcy5nZXQocHJlZmFiTmFtZSkgYXMgYW55KS5yZXNvbHZlKCk7XG4gICAgICAgICAgICBpblByb2dyZXNzLmRlbGV0ZShwcmVmYWJOYW1lKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkRGVwZW5kZW5jaWVzKHByZWZhYk5hbWUpOiBQcm9taXNlPHZvaWQ+IHtcblxuICAgICAgICBpZiAocmVzb2x2ZWRQcmVmYWJzLmhhcyhwcmVmYWJOYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHByZWZhYnNXaXRoRXJyb3IuaGFzKHByZWZhYk5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJycpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGluUHJvZ3Jlc3MuZ2V0KHByZWZhYk5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gaW5Qcm9ncmVzcy5nZXQocHJlZmFiTmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldEluUHJvZ3Jlc3MocHJlZmFiTmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlnKHByZWZhYk5hbWUpXG4gICAgICAgICAgICAudGhlbihjb25maWcgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZFN0eWxlcyhwcmVmYWJOYW1lLCBjb25maWcpLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRTY3JpcHRzKHByZWZhYk5hbWUsIGNvbmZpZyksXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZFNlcnZpY2VEZWZzKHByZWZhYk5hbWUpXG4gICAgICAgICAgICAgICAgXSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZUluUHJvZ3Jlc3MocHJlZmFiTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJlZmFicy5hZGQocHJlZmFiTmFtZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=