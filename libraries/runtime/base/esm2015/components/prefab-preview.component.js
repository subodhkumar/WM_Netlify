import { Component, ViewChild } from '@angular/core';
import { PrefabDirective } from '@wm/components';
import { PrefabManagerService } from '../services/prefab-manager.service';
const PREFAB = 'PREFAB';
export class PrefabPreviewComponent {
    constructor(prefabManager) {
        this.prefabManager = prefabManager;
        window.addEventListener('message', e => {
            const context = e.data && e.data.context;
            if (context !== PREFAB) {
                return;
            }
            const action = e.data.action;
            const payload = e.data.payload;
            if (action === 'init') {
                this.init();
            }
            else if (action === 'set-property') {
                this.setProperty(payload);
            }
            else if (action === 'get-outbound-properties') {
                this.getOutboundProps();
            }
            else if (action === 'invoke-script') {
                this.invokeScript(payload);
            }
        });
    }
    postMessage(action, payload) {
        const data = {
            context: PREFAB,
            action,
            payload
        };
        window.top.postMessage(data, '*');
    }
    setupEventListeners() {
        this.prefabInstance.invokeEventCallback = (eventName, locals = {}) => {
            this.postMessage('event-log', { name: eventName, data: locals });
        };
    }
    init() {
        this.previewMode = true;
        this.prefabInstance.readyState.subscribe(() => { }, () => { }, () => {
            this.prefabManager.getConfig('__self__')
                .then(config => {
                this.config = config;
                this.postMessage('config', config);
                this.setupEventListeners();
            });
        });
    }
    setProperty(payload) {
        this.prefabInstance.widget[payload.name] = payload.value;
    }
    isOutBoundProp(info) {
        return info.bindable === 'out-bound' || info.bindable === 'in-out-bound';
    }
    getOutboundProps() {
        const payload = {};
        for (const [name, info] of Object.entries(this.config.properties || {})) {
            if (this.isOutBoundProp(info)) {
                payload[name] = this.prefabInstance.widget[name];
            }
        }
        this.postMessage('outbound-properties', payload);
    }
    invokeScript(payload) {
        const script = `\n return ${payload.script};`;
        const fn = new Function('Prefab', script);
        const retVal = fn(this.prefabInstance);
        this.postMessage('method-output', { methodName: payload.methodName, output: retVal });
    }
    ngAfterViewInit() {
        this.setupEventListeners();
        this.postMessage('init');
    }
}
PrefabPreviewComponent.decorators = [
    { type: Component, args: [{
                selector: 'wm-prefab-preview',
                template: `
        <div class="prefab-preview row">
            <section wmPrefab name="prefab-preview" prefabname="__self__"></section>
        </div>
    `
            }] }
];
/** @nocollapse */
PrefabPreviewComponent.ctorParameters = () => [
    { type: PrefabManagerService }
];
PrefabPreviewComponent.propDecorators = {
    prefabInstance: [{ type: ViewChild, args: [PrefabDirective,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLXByZXZpZXcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL3J1bnRpbWUvYmFzZS8iLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvcHJlZmFiLXByZXZpZXcuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVwRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFMUUsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBVXhCLE1BQU0sT0FBTyxzQkFBc0I7SUFNL0IsWUFBb0IsYUFBbUM7UUFBbkMsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBRW5ELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDbkMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUV6QyxJQUFJLE9BQU8sS0FBSyxNQUFNLEVBQUU7Z0JBQ3BCLE9BQU87YUFDVjtZQUVELE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQzdCLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBRS9CLElBQUksTUFBTSxLQUFLLE1BQU0sRUFBRTtnQkFDbkIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ2Y7aUJBQU0sSUFBSSxNQUFNLEtBQUssY0FBYyxFQUFFO2dCQUNsQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzdCO2lCQUFNLElBQUksTUFBTSxLQUFLLHlCQUF5QixFQUFFO2dCQUM3QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQzthQUMzQjtpQkFB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LENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzdCLENBQUM7OztZQXZHSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLG1CQUFtQjtnQkFDN0IsUUFBUSxFQUFFOzs7O0tBSVQ7YUFDSjs7OztZQVhRLG9CQUFvQjs7OzZCQWdCeEIsU0FBUyxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBQcmVmYWJEaXJlY3RpdmUgfSBmcm9tICdAd20vY29tcG9uZW50cyc7XG5cbmltcG9ydCB7IFByZWZhYk1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcHJlZmFiLW1hbmFnZXIuc2VydmljZSc7XG5cbmNvbnN0IFBSRUZBQiA9ICdQUkVGQUInO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3dtLXByZWZhYi1wcmV2aWV3JyxcbiAgICB0ZW1wbGF0ZTogYFxuICAgICAgICA8ZGl2IGNsYXNzPVwicHJlZmFiLXByZXZpZXcgcm93XCI+XG4gICAgICAgICAgICA8c2VjdGlvbiB3bVByZWZhYiBuYW1lPVwicHJlZmFiLXByZXZpZXdcIiBwcmVmYWJuYW1lPVwiX19zZWxmX19cIj48L3NlY3Rpb24+XG4gICAgICAgIDwvZGl2PlxuICAgIGBcbn0pXG5leHBvcnQgY2xhc3MgUHJlZmFiUHJldmlld0NvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xuICAgIHByaXZhdGUgY29uZmlnOiBhbnk7XG4gICAgcHJpdmF0ZSBwcmV2aWV3TW9kZTogYm9vbGVhbjtcblxuICAgIEBWaWV3Q2hpbGQoUHJlZmFiRGlyZWN0aXZlKSBwcmVmYWJJbnN0YW5jZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcHJlZmFiTWFuYWdlcjogUHJlZmFiTWFuYWdlclNlcnZpY2UpIHtcblxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGV4dCA9IGUuZGF0YSAmJiBlLmRhdGEuY29udGV4dDtcblxuICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IFBSRUZBQikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gZS5kYXRhLmFjdGlvbjtcbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBlLmRhdGEucGF5bG9hZDtcblxuICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ2luaXQnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0KCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3NldC1wcm9wZXJ0eScpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldFByb3BlcnR5KHBheWxvYWQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdnZXQtb3V0Ym91bmQtcHJvcGVydGllcycpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmdldE91dGJvdW5kUHJvcHMoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnaW52b2tlLXNjcmlwdCcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmludm9rZVNjcmlwdChwYXlsb2FkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcG9zdE1lc3NhZ2UoYWN0aW9uLCBwYXlsb2FkPzogYW55KSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgICBjb250ZXh0OiBQUkVGQUIsXG4gICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICBwYXlsb2FkXG4gICAgICAgIH07XG4gICAgICAgIHdpbmRvdy50b3AucG9zdE1lc3NhZ2UoZGF0YSwgJyonKTtcbiAgICB9XG5cbiAgICBzZXR1cEV2ZW50TGlzdGVuZXJzKCkge1xuICAgICAgICB0aGlzLnByZWZhYkluc3RhbmNlLmludm9rZUV2ZW50Q2FsbGJhY2sgPSAoZXZlbnROYW1lLCBsb2NhbHMgPSB7fSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSgnZXZlbnQtbG9nJywgeyBuYW1lOiBldmVudE5hbWUsIGRhdGE6IGxvY2FscyB9KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBpbml0KCkge1xuICAgICAgICB0aGlzLnByZXZpZXdNb2RlID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLnByZWZhYkluc3RhbmNlLnJlYWR5U3RhdGUuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKCkgPT4ge30sXG4gICAgICAgICAgICAoKSA9PiB7fSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZWZhYk1hbmFnZXIuZ2V0Q29uZmlnKCdfX3NlbGZfXycpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zdE1lc3NhZ2UoJ2NvbmZpZycsIGNvbmZpZyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0dXBFdmVudExpc3RlbmVycygpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBzZXRQcm9wZXJ0eShwYXlsb2FkOiBhbnkpIHtcbiAgICAgICAgdGhpcy5wcmVmYWJJbnN0YW5jZS53aWRnZXRbcGF5bG9hZC5uYW1lXSA9IHBheWxvYWQudmFsdWU7XG4gICAgfVxuXG4gICAgaXNPdXRCb3VuZFByb3AoaW5mbykge1xuICAgICAgICByZXR1cm4gaW5mby5iaW5kYWJsZSA9PT0gJ291dC1ib3VuZCcgfHwgaW5mby5iaW5kYWJsZSA9PT0gJ2luLW91dC1ib3VuZCc7XG4gICAgfVxuXG4gICAgZ2V0T3V0Ym91bmRQcm9wcygpIHtcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCBpbmZvXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLmNvbmZpZy5wcm9wZXJ0aWVzIHx8IHt9KSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNPdXRCb3VuZFByb3AoaW5mbykpIHtcbiAgICAgICAgICAgICAgICBwYXlsb2FkW25hbWVdID0gdGhpcy5wcmVmYWJJbnN0YW5jZS53aWRnZXRbbmFtZV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBvc3RNZXNzYWdlKCdvdXRib3VuZC1wcm9wZXJ0aWVzJywgcGF5bG9hZCk7XG4gICAgfVxuXG4gICAgaW52b2tlU2NyaXB0KHBheWxvYWQ6IGFueSkge1xuICAgICAgICBjb25zdCBzY3JpcHQgPSBgXFxuIHJldHVybiAke3BheWxvYWQuc2NyaXB0fTtgO1xuXG4gICAgICAgIGNvbnN0IGZuID0gbmV3IEZ1bmN0aW9uKCdQcmVmYWInLCBzY3JpcHQpO1xuXG4gICAgICAgIGNvbnN0IHJldFZhbCA9IGZuKHRoaXMucHJlZmFiSW5zdGFuY2UpO1xuXG4gICAgICAgIHRoaXMucG9zdE1lc3NhZ2UoJ21ldGhvZC1vdXRwdXQnLCB7IG1ldGhvZE5hbWU6IHBheWxvYWQubWV0aG9kTmFtZSwgb3V0cHV0OiByZXRWYWwgfSk7XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgICAgICB0aGlzLnNldHVwRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICAgICAgdGhpcy5wb3N0TWVzc2FnZSgnaW5pdCcpO1xuICAgIH1cbn1cblxuIl19