!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/platform-browser-dynamic"),require("@angular/platform-browser"),require("@angular/common"),require("@angular/platform-browser/animations"),require("ngx-toastr"),require("@angular/router"),require("@wm/variables"),require("@wm/security"),require("@angular/common/http"),require("@wm/core"),require("@wm/transpiler"),require("@angular/core"),require("@wm/runtime/base")):"function"==typeof define&&define.amd?define("@wm/runtime/dynamic",["exports","@angular/platform-browser-dynamic","@angular/platform-browser","@angular/common","@angular/platform-browser/animations","ngx-toastr","@angular/router","@wm/variables","@wm/security","@angular/common/http","@wm/core","@wm/transpiler","@angular/core","@wm/runtime/base"],t):t((e.wm=e.wm||{},e.wm.runtime=e.wm.runtime||{},e.wm.runtime.dynamic={}),e.ng.platformBrowserDynamic,e.ng.platformBrowser,e.ng.common,e.ng.platformBrowser.animations,e.ngxToastr,e.ng.router,e.wm.variables,e.wm.security,e.ng.common.http,e.wm.core,e.wm.transpiler,e.ng.core,e.wm.runtime.base)}(this,function(e,t,r,n,o,a,i,p,s,c,m,u,d,g){"use strict";var l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function h(e,t){function r(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var v=Object.assign||function v(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};function f(t,i,p,s){return new(p||(p=Promise))(function(e,r){function n(e){try{a(s.next(e))}catch(t){r(t)}}function o(e){try{a(s["throw"](e))}catch(t){r(t)}}function a(t){t.done?e(t.value):new p(function(e){e(t.value)}).then(n,o)}a((s=s.apply(t,i||[])).next())})}function y(n,o){var a,i,p,e,s={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function r(e){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(p=i[2&e[0]?"return":e[0]?"throw":"next"])&&!(p=p.call(i,e[1])).done)return p;switch(i=0,p&&(e=[0,p.value]),e[0]){case 0:case 1:p=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(p=0<(p=s.trys).length&&p[p.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!p||e[1]>p[0]&&e[1]<p[3])){s.label=e[1];break}if(6===e[0]&&s.label<p[1]){s.label=p[1],p=e;break}if(p&&s.label<p[2]){s.label=p[2],s.ops.push(e);break}p[2]&&s.ops.pop(),s.trys.pop();continue}e=o.call(n,s)}catch(t){e=[6,t],i=0}finally{a=p=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}var b=function(){function e(e,t,r,n,o,a,i,p,s,c,u,l,f){this.injector=e,this.route=t,this.vcRef=r,this.appRef=n,this.metadataService=o,this.securityService=a,this.appManager=i,this.app=p,this.ngZone=s,this.elRef=c,this.spinnerService=u,this.componentRefProvider=l,this.router=f}return e.prototype.getTargetNode=function(){return this.elRef.nativeElement},e.prototype.resetViewContainer=function(){this.vcRef.clear(),this.getTargetNode().innerHTML=""},e.prototype.renderPage=function(n){var e=this,o=this.getTargetNode();this.appManager.loadAppVariables().then(function(){return f(e,void 0,void 0,function(){var t,r;return y(this,function(e){switch(e.label){case 0:return[4,this.componentRefProvider.getComponentFactoryRef(n,g.ComponentType.PAGE)];case 1:return(t=e.sent())&&(r=this.vcRef.createComponent(t,0,this.injector),o.appendChild(r.location.nativeElement)),1<this.vcRef.length&&this.vcRef.remove(1),[2]}})})})},e.prototype.renderPrefabPreviewPage=function(){this.router.navigate(["prefab-preview"])},e.prototype.canDeactivate=function(){var e;return!1!==(e=this.app.activePage&&this.app.activePage.onBeforePageLeave())&&(e=(this.app.onBeforePageLeave||m.noop)(this.app.activePageName,this.app.activePage)),e===undefined||e},e.prototype.ngOnInit=function(){var r=this;this.app.isPrefabType?this.renderPrefabPreviewPage():($(this.getTargetNode()).find(">div:first").remove(),this.subscription=this.route.params.subscribe(function(e){var t=e.pageName;r.ngZone.run(function(){t&&r.renderPage(t)})}))},e.prototype.ngOnDestroy=function(){this.vcRef.clear(),this.subscription&&this.subscription.unsubscribe()},e.decorators=[{type:d.Component,args:[{selector:"app-page-outlet",template:"<div></div>"}]}],e.ctorParameters=function(){return[{type:d.Injector},{type:i.ActivatedRoute},{type:d.ViewContainerRef},{type:d.ApplicationRef},{type:p.MetadataService},{type:s.SecurityService},{type:g.AppManagerService},{type:m.App},{type:d.NgZone},{type:d.ElementRef},{type:m.AbstractSpinnerService},{type:g.ComponentRefProvider},{type:i.Router}]},e.propDecorators={canDeactivate:[{type:d.HostListener,args:["window:beforeunload"]}]},e}(),w={securityConfig:g.SecurityConfigResolve,metadata:g.MetadataResolve,appJS:g.AppJSResolve},P=[{path:"",pathMatch:"full",resolve:w,component:g.EmptyPageComponent},{path:"prefab-preview",pathMatch:"full",resolve:w,component:g.PrefabPreviewComponent},{path:":pageName",pathMatch:"full",resolve:w,component:b,canDeactivate:[g.CanDeactivatePageGuard]}],C=function(r){function e(e){var t=r.call(this)||this;return t.$http=e,t}return h(e,r),e.prototype.getAppScriptFn=function(){return this.$http.get("./app.js",{responseType:"text"}).toPromise().then(function(e){return new Function("App","Utils","Injector",e)})},e.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:c.HttpClient}]},e.ngInjectableDef=d.defineInjectable({factory:function(){return new e(d.inject(c.HttpClient))},token:e,providedIn:"root"}),e}(g.AppJSProvider),M=new Map,R=function(){function e(e){this.$http=e}return e.prototype.get=function(t,r){var e=M.get(t);return e?Promise.resolve(e):this.$http.get(t).then(function(e){return r&&M.set(t,e),e})},e.prototype.clearCache=function(){M.clear()},e.decorators=[{type:d.Injectable}],e.ctorParameters=function(){return[{type:m.AbstractHttpService}]},e}(),A=function(r){function e(e){var t=r.call(this)||this;return t.resourceManager=e,t}return h(e,r),e.prototype.getAppVariables=function(){return f(this,void 0,void 0,function(){return y(this,function(e){return[2,this.resourceManager.get("./app.variables.json")]})})},e.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:R}]},e.ngInjectableDef=d.defineInjectable({factory:function(){return new e(d.inject(R))},token:e,providedIn:"root"}),e}(g.AppVariablesProvider),S=new Map;window.resourceCache=S;var E=new Map;E.set(g.ComponentType.PAGE,new Map),E.set(g.ComponentType.PARTIAL,new Map),E.set(g.ComponentType.PREFAB,new Map);var T=function(e){return decodeURIComponent(e.replace(/\+/g," "))},j=new Map,O=function(){function e(){}return e.prototype.init=function(){},e}(),I=function(n,o,e,t,u,a){var i={template:e,styles:[t],encapsulation:d.ViewEncapsulation.None},r=O,l="",f="";switch(o){case g.ComponentType.PAGE:r=g.BasePageComponent,l="app-page-"+n,f="Page";break;case g.ComponentType.PARTIAL:r=g.BasePartialComponent,l="app-partial-"+n,f="Partial";break;case g.ComponentType.PREFAB:r=g.BasePrefabComponent,l="app-prefab-"+n,f="Prefab"}return function(r){function e(e){var t=r.call(this)||this;switch(t.injector=e,o){case g.ComponentType.PAGE:t.pageName=n;break;case g.ComponentType.PARTIAL:t.partialName=n;break;case g.ComponentType.PREFAB:t.prefabName=n}return r.prototype.init.call(t),t}return h(e,r),e.prototype.evalUserScript=function(e,t,r){var n,o,a,i,p,s,c;n=u,o=l,a=f,i=e,p=t,s=r,(c=j.get(o))||(c=new Function(a,"App","Utils",n),j.set(o,c)),c(i,p,s)},e.prototype.getVariables=function(){return JSON.parse(a)},e.decorators=[{type:d.Component,args:[v({},i,{selector:l,providers:[{provide:m.UserDefinedExecutionContext,useExisting:e}]})]}],e.ctorParameters=function(){return[{type:d.Injector}]},e}(r)},N=function(a){function e(e,t,r,n){var o=a.call(this)||this;return o.resouceMngr=e,o.app=t,o.appManager=r,o.compiler=n,o}return h(e,a),e.prototype.loadResourcesOfFragment=function(i,p){var e,t,n=this,s=(e=i,(t=p)===g.ComponentType.PAGE||t===g.ComponentType.PARTIAL?"./pages/"+e+"/page.min.json":t===g.ComponentType.PREFAB?g.getPrefabMinJsonUrl(e):void 0),r=S.get(s);return r?Promise.resolve(r):this.resouceMngr.get(s,!0).then(function(e){var t=e.markup,r=e.script,n=e.styles,o=e.variables,a={markup:u.transpile(T(t)),script:T(r),styles:u.scopeComponentStyles(i,p,T(n)),variables:m.getValidJSON(T(o))};return S.set(s,a),a},function(e){var t=e.details.status,r={404:n.app.appLocale.MESSAGE_PAGE_NOT_FOUND||"The page you are trying to reach is not available",403:n.app.appLocale.LABEL_ACCESS_DENIED||"Access Denied"};return Promise.reject(r[t])})},e.prototype.getComponentFactoryRef=function(u,l){return f(this,void 0,void 0,function(){var t,s,c=this;return y(this,function(e){return(t=E.get(l))&&(s=t.get(u))?[2,s]:[2,this.loadResourcesOfFragment(u,l).then(function(e){var t,r=e.markup,n=e.script,o=e.styles,a=e.variables,i=I(u,l,r,o,n,JSON.stringify(a)),p=(t=i,function(){function e(){}return e.decorators=[{type:d.NgModule,args:[{declarations:[t],imports:[g.RuntimeBaseModule],schemas:[d.CUSTOM_ELEMENTS_SCHEMA,d.NO_ERRORS_SCHEMA]}]}],e}());return s=c.compiler.compileModuleAndAllComponentsSync(p).componentFactories.filter(function(e){return e.componentType===i})[0],E.get(l).set(u,s),s},function(e){e&&c.appManager.notifyApp(e,"error")})]})})},e.prototype.clearComponentFactoryRefCache=function(){this.resouceMngr.clearCache(),S.clear(),E.forEach(function(e){e.clear()})},e.decorators=[{type:d.Injectable}],e.ctorParameters=function(){return[{type:R},{type:m.App},{type:g.AppManagerService},{type:d.Compiler}]},e}(g.ComponentRefProvider),x=new Map,D=function(r){function e(e){var t=r.call(this)||this;return t.resourceMngr=e,t}return h(e,r),e.prototype.getConfig=function(t){var e=x.get(t);return e?Promise.resolve(e):this.resourceMngr.get(g.getPrefabConfigUrl(t)).then(function(e){return x.set(t,e),e})},e.decorators=[{type:d.Injectable}],e.ctorParameters=function(){return[{type:R}]},e}(g.PrefabConfigProvider),L=i.RouterModule.forRoot(P,{useHash:!0,scrollPositionRestoration:"top"}),B=a.ToastrModule.forRoot({maxOpened:1,autoDismiss:!0}),F=c.HttpClientXsrfModule.withOptions({cookieName:"wm_xsrf_token",headerName:m.getWmProjectProperties().xsrf_header_name}),k=function(){function e(e,t,r){this.app=e,this.inj=t,this.componentRefProvider=r,window.cordova&&this.app.subscribe("userLoggedOut",this.componentRefProvider.clearComponentFactoryRefCache.bind(this.componentRefProvider))}return e.decorators=[{type:d.NgModule,args:[{declarations:[b],imports:[r.BrowserModule,n.CommonModule,i.RouterModule,c.HttpClientModule,o.BrowserAnimationsModule,L,B,F,g.WM_MODULES_FOR_ROOT],providers:[R,{provide:g.AppJSProvider,useClass:C},{provide:g.AppVariablesProvider,useClass:A},{provide:g.ComponentRefProvider,useClass:N},{provide:g.PartialRefProvider,useClass:N},{provide:g.PrefabConfigProvider,useClass:D}],bootstrap:[g.AppComponent]}]}],e.ctorParameters=function(){return[{type:m.App},{type:d.Injector},{type:g.ComponentRefProvider}]},e}(),q="debugMode";"true"!==sessionStorage.getItem(q)&&d.enableProdMode(),console.time("bootstrap"),document.addEventListener("DOMContentLoaded",function(){new Promise(function(e){window.cordova?document.addEventListener("deviceready",e):e()}).then(function(){return t.platformBrowserDynamic().bootstrapModule(k)}).then(function(){return console.timeEnd("bootstrap")},function(e){return console.log(e)})}),window.debugMode=function(e){_.isEmpty(e)&&(e=!0);var t=e?"true":"false";sessionStorage.getItem(q)!==t&&(sessionStorage.setItem(q,t),window.location.reload())},e.ɵa=P,e.ɵb=b,e.ɵd=C,e.ɵc=R,e.ɵe=A,e.ɵf=N,e.ɵg=D,e.routerModule=L,e.toastrModule=B,e.httpClientXsrfModule=F,e.AppModule=k,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map