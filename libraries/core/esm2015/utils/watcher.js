import { IDGenerator } from './id-generator';
import { $parseExpr } from './expression-parser';
const registry = new Map();
const watchIdGenerator = new IDGenerator('watch-id-');
export const FIRST_TIME_WATCH = {};
Object.freeze(FIRST_TIME_WATCH);
export const isFirstTimeChange = v => v === FIRST_TIME_WATCH;
let muted = false;
export const debounce = (fn, wait = 50) => {
    let timeout;
    return (...args) => {
        window['__zone_symbol__clearTimeout'](timeout);
        timeout = window['__zone_symbol__setTimeout'](() => fn(...args), wait);
    };
};
export const muteWatchers = () => {
    muted = true;
};
export const unMuteWatchers = () => {
    muted = false;
    triggerWatchers();
};
export const $watch = (expr, $scope, $locals, listener, identifier = watchIdGenerator.nextUid(), doNotClone = false) => {
    if (expr.indexOf('[$i]') !== -1) {
        expr = expr.replace(/\[\$i]/g, '[0]');
    }
    const fn = $parseExpr(expr);
    registry.set(identifier, {
        fn: fn.bind(expr, $scope, $locals),
        listener,
        expr,
        last: FIRST_TIME_WATCH,
        doNotClone
    });
    return () => $unwatch(identifier);
};
export const $unwatch = identifier => registry.delete(identifier);
let changedByWatch = false;
const $RAF = window.requestAnimationFrame;
let ngZone;
const triggerWatchers = (ignoreMuted) => {
    if (muted && !ignoreMuted) {
        return;
    }
    const limit = 5;
    let pass = 1;
    let changeDetected;
    do {
        changeDetected = false;
        registry.forEach(watchInfo => {
            const fn = watchInfo.fn;
            const listener = watchInfo.listener;
            const ov = watchInfo.last;
            let nv;
            try {
                nv = fn();
            }
            catch (e) {
                console.warn(`error in executing expression: '${watchInfo.expr}'`);
            }
            if (!_.isEqual(nv, ov)) {
                changeDetected = true;
                changedByWatch = true;
                watchInfo.last = nv;
                if (_.isObject(nv) && !watchInfo.doNotClone && nv.__cloneable__ !== false) {
                    watchInfo.last = _.clone(nv);
                }
                listener(nv, ov);
                resetChangeFromWatch();
            }
        });
        pass++;
    } while (changeDetected && pass < limit);
    if (changeDetected && pass === limit) {
        console.warn(`Number of watch cycles gone above set limit of: ${limit} `);
    }
};
const ɵ0 = triggerWatchers;
export const setNgZone = zone => ngZone = zone;
export const setAppRef = appRef => {
    $appDigest = (() => {
        let queued = false;
        return (force) => {
            if (force) {
                ngZone.run(() => appRef.tick());
                queued = false;
            }
            else {
                if (queued) {
                    return;
                }
                else {
                    queued = true;
                    $RAF(() => {
                        ngZone.run(() => appRef.tick());
                        queued = false;
                    });
                }
            }
        };
    })();
};
export const isChangeFromWatch = () => changedByWatch;
export const resetChangeFromWatch = () => changedByWatch = false;
window.watchRegistry = registry;
let skipWatchers;
const ɵ1 = () => {
    skipWatchers = true;
    ngZone.run(() => triggerWatchers());
};
const debouncedTriggerWatchers = debounce(ɵ1, 100);
export const $invokeWatchers = (force, ignoreMuted) => {
    if (force) {
        triggerWatchers(ignoreMuted);
    }
    else {
        if (skipWatchers) {
            skipWatchers = false;
            return;
        }
        debouncedTriggerWatchers();
    }
};
export let $appDigest = (force) => { };
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9jb3JlLyIsInNvdXJjZXMiOlsidXRpbHMvd2F0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSWpELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7QUFFeEMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUV0RCxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFFbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRWhDLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLGdCQUFnQixDQUFDO0FBRTdELElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQztBQUVsQixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxFQUFZLEVBQUUsT0FBZSxFQUFFLEVBQUUsRUFBRTtJQUN4RCxJQUFJLE9BQU8sQ0FBQztJQUNaLE9BQU8sQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFO1FBQ2YsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0MsT0FBTyxHQUFHLE1BQU0sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzNFLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxHQUFHLEVBQUU7SUFDN0IsS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxjQUFjLEdB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QUM7QUFFdkMsSUFBSSxZQUFZLENBQUM7V0FFeUIsR0FBRyxFQUFFO0lBQzNDLFlBQVksR0FBRyxJQUFJLENBQUM7SUFDcEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFIRCxNQUFNLHdCQUF3QixHQUFHLFFBQVEsS0FHdEMsR0FBRyxDQUFDLENBQUM7QUFFUixNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFlLEVBQUUsV0FBcUIsRUFBRSxFQUFFO0lBQ3RFLElBQUksS0FBSyxFQUFFO1FBQ1AsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ2hDO1NBQU07UUFFSCxJQUFJLFlBQVksRUFBRTtZQUNkLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDckIsT0FBTztTQUNWO1FBQ0Qsd0JBQXdCLEVBQUUsQ0FBQztLQUM5QjtBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFJLFVBQVUsR0FBRyxDQUFDLEtBQWUsRUFBRSxFQUFFLEdBQUUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSURHZW5lcmF0b3IgfSBmcm9tICcuL2lkLWdlbmVyYXRvcic7XG5cbmltcG9ydCB7ICRwYXJzZUV4cHIgfSBmcm9tICcuL2V4cHJlc3Npb24tcGFyc2VyJztcblxuZGVjbGFyZSBjb25zdCBfO1xuXG5jb25zdCByZWdpc3RyeSA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG5cbmNvbnN0IHdhdGNoSWRHZW5lcmF0b3IgPSBuZXcgSURHZW5lcmF0b3IoJ3dhdGNoLWlkLScpO1xuXG5leHBvcnQgY29uc3QgRklSU1RfVElNRV9XQVRDSCA9IHt9O1xuXG5PYmplY3QuZnJlZXplKEZJUlNUX1RJTUVfV0FUQ0gpO1xuXG5leHBvcnQgY29uc3QgaXNGaXJzdFRpbWVDaGFuZ2UgPSB2ID0+IHYgPT09IEZJUlNUX1RJTUVfV0FUQ0g7XG5cbmxldCBtdXRlZCA9IGZhbHNlO1xuXG5leHBvcnQgY29uc3QgZGVib3VuY2UgPSAoZm46IEZ1bmN0aW9uLCB3YWl0OiBudW1iZXIgPSA1MCkgPT4ge1xuICAgIGxldCB0aW1lb3V0O1xuICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICB3aW5kb3dbJ19fem9uZV9zeW1ib2xfX2NsZWFyVGltZW91dCddKHRpbWVvdXQpO1xuICAgICAgICB0aW1lb3V0ID0gd2luZG93WydfX3pvbmVfc3ltYm9sX19zZXRUaW1lb3V0J10oKCkgPT4gZm4oLi4uYXJncyksIHdhaXQpO1xuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3QgbXV0ZVdhdGNoZXJzID0gKCkgPT4ge1xuICAgIG11dGVkID0gdHJ1ZTtcbn07XG5cbmV4cG9ydCBjb25zdCB1bk11dGVXYXRjaGVycyA9ICgpID0+IHtcbiAgICBtdXRlZCA9IGZhbHNlO1xuICAgIHRyaWdnZXJXYXRjaGVycygpO1xufTtcblxuZXhwb3J0IGNvbnN0ICR3YXRjaCA9IChleHByLCAkc2NvcGUsICRsb2NhbHMsIGxpc3RlbmVyLCBpZGVudGlmaWVyID0gd2F0Y2hJZEdlbmVyYXRvci5uZXh0VWlkKCksIGRvTm90Q2xvbmUgPSBmYWxzZSkgPT4ge1xuICAgIGlmIChleHByLmluZGV4T2YoJ1skaV0nKSAhPT0gLTEpIHtcbiAgICAgICAgZXhwciA9IGV4cHIucmVwbGFjZSgvXFxbXFwkaV0vZywgJ1swXScpO1xuICAgIH1cbiAgICBjb25zdCBmbiA9ICRwYXJzZUV4cHIoZXhwcik7XG5cbiAgICByZWdpc3RyeS5zZXQoaWRlbnRpZmllciwge1xuICAgICAgICBmbjogZm4uYmluZChleHByLCAkc2NvcGUsICRsb2NhbHMpLFxuICAgICAgICBsaXN0ZW5lcixcbiAgICAgICAgZXhwcixcbiAgICAgICAgbGFzdDogRklSU1RfVElNRV9XQVRDSCxcbiAgICAgICAgZG9Ob3RDbG9uZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuICgpID0+ICR1bndhdGNoKGlkZW50aWZpZXIpO1xufTtcblxuZXhwb3J0IGNvbnN0ICR1bndhdGNoID0gaWRlbnRpZmllciA9PiByZWdpc3RyeS5kZWxldGUoaWRlbnRpZmllcik7XG5cbmxldCBjaGFuZ2VkQnlXYXRjaCA9IGZhbHNlO1xuXG5jb25zdCAkUkFGID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTtcblxubGV0IG5nWm9uZTtcblxuY29uc3QgdHJpZ2dlcldhdGNoZXJzID0gKGlnbm9yZU11dGVkPzogYm9vbGVhbikgPT4ge1xuXG4gICAgaWYgKG11dGVkICYmICFpZ25vcmVNdXRlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbGltaXQgPSA1O1xuICAgIGxldCBwYXNzID0gMTtcbiAgICBsZXQgY2hhbmdlRGV0ZWN0ZWQ7XG5cbiAgICBkbyB7XG4gICAgICAgIGNoYW5nZURldGVjdGVkID0gZmFsc2U7XG4gICAgICAgIHJlZ2lzdHJ5LmZvckVhY2god2F0Y2hJbmZvID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZuID0gd2F0Y2hJbmZvLmZuO1xuICAgICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSB3YXRjaEluZm8ubGlzdGVuZXI7XG4gICAgICAgICAgICBjb25zdCBvdiA9IHdhdGNoSW5mby5sYXN0O1xuICAgICAgICAgICAgbGV0IG52O1xuXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG52ID0gZm4oKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGVycm9yIGluIGV4ZWN1dGluZyBleHByZXNzaW9uOiAnJHt3YXRjaEluZm8uZXhwcn0nYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghXy5pc0VxdWFsKG52LCBvdikpIHtcbiAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2hhbmdlZEJ5V2F0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgIHdhdGNoSW5mby5sYXN0ID0gbnY7XG5cbiAgICAgICAgICAgICAgICBpZiAoXy5pc09iamVjdChudikgJiYgIXdhdGNoSW5mby5kb05vdENsb25lICYmIG52Ll9fY2xvbmVhYmxlX18gIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHdhdGNoSW5mby5sYXN0ID0gXy5jbG9uZShudik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxpc3RlbmVyKG52LCBvdik7XG4gICAgICAgICAgICAgICAgcmVzZXRDaGFuZ2VGcm9tV2F0Y2goKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHBhc3MrKztcblxuICAgIH0gd2hpbGUgKGNoYW5nZURldGVjdGVkICYmIHBhc3MgPCBsaW1pdCk7XG5cbiAgICBpZiAoY2hhbmdlRGV0ZWN0ZWQgJiYgcGFzcyA9PT0gbGltaXQpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBOdW1iZXIgb2Ygd2F0Y2ggY3ljbGVzIGdvbmUgYWJvdmUgc2V0IGxpbWl0IG9mOiAke2xpbWl0fSBgKTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3Qgc2V0Tmdab25lID0gem9uZSA9PiBuZ1pvbmUgPSB6b25lO1xuXG5leHBvcnQgY29uc3Qgc2V0QXBwUmVmID0gYXBwUmVmID0+IHtcbiAgICAkYXBwRGlnZXN0ID0gKCgpID0+IHtcbiAgICAgICAgbGV0IHF1ZXVlZCA9IGZhbHNlO1xuICAgICAgICByZXR1cm4gKGZvcmNlPzogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgaWYgKGZvcmNlKSB7XG4gICAgICAgICAgICAgICAgbmdab25lLnJ1bigoKSA9PiBhcHBSZWYudGljaygpKTtcbiAgICAgICAgICAgICAgICBxdWV1ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXVlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcXVldWVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgJFJBRigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZ1pvbmUucnVuKCgpID0+IGFwcFJlZi50aWNrKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcXVldWVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9KSgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGlzQ2hhbmdlRnJvbVdhdGNoID0gKCkgPT4gY2hhbmdlZEJ5V2F0Y2g7XG5leHBvcnQgY29uc3QgcmVzZXRDaGFuZ2VGcm9tV2F0Y2ggPSAoKSA9PiBjaGFuZ2VkQnlXYXRjaCA9IGZhbHNlO1xuXG4oPGFueT53aW5kb3cpLndhdGNoUmVnaXN0cnkgPSByZWdpc3RyeTtcblxubGV0IHNraXBXYXRjaGVycztcblxuY29uc3QgZGVib3VuY2VkVHJpZ2dlcldhdGNoZXJzID0gZGVib3VuY2UoKCkgPT4ge1xuICAgIHNraXBXYXRjaGVycyA9IHRydWU7XG4gICAgbmdab25lLnJ1bigoKSA9PiB0cmlnZ2VyV2F0Y2hlcnMoKSk7XG59LCAxMDApO1xuXG5leHBvcnQgY29uc3QgJGludm9rZVdhdGNoZXJzID0gKGZvcmNlPzogYm9vbGVhbiwgaWdub3JlTXV0ZWQ/OiBib29sZWFuKSA9PiB7XG4gICAgaWYgKGZvcmNlKSB7XG4gICAgICAgIHRyaWdnZXJXYXRjaGVycyhpZ25vcmVNdXRlZCk7XG4gICAgfSBlbHNlIHtcblxuICAgICAgICBpZiAoc2tpcFdhdGNoZXJzKSB7XG4gICAgICAgICAgICBza2lwV2F0Y2hlcnMgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBkZWJvdW5jZWRUcmlnZ2VyV2F0Y2hlcnMoKTtcbiAgICB9XG59O1xuXG5leHBvcnQgbGV0ICRhcHBEaWdlc3QgPSAoZm9yY2U/OiBib29sZWFuKSA9PiB7fTtcbiJdfQ==