import * as tslib_1 from "tslib";
import { IDGenerator } from './id-generator';
import { $parseExpr } from './expression-parser';
var registry = new Map();
var watchIdGenerator = new IDGenerator('watch-id-');
export var FIRST_TIME_WATCH = {};
Object.freeze(FIRST_TIME_WATCH);
export var isFirstTimeChange = function (v) { return v === FIRST_TIME_WATCH; };
var muted = false;
export var debounce = function (fn, wait) {
    if (wait === void 0) { wait = 50; }
    var timeout;
    return function () {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
        }
        window['__zone_symbol__clearTimeout'](timeout);
        timeout = window['__zone_symbol__setTimeout'](function () { return fn.apply(void 0, tslib_1.__spread(args)); }, wait);
    };
};
export var muteWatchers = function () {
    muted = true;
};
export var unMuteWatchers = function () {
    muted = false;
    triggerWatchers();
};
export var $watch = function (expr, $scope, $locals, listener, identifier, doNotClone) {
    if (identifier === void 0) { identifier = watchIdGenerator.nextUid(); }
    if (doNotClone === void 0) { doNotClone = false; }
    if (expr.indexOf('[$i]') !== -1) {
        expr = expr.replace(/\[\$i]/g, '[0]');
    }
    var fn = $parseExpr(expr);
    registry.set(identifier, {
        fn: fn.bind(expr, $scope, $locals),
        listener: listener,
        expr: expr,
        last: FIRST_TIME_WATCH,
        doNotClone: doNotClone
    });
    return function () { return $unwatch(identifier); };
};
export var $unwatch = function (identifier) { return registry.delete(identifier); };
var changedByWatch = false;
var $RAF = window.requestAnimationFrame;
var ngZone;
var triggerWatchers = function (ignoreMuted) {
    if (muted && !ignoreMuted) {
        return;
    }
    var limit = 5;
    var pass = 1;
    var changeDetected;
    do {
        changeDetected = false;
        registry.forEach(function (watchInfo) {
            var fn = watchInfo.fn;
            var listener = watchInfo.listener;
            var ov = watchInfo.last;
            var nv;
            try {
                nv = fn();
            }
            catch (e) {
                console.warn("error in executing expression: '" + watchInfo.expr + "'");
            }
            if (!_.isEqual(nv, ov)) {
                changeDetected = true;
                changedByWatch = true;
                watchInfo.last = nv;
                if (_.isObject(nv) && !watchInfo.doNotClone && nv.__cloneable__ !== false) {
                    watchInfo.last = _.clone(nv);
                }
                listener(nv, ov);
                resetChangeFromWatch();
            }
        });
        pass++;
    } while (changeDetected && pass < limit);
    if (changeDetected && pass === limit) {
        console.warn("Number of watch cycles gone above set limit of: " + limit + " ");
    }
};
var ɵ0 = triggerWatchers;
export var setNgZone = function (zone) { return ngZone = zone; };
export var setAppRef = function (appRef) {
    $appDigest = (function () {
        var queued = false;
        return function (force) {
            if (force) {
                ngZone.run(function () { return appRef.tick(); });
                queued = false;
            }
            else {
                if (queued) {
                    return;
                }
                else {
                    queued = true;
                    $RAF(function () {
                        ngZone.run(function () { return appRef.tick(); });
                        queued = false;
                    });
                }
            }
        };
    })();
};
export var isChangeFromWatch = function () { return changedByWatch; };
export var resetChangeFromWatch = function () { return changedByWatch = false; };
window.watchRegistry = registry;
var skipWatchers;
var ɵ1 = function () {
    skipWatchers = true;
    ngZone.run(function () { return triggerWatchers(); });
};
var debouncedTriggerWatchers = debounce(ɵ1, 100);
export var $invokeWatchers = function (force, ignoreMuted) {
    if (force) {
        triggerWatchers(ignoreMuted);
    }
    else {
        if (skipWatchers) {
            skipWatchers = false;
            return;
        }
        debouncedTriggerWatchers();
    }
};
export var $appDigest = function (force) { };
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9jb3JlLyIsInNvdXJjZXMiOlsidXRpbHMvd2F0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUlqRCxJQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFDO0FBRXhDLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFdEQsTUFBTSxDQUFDLElBQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0FBRW5DLE1BQU0sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUVoQyxNQUFNLENBQUMsSUFBTSxpQkFBaUIsR0FBRyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsS0FBSyxnQkFBZ0IsRUFBdEIsQ0FBc0IsQ0FBQztBQUU3RCxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUM7QUFFbEIsTUFBTSxDQUFDLElBQU0sUUFBUSxHQUFHLFVBQUMsRUFBWSxFQUFFLElBQWlCO0lBQWpCLHFCQUFBLEVBQUEsU0FBaUI7SUFDcEQsSUFBSSxPQUFPLENBQUM7SUFDWixPQUFPO1FBQUMsY0FBTzthQUFQLFVBQU8sRUFBUCxxQkFBTyxFQUFQLElBQU87WUFBUCx5QkFBTzs7UUFDWCxNQUFNLENBQUMsNkJBQTZCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQyxPQUFPLEdBQUcsTUFBTSxDQUFDLDJCQUEyQixDQUFDLENBQUMsY0FBTSxPQUFBLEVBQUUsZ0NBQUksSUFBSSxJQUFWLENBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzRSxDQUFDLENBQUM7QUFDTixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsSUFBTSxZQUFZLEdBQUc7SUFDeEIsS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsSUFBTSxjQUFjLEdBQUc7SUFDMUIsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNkLGVBQWUsRUFBRSxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFNLE1BQU0sR0FBRyxVQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUF1QyxFQUFFLFVBQWtCO0lBQTNELDJCQUFBLEVBQUEsYUFBYSxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUU7SUFBRSwyQkFBQSxFQUFBLGtCQUFrQjtJQUMvRyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDN0IsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3pDO0lBQ0QsSUFBTSxFQUFFLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTVCLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFO1FBQ3JCLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDO1FBQ2xDLFFBQVEsVUFBQTtRQUNSLElBQUksTUFBQTtRQUNKLElBQUksRUFBRSxnQkFBZ0I7UUFDdEIsVUFBVSxZQUFBO0tBQ2IsQ0FBQyxDQUFDO0lBRUgsT0FBTyxjQUFNLE9BQUEsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFwQixDQUFvQixDQUFDO0FBQ3RDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFNLFFBQVEsR0FBRyxVQUFBLFVBQVUsSUFBSSxPQUFBLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQTNCLENBQTJCLENBQUM7QUFFbEUsSUFBSSxjQUFjLEdBQUcsS0FBSyxDQUFDO0FBRTNCLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztBQUUxQyxJQUFJLE1BQU0sQ0FBQztBQUVYLElBQU0sZUFBZSxHQUFHLFVBQUMsV0FBcUI7SUFFMUMsSUFBSSxLQUFLLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDdkIsT0FBTztLQUNWO0lBRUQsSUFBTSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNiLElBQUksY0FBYyxDQUFDO0lBRW5CLEdBQUc7UUFDQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQSxTQUFTO1lBQ3RCLElBQU0sRUFBRSxHQUFHLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDeEIsSUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUNwQyxJQUFNLEVBQUUsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQzFCLElBQUksRUFBRSxDQUFDO1lBRVAsSUFBSTtnQkFDQSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUM7YUFDYjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNSLE9BQU8sQ0FBQyxJQUFJLENBQUMscUNBQW1DLFNBQVMsQ0FBQyxJQUFJLE1BQUcsQ0FBQyxDQUFDO2FBQ3RFO1lBRUQsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFO2dCQUNwQixjQUFjLEdBQUcsSUFBSSxDQUFDO2dCQUN0QixjQUFjLEdBQUcsSUFBSSxDQUFDO2dCQUN0QixTQUFTLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFFcEIsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUMsYUFBYSxLQUFLLEtBQUssRUFBRTtvQkFDdkUsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUNoQztnQkFDRCxRQUFRLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNqQixvQkFBb0IsRUFBRSxDQUFDO2FBQzFCO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLEVBQUUsQ0FBQztLQUVWLFFBQVEsY0FBYyxJQUFJLElBQUksR0FBRyxLQUFLLEVBQUU7SUFFekMsSUFBSSxjQUFjLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtRQUNsQyxPQUFPLENBQUMsSUFBSSxDQUFDLHFEQUFtRCxLQUFLLE1BQUcsQ0FBQyxDQUFDO0tBQzdFO0FBQ0wsQ0FBQyxDQUFDOztBQUVGLE1BQU0sQ0FBQyxJQUFNLFNBQVMsR0FBRyxVQUFBLElBQUksSUFBSSxPQUFBLE1BQU0sR0FBRyxJQUFJLEVBQWIsQ0FBYSxDQUFDO0FBRS9DLE1BQU0sQ0FBQyxJQUFNLFNBQVMsR0FBRyxVQUFBLE1BQU07SUFDM0IsVUFBVSxHQUFHLENBQUM7UUFDVixJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDbkIsT0FBTyxVQUFDLEtBQWU7WUFDbkIsSUFBSSxLQUFLLEVBQUU7Z0JBQ1AsTUFBTSxDQUFDLEdBQUcsQ0FBQyxjQUFNLE9BQUEsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFiLENBQWEsQ0FBQyxDQUFDO2dCQUNoQyxNQUFNLEdBQUcsS0FBSyxDQUFDO2FBQ2xCO2lCQUFNO2dCQUNILElBQUksTUFBTSxFQUFFO29CQUNSLE9BQU87aUJBQ1Y7cUJBQU07b0JBQ0gsTUFBTSxHQUFHLElBQUksQ0FBQztvQkFDZCxJQUFJLENBQUM7d0JBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxjQUFNLE9BQUEsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFiLENBQWEsQ0FBQyxDQUFDO3dCQUNoQyxNQUFNLEdBQUcsS0FBSyxDQUFDO29CQUNuQixDQUFDLENBQUMsQ0FBQztpQkFDTjthQUNKO1FBQ0wsQ0FBQyxDQUFDO0lBQ04sQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUNULENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFNLGlCQUFpQixHQUFHLGNBQU0sT0FBQSxjQUFjLEVBQWQsQ0FBYyxDQUFDO0FBQ3RELE1BQU0sQ0FBQyxJQUFNLG9CQUFvQixHQUFHLGNBQU0sT0FBQSxjQUFjLEdBQUcsS0FBSyxFQUF0QixDQUFzQixDQUFDO0FBRTNELE1BQU8sQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDO0FBRXZDLElBQUksWUFBWSxDQUFDO1NBRXlCO0lBQ3RDLFlBQVksR0FBRyxJQUFJLENBQUM7SUFDcEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxjQUFNLE9BQUEsZUFBZSxFQUFFLEVBQWpCLENBQWlCLENBQUMsQ0FBQztBQUN4QyxDQUFDO0FBSEQsSUFBTSx3QkFBd0IsR0FBRyxRQUFRLEtBR3RDLEdBQUcsQ0FBQyxDQUFDO0FBRVIsTUFBTSxDQUFDLElBQU0sZUFBZSxHQUFHLFVBQUMsS0FBZSxFQUFFLFdBQXFCO0lBQ2xFLElBQUksS0FBSyxFQUFFO1FBQ1AsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ2hDO1NBQU07UUFFSCxJQUFJLFlBQVksRUFBRTtZQUNkLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDckIsT0FBTztTQUNWO1FBQ0Qsd0JBQXdCLEVBQUUsQ0FBQztLQUM5QjtBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFJLFVBQVUsR0FBRyxVQUFDLEtBQWUsSUFBTSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJREdlbmVyYXRvciB9IGZyb20gJy4vaWQtZ2VuZXJhdG9yJztcblxuaW1wb3J0IHsgJHBhcnNlRXhwciB9IGZyb20gJy4vZXhwcmVzc2lvbi1wYXJzZXInO1xuXG5kZWNsYXJlIGNvbnN0IF87XG5cbmNvbnN0IHJlZ2lzdHJ5ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcblxuY29uc3Qgd2F0Y2hJZEdlbmVyYXRvciA9IG5ldyBJREdlbmVyYXRvcignd2F0Y2gtaWQtJyk7XG5cbmV4cG9ydCBjb25zdCBGSVJTVF9USU1FX1dBVENIID0ge307XG5cbk9iamVjdC5mcmVlemUoRklSU1RfVElNRV9XQVRDSCk7XG5cbmV4cG9ydCBjb25zdCBpc0ZpcnN0VGltZUNoYW5nZSA9IHYgPT4gdiA9PT0gRklSU1RfVElNRV9XQVRDSDtcblxubGV0IG11dGVkID0gZmFsc2U7XG5cbmV4cG9ydCBjb25zdCBkZWJvdW5jZSA9IChmbjogRnVuY3Rpb24sIHdhaXQ6IG51bWJlciA9IDUwKSA9PiB7XG4gICAgbGV0IHRpbWVvdXQ7XG4gICAgcmV0dXJuICguLi5hcmdzKSA9PiB7XG4gICAgICAgIHdpbmRvd1snX196b25lX3N5bWJvbF9fY2xlYXJUaW1lb3V0J10odGltZW91dCk7XG4gICAgICAgIHRpbWVvdXQgPSB3aW5kb3dbJ19fem9uZV9zeW1ib2xfX3NldFRpbWVvdXQnXSgoKSA9PiBmbiguLi5hcmdzKSwgd2FpdCk7XG4gICAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBtdXRlV2F0Y2hlcnMgPSAoKSA9PiB7XG4gICAgbXV0ZWQgPSB0cnVlO1xufTtcblxuZXhwb3J0IGNvbnN0IHVuTXV0ZVdhdGNoZXJzID0gKCkgPT4ge1xuICAgIG11dGVkID0gZmFsc2U7XG4gICAgdHJpZ2dlcldhdGNoZXJzKCk7XG59O1xuXG5leHBvcnQgY29uc3QgJHdhdGNoID0gKGV4cHIsICRzY29wZSwgJGxvY2FscywgbGlzdGVuZXIsIGlkZW50aWZpZXIgPSB3YXRjaElkR2VuZXJhdG9yLm5leHRVaWQoKSwgZG9Ob3RDbG9uZSA9IGZhbHNlKSA9PiB7XG4gICAgaWYgKGV4cHIuaW5kZXhPZignWyRpXScpICE9PSAtMSkge1xuICAgICAgICBleHByID0gZXhwci5yZXBsYWNlKC9cXFtcXCRpXS9nLCAnWzBdJyk7XG4gICAgfVxuICAgIGNvbnN0IGZuID0gJHBhcnNlRXhwcihleHByKTtcblxuICAgIHJlZ2lzdHJ5LnNldChpZGVudGlmaWVyLCB7XG4gICAgICAgIGZuOiBmbi5iaW5kKGV4cHIsICRzY29wZSwgJGxvY2FscyksXG4gICAgICAgIGxpc3RlbmVyLFxuICAgICAgICBleHByLFxuICAgICAgICBsYXN0OiBGSVJTVF9USU1FX1dBVENILFxuICAgICAgICBkb05vdENsb25lXG4gICAgfSk7XG5cbiAgICByZXR1cm4gKCkgPT4gJHVud2F0Y2goaWRlbnRpZmllcik7XG59O1xuXG5leHBvcnQgY29uc3QgJHVud2F0Y2ggPSBpZGVudGlmaWVyID0+IHJlZ2lzdHJ5LmRlbGV0ZShpZGVudGlmaWVyKTtcblxubGV0IGNoYW5nZWRCeVdhdGNoID0gZmFsc2U7XG5cbmNvbnN0ICRSQUYgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lO1xuXG5sZXQgbmdab25lO1xuXG5jb25zdCB0cmlnZ2VyV2F0Y2hlcnMgPSAoaWdub3JlTXV0ZWQ/OiBib29sZWFuKSA9PiB7XG5cbiAgICBpZiAobXV0ZWQgJiYgIWlnbm9yZU11dGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBsaW1pdCA9IDU7XG4gICAgbGV0IHBhc3MgPSAxO1xuICAgIGxldCBjaGFuZ2VEZXRlY3RlZDtcblxuICAgIGRvIHtcbiAgICAgICAgY2hhbmdlRGV0ZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgcmVnaXN0cnkuZm9yRWFjaCh3YXRjaEluZm8gPT4ge1xuICAgICAgICAgICAgY29uc3QgZm4gPSB3YXRjaEluZm8uZm47XG4gICAgICAgICAgICBjb25zdCBsaXN0ZW5lciA9IHdhdGNoSW5mby5saXN0ZW5lcjtcbiAgICAgICAgICAgIGNvbnN0IG92ID0gd2F0Y2hJbmZvLmxhc3Q7XG4gICAgICAgICAgICBsZXQgbnY7XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbnYgPSBmbigpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgZXJyb3IgaW4gZXhlY3V0aW5nIGV4cHJlc3Npb246ICcke3dhdGNoSW5mby5leHByfSdgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFfLmlzRXF1YWwobnYsIG92KSkge1xuICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjaGFuZ2VkQnlXYXRjaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgd2F0Y2hJbmZvLmxhc3QgPSBudjtcblxuICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KG52KSAmJiAhd2F0Y2hJbmZvLmRvTm90Q2xvbmUgJiYgbnYuX19jbG9uZWFibGVfXyAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgd2F0Y2hJbmZvLmxhc3QgPSBfLmNsb25lKG52KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGlzdGVuZXIobnYsIG92KTtcbiAgICAgICAgICAgICAgICByZXNldENoYW5nZUZyb21XYXRjaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcGFzcysrO1xuXG4gICAgfSB3aGlsZSAoY2hhbmdlRGV0ZWN0ZWQgJiYgcGFzcyA8IGxpbWl0KTtcblxuICAgIGlmIChjaGFuZ2VEZXRlY3RlZCAmJiBwYXNzID09PSBsaW1pdCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYE51bWJlciBvZiB3YXRjaCBjeWNsZXMgZ29uZSBhYm92ZSBzZXQgbGltaXQgb2Y6ICR7bGltaXR9IGApO1xuICAgIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzZXROZ1pvbmUgPSB6b25lID0+IG5nWm9uZSA9IHpvbmU7XG5cbmV4cG9ydCBjb25zdCBzZXRBcHBSZWYgPSBhcHBSZWYgPT4ge1xuICAgICRhcHBEaWdlc3QgPSAoKCkgPT4ge1xuICAgICAgICBsZXQgcXVldWVkID0gZmFsc2U7XG4gICAgICAgIHJldHVybiAoZm9yY2U/OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICBpZiAoZm9yY2UpIHtcbiAgICAgICAgICAgICAgICBuZ1pvbmUucnVuKCgpID0+IGFwcFJlZi50aWNrKCkpO1xuICAgICAgICAgICAgICAgIHF1ZXVlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocXVldWVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBxdWV1ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAkUkFGKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5nWm9uZS5ydW4oKCkgPT4gYXBwUmVmLnRpY2soKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBxdWV1ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH0pKCk7XG59O1xuXG5leHBvcnQgY29uc3QgaXNDaGFuZ2VGcm9tV2F0Y2ggPSAoKSA9PiBjaGFuZ2VkQnlXYXRjaDtcbmV4cG9ydCBjb25zdCByZXNldENoYW5nZUZyb21XYXRjaCA9ICgpID0+IGNoYW5nZWRCeVdhdGNoID0gZmFsc2U7XG5cbig8YW55PndpbmRvdykud2F0Y2hSZWdpc3RyeSA9IHJlZ2lzdHJ5O1xuXG5sZXQgc2tpcFdhdGNoZXJzO1xuXG5jb25zdCBkZWJvdW5jZWRUcmlnZ2VyV2F0Y2hlcnMgPSBkZWJvdW5jZSgoKSA9PiB7XG4gICAgc2tpcFdhdGNoZXJzID0gdHJ1ZTtcbiAgICBuZ1pvbmUucnVuKCgpID0+IHRyaWdnZXJXYXRjaGVycygpKTtcbn0sIDEwMCk7XG5cbmV4cG9ydCBjb25zdCAkaW52b2tlV2F0Y2hlcnMgPSAoZm9yY2U/OiBib29sZWFuLCBpZ25vcmVNdXRlZD86IGJvb2xlYW4pID0+IHtcbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgICAgdHJpZ2dlcldhdGNoZXJzKGlnbm9yZU11dGVkKTtcbiAgICB9IGVsc2Uge1xuXG4gICAgICAgIGlmIChza2lwV2F0Y2hlcnMpIHtcbiAgICAgICAgICAgIHNraXBXYXRjaGVycyA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGRlYm91bmNlZFRyaWdnZXJXYXRjaGVycygpO1xuICAgIH1cbn07XG5cbmV4cG9ydCBsZXQgJGFwcERpZ2VzdCA9IChmb3JjZT86IGJvb2xlYW4pID0+IHt9O1xuIl19