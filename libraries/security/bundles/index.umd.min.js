!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/router"),require("@wm/core")):"function"==typeof define&&define.amd?define("@wm/security",["exports","@angular/core","@angular/common","@angular/router","@wm/core"],t):t((e.wm=e.wm||{},e.wm.security={}),e.ng.core,e.ng.common,e.ng.router,e.wm.core)}(this,function(e,t,o,r,u){"use strict";var i="wm_xsrf_token",n=function(){function e(e,t,o,r,n){this.injector=e,this.$http=t,this.routerService=o,this.activatedRoute=r,this._location=n,this.requestQueue={}}return e.prototype.isLoaded=function(){return this.config},e.prototype.get=function(){return this.config},e.prototype.load=function(){var r=this;return this.loadPromise||(this.loadPromise=new Promise(function(t,o){r.$http.send({url:"./services/security/info",method:"GET"}).then(function(e){r.config=e.body,r.lastLoggedInUser=u.getClonedObject(r.loggedInUser),r.loggedInUser=r.config.userInfo,t(e.body)})["catch"](function(e){o(e)})["finally"](function(){r.loadPromise=null})})),this.loadPromise},e.prototype.getWebConfig=function(t,e){this.get()?u.triggerFn(t,this.get()):this.load().then(function(e){u.triggerFn(t,e)},e)},e.prototype.getConfig=function(e,t){function o(e,t,o){_.forEach(this.requestQueue[e],function(e){return u.triggerFn(e[t],o)}),this.requestQueue[e]=null}this.get()?u.triggerFn(e,this.get()):(this.requestQueue.config=this.requestQueue.config||[],this.requestQueue.config.push({success:e,error:t}),1<this.requestQueue.config.length||u.hasCordova()||this.getWebConfig(function r(e){e.homePage=u.getWmProjectProperties().homePage,e.userInfo,this.config=e,this.lastLoggedInUser=u.getClonedObject(this.loggedInUser),this.loggedInUser=e.userInfo,o.call(this,"config","success",this.get())}.bind(this),function n(e){o.call(this,"config","error",e)}.bind(this)))},e.prototype.getLastLoggedInUsername=function(){return this.lastLoggedInUser&&this.lastLoggedInUser.userName},e.prototype.getCurrentRoutePage=function(){var e=this._location.path(),t=e.indexOf("?");return t=-1===t?e.length:t-1,e.substr(1,t)},e.prototype.getCurrentRouteQueryParam=function(t){var o;return this.activatedRoute.queryParams.subscribe(function(e){o=e[t]}),o},e.prototype.isNoPageLoaded=function(){return!_.isEmpty(this.getCurrentRoutePage())},e.prototype.getPageByLoggedInUser=function(){var r=this;return new Promise(function(t){var o;r.getConfig(function(e){e.securityEnabled&&e.authenticated?(o=e.userInfo.landingPage||u.getWmProjectProperties().homePage,r.isXsrfEnabled()):o=u.getWmProjectProperties().homePage,t(o)},function(){t(u.getWmProjectProperties().homePage)})})},e.prototype.loadPageByUserRole=function(t){var o=this;return this.getPageByLoggedInUser().then(function(e){(o.isNoPageLoaded()||t)&&(o.getCurrentRoutePage()===e?window.location.reload():o.routerService.navigate(["/"+e]))})},e.prototype.navigateOnLogin=function(){this.loadPageByUserRole(!0)},e.prototype.getRedirectPage=function(e,t){var o,r=u.getWmProjectProperties().homePage,n=_.get(e,"loginConfig.pageName"),i=t||this.getCurrentRoutePage();return i!==r&&i!==n||(o=this.getCurrentRouteQueryParam("redirectTo"),i=_.isEmpty(o)?undefined:o),i},e.prototype.getRedirectedRouteQueryParams=function(){var o={};return this.activatedRoute.queryParams.subscribe(function(e){_.forEach(e,function(e,t){o[t]=e})}),o},e.prototype.getQueryString=function(e){var o=[];return _.forEach(e,function(e,t){o.push(t+"="+e)}),_.join(o,"&")},e.prototype.appLogin=function(e,o,t){var r=this,n="";return _.each(e,function(e,t){n+=(n?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),this.$http.send({method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"j_spring_security_check",data:n}).then(function(e){var t=e.body?e.body[i]:"";t&&u.hasCordova()&&localStorage.setItem(i,t||""),r.injector.get(u.App).notify("userLoggedIn",{}),u.triggerFn(o,e)},t)},e.prototype.isAuthenticated=function(t,e){this.getConfig(function(e){u.triggerFn(t,e.authenticated)},e)},e.prototype.appLogout=function(t,e){var o=this;return this.$http.send({target:"Security",url:"j_spring_security_logout",method:"POST",responseType:"text",byPassResult:!0}).then(function(e){_.set(o.get(),"authenticated",!1),_.set(o.get(),"userInfo",null),o.injector.get(u.App).notify("userLoggedOut",{}),u.triggerFn(t,e)},e)},e.prototype.getCookieByName=function(e){return"cookie"},e.prototype.isXsrfEnabled=function(){return u.hasCordova()?localStorage.getItem(i):this.getCookieByName(i)},e.prototype.onUserLogin=function(){var r=this;return new Promise(function(o,e){r.getConfig(function(e){if(e.securityEnabled)if(e.authenticated)o();else var t=r.injector.get(u.App).subscribe("userLoggedIn",function(){o(),t()});else o()},e)})},e.prototype.getLoggedInUser=function(){var e=this;return new Promise(function(t,o){e.getConfig(function(e){e&&e.userInfo?t(e.userInfo):o()},o)})},e.prototype.authInBrowser=function(){return Promise.reject("This authInBrowser should not be called")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:t.Injector},{type:u.AbstractHttpService},{type:r.Router},{type:r.ActivatedRoute},{type:o.Location}]},e}(),s=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:[n]}},e.decorators=[{type:t.NgModule,args:[{}]}],e}();e.SecurityModule=s,e.SecurityService=n,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map