import { $appDigest } from '@wm/core';
import { DeviceVariableService, initiateCallback } from '@wm/variables';
/**
 * this file contains all device operations under 'device' service.
 */
export class DeviceService extends DeviceVariableService {
    constructor(app, appVersion, device, geoLocation, networkService, vibrateService) {
        super();
        this.name = 'device';
        this.operations = [];
        this.operations.push(new AppInfoOperation(device, appVersion), new CurrentGeoPositionOperation(geoLocation), new DeviceInfoOperation(device), new GetNetworkInfoOperation(app, networkService), new GoOfflineOperation(networkService), new GoOnlineOperation(networkService), new VibrateOperation(vibrateService));
        app.subscribe('onNetworkStateChange', data => {
            app.networkStatus = data;
            $appDigest();
        });
        app.networkStatus = {
            isConnecting: false,
            isConnected: true,
            isNetworkAvailable: true,
            isServiceAvailable: true
        };
    }
}
/**
 * This class handles 'getAppInfo' device operation.
 */
class AppInfoOperation {
    constructor(device, appVersion) {
        this.device = device;
        this.appVersion = appVersion;
        this.name = 'getAppInfo';
        this.model = {
            appversion: 'X.X.X',
            cordovaversion: 'X.X.X'
        };
        this.properties = [
            { target: 'startUpdate', type: 'boolean', value: true, hide: true }
        ];
    }
    invoke(variable, options) {
        const cordovaVersion = this.device.cordova;
        return this.appVersion.getVersionNumber().then(appVersion => {
            return {
                appversion: appVersion,
                cordovaversion: cordovaVersion
            };
        });
    }
}
/**
 * This class handles 'getCurrentGeoPosition' device operation.
 */
class CurrentGeoPositionOperation {
    constructor(geoLocation) {
        this.geoLocation = geoLocation;
        this.name = 'getCurrentGeoPosition';
        this.model = {
            coords: {
                latitude: 0,
                longitude: 0,
                altitude: 0,
                accuracy: 0,
                altitudeAccuracy: 0,
                heading: 0,
                speed: 0
            },
            timestamp: 0
        };
        this.properties = [
            { target: 'startUpdate', type: 'boolean', value: true, hide: true },
            { target: 'autoUpdate', type: 'boolean', value: true, hide: true },
            { target: 'geolocationHighAccuracy', type: 'boolean', value: true, dataBinding: true },
            { target: 'geolocationMaximumAge', type: 'number', value: 3, dataBinding: true },
            { target: 'geolocationTimeout', type: 'number', value: 5, dataBinding: true }
        ];
        this.requiredCordovaPlugins = ['GEOLOCATION'];
        this.waitingQueue = [];
        this.options = {
            maximumAge: 3000,
            timeout: (2 * 60) * 1000,
            enableHighAccuracy: true
        };
    }
    watchPosition() {
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
            this.watchId = null;
        }
        const options = window['WM_GEO_LOCATION_OPTIONS'] || this.options;
        this.watchId = navigator.geolocation.watchPosition(position => {
            this.lastKnownPosition = {
                coords: {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    altitude: position.coords.altitude,
                    accuracy: position.coords.accuracy,
                    altitudeAccuracy: position.coords.altitudeAccuracy,
                    heading: position.coords.heading,
                    speed: position.coords.speed
                },
                timestamp: position.timestamp
            };
            if (this.waitingQueue.length > 0) {
                this.waitingQueue.forEach(fn => fn(this.lastKnownPosition));
                this.waitingQueue.length = 0;
            }
            $(document).off('touchend.usergesture');
        }, () => {
            this.watchId = null;
        }, options);
    }
    invoke(variable, options, dataBindings) {
        if (!this.watchId || !this.lastKnownPosition) {
            this.watchPosition();
            $(document).on('touchend.usergesture', () => this.watchPosition());
        }
        const geoLocationOptions = {
            maximumAge: dataBindings.get('geolocationMaximumAge') * 1000,
            timeout: dataBindings.get('geolocationTimeout') * 1000,
            enableHighAccuracy: dataBindings.get('geolocationHighAccuracy')
        };
        if (this.lastKnownPosition) {
            return Promise.resolve(this.lastKnownPosition);
        }
        return new Promise(resolve => {
            const c = position => {
                resolve(position);
            };
            setTimeout(() => {
                const index = this.waitingQueue.indexOf(c);
                if (index > -1) {
                    this.waitingQueue.splice(index, 1);
                    resolve(this.model);
                }
            }, this.options.timeout);
            this.waitingQueue.push(c);
        });
    }
}
/**
 * This class handles 'getDeviceInfo' device operation.
 */
class DeviceInfoOperation {
    constructor(device) {
        this.device = device;
        this.name = 'getDeviceInfo';
        this.model = {
            deviceModel: 'DEVICEMODEL',
            os: 'DEVICEOS',
            osVersion: 'X.X.X',
            deviceUUID: 'DEVICEUUID'
        };
        this.properties = [
            { target: 'startUpdate', type: 'boolean', value: true, hide: true }
        ];
    }
    invoke(variable, options) {
        const response = {
            'deviceModel': this.device.model,
            'os': this.device.platform,
            'osVersion': this.device.version,
            'deviceUUID': this.device.uuid
        };
        return Promise.resolve(response);
    }
}
class GetNetworkInfoOperation {
    constructor(app, networkService) {
        this.app = app;
        this.networkService = networkService;
        this.name = 'getNetworkInfo';
        this.model = {
            connectionType: 'NONE',
            isConnecting: false,
            isNetworkAvailable: true,
            isOnline: true,
            isOffline: false
        };
        this.properties = [
            { target: 'autoUpdate', type: 'boolean', value: true, hide: true },
            { target: 'startUpdate', type: 'boolean', value: true, hide: true },
            { target: 'networkStatus', type: 'object', value: 'bind:App.networkStatus', dataBinding: true, hide: true },
            { target: 'onOnline', hide: false },
            { target: 'onOffline', hide: false }
        ];
        this.requiredCordovaPlugins = ['NETWORK'];
    }
    invoke(variable, options, dataBindings) {
        const data = {
            connectionType: navigator.connection.type,
            isConnecting: this.app.networkStatus.isConnecting,
            isNetworkAvailable: this.app.networkStatus.isNetworkAvailable,
            isOnline: this.app.networkStatus.isConnected,
            isOffline: !this.app.networkStatus.isConnected
        };
        if (this.networkService.isConnected()) {
            initiateCallback('onOnline', variable, data);
        }
        else {
            initiateCallback('onOffline', variable, data);
        }
        return Promise.resolve(data);
    }
}
class GoOfflineOperation {
    constructor(networkService) {
        this.networkService = networkService;
        this.name = 'goOffline';
        this.model = {};
        this.properties = [];
        this.requiredCordovaPlugins = ['NETWORK'];
    }
    invoke(variable, options, dataBindings) {
        return this.networkService.disconnect();
    }
}
class GoOnlineOperation {
    constructor(networkService) {
        this.networkService = networkService;
        this.name = 'goOnline';
        this.model = {};
        this.properties = [];
        this.requiredCordovaPlugins = ['NETWORK'];
    }
    invoke(variable, options, dataBindings) {
        return this.networkService.connect();
    }
}
/**
 * This class handles 'vibrate' device operation.
 */
class VibrateOperation {
    constructor(vibrationService) {
        this.vibrationService = vibrationService;
        this.name = 'vibrate';
        this.model = {
            appversion: 'X.X.X',
            cordovaversion: 'X.X.X'
        };
        this.properties = [
            { target: 'vibrationtime', type: 'number', value: 2, dataBinding: true }
        ];
        this.requiredCordovaPlugins = ['VIBRATE'];
    }
    invoke(variable, options, dataBindings) {
        this.vibrationService.vibrate(dataBindings.get('vibrationtime') * 1000);
        return Promise.resolve();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vbW9iaWxlL3ZhcmlhYmxlcy8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL2RldmljZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUtBLE9BQU8sRUFBRSxVQUFVLEVBQU8sTUFBTSxVQUFVLENBQUM7QUFFM0MsT0FBTyxFQUFFLHFCQUFxQixFQUE0QixnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUdsRzs7R0FFRztBQUNILE1BQU0sT0FBTyxhQUFjLFNBQVEscUJBQXFCO0lBSXBELFlBQVksR0FBUSxFQUNoQixVQUFzQixFQUN0QixNQUFjLEVBQ2QsV0FBd0IsRUFDeEIsY0FBOEIsRUFDOUIsY0FBeUI7UUFDekIsS0FBSyxFQUFFLENBQUM7UUFUSSxTQUFJLEdBQUcsUUFBUSxDQUFDO1FBQ2hCLGVBQVUsR0FBK0IsRUFBRSxDQUFDO1FBU3hELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksZ0JBQWdCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxFQUN6RCxJQUFJLDJCQUEyQixDQUFDLFdBQVcsQ0FBQyxFQUM1QyxJQUFJLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxFQUMvQixJQUFJLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxjQUFjLENBQUMsRUFDaEQsSUFBSSxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsRUFDdEMsSUFBSSxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsRUFDckMsSUFBSSxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQzFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDekMsR0FBRyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFDekIsVUFBVSxFQUFFLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7UUFDSCxHQUFHLENBQUMsYUFBYSxHQUFHO1lBQ2hCLFlBQVksRUFBRyxLQUFL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QWhCLGdCQUFnQixDQUFXO1FBVmhDLFNBQUksR0FBRyxTQUFTLENBQUM7UUFDakIsVUFBSyxHQUFHO1lBQ3BCLFVBQVUsRUFBRSxPQUFPO1lBQ25CLGNBQWMsRUFBRSxPQUFPO1NBQzFCLENBQUM7UUFDYyxlQUFVLEdBQUc7WUFDekIsRUFBQyxNQUFNLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFDO1NBQ3pFLENBQUM7UUFDYywyQkFBc0IsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBSXJELENBQUM7SUFFTSxNQUFNLENBQUMsUUFBYSxFQUFFLE9BQVksRUFBRSxZQUE4QjtRQUNyRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEUsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDN0IsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwVmVyc2lvbiB9IGZyb20gJ0Bpb25pYy1uYXRpdmUvYXBwLXZlcnNpb24nO1xuaW1wb3J0IHsgRGV2aWNlIH0gZnJvbSAnQGlvbmljLW5hdGl2ZS9kZXZpY2UnO1xuaW1wb3J0IHsgR2VvbG9jYXRpb24sIEdlb2xvY2F0aW9uT3B0aW9ucyB9IGZyb20gJ0Bpb25pYy1uYXRpdmUvZ2VvbG9jYXRpb24nO1xuaW1wb3J0IHsgVmlicmF0aW9uIH0gZnJvbSAnQGlvbmljLW5hdGl2ZS92aWJyYXRpb24nO1xuXG5pbXBvcnQgeyAkYXBwRGlnZXN0LCBBcHAgfSBmcm9tICdAd20vY29yZSc7XG5pbXBvcnQgeyBOZXR3b3JrU2VydmljZSB9IGZyb20gJ0B3bS9tb2JpbGUvY29yZSc7XG5pbXBvcnQgeyBEZXZpY2VWYXJpYWJsZVNlcnZpY2UsIElEZXZpY2VWYXJpYWJsZU9wZXJhdGlvbiwgaW5pdGlhdGVDYWxsYmFjayB9IGZyb20gJ0B3bS92YXJpYWJsZXMnO1xuXG5kZWNsYXJlIGNvbnN0IG5hdmlnYXRvciwgJDtcbi8qKlxuICogdGhpcyBmaWxlIGNvbnRhaW5zIGFsbCBkZXZpY2Ugb3BlcmF0aW9ucyB1bmRlciAnZGV2aWNlJyBzZXJ2aWNlLlxuICovXG5leHBvcnQgY2xhc3MgRGV2aWNlU2VydmljZSBleHRlbmRzIERldmljZVZhcmlhYmxlU2VydmljZSB7XG4gICAgcHVibGljIHJlYWRvbmx5IG5hbWUgPSAnZGV2aWNlJztcbiAgICBwdWJsaWMgcmVhZG9ubHkgb3BlcmF0aW9uczogSURldmljZVZhcmlhYmxlT3BlcmF0aW9uW10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKGFwcDogQXBwLFxuICAgICAgICBhcHBWZXJzaW9uOiBBcHBWZXJzaW9uLFxuICAgICAgICBkZXZpY2U6IERldmljZSxcbiAgICAgICAgZ2VvTG9jYXRpb246IEdlb2xvY2F0aW9uLFxuICAgICAgICBuZXR3b3JrU2VydmljZTogTmV0d29ya1NlcnZpY2UsXG4gICAgICAgIHZpYnJhdGVTZXJ2aWNlOiBWaWJyYXRpb24pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5vcGVyYXRpb25zLnB1c2gobmV3IEFwcEluZm9PcGVyYXRpb24oZGV2aWNlLCBhcHBWZXJzaW9uKSxcbiAgICAgICAgICAgIG5ldyBDdXJyZW50R2VvUG9zaXRpb25PcGVyYXRpb24oZ2VvTG9jYXRpb24pLFxuICAgICAgICAgICAgbmV3IERldmljZUluZm9PcGVyYXRpb24oZGV2aWNlKSxcbiAgICAgICAgICAgIG5ldyBHZXROZXR3b3JrSW5mb09wZXJhdGlvbihhcHAsIG5ldHdvcmtTZXJ2aWNlKSxcbiAgICAgICAgICAgIG5ldyBHb09mZmxpbmVPcGVyYXRpb24obmV0d29ya1NlcnZpY2UpLFxuICAgICAgICAgICAgbmV3IEdvT25saW5lT3BlcmF0aW9uKG5ldHdvcmtTZXJ2aWNlKSxcbiAgICAgICAgICAgIG5ldyBWaWJyYXRlT3BlcmF0aW9uKHZpYnJhdGVTZXJ2aWNlKSk7XG4gICAgICAgIGFwcC5zdWJzY3JpYmUoJ29uTmV0d29ya1N0YXRlQ2hhbmdlJywgZGF0YSA9PiB7XG4gICAgICAgICAgICBhcHAubmV0d29ya1N0YXR1cyA9IGRhdGE7XG4gICAgICAgICAgICAkYXBwRGlnZXN0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICBhcHAubmV0d29ya1N0YXR1cyA9IHtcbiAgICAgICAgICAgIGlzQ29ubmVjdGluZyA6IGZhbHNlLFxuICAgICAgICAgICAgaXNDb25uZWN0ZWQgOiB0cnVlLFxuICAgICAgICAgICAgaXNOZXR3b3JrQXZhaWxhYmxlIDogdHJ1ZSxcbiAgICAgICAgICAgIGlzU2VydmljZUF2YWlsYWJsZSA6IHRydWVcbiAgICAgICAgfTtcbiAgICB9XG59XG5cblxuLyoqXG4gKiBUaGlzIGNsYXNzIGhhbmRsZXMgJ2dldEFwcEluZm8nIGRldmljZSBvcGVyYXRpb24uXG4gKi9cbmNsYXNzIEFwcEluZm9PcGVyYXRpb24gaW1wbGVtZW50cyBJRGV2aWNlVmFyaWFibGVPcGVyYXRpb24ge1xuICAgIHB1YmxpYyByZWFkb25seSBuYW1lID0gJ2dldEFwcEluZm8nO1xuICAgIHB1YmxpYyByZWFkb25seSBtb2RlbCA9IHtcbiAgICAgICAgYXBwdmVyc2lvbjogJ1guWC5YJyxcbiAgICAgICAgY29yZG92YXZlcnNpb246ICdYLlguWCdcbiAgICB9O1xuICAgIHB1YmxpYyByZWFkb25seSBwcm9wZXJ0aWVzID0gW1xuICAgICAgICB7dGFyZ2V0OiAnc3RhcnRVcGRhdGUnLCB0eXBlOiAnYm9vbGVhbicsIHZhbHVlOiB0cnVlLCBoaWRlOiB0cnVlfVxuICAgIF07XG5cbiAgICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBkZXZpY2U6IERldmljZSwgcHJpdmF0ZSBhcHBWZXJzaW9uOiBBcHBWZXJzaW9uKSB7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgaW52b2tlKHZhcmlhYmxlOiBhbnksIG9wdGlvbnM6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGNvcmRvdmFWZXJzaW9uID0gdGhpcy5kZXZpY2UuY29yZG92YTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwVmVyc2lvbi5nZXRWZXJzaW9uTnVtYmVyKCkudGhlbihhcHBWZXJzaW9uID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgYXBwdmVyc2lvbjogYXBwVmVyc2lvbixcbiAgICAgICAgICAgICAgICBjb3Jkb3ZhdmVyc2lvbjogY29yZG92YVZlcnNpb25cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUaGlzIGNsYXNzIGhhbmRsZXMgJ2dldEN1cnJlbnRHZW9Qb3NpdGlvbicgZGV2aWNlIG9wZXJhdGlvbi5cbiAqL1xuY2xhc3MgQ3VycmVudEdlb1Bvc2l0aW9uT3BlcmF0aW9uIGltcGxlbWVudHMgSURldmljZVZhcmlhYmxlT3BlcmF0aW9uIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbmFtZSA9ICdnZXRDdXJyZW50R2VvUG9zaXRpb24nO1xuICAgIHB1YmxpYyByZWFkb25seSBtb2RlbCA9IHtcbiAgICAgICAgY29vcmRzOiB7XG4gICAgICAgICAgICBsYXRpdHVkZTogMCxcbiAgICAgICAgICAgIGxvbmdpdHVkZTogMCxcbiAgICAgICAgICAgIGFsdGl0dWRlOiAwLFxuICAgICAgICAgICAgYWNjdXJhY3k6IDAsXG4gICAgICAgICAgICBhbHRpdHVkZUFjY3VyYWN5OiAwLFxuICAgICAgICAgICAgaGVhZGluZzogMCxcbiAgICAgICAgICAgIHNwZWVkOiAwXG4gICAgICAgIH0sXG4gICAgICAgIHRpbWVzdGFtcDogMFxuICAgIH07XG4gICAgcHVibGljIHJlYWRvbmx5IHByb3BlcnRpZXMgPSBbXG4gICAgICAgIHt0YXJnZXQ6ICdzdGFydFVwZGF0ZScsIHR5cGU6ICdib29sZWFuJywgdmFsdWU6IHRydWUsIGhpZGUgOiB0cnVlfSxcbiAgICAgICAge3RhcmdldDogJ2F1dG9VcGRhdGUnLCB0eXBlOiAnYm9vbGVhbicsIHZhbHVlOiB0cnVlLCBoaWRlIDogdHJ1ZX0sXG4gICAgICAgIHt0YXJnZXQ6ICdnZW9sb2NhdGlvbkhpZ2hBY2N1cmFjeScsIHR5cGU6ICdib29sZWFuJywgdmFsdWU6IHRydWUsIGRhdGFCaW5kaW5nOiB0cnVlfSxcbiAgICAgICAge3RhcmdldDogJ2dlb2xvY2F0aW9uTWF4aW11bUFnZScsIHR5cGU6ICdudW1iZXInLCB2YWx1ZTogMywgZGF0YUJpbmRpbmc6IHRydWV9LFxuICAgICAgICB7dGFyZ2V0OiAnZ2VvbG9jYXRpb25UaW1lb3V0JywgdHlwZTogJ251bWJlcicsIHZhbHVlOiA1LCBkYXRhQmluZGluZzogdHJ1ZX1cbiAgICBdO1xuICAgIHB1YmxpYyByZWFkb25seSByZXF1aXJlZENvcmRvdmFQbHVnaW5zID0gWydHRU9MT0NBVElPTiddO1xuXG4gICAgcHJpdmF0ZSBsYXN0S25vd25Qb3NpdGlvbjtcbiAgICBwcml2YXRlIHdhaXRpbmdRdWV1ZSA9IFtdO1xuICAgIHByaXZhdGUgd2F0Y2hJZDtcbiAgICBwcml2YXRlIG9wdGlvbnMgPSB7XG4gICAgICAgIG1heGltdW1BZ2U6IDMwMDAsXG4gICAgICAgIHRpbWVvdXQ6ICgyICogNjApICogMTAwMCxcbiAgICAgICAgZW5hYmxlSGlnaEFjY3VyYWN5OiB0cnVlXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yIChwcml2YXRlIGdlb0xvY2F0aW9uOiBHZW9sb2NhdGlvbikge31cblxuICAgIHByaXZhdGUgd2F0Y2hQb3NpdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMud2F0Y2hJZCkge1xuICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmNsZWFyV2F0Y2godGhpcy53YXRjaElkKTtcbiAgICAgICAgICAgIHRoaXMud2F0Y2hJZCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHdpbmRvd1snV01fR0VPX0xPQ0FUSU9OX09QVElPTlMnXSB8fCB0aGlzLm9wdGlvbnM7XG4gICAgICAgIHRoaXMud2F0Y2hJZCA9IG5hdmlnYXRvci5nZW9sb2NhdGlvbi53YXRjaFBvc2l0aW9uKHBvc2l0aW9uID0+IHtcbiAgICAgICAgICAgIHRoaXMubGFzdEtub3duUG9zaXRpb24gPSB7XG4gICAgICAgICAgICAgICAgY29vcmRzOiB7XG4gICAgICAgICAgICAgICAgICAgIGxhdGl0dWRlOiBwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsXG4gICAgICAgICAgICAgICAgICAgIGxvbmdpdHVkZTogcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZSxcbiAgICAgICAgICAgICAgICAgICAgYWx0aXR1ZGU6IHBvc2l0aW9uLmNvb3Jkcy5hbHRpdHVkZSxcbiAgICAgICAgICAgICAgICAgICAgYWNjdXJhY3k6IHBvc2l0aW9uLmNvb3Jkcy5hY2N1cmFjeSxcbiAgICAgICAgICAgICAgICAgICAgYWx0aXR1ZGVBY2N1cmFjeTogcG9zaXRpb24uY29vcmRzLmFsdGl0dWRlQWNjdXJhY3ksXG4gICAgICAgICAgICAgICAgICAgIGhlYWRpbmc6IHBvc2l0aW9uLmNvb3Jkcy5oZWFkaW5nLFxuICAgICAgICAgICAgICAgICAgICBzcGVlZDogcG9zaXRpb24uY29vcmRzLnNwZWVkXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IHBvc2l0aW9uLnRpbWVzdGFtcFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmICh0aGlzLndhaXRpbmdRdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53YWl0aW5nUXVldWUuZm9yRWFjaChmbiA9PiBmbih0aGlzLmxhc3RLbm93blBvc2l0aW9uKSk7XG4gICAgICAgICAgICAgICAgdGhpcy53YWl0aW5nUXVldWUubGVuZ3RoID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigndG91Y2hlbmQudXNlcmdlc3R1cmUnKTtcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy53YXRjaElkID0gbnVsbDtcbiAgICAgICAgfSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIGludm9rZSh2YXJpYWJsZTogYW55LCBvcHRpb25zOiBhbnksIGRhdGFCaW5kaW5nczogTWFwPHN0cmluZywgYW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGlmICghdGhpcy53YXRjaElkIHx8ICF0aGlzLmxhc3RLbm93blBvc2l0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLndhdGNoUG9zaXRpb24oKTtcbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCd0b3VjaGVuZC51c2VyZ2VzdHVyZScsICgpID0+IHRoaXMud2F0Y2hQb3NpdGlvbigpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBnZW9Mb2NhdGlvbk9wdGlvbnM6IEdlb2xvY2F0aW9uT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIG1heGltdW1BZ2U6IGRhdGFCaW5kaW5ncy5nZXQoJ2dlb2xvY2F0aW9uTWF4aW11bUFnZScpICogMTAwMCxcbiAgICAgICAgICAgIHRpbWVvdXQ6IGRhdGFCaW5kaW5ncy5nZXQoJ2dlb2xvY2F0aW9uVGltZW91dCcpICogMTAwMCxcbiAgICAgICAgICAgIGVuYWJsZUhpZ2hBY2N1cmFjeTogZGF0YUJpbmRpbmdzLmdldCgnZ2VvbG9jYXRpb25IaWdoQWNjdXJhY3knKVxuICAgICAgICB9O1xuICAgICAgICBpZiAodGhpcy5sYXN0S25vd25Qb3NpdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLmxhc3RLbm93blBvc2l0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjID0gcG9zaXRpb24gPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUocG9zaXRpb24pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy53YWl0aW5nUXVldWUuaW5kZXhPZihjKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLndhaXRpbmdRdWV1ZS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMubW9kZWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHRoaXMub3B0aW9ucy50aW1lb3V0KTtcblxuICAgICAgICAgICAgdGhpcy53YWl0aW5nUXVldWUucHVzaChjKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5cblxuLyoqXG4gKiBUaGlzIGNsYXNzIGhhbmRsZXMgJ2dldERldmljZUluZm8nIGRldmljZSBvcGVyYXRpb24uXG4gKi9cbmNsYXNzIERldmljZUluZm9PcGVyYXRpb24gaW1wbGVtZW50cyBJRGV2aWNlVmFyaWFibGVPcGVyYXRpb24ge1xuICAgIHB1YmxpYyByZWFkb25seSBuYW1lID0gJ2dldERldmljZUluZm8nO1xuICAgIHB1YmxpYyByZWFkb25seSBtb2RlbCA9IHtcbiAgICAgICAgZGV2aWNlTW9kZWw6ICdERVZJQ0VNT0RFTCcsXG4gICAgICAgIG9zOiAnREVWSUNFT1MnLFxuICAgICAgICBvc1ZlcnNpb246ICdYLlguWCcsXG4gICAgICAgIGRldmljZVVVSUQ6ICdERVZJQ0VVVUlEJ1xuICAgIH07XG4gICAgcHVibGljIHJlYWRvbmx5IHByb3BlcnRpZXMgPSBbXG4gICAgICAgIHt0YXJnZXQ6ICdzdGFydFVwZGF0ZScsIHR5cGU6ICdib29sZWFuJywgdmFsdWU6IHRydWUsIGhpZGU6IHRydWV9XG4gICAgXTtcblxuICAgIGNvbnN0cnVjdG9yIChwcml2YXRlIGRldmljZTogRGV2aWNlKSB7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgaW52b2tlKHZhcmlhYmxlOiBhbnksIG9wdGlvbnM6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgJ2RldmljZU1vZGVsJzogdGhpcy5kZXZpY2UubW9kZWwsXG4gICAgICAgICAgICAnb3MnOiB0aGlzLmRldmljZS5wbGF0Zm9ybSxcbiAgICAgICAgICAgICdvc1ZlcnNpb24nOiB0aGlzLmRldmljZS52ZXJzaW9uLFxuICAgICAgICAgICAgJ2RldmljZVVVSUQnOiB0aGlzLmRldmljZS51dWlkXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2UpO1xuICAgIH1cbn1cblxuY2xhc3MgR2V0TmV0d29ya0luZm9PcGVyYXRpb24gaW1wbGVtZW50cyBJRGV2aWNlVmFyaWFibGVPcGVyYXRpb24ge1xuICAgIHB1YmxpYyByZWFkb25seSBuYW1lID0gJ2dldE5ldHdvcmtJbmZvJztcbiAgICBwdWJsaWMgcmVhZG9ubHkgbW9kZWwgPSB7XG4gICAgICAgIGNvbm5lY3Rpb25UeXBlOiAnTk9ORScsXG4gICAgICAgIGlzQ29ubmVjdGluZzogZmFsc2UsXG4gICAgICAgIGlzTmV0d29ya0F2YWlsYWJsZTogdHJ1ZSxcbiAgICAgICAgaXNPbmxpbmU6IHRydWUsXG4gICAgICAgIGlzT2ZmbGluZTogZmFsc2VcbiAgICB9O1xuICAgIHB1YmxpYyByZWFkb25seSBwcm9wZXJ0aWVzID0gW1xuICAgICAgICB7dGFyZ2V0OiAnYXV0b1VwZGF0ZScsIHR5cGU6ICdib29sZWFuJywgdmFsdWU6IHRydWUsIGhpZGUgOiB0cnVlfSxcbiAgICAgICAge3RhcmdldDogJ3N0YXJ0VXBkYXRlJywgdHlwZTogJ2Jvb2xlYW4nLCB2YWx1ZTogdHJ1ZSwgaGlkZSA6IHRydWV9LFxuICAgICAgICB7dGFyZ2V0OiAnbmV0d29ya1N0YXR1cycsIHR5cGU6ICdvYmplY3QnLCB2YWx1ZTogJ2JpbmQ6QXBwLm5ldHdvcmtTdGF0dXMnLCBkYXRhQmluZGluZzogdHJ1ZSwgaGlkZTogdHJ1ZX0sXG4gICAgICAgIHt0YXJnZXQ6ICdvbk9ubGluZScsIGhpZGUgOiBmYWxzZX0sXG4gICAgICAgIHt0YXJnZXQ6ICdvbk9mZmxpbmUnLCBoaWRlIDogZmFsc2V9XG4gICAgXTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcmVxdWlyZWRDb3Jkb3ZhUGx1Z2lucyA9IFsnTkVUV09SSyddO1xuXG4gICAgY29uc3RydWN0b3IgKHByaXZhdGUgYXBwOiBBcHAsIHByaXZhdGUgbmV0d29ya1NlcnZpY2U6IE5ldHdvcmtTZXJ2aWNlKSB7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgaW52b2tlKHZhcmlhYmxlOiBhbnksIG9wdGlvbnM6IGFueSwgZGF0YUJpbmRpbmdzOiBNYXA8c3RyaW5nLCBhbnk+KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgICAgIGNvbm5lY3Rpb25UeXBlOiBuYXZpZ2F0b3IuY29ubmVjdGlvbi50eXBlLFxuICAgICAgICAgICAgaXNDb25uZWN0aW5nOiB0aGlzLmFwcC5uZXR3b3JrU3RhdHVzLmlzQ29ubmVjdGluZyxcbiAgICAgICAgICAgIGlzTmV0d29ya0F2YWlsYWJsZTogdGhpcy5hcHAubmV0d29ya1N0YXR1cy5pc05ldHdvcmtBdmFpbGFibGUsXG4gICAgICAgICAgICBpc09ubGluZTogdGhpcy5hcHAubmV0d29ya1N0YXR1cy5pc0Nvbm5lY3RlZCxcbiAgICAgICAgICAgIGlzT2ZmbGluZTogIXRoaXMuYXBwLm5ldHdvcmtTdGF0dXMuaXNDb25uZWN0ZWRcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHRoaXMubmV0d29ya1NlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgaW5pdGlhdGVDYWxsYmFjaygnb25PbmxpbmUnLCB2YXJpYWJsZSwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbml0aWF0ZUNhbGxiYWNrKCdvbk9mZmxpbmUnLCB2YXJpYWJsZSwgZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgICB9XG59XG5cbmNsYXNzIEdvT2ZmbGluZU9wZXJhdGlvbiBpbXBsZW1lbnRzIElEZXZpY2VWYXJpYWJsZU9wZXJhdGlvbiB7XG4gICAgcHVibGljIHJlYWRvbmx5IG5hbWUgPSAnZ29PZmZsaW5lJztcbiAgICBwdWJsaWMgcmVhZG9ubHkgbW9kZWwgPSB7fTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcHJvcGVydGllcyA9IFtdO1xuICAgIHB1YmxpYyByZWFkb25seSByZXF1aXJlZENvcmRvdmFQbHVnaW5zID0gWydORVRXT1JLJ107XG5cbiAgICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBuZXR3b3JrU2VydmljZTogTmV0d29ya1NlcnZpY2UpIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyBpbnZva2UodmFyaWFibGU6IGFueSwgb3B0aW9uczogYW55LCBkYXRhQmluZGluZ3M6IE1hcDxzdHJpbmcsIGFueT4pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5uZXR3b3JrU2VydmljZS5kaXNjb25uZWN0KCk7XG4gICAgfVxufVxuXG5jbGFzcyBHb09ubGluZU9wZXJhdGlvbiBpbXBsZW1lbnRzIElEZXZpY2VWYXJpYWJsZU9wZXJhdGlvbiB7XG4gICAgcHVibGljIHJlYWRvbmx5IG5hbWUgPSAnZ29PbmxpbmUnO1xuICAgIHB1YmxpYyByZWFkb25seSBtb2RlbCA9IHt9O1xuICAgIHB1YmxpYyByZWFkb25seSBwcm9wZXJ0aWVzID0gW107XG4gICAgcHVibGljIHJlYWRvbmx5IHJlcXVpcmVkQ29yZG92YVBsdWdpbnMgPSBbJ05FVFdPUksnXTtcblxuICAgIGNvbnN0cnVjdG9yIChwcml2YXRlIG5ldHdvcmtTZXJ2aWNlOiBOZXR3b3JrU2VydmljZSkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGludm9rZSh2YXJpYWJsZTogYW55LCBvcHRpb25zOiBhbnksIGRhdGFCaW5kaW5nczogTWFwPHN0cmluZywgYW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLm5ldHdvcmtTZXJ2aWNlLmNvbm5lY3QoKTtcbiAgICB9XG59XG5cbi8qKlxuICogVGhpcyBjbGFzcyBoYW5kbGVzICd2aWJyYXRlJyBkZXZpY2Ugb3BlcmF0aW9uLlxuICovXG5jbGFzcyBWaWJyYXRlT3BlcmF0aW9uIGltcGxlbWVudHMgSURldmljZVZhcmlhYmxlT3BlcmF0aW9uIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgbmFtZSA9ICd2aWJyYXRlJztcbiAgICBwdWJsaWMgcmVhZG9ubHkgbW9kZWwgPSB7XG4gICAgICAgIGFwcHZlcnNpb246ICdYLlguWCcsXG4gICAgICAgIGNvcmRvdmF2ZXJzaW9uOiAnWC5YLlgnXG4gICAgfTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgcHJvcGVydGllcyA9IFtcbiAgICAgICAge3RhcmdldDogJ3ZpYnJhdGlvbnRpbWUnLCB0eXBlOiAnbnVtYmVyJywgdmFsdWU6IDIsIGRhdGFCaW5kaW5nOiB0cnVlfVxuICAgIF07XG4gICAgcHVibGljIHJlYWRvbmx5IHJlcXVpcmVkQ29yZG92YVBsdWdpbnMgPSBbJ1ZJQlJBVEUnXTtcblxuICAgIGNvbnN0cnVjdG9yIChwcml2YXRlIHZpYnJhdGlvblNlcnZpY2U6IFZpYnJhdGlvbikge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGludm9rZSh2YXJpYWJsZTogYW55LCBvcHRpb25zOiBhbnksIGRhdGFCaW5kaW5nczogTWFwPHN0cmluZywgYW55Pik6IFByb21pc2U8YW55PiB7XG4gICAgICAgIHRoaXMudmlicmF0aW9uU2VydmljZS52aWJyYXRlKGRhdGFCaW5kaW5ncy5nZXQoJ3ZpYnJhdGlvbnRpbWUnKSAqIDEwMDApO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxufVxuIl19