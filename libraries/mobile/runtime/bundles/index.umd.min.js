!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common/http"),require("@ionic-native/app-version"),require("@ionic-native/barcode-scanner"),require("@ionic-native/calendar"),require("@ionic-native/camera"),require("@ionic-native/contacts"),require("@ionic-native/file-opener"),require("@ionic-native/device"),require("@ionic-native/media-capture"),require("@ionic-native/geolocation"),require("@ionic-native/network"),require("@ionic-native/sqlite"),require("@ionic-native/vibration"),require("@wm/components"),require("@wm/mobile/offline"),require("@wm/mobile/variables"),require("@wm/mobile/components"),require("@ionic-native/file"),require("rxjs"),require("rxjs/operators"),require("@wm/security"),require("@wm/variables"),require("@angular/core"),require("@wm/core"),require("@wm/mobile/core")):"function"==typeof define&&define.amd?define("@wm/mobile/runtime",["exports","@angular/common/http","@ionic-native/app-version","@ionic-native/barcode-scanner","@ionic-native/calendar","@ionic-native/camera","@ionic-native/contacts","@ionic-native/file-opener","@ionic-native/device","@ionic-native/media-capture","@ionic-native/geolocation","@ionic-native/network","@ionic-native/sqlite","@ionic-native/vibration","@wm/components","@wm/mobile/offline","@wm/mobile/variables","@wm/mobile/components","@ionic-native/file","rxjs","rxjs/operators","@wm/security","@wm/variables","@angular/core","@wm/core","@wm/mobile/core"],t):t((e.wm=e.wm||{},e.wm.mobile=e.wm.mobile||{},e.wm.mobile.runtime={}),e.ng.common.http,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.ionicNative.plugins,e.wm.components,e.wm.mobile.offline,e.wm.mobile.variables,e.wm.mobile.components,e.ionicNative.plugins,e.rxjs,e.rxjs.operators,e.wm.security,e.wm.variables,e.ng.core,e.wm.core,e.wm.mobile.core)}(this,function(e,t,i,r,n,o,c,s,a,p,u,l,v,d,h,f,m,w,S,y,g,b,C,E,I,R){"use strict";function k(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),c=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)c.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o["return"])&&i.call(o)}finally{if(n)throw n.error}}return c}var A,N,P=function(){function e(e,t,i){this.elRef=e,this.fileSelectorService=t,this.processManagementService=i}return e.prototype.ngAfterViewInit=function(){var e=$(this.elRef.nativeElement).find(">[wmNetworkInfoToaster], >[wmAppUpdate], >[wmMobileFileBrowser]"),t=$("body:first");I.hasCordova()?(e.appendTo(t),this.fileSelectorService.setFileBrowser(this.fileBrowserComponent)):e.remove(),$(this.elRef.nativeElement).find(">[wmProgressManager]").appendTo(t),this.processManagementService.setUIComponent(this.processManagerComponent)},e.decorators=[{type:E.Component,args:[{selector:"[wmAppExt]",template:"<ng-container>\n        <div wmNetworkInfoToaster></div>\n        <div wmAppUpdate></div>\n        <div wmMobileFileBrowser></div>\n        <div wmProcessManager></div>\n    </ng-container>"}]}],e.ctorParameters=function(){return[{type:E.ElementRef},{type:w.FileSelectorService},{type:w.ProcessManagementService}]},e.propDecorators={fileBrowserComponent:[{type:E.ViewChild,args:[w.FileBrowserComponent]}],processManagerComponent:[{type:E.ViewChild,args:[w.ProcessManagerComponent]}]},e}(),T="wavemaker.persistedcookies",O=function(){function e(){this.cookieInfo={},this.serviceName="CookeService"}return e.prototype.persistCookie=function(i,r,e){var n=this;return new Promise(function(t){e?t(e):n.getCookie(i,r).then(function(e){return t(e.cookieValue)})}).then(function(e){n.cookieInfo[i+"-"+r]={hostname:i.replace(/:[0-9]+/,""),name:r,value:n.rotateLTR(e)},localStorage.setItem(T,JSON.stringify(n.cookieInfo))})},e.prototype.getCookie=function(i,r){return new Promise(function(e,t){window.cookieEmperor.getCookie(i,r,e,t)})},e.prototype.setCookie=function(i,r,n){return new Promise(function(e,t){window.cookieEmperor.setCookie(i,r,n,e,t)})},e.prototype.clearAll=function(){return new Promise(function(e,t){return window.cookieEmperor.clearAll(e,t)})},e.prototype.start=function(){var r=this,e=localStorage.getItem(T),t=[];if(e){var i=JSON.parse(e);_.forEach(i,function(i){if(i.name&&i.value){var e=new Promise(function(e,t){window.cookieEmperor.setCookie(i.hostname,i.name,r.rotateRTL(i.value),e,t)});t.push(e)}})}return Promise.all(t)},e.prototype.rotateLTR=function(e){var i=e.split(""),r=[],n=Math.floor(e.length/3);return i.forEach(function(e,t){r[(t+n)%i.length]=i[t]}),r.join("")},e.prototype.rotateRTL=function(e){var i=e.split(""),r=[],n=Math.floor(e.length/3);return i.forEach(function(e,t){r[(i.length+t-n)%i.length]=i[t]}),r.join("")},e.decorators=[{type:E.Injectable,args:[{providedIn:"root"}]}],e.ngInjectableDef=E.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}(),M=function(){function e(e,t,i,r,n,o){this.app=e,this.deviceService=r,this.networkService=n,this.requestInterceptors=[],I.hasCordova()&&!C.CONSTANTS.isWaveLens&&(this.requestInterceptors.push(new j(e,t,o)),this.requestInterceptors.push(new q(e,i,r,t,n)),this.requestInterceptors.push(new x(e)))}return e.prototype.intercept=function(e,t){var i=this,r=(new y.Subject,localStorage.getItem(C.CONSTANTS.XSRF_COOKIE_NAME));r&&(e=e.clone({headers:e.headers.set(I.getWmProjectProperties().xsrf_header_name,r)}));var n={request:e};return y.from(this.deviceService.whenReady().then(function(){return I.executePromiseChain(i.getInterceptors(),[n])})).pipe(g.mergeMap(function(){return t.handle(n.request)}))},e.prototype.getInterceptors=function(){return this.requestInterceptors.map(function(e){return function(t){return e.intercept(t.request).then(function(e){return t.request=e})}})},e.prototype.onHttpError=function(e){I.hasCordova&&(!e||!e.status||e.status<0||404===e.status)&&this.networkService.isConnected()&&this.networkService.isAvailable(!0)},e.decorators=[{type:E.Injectable}],e.ctorParameters=function(){return[{type:I.App},{type:S.File},{type:R.DeviceFileDownloadService},{type:R.DeviceService},{type:R.NetworkService},{type:b.SecurityService}]},e}(),x=function(){function r(e){this.app=e}return r.prototype.intercept=function(e){var t=e,i=e.url;return i.indexOf("://")<0&&r.REMOTE_SERVICE_URL_PATTERNS.find(function(e){return e.test(i)})&&(i=this.app.deployedUrl+i),(i=I.removeExtraSlashes(i))!==e.url&&(t=e.clone({url:i})),Promise.resolve(t)},r.REMOTE_SERVICE_URL_PATTERNS=[new RegExp("^((./)|/)?services/"),new RegExp("j_spring_security_check"),new RegExp("j_spring_security_logout")],r}(),q=function(){function n(e,t,i,r,n){var o=this;this.app=e,this.deviceFileDownloadService=t,this.deviceService=i,this.file=r,this.networkService=n,this.checkRemoteDirectory=!0,this.hasRemoteChanges=!1,this.file.checkDir(cordova.file.dataDirectory,"remote").then(function(){return o.hasRemoteChanges=!0},I.noop)}return n.prototype.intercept=function(t){var i=this,r="true"===localStorage.getItem("remoteSync");return this.hasRemoteChanges||r?Promise.resolve(t.url).then(function(t){if(t.indexOf("://")<0&&n.URL_TO_SYNC.find(function(e){return e.test(t)})){var e=_.last(_.split(t,"/"));return i.download(t,e,r)}return t}).then(function(e){return e!==t.url?(i.hasRemoteChanges=!0,t.clone({url:e})):t}):Promise.resolve(t)},n.prototype.createFolderStructure=function(e,t){var i=this,r=t[0];return _.isEmpty(r)?Promise.resolve(e):this.file.createDir(e,r,!1)["catch"](I.noop).then(function(){return e=e+r+"/",t.shift(),i.createFolderStructure(e,t)})},n.prototype.init=function(e,t){var i=this,r=_.last(_.split(e,"/")),n=_.replace(e,r,""),o="remote"+_.replace(n,this.app.deployedUrl,""),c=cordova.file.dataDirectory;return new Promise(function(e,t){if(i.checkRemoteDirectory)return i.deviceService.getAppBuildTime().then(function(e){var t=i.deviceService.getEntry("remote-sync")||{};if(!t.lastBuildTime||t.lastBuildTime!==e)return i.file.removeDir(cordova.file.dataDirectory,"remote")["catch"](I.noop).then(function(){return t.lastBuildTime=e,i.hasRemoteChanges=!1,i.deviceService.storeEntry("remote-sync",t)})}).then(function(){return i.checkRemoteDirectory=!1}).then(e,t);e()}).then(function(){return i.file.checkDir(c,o)}).then(function(){return c+o},function(){return t?i.createFolderStructure(c,_.split(o,"/")):Promise.reject("Could not find equivalent remote path")})},n.prototype.download=function(e,t,i){var r,n=this,o=this.app.deployedUrl+"/"+e;return this.init(o,i).then(function(e){return r=e,n.file.checkFile(r+t,"")}).then(function(){return i&&n.networkService.isConnected()?n.file.removeFile(r,t).then(function(){return r+t}):r+t},function(){return e}).then(function(e){return i&&n.networkService.isConnected()?n.deviceFileDownloadService.download(o,!1,r,t):e})},n.URL_TO_SYNC=[new RegExp("page.min.json$"),new RegExp("app.js$"),new RegExp("app.variables.json$")],n}(),j=function(){function e(e,t,i){this.app=e,this.file=t,this.securityService=i,this.initialized=!1}return e.prototype.intercept=function(n){var o=this;return new Promise(function(i,r){return e.PAGE_URL_PATTERN.test(n.url)?Promise.resolve().then(function(){if(!o.initialized)return o.init()}).then(function(){var e=_.split(n.url,"/"),t=e[e.length-2];return!o.publicPages||o.publicPages[t]||o.securityService.getConfig(function(e){!e.securityEnabled||e.authenticated?i(n):(r("Page '"+t+"' is not accessible to the user."),o.app.notify("http401",{page:t}))},function(){return r("Security call failed.")}),Promise.resolve(n)}).then(i,r):i(n)})},e.prototype.init=function(){var t=this,e=cordova.file.applicationDirectory+"www/metadata/app";return this.file.readAsText(e,"public-pages.json").then(function(e){t.initialized||(t.publicPages={},t.initialized=!0,_.forEach(JSON.parse(e),function(e){return t.publicPages[e]=!0}))})["catch"](function(){t.initialized=!0})},e.PAGE_URL_PATTERN=new RegExp("page.min.json$"),e}(),U=function(){function e(e,t,i,r){this.app=e,this.cookieService=t,this.httpService=i,this.extAppMessageService=r}return e.prototype.execute=function(t,e,i){var r=this;return void 0===i&&(i=!1),this.httpService.get("/services/webprocess/prepare?processName="+t+"&hookUrl="+e+"&requestSourceType=MOBILE").then(function(e){return i?r.executeWithSystemBrowser(e):r.executeWithInAppBrowser(e,t)}).then(function(e){return r.httpService.get("/services/webprocess/decode?encodedProcessdata="+e)})},e.prototype.executeWithSystemBrowser=function(e){var r=this;return new Promise(function(t){var i=r.extAppMessageService.subscribe("^services/webprocess/LOGIN",function(e){t(e.data.process_output),i()});window.open(r.app.deployedUrl+"services/webprocess/start?process="+encodeURIComponent(e),"_system")})},e.prototype.executeWithInAppBrowser=function(n,o){var c=this;return new Promise(function(t,e){var i=cordova.InAppBrowser.open(c.app.deployedUrl+"services/webprocess/start?process="+encodeURIComponent(n),"_blank","location=yes,clearcache=yes"),r=!1;i.addEventListener("loadstop",function(){i.executeScript({code:c.getScriptToInject(o)},function(e){e&&e[0]&&(r=!0,i.close(),t(e[0]))})}),i.addEventListener("exit",function(){r||e("Login process is stopped")})}).then(function(e){var t=c.app.deployedUrl;return t.endsWith("/")&&(t=t.substr(0,t.length-1)),c.cookieService.setCookie(t,"WM_WEB_PROCESS",n).then(function(){return e})})},e.prototype.getScriptToInject=function(e){return"\n            (function() {\n                var elements = document.querySelectorAll('body.flex>a.link');\n                for (var i = 0; i < elements.length; i++) {\n                    var href = elements[i].href;\n                    if (href && href.indexOf('://services/webprocess/"+e+"?process_output=')) {\n                        return href.split('process_output=')[1];\n                    }\n                }\n                window.isWebLoginProcess = true;\n            })();\n        "},e.decorators=[{type:E.Injectable}],e.ctorParameters=function(){return[{type:I.App},{type:O},{type:I.AbstractHttpService},{type:R.ExtAppMessageService}]},e}();(N=A||(A={})).IOS="ios",N.ANDROID="android";var D="keyboard",F=[i.AppVersion,r.BarcodeScanner,n.Calendar,o.Camera,c.Contacts,S.File,s.FileOpener,a.Device,u.Geolocation,p.MediaCapture,l.Network,v.SQLite,d.Vibration],L=function(){function p(e,t,i,r,n,o,c,s,a){this.app=e,this.cookieService=t,this.deviceFileOpenerService=i,this.deviceService=r,this.securityService=n,this.httpService=o,this.extAppMessageService=c,this.networkService=s,this.webProcessService=a,this._$appEl=$(".wm-app:first"),768<=this._$appEl.width()?(e.isTabletApplicationType=!0,this._$appEl.addClass("wm-tablet-app")):this._$appEl.addClass("wm-mobile-app"),p.initializeRuntime(this,this.app,this.cookieService,this.deviceFileOpenerService,this.deviceService)}return p.forRoot=function(){return{ngModule:p,providers:function i(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(k(arguments[t]));return e}([U,{provide:t.HTTP_INTERCEPTORS,useClass:M,multi:!0}],F,[h.FileExtensionFromMimePipe,{provide:f.PushService,useClass:f.PushServiceImpl}])}},p.initializeRuntime=function(t,i,r,n,e){if(!this.initialized){if(this.initialized=!0,i.deployedUrl=t.getDeployedUrl(),t.getDeviceOS().then(function(e){i.selectedViewPort={os:e},t.applyOSTheme(e)}),I.hasCordova()){t.handleKeyBoardClass(),e.addStartUpService(r),i.subscribe("userLoggedIn",function(){var e=C.$rootScope.project.deployedUrl;e.endsWith("/")&&(e=e.substr(0,e.length-1)),r.persistCookie(e,"JSESSIONID")["catch"](I.noop),r.persistCookie(e,"SPRING_SECURITY_REMEMBER_ME_COOKIE")["catch"](I.noop)}),i.subscribe("device-file-download",function(e){n.openRemoteFile(e.url,e.extension,e.name).then(e.successCb,e.errorCb)});var o=window.__zone_symbol__FileReader;o&&o.READ_CHUNK_SIZE&&(window.FileReader=o),C.CONSTANTS.isWaveLens||(window.remoteSync=function(e){void 0===e&&(e=!0),localStorage.setItem("remoteSync",e?"true":"false")}),t.addAuthInBrowser()}e.start(),e.whenReady().then(function(){I.hasCordova()&&(t._$appEl.addClass("cordova"),t.exposeOAuthService(),navigator.splashscreen.hide(),window.StatusBar&&window.StatusBar.overlaysWebView(!1))})}},p.prototype.exposeOAuthService=function(){var c=this;window.OAuthInMobile=function(o){return new Promise(function(t,e){var i="^services/oauth/"+o+"$",r=c.extAppMessageService.subscribe(i,function(e){t(e.data.access_token),r(),clearTimeout(n)}),n=setTimeout(function(){r(),e("Time out for oauth message after 0 seconds")},6e4)})};var e=window.handleOpenURL;e.isReady=!0,e(e.lastURL)},p.prototype.applyOSTheme=function(e){var t=$('link[theme="wmtheme"]:first'),i=t.attr("href").replace(new RegExp("/[a-z]*/style.css$"),"/"+e.toLowerCase()+"/style.css"),r=I.loadStyleSheet(i,{name:"theme",value:"wmtheme"});t=0<t.length&&t[0],r&&t&&(I.insertAfter(r,t),I.removeNode(t))},p.prototype.handleKeyBoardClass=function(){var e=this,t=window.innerHeight;window.addEventListener("resize",function(){window.innerHeight<t?e._$appEl.addClass(D):e._$appEl.removeClass(D)})},p.prototype.getDeployedUrl=function(){var e=window.WaveLens&&window.WaveLens.appUrl,t=C.$rootScope.project.deployedUrl;return I.hasCordova()&&(e?t=e:I.fetchContent("json","./config.json",!0,function(e){!e.error&&e.baseUrl&&(t=e.baseUrl)})),t.endsWith("/")||(t+="/"),C.$rootScope.project.deployedUrl=t},p.prototype.getDeviceOS=function(){return new Promise(function(i,e){window.top!==window?(window.top.postMessage({key:"on-load"},"*"),window.onmessage=function(e){var t=e.data;I.isObject(t)&&"switch-device"===t.key&&i(t.device.os)}):I.isIphone()||I.isIpod()||I.isIpad()?i(A.IOS):i(A.ANDROID)})},p.prototype.addAuthInBrowser=function(){var r=this;this.securityService.authInBrowser=function(){return r.networkService.isConnected()?r.webProcessService.execute("LOGIN","/").then(function(t){var i=r.app.deployedUrl;return i.endsWith("/")&&(i=i.substr(0,i.length-1)),(t=JSON.parse(t))[C.CONSTANTS.XSRF_COOKIE_NAME]&&localStorage.setItem(C.CONSTANTS.XSRF_COOKIE_NAME,t[C.CONSTANTS.XSRF_COOKIE_NAME]),r.cookieService.clearAll().then(function(){var e=_.keys(t).map(function(e){return r.cookieService.setCookie(i,e,t[e])});return Promise.all(e)})}).then(function(){return r.app.notify("userLoggedIn",{})}):Promise.reject("In offline, app cannot contact the server.")}},p.initialized=!1,p.decorators=[{type:E.NgModule,args:[{declarations:[P],exports:[P,w.WmMobileComponentsModule],imports:[R.MobileCoreModule,m.VariablesModule,w.WmMobileComponentsModule],bootstrap:[]}]}],p.ctorParameters=function(){return[{type:I.App},{type:O},{type:R.DeviceFileOpenerService},{type:R.DeviceService},{type:b.SecurityService},{type:I.AbstractHttpService},{type:R.ExtAppMessageService},{type:R.NetworkService},{type:U}]},p}();e.ɵa=P,e.ɵb=O,e.ɵd=M,e.ɵc=U,e.MAX_WAIT_TIME_4_OAUTH_MESSAGE=6e4,e.MobileRuntimeModule=L,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map