import { Injectable } from '@angular/core';
import { File } from '@ionic-native/file';
import { from, Subject } from 'rxjs';
import { mergeMap } from 'rxjs/operators';
import { App, executePromiseChain, getWmProjectProperties, hasCordova, noop, removeExtraSlashes } from '@wm/core';
import { DeviceFileDownloadService, DeviceService, NetworkService } from '@wm/mobile/core';
import { SecurityService } from '@wm/security';
import { CONSTANTS } from '@wm/variables';
export class MobileHttpInterceptor {
    constructor(app, file, deviceFileDownloadService, deviceService, networkService, securityService) {
        this.app = app;
        this.deviceService = deviceService;
        this.networkService = networkService;
        this.requestInterceptors = [];
        if (hasCordova() && !CONSTANTS.isWaveLens) {
            this.requestInterceptors.push(new SecurityInterceptor(app, file, securityService));
            this.requestInterceptors.push(new RemoteSyncInterceptor(app, deviceFileDownloadService, deviceService, file, networkService));
            this.requestInterceptors.push(new ServiceCallInterceptor(app));
        }
    }
    intercept(request, next) {
        const subject = new Subject();
        const token = localStorage.getItem(CONSTANTS.XSRF_COOKIE_NAME);
        if (token) {
            // Clone the request to add the new header
            request = request.clone({ headers: request.headers.set(getWmProjectProperties().xsrf_header_name, token) });
        }
        const data = { request: request };
        // invoke the request only when device is ready.
        const obs = from(this.deviceService.whenReady()
            .then(() => executePromiseChain(this.getInterceptors(), [data])));
        return obs.pipe(mergeMap(() => {
            return next.handle(data.request);
        }));
    }
    getInterceptors() {
        return this.requestInterceptors.map(i => {
            return (data) => i.intercept(data.request).then(req => data.request = req);
        });
    }
    onHttpError(response) {
        if (hasCordova
            && (!response || !response.status || response.status < 0 || response.status === 404)
            && (this.networkService.isConnected())) {
            this.networkService.isAvailable(true);
        }
    }
}
MobileHttpInterceptor.decorators = [
    { type: Injectable }
];
/** @nocollapse */
MobileHttpInterceptor.ctorParameters = () => [
    { type: App },
    { type: File },
    { type: DeviceFileDownloadService },
    { type: DeviceService },
    { type: NetworkService },
    { type: SecurityService }
];
class ServiceCallInterceptor {
    constructor(app) {
        this.app = app;
    }
    intercept(request) {
        let modifiedRequest = request;
        let url = request.url;
        // if necessary, prepend deployed url
        if (url.indexOf('://') < 0
            && ServiceCallInterceptor.REMOTE_SERVICE_URL_PATTERNS.find(r => r.test(url))) {
            url = this.app.deployedUrl + url;
        }
        url = removeExtraSlashes(url);
        if (url !== request.url) {
            modifiedRequest = request.clone({
                url: url
            });
        }
        return Promise.resolve(modifiedRequest);
    }
}
ServiceCallInterceptor.REMOTE_SERVICE_URL_PATTERNS = [
    new RegExp('^((./)|/)?services/'),
    new RegExp('j_spring_security_check'),
    new RegExp('j_spring_security_logout')
];
class RemoteSyncInterceptor {
    constructor(app, deviceFileDownloadService, deviceService, file, networkService) {
        this.app = app;
        this.deviceFileDownloadService = deviceFileDownloadService;
        this.deviceService = deviceService;
        this.file = file;
        this.networkService = networkService;
        this.checkRemoteDirectory = true;
        this.hasRemoteChanges = false;
        this.file.checkDir(cordova.file.dataDirectory, 'remote').then(() => this.hasRemoteChanges = true, noop);
    }
    intercept(request) {
        const isRemoteSyncEnabled = localStorage.getItem('remoteSync') === 'true';
        if (this.hasRemoteChanges || isRemoteSyncEnabled) {
            return Promise.resolve(request.url).then(url => {
                if (url.indexOf('://') < 0
                    && RemoteSyncInterceptor.URL_TO_SYNC.find(r => r.test(url))) {
                    const fileNameFromUrl = _.last(_.split(url, '/'));
                    return this.download(url, fileNameFromUrl, isRemoteSyncEnabled);
                }
                return url;
            }).then(url => {
                if (url !== request.url) {
                    this.hasRemoteChanges = true;
                    return request.clone({
                        url: url
                    });
                }
                return request;
            });
        }
        else {
            return Promise.resolve(request);
        }
    }
    createFolderStructure(parentFolder, folderNamesList) {
        const folderName = folderNamesList[0];
        if (!_.isEmpty(folderName)) {
            return this.file.createDir(parentFolder, folderName, false)
                .catch(noop)
                .then(() => {
                parentFolder = parentFolder + folderName + '/';
                folderNamesList.shift();
                return this.createFolderStructure(parentFolder, folderNamesList);
            });
        }
        return Promise.resolve(parentFolder);
    }
    init(pageUrl, isRemoteSyncEnabled) {
        const fileName = _.last(_.split(pageUrl, '/')), path = _.replace(pageUrl, fileName, ''), folderPath = 'remote' + _.replace(path, this.app.deployedUrl, ''), downloadsParent = cordova.file.dataDirectory;
        return new Promise((resolve, reject) => {
            if (this.checkRemoteDirectory) {
                return this.deviceService.getAppBuildTime().then(buildTime => {
                    const remoteSyncInfo = this.deviceService.getEntry('remote-sync') || {};
                    if (!remoteSyncInfo.lastBuildTime || remoteSyncInfo.lastBuildTime !== buildTime) {
                        return this.file.removeDir(cordova.file.dataDirectory, 'remote')
                            .catch(noop).then(() => {
                            remoteSyncInfo.lastBuildTime = buildTime;
                            this.hasRemoteChanges = false;
                            return this.deviceService.storeEntry('remote-sync', remoteSyncInfo);
                        });
                    }
                }).then(() => this.checkRemoteDirectory = false)
                    .then(resolve, reject);
            }
            resolve();
        })
            .then(() => this.file.checkDir(downloadsParent, folderPath))
            .then(() => downloadsParent + folderPath, () => {
            if (isRemoteSyncEnabled) {
                return this.createFolderStructure(downloadsParent, _.split(folderPath, '/'));
            }
            return Promise.reject('Could not find equivalent remote path');
        });
    }
    download(url, fileName, isRemoteSyncEnabled) {
        const pageUrl = this.app.deployedUrl + '/' + url;
        let folderPath;
        return this.init(pageUrl, isRemoteSyncEnabled)
            .then(pathToRemote => {
            folderPath = pathToRemote;
            return this.file.checkFile(folderPath + fileName, '');
        }).then(() => {
            if (isRemoteSyncEnabled && this.networkService.isConnected()) {
                return this.file.removeFile(folderPath, fileName)
                    .then(() => folderPath + fileName);
            }
            return folderPath + fileName;
        }, () => url)
            .then(path => {
            if (isRemoteSyncEnabled && this.networkService.isConnected()) {
                return this.deviceFileDownloadService.download(pageUrl, false, folderPath, fileName);
            }
            return path;
        });
    }
}
RemoteSyncInterceptor.URL_TO_SYNC = [
    new RegExp('page.min.json$'),
    new RegExp('app.js$'),
    new RegExp('app.variables.json$')
];
class SecurityInterceptor {
    constructor(app, file, securityService) {
        this.app = app;
        this.file = file;
        this.securityService = securityService;
        this.initialized = false;
    }
    intercept(request) {
        return new Promise((resolve, reject) => {
            if (SecurityInterceptor.PAGE_URL_PATTERN.test(request.url)) {
                return Promise.resolve().then(() => {
                    if (!this.initialized) {
                        return this.init();
                    }
                }).then(() => {
                    const urlSplits = _.split(request.url, '/');
                    const pageName = urlSplits[urlSplits.length - 2];
                    if (!this.publicPages || this.publicPages[pageName]) {
                        return Promise.resolve(request);
                    }
                    else {
                        this.securityService.getConfig(config => {
                            if (!config.securityEnabled || config.authenticated) {
                                resolve(request);
                            }
                            else {
                                reject(`Page '${pageName}' is not accessible to the user.`);
                                this.app.notify('http401', { page: pageName });
                            }
                        }, () => reject(`Security call failed.`));
                    }
                    return Promise.resolve(request);
                }).then(resolve, reject);
            }
            return resolve(request);
        });
    }
    /**
     * loads public pages from 'metadata/app/public-pages.info' and overrides canAccess method SecurityService
     */
    init() {
        const folderPath = cordova.file.applicationDirectory + 'www/metadata/app', fileName = 'public-pages.json';
        return this.file.readAsText(folderPath, fileName).then(text => {
            if (!this.initialized) {
                this.publicPages = {};
                this.initialized = true;
                _.forEach(JSON.parse(text), pageName => this.publicPages[pageName] = true);
            }
        }).catch(() => {
            this.initialized = true;
        });
    }
}
SecurityInterceptor.PAGE_URL_PATTERN = new RegExp('page.min.json$');
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1pbnRlcmNlcHRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL21vYmlsZS9ydW50aW1lLyIsInNvdXJjZXMiOlsic2VydmljZXMvaHR0cC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUxQyxPQUFPLEVBQUUsR0FBRyxFQUFFLG1CQUFtQixFQUFFLHNCQUFzQixFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFVMUMsTUFBTSxPQUFPLHFCQUFxQjtJQUk5QixZQUEyQixHQUFRLEVBQ2hCLElBQVUsRUFDVix5QkFBb0QsRUFDNUMsYUFBNEIsRUFDNUIsY0FBOEIsRUFDdEMsZUFBZ0M7UUFMeEIsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUdSLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQU5qRCx3QkFBbUIsR0FBeUIsRUFBRSxDQUFDO1FBUW5ELElBQUksVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxtQkFBbUIsQ0FBQyxH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QUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQzthQUM5RTtRQUNMLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O0FBakRjLG9DQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwSW50ZXJjZXB0b3IsIEh0dHBSZXF1ZXN0LCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEZpbGUgfSBmcm9tICdAaW9uaWMtbmF0aXZlL2ZpbGUnO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEFwcCwgZXhlY3V0ZVByb21pc2VDaGFpbiwgZ2V0V21Qcm9qZWN0UHJvcGVydGllcywgaGFzQ29yZG92YSwgbm9vcCwgcmVtb3ZlRXh0cmFTbGFzaGVzIH0gZnJvbSAnQHdtL2NvcmUnO1xuaW1wb3J0IHsgRGV2aWNlRmlsZURvd25sb2FkU2VydmljZSwgRGV2aWNlU2VydmljZSwgTmV0d29ya1NlcnZpY2UgfSBmcm9tICdAd20vbW9iaWxlL2NvcmUnO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXJ2aWNlIH0gZnJvbSAnQHdtL3NlY3VyaXR5JztcbmltcG9ydCB7IENPTlNUQU5UUyB9IGZyb20gJ0B3bS92YXJpYWJsZXMnO1xuXG5kZWNsYXJlIGNvbnN0IGNvcmRvdmE7XG5kZWNsYXJlIGNvbnN0IF87XG5cbmludGVyZmFjZSBSZXF1ZXN0SW50ZXJjZXB0b3Ige1xuICAgIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogUHJvbWlzZTxIdHRwUmVxdWVzdDxhbnk+Pjtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vYmlsZUh0dHBJbnRlcmNlcHRvciBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG5cbiAgICBwcml2YXRlIHJlcXVlc3RJbnRlcmNlcHRvcnM6IFJlcXVlc3RJbnRlcmNlcHRvcltdID0gW107XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEFwcCxcbiAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogRmlsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlRmlsZURvd25sb2FkU2VydmljZTogRGV2aWNlRmlsZURvd25sb2FkU2VydmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBkZXZpY2VTZXJ2aWNlOiBEZXZpY2VTZXJ2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIG5ldHdvcmtTZXJ2aWNlOiBOZXR3b3JrU2VydmljZSxcbiAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlTZXJ2aWNlOiBTZWN1cml0eVNlcnZpY2UpIHtcbiAgICAgICAgaWYgKGhhc0NvcmRvdmEoKSAmJiAhQ09OU1RBTlRTLmlzV2F2ZUxlbnMpIHtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9ycy5wdXNoKG5ldyBTZWN1cml0eUludGVyY2VwdG9yKGFwcCwgZmlsZSwgc2VjdXJpdHlTZXJ2aWNlKSk7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcnMucHVzaChuZXcgUmVtb3RlU3luY0ludGVyY2VwdG9yKGFwcCwgZGV2aWNlRmlsZURvd25sb2FkU2VydmljZSwgZGV2aWNlU2VydmljZSwgZmlsZSwgbmV0d29ya1NlcnZpY2UpKTtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9ycy5wdXNoKG5ldyBTZXJ2aWNlQ2FsbEludGVyY2VwdG9yKGFwcCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICAgICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PEh0dHBFdmVudDxhbnk+PigpO1xuICAgICAgICBjb25zdCB0b2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKENPTlNUQU5UUy5YU1JGX0NPT0tJRV9OQU1FKTtcbiAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgICAvLyBDbG9uZSB0aGUgcmVxdWVzdCB0byBhZGQgdGhlIG5ldyBoZWFkZXJcbiAgICAgICAgICAgIHJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKHsgaGVhZGVyczogcmVxdWVzdC5oZWFkZXJzLnNldChnZXRXbVByb2plY3RQcm9wZXJ0aWVzKCkueHNyZl9oZWFkZXJfbmFtZSwgdG9rZW4pIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRhdGEgPSB7cmVxdWVzdDogcmVxdWVzdH07XG5cbiAgICAgICAgLy8gaW52b2tlIHRoZSByZXF1ZXN0IG9ubHkgd2hlbiBkZXZpY2UgaXMgcmVhZHkuXG4gICAgICAgIGNvbnN0IG9icyA9IGZyb20odGhpcy5kZXZpY2VTZXJ2aWNlLndoZW5SZWFkeSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiBleGVjdXRlUHJvbWlzZUNoYWluKHRoaXMuZ2V0SW50ZXJjZXB0b3JzKCksIFtkYXRhXSkpKTtcbiAgICAgICAgcmV0dXJuIG9icy5waXBlKG1lcmdlTWFwKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShkYXRhLnJlcXVlc3QpO1xuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRJbnRlcmNlcHRvcnMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcnMubWFwKGkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChkYXRhKSA9PiBpLmludGVyY2VwdChkYXRhLnJlcXVlc3QpLnRoZW4ocmVxID0+IGRhdGEucmVxdWVzdCA9IHJlcSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25IdHRwRXJyb3IocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+KSB7XG4gICAgICAgIGlmIChoYXNDb3Jkb3ZhXG4gICAgICAgICAgICAmJiAoIXJlc3BvbnNlIHx8ICFyZXNwb25zZS5zdGF0dXMgfHwgcmVzcG9uc2Uuc3RhdHVzIDwgMCB8fCByZXNwb25zZS5zdGF0dXMgPT09IDQwNClcbiAgICAgICAgICAgICYmICh0aGlzLm5ldHdvcmtTZXJ2aWNlLmlzQ29ubmVjdGVkKCkpKSB7XG4gICAgICAgICAgICB0aGlzLm5ldHdvcmtTZXJ2aWNlLmlzQXZhaWxhYmxlKHRydWUpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5jbGFzcyBTZXJ2aWNlQ2FsbEludGVyY2VwdG9yIGltcGxlbWVudHMgUmVxdWVzdEludGVyY2VwdG9yIHtcblxuICAgIHByaXZhdGUgc3RhdGljIFJFTU9URV9TRVJWSUNFX1VSTF9QQVRURVJOUyA9IFtcbiAgICAgICAgbmV3IFJlZ0V4cCgnXigoLi8pfC8pP3NlcnZpY2VzLycpLFxuICAgICAgICBuZXcgUmVnRXhwKCdqX3NwcmluZ19zZWN1cml0eV9jaGVjaycpLFxuICAgICAgICBuZXcgUmVnRXhwKCdqX3NwcmluZ19zZWN1cml0eV9sb2dvdXQnKVxuICAgIF07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwKSB7fVxuXG4gICAgcHVibGljIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogUHJvbWlzZTxIdHRwUmVxdWVzdDxhbnk+PiB7XG4gICAgICAgIGxldCBtb2RpZmllZFJlcXVlc3QgPSByZXF1ZXN0O1xuICAgICAgICBsZXQgdXJsID0gcmVxdWVzdC51cmw7XG4gICAgICAgIC8vIGlmIG5lY2Vzc2FyeSwgcHJlcGVuZCBkZXBsb3llZCB1cmxcbiAgICAgICAgaWYgKHVybC5pbmRleE9mKCc6Ly8nKSA8IDBcbiAgICAgICAgICAgICYmIFNlcnZpY2VDYWxsSW50ZXJjZXB0b3IuUkVNT1RFX1NFUlZJQ0VfVVJMX1BBVFRFUk5TLmZpbmQociA9PiByLnRlc3QodXJsKSkpIHtcbiAgICAgICAgICAgIHVybCA9IHRoaXMuYXBwLmRlcGxveWVkVXJsICsgdXJsO1xuICAgICAgICB9XG4gICAgICAgIHVybCA9IHJlbW92ZUV4dHJhU2xhc2hlcyh1cmwpO1xuICAgICAgICBpZiAodXJsICE9PSByZXF1ZXN0LnVybCkge1xuICAgICAgICAgICAgbW9kaWZpZWRSZXF1ZXN0ID0gcmVxdWVzdC5jbG9uZSh7XG4gICAgICAgICAgICAgICAgdXJsOiB1cmxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobW9kaWZpZWRSZXF1ZXN0KTtcbiAgICB9XG5cbn1cblxuY2xhc3MgUmVtb3RlU3luY0ludGVyY2VwdG9yIGltcGxlbWVudHMgUmVxdWVzdEludGVyY2VwdG9yIHtcblxuICAgIHByaXZhdGUgY2hlY2tSZW1vdGVEaXJlY3RvcnkgPSB0cnVlO1xuICAgIHByaXZhdGUgaGFzUmVtb3RlQ2hhbmdlcyA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgVVJMX1RPX1NZTkMgPSBbXG4gICAgICAgIG5ldyBSZWdFeHAoJ3BhZ2UubWluLmpzb24kJyksXG4gICAgICAgIG5ldyBSZWdFeHAoJ2FwcC5qcyQnKSxcbiAgICAgICAgbmV3IFJlZ0V4cCgnYXBwLnZhcmlhYmxlcy5qc29uJCcpXG4gICAgXTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwOiBBcHAsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlOiBEZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZGV2aWNlU2VydmljZTogRGV2aWNlU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGZpbGU6IEZpbGUsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBuZXR3b3JrU2VydmljZTogTmV0d29ya1NlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5maWxlLmNoZWNrRGlyKGNvcmRvdmEuZmlsZS5kYXRhRGlyZWN0b3J5LCAncmVtb3RlJykudGhlbigoKSA9PiB0aGlzLmhhc1JlbW90ZUNoYW5nZXMgPSB0cnVlLCBub29wKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBQcm9taXNlPEh0dHBSZXF1ZXN0PGFueT4+IHtcbiAgICAgICAgY29uc3QgaXNSZW1vdGVTeW5jRW5hYmxlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdyZW1vdGVTeW5jJykgPT09ICd0cnVlJztcbiAgICAgICAgaWYgKHRoaXMuaGFzUmVtb3RlQ2hhbmdlcyB8fCBpc1JlbW90ZVN5bmNFbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QudXJsKS50aGVuKHVybCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHVybC5pbmRleE9mKCc6Ly8nKSA8IDBcbiAgICAgICAgICAgICAgICAgICAgJiYgUmVtb3RlU3luY0ludGVyY2VwdG9yLlVSTF9UT19TWU5DLmZpbmQociA9PiByLnRlc3QodXJsKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZU5hbWVGcm9tVXJsID0gXy5sYXN0KF8uc3BsaXQodXJsLCAnLycpKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWQodXJsLCBmaWxlTmFtZUZyb21VcmwsIGlzUmVtb3RlU3luY0VuYWJsZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdXJsO1xuICAgICAgICAgICAgfSkudGhlbih1cmwgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh1cmwgIT09IHJlcXVlc3QudXJsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzUmVtb3RlQ2hhbmdlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXF1ZXN0LmNsb25lKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVxdWVzdDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlRm9sZGVyU3RydWN0dXJlKHBhcmVudEZvbGRlcjogc3RyaW5nLCBmb2xkZXJOYW1lc0xpc3Q6IHN0cmluZ1tdKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyTmFtZSA9IGZvbGRlck5hbWVzTGlzdFswXTtcbiAgICAgICAgaWYgKCFfLmlzRW1wdHkoZm9sZGVyTmFtZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGUuY3JlYXRlRGlyKHBhcmVudEZvbGRlciwgZm9sZGVyTmFtZSwgZmFsc2UpXG4gICAgICAgICAgICAgICAgLmNhdGNoKG5vb3ApXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnRGb2xkZXIgPSBwYXJlbnRGb2xkZXIgKyBmb2xkZXJOYW1lICsgJy8nO1xuICAgICAgICAgICAgICAgICAgICBmb2xkZXJOYW1lc0xpc3Quc2hpZnQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRm9sZGVyU3RydWN0dXJlKHBhcmVudEZvbGRlciwgZm9sZGVyTmFtZXNMaXN0KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHBhcmVudEZvbGRlcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0KHBhZ2VVcmw6IHN0cmluZywgaXNSZW1vdGVTeW5jRW5hYmxlZDogYm9vbGVhbikge1xuICAgICAgICBjb25zdCBmaWxlTmFtZSA9IF8ubGFzdChfLnNwbGl0KHBhZ2VVcmwsICcvJykpLFxuICAgICAgICAgICAgcGF0aCA9IF8ucmVwbGFjZShwYWdlVXJsLCBmaWxlTmFtZSwgJycpLFxuICAgICAgICAgICAgZm9sZGVyUGF0aCA9ICdyZW1vdGUnICsgXy5yZXBsYWNlKHBhdGgsIHRoaXMuYXBwLmRlcGxveWVkVXJsLCAnJyksXG4gICAgICAgICAgICBkb3dubG9hZHNQYXJlbnQgPSBjb3Jkb3ZhLmZpbGUuZGF0YURpcmVjdG9yeTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja1JlbW90ZURpcmVjdG9yeSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXZpY2VTZXJ2aWNlLmdldEFwcEJ1aWxkVGltZSgpLnRoZW4oYnVpbGRUaW1lID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW90ZVN5bmNJbmZvID0gdGhpcy5kZXZpY2VTZXJ2aWNlLmdldEVudHJ5KCdyZW1vdGUtc3luYycpIHx8IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW1vdGVTeW5jSW5mby5sYXN0QnVpbGRUaW1lIHx8IHJlbW90ZVN5bmNJbmZvLmxhc3RCdWlsZFRpbWUgIT09IGJ1aWxkVGltZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGUucmVtb3ZlRGlyKGNvcmRvdmEuZmlsZS5kYXRhRGlyZWN0b3J5LCAncmVtb3RlJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKG5vb3ApLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlU3luY0luZm8ubGFzdEJ1aWxkVGltZSA9IGJ1aWxkVGltZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzUmVtb3RlQ2hhbmdlcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGV2aWNlU2VydmljZS5zdG9yZUVudHJ5KCdyZW1vdGUtc3luYycsIHJlbW90ZVN5bmNJbmZvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4gdGhpcy5jaGVja1JlbW90ZURpcmVjdG9yeSA9IGZhbHNlKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuZmlsZS5jaGVja0Rpcihkb3dubG9hZHNQYXJlbnQsIGZvbGRlclBhdGgpKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gZG93bmxvYWRzUGFyZW50ICsgZm9sZGVyUGF0aCxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1JlbW90ZVN5bmNFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGb2xkZXJTdHJ1Y3R1cmUoZG93bmxvYWRzUGFyZW50LCBfLnNwbGl0KGZvbGRlclBhdGgsICcvJykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnQ291bGQgbm90IGZpbmQgZXF1aXZhbGVudCByZW1vdGUgcGF0aCcpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZG93bmxvYWQodXJsOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcsIGlzUmVtb3RlU3luY0VuYWJsZWQ6IGJvb2xlYW4pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCBwYWdlVXJsID0gdGhpcy5hcHAuZGVwbG95ZWRVcmwgKyAnLycgKyB1cmw7XG4gICAgICAgIGxldCBmb2xkZXJQYXRoO1xuICAgICAgICByZXR1cm4gdGhpcy5pbml0KHBhZ2VVcmwsIGlzUmVtb3RlU3luY0VuYWJsZWQpXG4gICAgICAgICAgICAudGhlbihwYXRoVG9SZW1vdGUgPT4ge1xuICAgICAgICAgICAgICAgIGZvbGRlclBhdGggPSBwYXRoVG9SZW1vdGU7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZS5jaGVja0ZpbGUoZm9sZGVyUGF0aCArIGZpbGVOYW1lLCAnJyk7XG4gICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoaXNSZW1vdGVTeW5jRW5hYmxlZCAmJiB0aGlzLm5ldHdvcmtTZXJ2aWNlLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZS5yZW1vdmVGaWxlKGZvbGRlclBhdGgsIGZpbGVOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gZm9sZGVyUGF0aCArIGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZvbGRlclBhdGggKyBmaWxlTmFtZTtcbiAgICAgICAgICAgIH0sICgpID0+IHVybClcbiAgICAgICAgICAgIC50aGVuKHBhdGggPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpc1JlbW90ZVN5bmNFbmFibGVkICYmIHRoaXMubmV0d29ya1NlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlLmRvd25sb2FkKHBhZ2VVcmwsIGZhbHNlLCBmb2xkZXJQYXRoLCBmaWxlTmFtZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBwYXRoO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG59XG5cbmNsYXNzIFNlY3VyaXR5SW50ZXJjZXB0b3IgaW1wbGVtZW50cyBSZXF1ZXN0SW50ZXJjZXB0b3Ige1xuXG4gICAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIFBBR0VfVVJMX1BBVFRFUk4gPSBuZXcgUmVnRXhwKCdwYWdlLm1pbi5qc29uJCcpO1xuICAgIHByaXZhdGUgcHVibGljUGFnZXM7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwLCBwcml2YXRlIGZpbGU6IEZpbGUsIHByaXZhdGUgc2VjdXJpdHlTZXJ2aWNlOiBTZWN1cml0eVNlcnZpY2UpIHt9XG5cbiAgICBwdWJsaWMgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBQcm9taXNlPEh0dHBSZXF1ZXN0PGFueT4+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEh0dHBSZXF1ZXN0PGFueT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGlmIChTZWN1cml0eUludGVyY2VwdG9yLlBBR0VfVVJMX1BBVFRFUk4udGVzdChyZXF1ZXN0LnVybCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybFNwbGl0cyA9IF8uc3BsaXQocmVxdWVzdC51cmwsICcvJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhZ2VOYW1lID0gdXJsU3BsaXRzW3VybFNwbGl0cy5sZW5ndGggLSAyXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnB1YmxpY1BhZ2VzIHx8IHRoaXMucHVibGljUGFnZXNbcGFnZU5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWN1cml0eVNlcnZpY2UuZ2V0Q29uZmlnKGNvbmZpZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25maWcuc2VjdXJpdHlFbmFibGVkIHx8IGNvbmZpZy5hdXRoZW50aWNhdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGBQYWdlICcke3BhZ2VOYW1lfScgaXMgbm90IGFjY2Vzc2libGUgdG8gdGhlIHVzZXIuYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLm5vdGlmeSgnaHR0cDQwMScsIHsgcGFnZTogcGFnZU5hbWV9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAoKSA9PiByZWplY3QoYFNlY3VyaXR5IGNhbGwgZmFpbGVkLmApKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgIH0pLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHJlcXVlc3QpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBsb2FkcyBwdWJsaWMgcGFnZXMgZnJvbSAnbWV0YWRhdGEvYXBwL3B1YmxpYy1wYWdlcy5pbmZvJyBhbmQgb3ZlcnJpZGVzIGNhbkFjY2VzcyBtZXRob2QgU2VjdXJpdHlTZXJ2aWNlXG4gICAgICovXG4gICAgcHJpdmF0ZSBpbml0KCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IGZvbGRlclBhdGggPSBjb3Jkb3ZhLmZpbGUuYXBwbGljYXRpb25EaXJlY3RvcnkgKyAnd3d3L21ldGFkYXRhL2FwcCcsXG4gICAgICAgICAgICBmaWxlTmFtZSA9ICdwdWJsaWMtcGFnZXMuanNvbic7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbGUucmVhZEFzVGV4dChmb2xkZXJQYXRoLCBmaWxlTmFtZSkudGhlbih0ZXh0ID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgICAgIHRoaXMucHVibGljUGFnZXMgPSB7fTtcbiAgICAgICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBfLmZvckVhY2goSlNPTi5wYXJzZSh0ZXh0KSwgcGFnZU5hbWUgPT4gdGhpcy5wdWJsaWNQYWdlc1twYWdlTmFtZV0gPSB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==