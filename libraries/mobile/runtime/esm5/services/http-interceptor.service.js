import { Injectable } from '@angular/core';
import { File } from '@ionic-native/file';
import { from, Subject } from 'rxjs';
import { mergeMap } from 'rxjs/operators';
import { App, executePromiseChain, getWmProjectProperties, hasCordova, noop, removeExtraSlashes } from '@wm/core';
import { DeviceFileDownloadService, DeviceService, NetworkService } from '@wm/mobile/core';
import { SecurityService } from '@wm/security';
import { CONSTANTS } from '@wm/variables';
var MobileHttpInterceptor = /** @class */ (function () {
    function MobileHttpInterceptor(app, file, deviceFileDownloadService, deviceService, networkService, securityService) {
        this.app = app;
        this.deviceService = deviceService;
        this.networkService = networkService;
        this.requestInterceptors = [];
        if (hasCordova() && !CONSTANTS.isWaveLens) {
            this.requestInterceptors.push(new SecurityInterceptor(app, file, securityService));
            this.requestInterceptors.push(new RemoteSyncInterceptor(app, deviceFileDownloadService, deviceService, file, networkService));
            this.requestInterceptors.push(new ServiceCallInterceptor(app));
        }
    }
    MobileHttpInterceptor.prototype.intercept = function (request, next) {
        var _this = this;
        var subject = new Subject();
        var token = localStorage.getItem(CONSTANTS.XSRF_COOKIE_NAME);
        if (token) {
            // Clone the request to add the new header
            request = request.clone({ headers: request.headers.set(getWmProjectProperties().xsrf_header_name, token) });
        }
        var data = { request: request };
        // invoke the request only when device is ready.
        var obs = from(this.deviceService.whenReady()
            .then(function () { return executePromiseChain(_this.getInterceptors(), [data]); }));
        return obs.pipe(mergeMap(function () {
            return next.handle(data.request);
        }));
    };
    MobileHttpInterceptor.prototype.getInterceptors = function () {
        return this.requestInterceptors.map(function (i) {
            return function (data) { return i.intercept(data.request).then(function (req) { return data.request = req; }); };
        });
    };
    MobileHttpInterceptor.prototype.onHttpError = function (response) {
        if (hasCordova
            && (!response || !response.status || response.status < 0 || response.status === 404)
            && (this.networkService.isConnected())) {
            this.networkService.isAvailable(true);
        }
    };
    MobileHttpInterceptor.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    MobileHttpInterceptor.ctorParameters = function () { return [
        { type: App },
        { type: File },
        { type: DeviceFileDownloadService },
        { type: DeviceService },
        { type: NetworkService },
        { type: SecurityService }
    ]; };
    return MobileHttpInterceptor;
}());
export { MobileHttpInterceptor };
var ServiceCallInterceptor = /** @class */ (function () {
    function ServiceCallInterceptor(app) {
        this.app = app;
    }
    ServiceCallInterceptor.prototype.intercept = function (request) {
        var modifiedRequest = request;
        var url = request.url;
        // if necessary, prepend deployed url
        if (url.indexOf('://') < 0
            && ServiceCallInterceptor.REMOTE_SERVICE_URL_PATTERNS.find(function (r) { return r.test(url); })) {
            url = this.app.deployedUrl + url;
        }
        url = removeExtraSlashes(url);
        if (url !== request.url) {
            modifiedRequest = request.clone({
                url: url
            });
        }
        return Promise.resolve(modifiedRequest);
    };
    ServiceCallInterceptor.REMOTE_SERVICE_URL_PATTERNS = [
        new RegExp('^((./)|/)?services/'),
        new RegExp('j_spring_security_check'),
        new RegExp('j_spring_security_logout')
    ];
    return ServiceCallInterceptor;
}());
var RemoteSyncInterceptor = /** @class */ (function () {
    function RemoteSyncInterceptor(app, deviceFileDownloadService, deviceService, file, networkService) {
        var _this = this;
        this.app = app;
        this.deviceFileDownloadService = deviceFileDownloadService;
        this.deviceService = deviceService;
        this.file = file;
        this.networkService = networkService;
        this.checkRemoteDirectory = true;
        this.hasRemoteChanges = false;
        this.file.checkDir(cordova.file.dataDirectory, 'remote').then(function () { return _this.hasRemoteChanges = true; }, noop);
    }
    RemoteSyncInterceptor.prototype.intercept = function (request) {
        var _this = this;
        var isRemoteSyncEnabled = localStorage.getItem('remoteSync') === 'true';
        if (this.hasRemoteChanges || isRemoteSyncEnabled) {
            return Promise.resolve(request.url).then(function (url) {
                if (url.indexOf('://') < 0
                    && RemoteSyncInterceptor.URL_TO_SYNC.find(function (r) { return r.test(url); })) {
                    var fileNameFromUrl = _.last(_.split(url, '/'));
                    return _this.download(url, fileNameFromUrl, isRemoteSyncEnabled);
                }
                return url;
            }).then(function (url) {
                if (url !== request.url) {
                    _this.hasRemoteChanges = true;
                    return request.clone({
                        url: url
                    });
                }
                return request;
            });
        }
        else {
            return Promise.resolve(request);
        }
    };
    RemoteSyncInterceptor.prototype.createFolderStructure = function (parentFolder, folderNamesList) {
        var _this = this;
        var folderName = folderNamesList[0];
        if (!_.isEmpty(folderName)) {
            return this.file.createDir(parentFolder, folderName, false)
                .catch(noop)
                .then(function () {
                parentFolder = parentFolder + folderName + '/';
                folderNamesList.shift();
                return _this.createFolderStructure(parentFolder, folderNamesList);
            });
        }
        return Promise.resolve(parentFolder);
    };
    RemoteSyncInterceptor.prototype.init = function (pageUrl, isRemoteSyncEnabled) {
        var _this = this;
        var fileName = _.last(_.split(pageUrl, '/')), path = _.replace(pageUrl, fileName, ''), folderPath = 'remote' + _.replace(path, this.app.deployedUrl, ''), downloadsParent = cordova.file.dataDirectory;
        return new Promise(function (resolve, reject) {
            if (_this.checkRemoteDirectory) {
                return _this.deviceService.getAppBuildTime().then(function (buildTime) {
                    var remoteSyncInfo = _this.deviceService.getEntry('remote-sync') || {};
                    if (!remoteSyncInfo.lastBuildTime || remoteSyncInfo.lastBuildTime !== buildTime) {
                        return _this.file.removeDir(cordova.file.dataDirectory, 'remote')
                            .catch(noop).then(function () {
                            remoteSyncInfo.lastBuildTime = buildTime;
                            _this.hasRemoteChanges = false;
                            return _this.deviceService.storeEntry('remote-sync', remoteSyncInfo);
                        });
                    }
                }).then(function () { return _this.checkRemoteDirectory = false; })
                    .then(resolve, reject);
            }
            resolve();
        })
            .then(function () { return _this.file.checkDir(downloadsParent, folderPath); })
            .then(function () { return downloadsParent + folderPath; }, function () {
            if (isRemoteSyncEnabled) {
                return _this.createFolderStructure(downloadsParent, _.split(folderPath, '/'));
            }
            return Promise.reject('Could not find equivalent remote path');
        });
    };
    RemoteSyncInterceptor.prototype.download = function (url, fileName, isRemoteSyncEnabled) {
        var _this = this;
        var pageUrl = this.app.deployedUrl + '/' + url;
        var folderPath;
        return this.init(pageUrl, isRemoteSyncEnabled)
            .then(function (pathToRemote) {
            folderPath = pathToRemote;
            return _this.file.checkFile(folderPath + fileName, '');
        }).then(function () {
            if (isRemoteSyncEnabled && _this.networkService.isConnected()) {
                return _this.file.removeFile(folderPath, fileName)
                    .then(function () { return folderPath + fileName; });
            }
            return folderPath + fileName;
        }, function () { return url; })
            .then(function (path) {
            if (isRemoteSyncEnabled && _this.networkService.isConnected()) {
                return _this.deviceFileDownloadService.download(pageUrl, false, folderPath, fileName);
            }
            return path;
        });
    };
    RemoteSyncInterceptor.URL_TO_SYNC = [
        new RegExp('page.min.json$'),
        new RegExp('app.js$'),
        new RegExp('app.variables.json$')
    ];
    return RemoteSyncInterceptor;
}());
var SecurityInterceptor = /** @class */ (function () {
    function SecurityInterceptor(app, file, securityService) {
        this.app = app;
        this.file = file;
        this.securityService = securityService;
        this.initialized = false;
    }
    SecurityInterceptor.prototype.intercept = function (request) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (SecurityInterceptor.PAGE_URL_PATTERN.test(request.url)) {
                return Promise.resolve().then(function () {
                    if (!_this.initialized) {
                        return _this.init();
                    }
                }).then(function () {
                    var urlSplits = _.split(request.url, '/');
                    var pageName = urlSplits[urlSplits.length - 2];
                    if (!_this.publicPages || _this.publicPages[pageName]) {
                        return Promise.resolve(request);
                    }
                    else {
                        _this.securityService.getConfig(function (config) {
                            if (!config.securityEnabled || config.authenticated) {
                                resolve(request);
                            }
                            else {
                                reject("Page '" + pageName + "' is not accessible to the user.");
                                _this.app.notify('http401', { page: pageName });
                            }
                        }, function () { return reject("Security call failed."); });
                    }
                    return Promise.resolve(request);
                }).then(resolve, reject);
            }
            return resolve(request);
        });
    };
    /**
     * loads public pages from 'metadata/app/public-pages.info' and overrides canAccess method SecurityService
     */
    SecurityInterceptor.prototype.init = function () {
        var _this = this;
        var folderPath = cordova.file.applicationDirectory + 'www/metadata/app', fileName = 'public-pages.json';
        return this.file.readAsText(folderPath, fileName).then(function (text) {
            if (!_this.initialized) {
                _this.publicPages = {};
                _this.initialized = true;
                _.forEach(JSON.parse(text), function (pageName) { return _this.publicPages[pageName] = true; });
            }
        }).catch(function () {
            _this.initialized = true;
        });
    };
    SecurityInterceptor.PAGE_URL_PATTERN = new RegExp('page.min.json$');
    return SecurityInterceptor;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1pbnRlcmNlcHRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL21vYmlsZS9ydW50aW1lLyIsInNvdXJjZXMiOlsic2VydmljZXMvaHR0cC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxJQUFJLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUxQyxPQUFPLEVBQUUsR0FBRyxFQUFFLG1CQUFtQixFQUFFLHNCQUFzQixFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFTMUM7SUFLSSwrQkFBMkIsR0FBUSxFQUNoQixJQUFVLEVBQ1YseUJBQW9ELEVBQzVDLGFBQTRCLEVBQzVCLGNBQThCLEVBQ3RDLGVBQWdDO1FBTHhCLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFHUixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFOakQsd0JBQW1CLEdBQXlCLEVBQUUsQ0FBQztRQVFuRCxJQUFJLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRTtZQUN2QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksbUJBQW1CLENBQUMsR0FBRyxFQUFFLElBQUksRUFB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QVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJO1lBQ3ZELElBQUksQ0FBQyxLQUFJLENBQUMsV0FBVyxFQUFFO2dCQUNuQixLQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztnQkFDdEIsS0FBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFBLFFBQVEsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsSUFBSSxFQUFqQyxDQUFpQyxDQUFDLENBQUM7YUFDOUU7UUFDTCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDTCxLQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFqRGMsb0NBQWdCLEdBQUcsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQWtEbkUsMEJBQUM7Q0FBQSxBQXJERCxJQXFEQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJ0Bpb25pYy1uYXRpdmUvZmlsZSc7XG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXBwLCBleGVjdXRlUHJvbWlzZUNoYWluLCBnZXRXbVByb2plY3RQcm9wZXJ0aWVzLCBoYXNDb3Jkb3ZhLCBub29wLCByZW1vdmVFeHRyYVNsYXNoZXMgfSBmcm9tICdAd20vY29yZSc7XG5pbXBvcnQgeyBEZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlLCBEZXZpY2VTZXJ2aWNlLCBOZXR3b3JrU2VydmljZSB9IGZyb20gJ0B3bS9tb2JpbGUvY29yZSc7XG5pbXBvcnQgeyBTZWN1cml0eVNlcnZpY2UgfSBmcm9tICdAd20vc2VjdXJpdHknO1xuaW1wb3J0IHsgQ09OU1RBTlRTIH0gZnJvbSAnQHdtL3ZhcmlhYmxlcyc7XG5cbmRlY2xhcmUgY29uc3QgY29yZG92YTtcbmRlY2xhcmUgY29uc3QgXztcblxuaW50ZXJmYWNlIFJlcXVlc3RJbnRlcmNlcHRvciB7XG4gICAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBQcm9taXNlPEh0dHBSZXF1ZXN0PGFueT4+O1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTW9iaWxlSHR0cEludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcblxuICAgIHByaXZhdGUgcmVxdWVzdEludGVyY2VwdG9yczogUmVxdWVzdEludGVyY2VwdG9yW10gPSBbXTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwLFxuICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBGaWxlLFxuICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlOiBEZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIGRldmljZVNlcnZpY2U6IERldmljZVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgICAgICAgIHByaXZhdGUgbmV0d29ya1NlcnZpY2U6IE5ldHdvcmtTZXJ2aWNlLFxuICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eVNlcnZpY2U6IFNlY3VyaXR5U2VydmljZSkge1xuICAgICAgICBpZiAoaGFzQ29yZG92YSgpICYmICFDT05TVEFOVFMuaXNXYXZlTGVucykge1xuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3JzLnB1c2gobmV3IFNlY3VyaXR5SW50ZXJjZXB0b3IoYXBwLCBmaWxlLCBzZWN1cml0eVNlcnZpY2UpKTtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9ycy5wdXNoKG5ldyBSZW1vdGVTeW5jSW50ZXJjZXB0b3IoYXBwLCBkZXZpY2VGaWxlRG93bmxvYWRTZXJ2aWNlLCBkZXZpY2VTZXJ2aWNlLCBmaWxlLCBuZXR3b3JrU2VydmljZSkpO1xuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0SW50ZXJjZXB0b3JzLnB1c2gobmV3IFNlcnZpY2VDYWxsSW50ZXJjZXB0b3IoYXBwKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFN1YmplY3Q8SHR0cEV2ZW50PGFueT4+KCk7XG4gICAgICAgIGNvbnN0IHRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQ09OU1RBTlRTLlhTUkZfQ09PS0lFX05BTUUpO1xuICAgICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgICAgIC8vIENsb25lIHRoZSByZXF1ZXN0IHRvIGFkZCB0aGUgbmV3IGhlYWRlclxuICAgICAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3QuY2xvbmUoeyBoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnMuc2V0KGdldFdtUHJvamVjdFByb3BlcnRpZXMoKS54c3JmX2hlYWRlcl9uYW1lLCB0b2tlbikgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGF0YSA9IHtyZXF1ZXN0OiByZXF1ZXN0fTtcblxuICAgICAgICAvLyBpbnZva2UgdGhlIHJlcXVlc3Qgb25seSB3aGVuIGRldmljZSBpcyByZWFkeS5cbiAgICAgICAgY29uc3Qgb2JzID0gZnJvbSh0aGlzLmRldmljZVNlcnZpY2Uud2hlblJlYWR5KClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGV4ZWN1dGVQcm9taXNlQ2hhaW4odGhpcy5nZXRJbnRlcmNlcHRvcnMoKSwgW2RhdGFdKSkpO1xuICAgICAgICByZXR1cm4gb2JzLnBpcGUobWVyZ2VNYXAoKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQuaGFuZGxlKGRhdGEucmVxdWVzdCk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEludGVyY2VwdG9ycygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdEludGVyY2VwdG9ycy5tYXAoaSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKGRhdGEpID0+IGkuaW50ZXJjZXB0KGRhdGEucmVxdWVzdCkudGhlbihyZXEgPT4gZGF0YS5yZXF1ZXN0ID0gcmVxKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkh0dHBFcnJvcihyZXNwb25zZTogSHR0cFJlc3BvbnNlPGFueT4pIHtcbiAgICAgICAgaWYgKGhhc0NvcmRvdmFcbiAgICAgICAgICAgICYmICghcmVzcG9uc2UgfHwgIXJlc3BvbnNlLnN0YXR1cyB8fCByZXNwb25zZS5zdGF0dXMgPCAwIHx8IHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KVxuICAgICAgICAgICAgJiYgKHRoaXMubmV0d29ya1NlcnZpY2UuaXNDb25uZWN0ZWQoKSkpIHtcbiAgICAgICAgICAgIHRoaXMubmV0d29ya1NlcnZpY2UuaXNBdmFpbGFibGUodHJ1ZSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNsYXNzIFNlcnZpY2VDYWxsSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBSZXF1ZXN0SW50ZXJjZXB0b3Ige1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgUkVNT1RFX1NFUlZJQ0VfVVJMX1BBVFRFUk5TID0gW1xuICAgICAgICBuZXcgUmVnRXhwKCdeKCguLyl8Lyk/c2VydmljZXMvJyksXG4gICAgICAgIG5ldyBSZWdFeHAoJ2pfc3ByaW5nX3NlY3VyaXR5X2NoZWNrJyksXG4gICAgICAgIG5ldyBSZWdFeHAoJ2pfc3ByaW5nX3NlY3VyaXR5X2xvZ291dCcpXG4gICAgXTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwOiBBcHApIHt9XG5cbiAgICBwdWJsaWMgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBQcm9taXNlPEh0dHBSZXF1ZXN0PGFueT4+IHtcbiAgICAgICAgbGV0IG1vZGlmaWVkUmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgIGxldCB1cmwgPSByZXF1ZXN0LnVybDtcbiAgICAgICAgLy8gaWYgbmVjZXNzYXJ5LCBwcmVwZW5kIGRlcGxveWVkIHVybFxuICAgICAgICBpZiAodXJsLmluZGV4T2YoJzovLycpIDwgMFxuICAgICAgICAgICAgJiYgU2VydmljZUNhbGxJbnRlcmNlcHRvci5SRU1PVEVfU0VSVklDRV9VUkxfUEFUVEVSTlMuZmluZChyID0+IHIudGVzdCh1cmwpKSkge1xuICAgICAgICAgICAgdXJsID0gdGhpcy5hcHAuZGVwbG95ZWRVcmwgKyB1cmw7XG4gICAgICAgIH1cbiAgICAgICAgdXJsID0gcmVtb3ZlRXh0cmFTbGFzaGVzKHVybCk7XG4gICAgICAgIGlmICh1cmwgIT09IHJlcXVlc3QudXJsKSB7XG4gICAgICAgICAgICBtb2RpZmllZFJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKHtcbiAgICAgICAgICAgICAgICB1cmw6IHVybFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtb2RpZmllZFJlcXVlc3QpO1xuICAgIH1cblxufVxuXG5jbGFzcyBSZW1vdGVTeW5jSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBSZXF1ZXN0SW50ZXJjZXB0b3Ige1xuXG4gICAgcHJpdmF0ZSBjaGVja1JlbW90ZURpcmVjdG9yeSA9IHRydWU7XG4gICAgcHJpdmF0ZSBoYXNSZW1vdGVDaGFuZ2VzID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBVUkxfVE9fU1lOQyA9IFtcbiAgICAgICAgbmV3IFJlZ0V4cCgncGFnZS5taW4uanNvbiQnKSxcbiAgICAgICAgbmV3IFJlZ0V4cCgnYXBwLmpzJCcpLFxuICAgICAgICBuZXcgUmVnRXhwKCdhcHAudmFyaWFibGVzLmpzb24kJylcbiAgICBdO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEFwcCxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGRldmljZUZpbGVEb3dubG9hZFNlcnZpY2U6IERldmljZUZpbGVEb3dubG9hZFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkZXZpY2VTZXJ2aWNlOiBEZXZpY2VTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZmlsZTogRmlsZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG5ldHdvcmtTZXJ2aWNlOiBOZXR3b3JrU2VydmljZSkge1xuICAgICAgICB0aGlzLmZpbGUuY2hlY2tEaXIoY29yZG92YS5maWxlLmRhdGFEaXJlY3RvcnksICdyZW1vdGUnKS50aGVuKCgpID0+IHRoaXMuaGFzUmVtb3RlQ2hhbmdlcyA9IHRydWUsIG5vb3ApO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IFByb21pc2U8SHR0cFJlcXVlc3Q8YW55Pj4ge1xuICAgICAgICBjb25zdCBpc1JlbW90ZVN5bmNFbmFibGVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3JlbW90ZVN5bmMnKSA9PT0gJ3RydWUnO1xuICAgICAgICBpZiAodGhpcy5oYXNSZW1vdGVDaGFuZ2VzIHx8IGlzUmVtb3RlU3luY0VuYWJsZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVxdWVzdC51cmwpLnRoZW4odXJsID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJzovLycpIDwgMFxuICAgICAgICAgICAgICAgICAgICAmJiBSZW1vdGVTeW5jSW50ZXJjZXB0b3IuVVJMX1RPX1NZTkMuZmluZChyID0+IHIudGVzdCh1cmwpKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlTmFtZUZyb21VcmwgPSBfLmxhc3QoXy5zcGxpdCh1cmwsICcvJykpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb3dubG9hZCh1cmwsIGZpbGVOYW1lRnJvbVVybCwgaXNSZW1vdGVTeW5jRW5hYmxlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB1cmw7XG4gICAgICAgICAgICB9KS50aGVuKHVybCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHVybCAhPT0gcmVxdWVzdC51cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNSZW1vdGVDaGFuZ2VzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiByZXF1ZXN0O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcXVlc3QpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVGb2xkZXJTdHJ1Y3R1cmUocGFyZW50Rm9sZGVyOiBzdHJpbmcsIGZvbGRlck5hbWVzTGlzdDogc3RyaW5nW10pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCBmb2xkZXJOYW1lID0gZm9sZGVyTmFtZXNMaXN0WzBdO1xuICAgICAgICBpZiAoIV8uaXNFbXB0eShmb2xkZXJOYW1lKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZS5jcmVhdGVEaXIocGFyZW50Rm9sZGVyLCBmb2xkZXJOYW1lLCBmYWxzZSlcbiAgICAgICAgICAgICAgICAuY2F0Y2gobm9vcClcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudEZvbGRlciA9IHBhcmVudEZvbGRlciArIGZvbGRlck5hbWUgKyAnLyc7XG4gICAgICAgICAgICAgICAgICAgIGZvbGRlck5hbWVzTGlzdC5zaGlmdCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGb2xkZXJTdHJ1Y3R1cmUocGFyZW50Rm9sZGVyLCBmb2xkZXJOYW1lc0xpc3QpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocGFyZW50Rm9sZGVyKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXQocGFnZVVybDogc3RyaW5nLCBpc1JlbW90ZVN5bmNFbmFibGVkOiBib29sZWFuKSB7XG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gXy5sYXN0KF8uc3BsaXQocGFnZVVybCwgJy8nKSksXG4gICAgICAgICAgICBwYXRoID0gXy5yZXBsYWNlKHBhZ2VVcmwsIGZpbGVOYW1lLCAnJyksXG4gICAgICAgICAgICBmb2xkZXJQYXRoID0gJ3JlbW90ZScgKyBfLnJlcGxhY2UocGF0aCwgdGhpcy5hcHAuZGVwbG95ZWRVcmwsICcnKSxcbiAgICAgICAgICAgIGRvd25sb2Fkc1BhcmVudCA9IGNvcmRvdmEuZmlsZS5kYXRhRGlyZWN0b3J5O1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUmVtb3RlRGlyZWN0b3J5KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRldmljZVNlcnZpY2UuZ2V0QXBwQnVpbGRUaW1lKCkudGhlbihidWlsZFRpbWUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3RlU3luY0luZm8gPSB0aGlzLmRldmljZVNlcnZpY2UuZ2V0RW50cnkoJ3JlbW90ZS1zeW5jJykgfHwge307XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbW90ZVN5bmNJbmZvLmxhc3RCdWlsZFRpbWUgfHwgcmVtb3RlU3luY0luZm8ubGFzdEJ1aWxkVGltZSAhPT0gYnVpbGRUaW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZS5yZW1vdmVEaXIoY29yZG92YS5maWxlLmRhdGFEaXJlY3RvcnksICdyZW1vdGUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2gobm9vcCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVTeW5jSW5mby5sYXN0QnVpbGRUaW1lID0gYnVpbGRUaW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNSZW1vdGVDaGFuZ2VzID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXZpY2VTZXJ2aWNlLnN0b3JlRW50cnkoJ3JlbW90ZS1zeW5jJywgcmVtb3RlU3luY0luZm8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSkudGhlbigoKSA9PiB0aGlzLmNoZWNrUmVtb3RlRGlyZWN0b3J5ID0gZmFsc2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZXNvbHZlLCByZWplY3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5maWxlLmNoZWNrRGlyKGRvd25sb2Fkc1BhcmVudCwgZm9sZGVyUGF0aCkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiBkb3dubG9hZHNQYXJlbnQgKyBmb2xkZXJQYXRoLFxuICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzUmVtb3RlU3luY0VuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZvbGRlclN0cnVjdHVyZShkb3dubG9hZHNQYXJlbnQsIF8uc3BsaXQoZm9sZGVyUGF0aCwgJy8nKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdDb3VsZCBub3QgZmluZCBlcXVpdmFsZW50IHJlbW90ZSBwYXRoJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb3dubG9hZCh1cmw6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgaXNSZW1vdGVTeW5jRW5hYmxlZDogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGNvbnN0IHBhZ2VVcmwgPSB0aGlzLmFwcC5kZXBsb3llZFVybCArICcvJyArIHVybDtcbiAgICAgICAgbGV0IGZvbGRlclBhdGg7XG4gICAgICAgIHJldHVybiB0aGlzLmluaXQocGFnZVVybCwgaXNSZW1vdGVTeW5jRW5hYmxlZClcbiAgICAgICAgICAgIC50aGVuKHBhdGhUb1JlbW90ZSA9PiB7XG4gICAgICAgICAgICAgICAgZm9sZGVyUGF0aCA9IHBhdGhUb1JlbW90ZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWxlLmNoZWNrRmlsZShmb2xkZXJQYXRoICsgZmlsZU5hbWUsICcnKTtcbiAgICAgICAgICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpc1JlbW90ZVN5bmNFbmFibGVkICYmIHRoaXMubmV0d29ya1NlcnZpY2UuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maWxlLnJlbW92ZUZpbGUoZm9sZGVyUGF0aCwgZmlsZU5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiBmb2xkZXJQYXRoICsgZmlsZU5hbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZm9sZGVyUGF0aCArIGZpbGVOYW1lO1xuICAgICAgICAgICAgfSwgKCkgPT4gdXJsKVxuICAgICAgICAgICAgLnRoZW4ocGF0aCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGlzUmVtb3RlU3luY0VuYWJsZWQgJiYgdGhpcy5uZXR3b3JrU2VydmljZS5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRldmljZUZpbGVEb3dubG9hZFNlcnZpY2UuZG93bmxvYWQocGFnZVVybCwgZmFsc2UsIGZvbGRlclBhdGgsIGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGg7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbn1cblxuY2xhc3MgU2VjdXJpdHlJbnRlcmNlcHRvciBpbXBsZW1lbnRzIFJlcXVlc3RJbnRlcmNlcHRvciB7XG5cbiAgICBwcml2YXRlIGluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBzdGF0aWMgUEFHRV9VUkxfUEFUVEVSTiA9IG5ldyBSZWdFeHAoJ3BhZ2UubWluLmpzb24kJyk7XG4gICAgcHJpdmF0ZSBwdWJsaWNQYWdlcztcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwOiBBcHAsIHByaXZhdGUgZmlsZTogRmlsZSwgcHJpdmF0ZSBzZWN1cml0eVNlcnZpY2U6IFNlY3VyaXR5U2VydmljZSkge31cblxuICAgIHB1YmxpYyBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IFByb21pc2U8SHR0cFJlcXVlc3Q8YW55Pj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SHR0cFJlcXVlc3Q8YW55Pj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKFNlY3VyaXR5SW50ZXJjZXB0b3IuUEFHRV9VUkxfUEFUVEVSTi50ZXN0KHJlcXVlc3QudXJsKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbml0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsU3BsaXRzID0gXy5zcGxpdChyZXF1ZXN0LnVybCwgJy8nKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFnZU5hbWUgPSB1cmxTcGxpdHNbdXJsU3BsaXRzLmxlbmd0aCAtIDJdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucHVibGljUGFnZXMgfHwgdGhpcy5wdWJsaWNQYWdlc1twYWdlTmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlY3VyaXR5U2VydmljZS5nZXRDb25maWcoY29uZmlnID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5zZWN1cml0eUVuYWJsZWQgfHwgY29uZmlnLmF1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXF1ZXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoYFBhZ2UgJyR7cGFnZU5hbWV9JyBpcyBub3QgYWNjZXNzaWJsZSB0byB0aGUgdXNlci5gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAubm90aWZ5KCdodHRwNDAxJywgeyBwYWdlOiBwYWdlTmFtZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sICgpID0+IHJlamVjdChgU2VjdXJpdHkgY2FsbCBmYWlsZWQuYCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVxdWVzdCk7XG4gICAgICAgICAgICAgICAgfSkudGhlbihyZXNvbHZlLCByZWplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVxdWVzdCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGxvYWRzIHB1YmxpYyBwYWdlcyBmcm9tICdtZXRhZGF0YS9hcHAvcHVibGljLXBhZ2VzLmluZm8nIGFuZCBvdmVycmlkZXMgY2FuQWNjZXNzIG1ldGhvZCBTZWN1cml0eVNlcnZpY2VcbiAgICAgKi9cbiAgICBwcml2YXRlIGluaXQoKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyUGF0aCA9IGNvcmRvdmEuZmlsZS5hcHBsaWNhdGlvbkRpcmVjdG9yeSArICd3d3cvbWV0YWRhdGEvYXBwJyxcbiAgICAgICAgICAgIGZpbGVOYW1lID0gJ3B1YmxpYy1wYWdlcy5qc29uJztcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZS5yZWFkQXNUZXh0KGZvbGRlclBhdGgsIGZpbGVOYW1lKS50aGVuKHRleHQgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmluaXRpYWxpemVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wdWJsaWNQYWdlcyA9IHt9O1xuICAgICAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIF8uZm9yRWFjaChKU09OLnBhcnNlKHRleHQpLCBwYWdlTmFtZSA9PiB0aGlzLnB1YmxpY1BhZ2VzW3BhZ2VOYW1lXSA9IHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19