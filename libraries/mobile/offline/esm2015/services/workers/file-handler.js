import { noop } from '@wm/core';
const STORE_KEY = 'offlineFileUpload';
export class FileHandler {
    constructor() {
        this.logger = window.console;
    }
    preFlush(context) {
        this.fileStore = context.get(STORE_KEY);
    }
    /**
     * Replaces all local paths with the remote path using mappings created during 'uploadToServer'.
     */
    preCall(change) {
        if (change.service === 'DatabaseService') {
            change.params.data = _.mapValues(change.params.data, v => {
                const remoteUrl = this.fileStore[v];
                if (remoteUrl) {
                    this.logger.debug('swapped file path from %s -> %s', v, remoteUrl);
                    return remoteUrl;
                }
                return v;
            });
        }
    }
    postCallSuccess(change, response) {
        if (change.service === 'OfflineFileUploadService'
            && change.operation === 'uploadToServer') {
            const remoteFile = JSON.parse(response[0].text)[0];
            /*
             * A mapping will be created between local path and remote path.
             * This will be used to resolve local paths in entities.
             */
            this.fileStore[change.params.file] = remoteFile.path;
            this.fileStore[change.params.file + '?inline'] = remoteFile.inlinePath;
        }
    }
}
export class UploadedFilesImportAndExportService {
    constructor(changeLogService, deviceFileService, localDBManagementService, file) {
        this.changeLogService = changeLogService;
        this.deviceFileService = deviceFileService;
        this.localDBManagementService = localDBManagementService;
        this.file = file;
    }
    preExport(folderToExport, meta) {
        // copy offline uploads
        const uploadFullPath = this.deviceFileService.getUploadDirectory(), lastIndexOfSep = uploadFullPath.lastIndexOf('/'), uploadParentDir = uploadFullPath.substring(0, lastIndexOfSep + 1), uploadDirName = uploadFullPath.substring(lastIndexOfSep + 1);
        meta.uploadDir = uploadFullPath;
        return this.file.copyDir(uploadParentDir, uploadDirName, folderToExport, 'uploads');
    }
    postImport(importedFolder, meta) {
        const uploadFullPath = this.deviceFileService.getUploadDirectory(), lastIndexOfSep = uploadFullPath.lastIndexOf('/'), uploadParentDir = uploadFullPath.substring(0, lastIndexOfSep + 1), uploadDirName = uploadFullPath.substring(lastIndexOfSep + 1);
        this.uploadDir = uploadFullPath;
        return this.file.checkDir(importedFolder, 'uploads')
            .then(() => {
            return this.deviceFileService.removeDir(uploadFullPath)
                .then(() => this.file.copyDir(importedFolder, 'uploads', uploadParentDir, uploadDirName))
                .then(() => this.updateChanges(meta));
        }, noop);
    }
    /**
     * returns back the changes that were logged.
     * @param page page number
     * @param size size of page
     * @returns {*}
     */
    getChanges(page, size) {
        return this.changeLogService.getStore().then(strore => {
            return (strore.filter([], 'id', {
                offset: (page - 1) * size,
                limit: size
            }));
        });
    }
    /**
     * If this is a database change, then it will replace old upload directory with the current upload directory
     * and its corresponding owner object, if  it has primary key.
     *
     * @param change
     * @param oldUploadDir
     * @param uploadDir
     * @returns {*}
     */
    updateDBChange(change, oldUploadDir, uploadDir) {
        const modifiedProperties = {}, entityName = change.params.entityName, dataModelName = change.params.dataModelName;
        change.params.data = _.mapValues(change.params.data, function (v, k) {
            let mv = v, isModified = false;
            if (_.isString(v)) {
                mv = _.replace(v, oldUploadDir, uploadDir);
                isModified = !_.isEqual(mv, v);
            }
            else if (_.isObject(v) && v.wmLocalPath) {
                // insertMultiPartData and updateMultiPartData
                mv = _.replace(v.wmLocalPath, oldUploadDir, uploadDir);
                isModified = !_.isEqual(mv, v.wmLocalPath);
            }
            if (isModified) {
                modifiedProperties[k] = mv;
            }
            return mv;
        });
        if (!_.isEmpty(modifiedProperties)) {
            this.localDBManagementService.getStore(dataModelName, entityName)
                .then(store => {
                // If there is a primary for the entity, then update actual row with the modifications
                if (store.primaryKeyField && store.primaryKeyField.generatorType === 'identity') {
                    const primaryKeyName = store.primaryKeyName;
                    const primaryKey = change.params.data[primaryKeyName];
                    return store.get(primaryKey)
                        .then(obj => store.save(_.assignIn(obj, modifiedProperties)));
                }
            }).then(() => {
                change.params = JSON.stringify(change.params);
                return this.changeLogService.getStore().then(store => store.save(change));
            });
        }
    }
    /**
     * This function check this change to update old upload directory path.
     *
     * @param change
     * @param metaInfo
     * @returns {*}
     */
    updateChange(change, metaInfo) {
        change.params = JSON.parse(change.params);
        if (change.service === 'OfflineFileUploadService'
            && change.operation === 'uploadToServer') {
            change.params.file = _.replace(change.params.file, metaInfo.uploadDir, this.uploadDir);
            change.params = JSON.stringify(change.params);
            return this.changeLogService.getStore().then(store => store.save(change));
        }
        if (change.service === 'DatabaseService') {
            return this.updateDBChange(change, metaInfo.uploadDir, this.uploadDir);
        }
    }
    /**
     * This function will visit all the changes and modify them, if necessary.
     * @param metaInfo
     * @param page
     * @returns {*}
     */
    updateChanges(metaInfo, page = 1) {
        const size = 10;
        return this.getChanges(page, size)
            .then(changes => {
            if (changes && changes.length > 0) {
                return Promise.all(changes.map(change => this.updateChange(change, metaInfo)));
            }
        }).then(result => {
            if (result && result.length === size) {
                return this.updateChanges(metaInfo, page + 1);
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL21vYmlsZS9vZmZsaW5lLyIsInNvdXJjZXMiOlsic2VydmljZXMvd29ya2Vycy9maWxlLWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQVFoQyxNQUFNLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQztBQUV0QyxNQUFNLE9BQU8sV0FBVztJQUF4QjtRQUdZLFdBQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO0lBbUNwQyxDQUFDO0lBakNVLFFBQVEsQ0FBQyxPQUFxQjtRQUNqQyxJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVEOztPQUVHO0lBQ0ksT0FBTyxDQUFDLE1BQWM7UUFDekIsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLGlCQUFpQixFQUFFO1lBQ3RDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3JELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQUksU0FBUyxFQUFFO29CQUNYLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDbkUsT0FBTyxTQUFTLENBQUM7aUJBQ3BCO2dCQUNELE9BQU8sQ0FBQyxDQUFDO1lBQ2IsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFFTSxlQUFlLENBQUMsTUFBYyxFQUFFLFFBQWE7UUFDaEQsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLDBCQUEwQjtlQUMxQyxNQUFNLENBQUMsU0FBUyxLQUFLLGdCQUFnQixFQUFFO1lBQzFDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25EOzs7ZUFHRztZQUNILElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBZSxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ2pFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQztTQUMxRTtJQUNMLENBQUM7Q0FFSjtBQUVELE1BQU0sT0FBTyxtQ0FBbUM7SUFHNUMsWUFDWSxnQkFBa0MsRUFDbEMsaUJBQW9DLEVBQ3BDLHdCQUFrRCxFQUNsRCxJQUFVO1FBSFYscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsU0FBSSxHQUFKLElBQUksQ0FBTTtJQUd0QixDQUFDO0lBRU0sU0FBUyxDQUFDLGNBQXNCLEVBQUUsSUFBUztRQUM5Qyx1QkFBdUI7UUFDdkIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGtCQUFrQixFQUFFLEVBQzlELGNBQWMsR0FBRyxjQUFjLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUNoRCxlQUFlLEdBQUcsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsY0FBYyxHQUFHLENBQUMsQ0FBQyxFQUNqRSxhQUFhLEdBQUcsY0FBYyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFjLENBQUM7UUFDaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN4RixDQUFDO0lBRU0sVUFBVSxDQUFDLGNBQXNCLEVBQUUsSUFBUztRQUMvQyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsa0JBQWtCLEVBQUUsRUFDOUQsY0FBYyxHQUFHLGNBQWMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQ2hELGVBQWUsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxjQUFjLEdBQUcsQ0FBQyxDQUFDLEVBQ2pFLGFBQWEsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsU0FBUyxHQUFHLGNBQWMsQ0FBQztRQUNoQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxTQUFTLENBQUM7YUFDL0MsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNQLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7aUJBQ2xELElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxhQUFhLENBQUMsQ0FBQztpQkFDeEYsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssVUFBVSxDQUFDLElBQVksRUFBRSxJQUFZO1FBQ3pDLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsRCxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFO2dCQUM1QixNQUFNLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSTtnQkFDekIsS0FBSyxFQUFFLElBQUk7YUFDZCxDQUFDLENBQXNCLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7Ozs7O09BUUc7SUFDSyxjQUFjLENBQUMsTUFBYyxFQUFFLFlBQW9CLEVBQUUsU0FBaUI7UUFDMUUsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLEVBQ3pCLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFDckMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUMvRCxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsVUFBVSxHQUFHLEtBQUssQ0FBQztZQUMvQixJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2YsRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDM0MsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDbEM7aUJBQU0sSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3ZDLDhDQUE4QztnQkFDOUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZELFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUM5QztZQUNELElBQUksVUFBVSxFQUFFO2dCQUNaLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzthQUM5QjtZQUNELE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO1lBQ2hDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLFVBQVUsQ0FBQztpQkFDNUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNWLHNGQUFzRjtnQkFDdEYsSUFBSSxLQUFLLENBQUMsZUFBZSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsYUFBYSxLQUFLLFVBQVUsRUFBRTtvQkFDN0UsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQztvQkFDNUMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7b0JBQ3RELE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7eUJBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7aUJBQ3JFO1lBQ0wsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDYixNQUFNLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUM5QyxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDL0UsQ0FBQyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSyxZQUFZLENBQUMsTUFBYyxFQUFFLFFBQWE7UUFDOUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssMEJBQTBCO2VBQzFDLE1BQU0sQ0FBQyxTQUFTLEtBQUssZ0JBQWdCLEVBQUU7WUFDMUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN2RixNQUFNLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzlDLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBRSxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUM5RTtRQUNELElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxpQkFBaUIsRUFBRTtZQUN0QyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzFFO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssYUFBYSxDQUFDLFFBQWEsRUFBRSxJQUFJLEdBQUcsQ0FBQztRQUN6QyxNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7YUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1osSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQy9CLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2xGO1FBQ0wsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2IsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxJQUFJLEVBQUU7Z0JBQ2xDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ2pEO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlIH0gZnJvbSAnQGlvbmljLW5hdGl2ZS9maWxlJztcblxuaW1wb3J0IHsgbm9vcCB9IGZyb20gJ0B3bS9jb3JlJztcbmltcG9ydCB7IERldmljZUZpbGVTZXJ2aWNlIH0gZnJvbSAnQHdtL21vYmlsZS9jb3JlJztcblxuaW1wb3J0IHsgQ2hhbmdlLCBDaGFuZ2VMb2dTZXJ2aWNlLCBGbHVzaENvbnRleHQsIFdvcmtlciB9IGZyb20gJy4uL2NoYW5nZS1sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBDYWxsQmFjaywgTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vbG9jYWwtZGItbWFuYWdlbWVudC5zZXJ2aWNlJztcblxuZGVjbGFyZSBjb25zdCBfO1xuXG5jb25zdCBTVE9SRV9LRVkgPSAnb2ZmbGluZUZpbGVVcGxvYWQnO1xuXG5leHBvcnQgY2xhc3MgRmlsZUhhbmRsZXIgaW1wbGVtZW50cyBXb3JrZXIge1xuXG4gICAgcHJpdmF0ZSBmaWxlU3RvcmU7XG4gICAgcHJpdmF0ZSBsb2dnZXIgPSB3aW5kb3cuY29uc29sZTtcblxuICAgIHB1YmxpYyBwcmVGbHVzaChjb250ZXh0OiBGbHVzaENvbnRleHQpIHtcbiAgICAgICAgdGhpcy5maWxlU3RvcmUgPSBjb250ZXh0LmdldChTVE9SRV9LRVkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlcGxhY2VzIGFsbCBsb2NhbCBwYXRocyB3aXRoIHRoZSByZW1vdGUgcGF0aCB1c2luZyBtYXBwaW5ncyBjcmVhdGVkIGR1cmluZyAndXBsb2FkVG9TZXJ2ZXInLlxuICAgICAqL1xuICAgIHB1YmxpYyBwcmVDYWxsKGNoYW5nZTogQ2hhbmdlKSB7XG4gICAgICAgIGlmIChjaGFuZ2Uuc2VydmljZSA9PT0gJ0RhdGFiYXNlU2VydmljZScpIHtcbiAgICAgICAgICAgIGNoYW5nZS5wYXJhbXMuZGF0YSA9IF8ubWFwVmFsdWVzKGNoYW5nZS5wYXJhbXMuZGF0YSwgdiA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVtb3RlVXJsID0gdGhpcy5maWxlU3RvcmVbdl07XG4gICAgICAgICAgICAgICAgaWYgKHJlbW90ZVVybCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1Zygnc3dhcHBlZCBmaWxlIHBhdGggZnJvbSAlcyAtPiAlcycsIHYsIHJlbW90ZVVybCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVVcmw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB2O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcG9zdENhbGxTdWNjZXNzKGNoYW5nZTogQ2hhbmdlLCByZXNwb25zZTogYW55KSB7XG4gICAgICAgIGlmIChjaGFuZ2Uuc2VydmljZSA9PT0gJ09mZmxpbmVGaWxlVXBsb2FkU2VydmljZSdcbiAgICAgICAgICAgICYmIGNoYW5nZS5vcGVyYXRpb24gPT09ICd1cGxvYWRUb1NlcnZlcicpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbW90ZUZpbGUgPSBKU09OLnBhcnNlKHJlc3BvbnNlWzBdLnRleHQpWzBdO1xuICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAqIEEgbWFwcGluZyB3aWxsIGJlIGNyZWF0ZWQgYmV0d2VlbiBsb2NhbCBwYXRoIGFuZCByZW1vdGUgcGF0aC5cbiAgICAgICAgICAgICAqIFRoaXMgd2lsbCBiZSB1c2VkIHRvIHJlc29sdmUgbG9jYWwgcGF0aHMgaW4gZW50aXRpZXMuXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIHRoaXMuZmlsZVN0b3JlW2NoYW5nZS5wYXJhbXMuZmlsZV0gICAgICAgICAgICAgPSByZW1vdGVGaWxlLnBhdGg7XG4gICAgICAgICAgICB0aGlzLmZpbGVTdG9yZVtjaGFuZ2UucGFyYW1zLmZpbGUgKyAnP2lubGluZSddID0gcmVtb3RlRmlsZS5pbmxpbmVQYXRoO1xuICAgICAgICB9XG4gICAgfVxuXG59XG5cbmV4cG9ydCBjbGFzcyBVcGxvYWRlZEZpbGVzSW1wb3J0QW5kRXhwb3J0U2VydmljZSBpbXBsZW1lbnRzIENhbGxCYWNrIHtcbiAgICBwcml2YXRlIHVwbG9hZERpcjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGNoYW5nZUxvZ1NlcnZpY2U6IENoYW5nZUxvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZGV2aWNlRmlsZVNlcnZpY2U6IERldmljZUZpbGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvY2FsREJNYW5hZ2VtZW50U2VydmljZTogTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGZpbGU6IEZpbGVcbiAgICApIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyBwcmVFeHBvcnQoZm9sZGVyVG9FeHBvcnQ6IHN0cmluZywgbWV0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgLy8gY29weSBvZmZsaW5lIHVwbG9hZHNcbiAgICAgICAgY29uc3QgdXBsb2FkRnVsbFBhdGggPSB0aGlzLmRldmljZUZpbGVTZXJ2aWNlLmdldFVwbG9hZERpcmVjdG9yeSgpLFxuICAgICAgICAgICAgbGFzdEluZGV4T2ZTZXAgPSB1cGxvYWRGdWxsUGF0aC5sYXN0SW5kZXhPZignLycpLFxuICAgICAgICAgICAgdXBsb2FkUGFyZW50RGlyID0gdXBsb2FkRnVsbFBhdGguc3Vic3RyaW5nKDAsIGxhc3RJbmRleE9mU2VwICsgMSksXG4gICAgICAgICAgICB1cGxvYWREaXJOYW1lID0gdXBsb2FkRnVsbFBhdGguc3Vic3RyaW5nKGxhc3RJbmRleE9mU2VwICsgMSk7XG4gICAgICAgIG1ldGEudXBsb2FkRGlyID0gdXBsb2FkRnVsbFBhdGg7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbGUuY29weURpcih1cGxvYWRQYXJlbnREaXIsIHVwbG9hZERpck5hbWUsIGZvbGRlclRvRXhwb3J0LCAndXBsb2FkcycpO1xuICAgIH1cblxuICAgIHB1YmxpYyBwb3N0SW1wb3J0KGltcG9ydGVkRm9sZGVyOiBzdHJpbmcsIG1ldGE6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHVwbG9hZEZ1bGxQYXRoID0gdGhpcy5kZXZpY2VGaWxlU2VydmljZS5nZXRVcGxvYWREaXJlY3RvcnkoKSxcbiAgICAgICAgICAgIGxhc3RJbmRleE9mU2VwID0gdXBsb2FkRnVsbFBhdGgubGFzdEluZGV4T2YoJy8nKSxcbiAgICAgICAgICAgIHVwbG9hZFBhcmVudERpciA9IHVwbG9hZEZ1bGxQYXRoLnN1YnN0cmluZygwLCBsYXN0SW5kZXhPZlNlcCArIDEpLFxuICAgICAgICAgICAgdXBsb2FkRGlyTmFtZSA9IHVwbG9hZEZ1bGxQYXRoLnN1YnN0cmluZyhsYXN0SW5kZXhPZlNlcCArIDEpO1xuICAgICAgICB0aGlzLnVwbG9hZERpciA9IHVwbG9hZEZ1bGxQYXRoO1xuICAgICAgICByZXR1cm4gdGhpcy5maWxlLmNoZWNrRGlyKGltcG9ydGVkRm9sZGVyLCAndXBsb2FkcycpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGV2aWNlRmlsZVNlcnZpY2UucmVtb3ZlRGlyKHVwbG9hZEZ1bGxQYXRoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmZpbGUuY29weURpcihpbXBvcnRlZEZvbGRlciwgJ3VwbG9hZHMnLCB1cGxvYWRQYXJlbnREaXIsIHVwbG9hZERpck5hbWUpKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLnVwZGF0ZUNoYW5nZXMobWV0YSkpO1xuICAgICAgICAgICAgfSwgbm9vcCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmV0dXJucyBiYWNrIHRoZSBjaGFuZ2VzIHRoYXQgd2VyZSBsb2dnZWQuXG4gICAgICogQHBhcmFtIHBhZ2UgcGFnZSBudW1iZXJcbiAgICAgKiBAcGFyYW0gc2l6ZSBzaXplIG9mIHBhZ2VcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBwcml2YXRlIGdldENoYW5nZXMocGFnZTogbnVtYmVyLCBzaXplOiBudW1iZXIpOiBQcm9taXNlPENoYW5nZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoYW5nZUxvZ1NlcnZpY2UuZ2V0U3RvcmUoKS50aGVuKHN0cm9yZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHN0cm9yZS5maWx0ZXIoW10sICdpZCcsIHtcbiAgICAgICAgICAgICAgICBvZmZzZXQ6IChwYWdlIC0gMSkgKiBzaXplLFxuICAgICAgICAgICAgICAgIGxpbWl0OiBzaXplXG4gICAgICAgICAgICB9KSkgYXMgUHJvbWlzZTxDaGFuZ2VbXT47XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElmIHRoaXMgaXMgYSBkYXRhYmFzZSBjaGFuZ2UsIHRoZW4gaXQgd2lsbCByZXBsYWNlIG9sZCB1cGxvYWQgZGlyZWN0b3J5IHdpdGggdGhlIGN1cnJlbnQgdXBsb2FkIGRpcmVjdG9yeVxuICAgICAqIGFuZCBpdHMgY29ycmVzcG9uZGluZyBvd25lciBvYmplY3QsIGlmICBpdCBoYXMgcHJpbWFyeSBrZXkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY2hhbmdlXG4gICAgICogQHBhcmFtIG9sZFVwbG9hZERpclxuICAgICAqIEBwYXJhbSB1cGxvYWREaXJcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZURCQ2hhbmdlKGNoYW5nZTogQ2hhbmdlLCBvbGRVcGxvYWREaXI6IHN0cmluZywgdXBsb2FkRGlyOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgbW9kaWZpZWRQcm9wZXJ0aWVzID0ge30sXG4gICAgICAgICAgICBlbnRpdHlOYW1lID0gY2hhbmdlLnBhcmFtcy5lbnRpdHlOYW1lLFxuICAgICAgICAgICAgZGF0YU1vZGVsTmFtZSA9IGNoYW5nZS5wYXJhbXMuZGF0YU1vZGVsTmFtZTtcbiAgICAgICAgY2hhbmdlLnBhcmFtcy5kYXRhID0gXy5tYXBWYWx1ZXMoY2hhbmdlLnBhcmFtcy5kYXRhLCBmdW5jdGlvbiAodiwgaykge1xuICAgICAgICAgICAgbGV0IG12ID0gdiwgaXNNb2RpZmllZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKF8uaXNTdHJpbmcodikpIHtcbiAgICAgICAgICAgICAgICBtdiA9IF8ucmVwbGFjZSh2LCBvbGRVcGxvYWREaXIsIHVwbG9hZERpcik7XG4gICAgICAgICAgICAgICAgaXNNb2RpZmllZCA9ICFfLmlzRXF1YWwobXYsIHYpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KHYpICYmIHYud21Mb2NhbFBhdGgpIHtcbiAgICAgICAgICAgICAgICAvLyBpbnNlcnRNdWx0aVBhcnREYXRhIGFuZCB1cGRhdGVNdWx0aVBhcnREYXRhXG4gICAgICAgICAgICAgICAgbXYgPSBfLnJlcGxhY2Uodi53bUxvY2FsUGF0aCwgb2xkVXBsb2FkRGlyLCB1cGxvYWREaXIpO1xuICAgICAgICAgICAgICAgIGlzTW9kaWZpZWQgPSAhXy5pc0VxdWFsKG12LCB2LndtTG9jYWxQYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpc01vZGlmaWVkKSB7XG4gICAgICAgICAgICAgICAgbW9kaWZpZWRQcm9wZXJ0aWVzW2tdID0gbXY7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbXY7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIV8uaXNFbXB0eShtb2RpZmllZFByb3BlcnRpZXMpKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5nZXRTdG9yZShkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lKVxuICAgICAgICAgICAgICAgIC50aGVuKHN0b3JlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYSBwcmltYXJ5IGZvciB0aGUgZW50aXR5LCB0aGVuIHVwZGF0ZSBhY3R1YWwgcm93IHdpdGggdGhlIG1vZGlmaWNhdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JlLnByaW1hcnlLZXlGaWVsZCAmJiBzdG9yZS5wcmltYXJ5S2V5RmllbGQuZ2VuZXJhdG9yVHlwZSA9PT0gJ2lkZW50aXR5Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJpbWFyeUtleU5hbWUgPSBzdG9yZS5wcmltYXJ5S2V5TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSBjaGFuZ2UucGFyYW1zLmRhdGFbcHJpbWFyeUtleU5hbWVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0b3JlLmdldChwcmltYXJ5S2V5KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKG9iaiA9PiBzdG9yZS5zYXZlKF8uYXNzaWduSW4ob2JqLCBtb2RpZmllZFByb3BlcnRpZXMpKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjaGFuZ2UucGFyYW1zID0gSlNPTi5zdHJpbmdpZnkoY2hhbmdlLnBhcmFtcyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hhbmdlTG9nU2VydmljZS5nZXRTdG9yZSgpLnRoZW4oIHN0b3JlID0+IHN0b3JlLnNhdmUoY2hhbmdlKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgZnVuY3Rpb24gY2hlY2sgdGhpcyBjaGFuZ2UgdG8gdXBkYXRlIG9sZCB1cGxvYWQgZGlyZWN0b3J5IHBhdGguXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY2hhbmdlXG4gICAgICogQHBhcmFtIG1ldGFJbmZvXG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICovXG4gICAgcHJpdmF0ZSB1cGRhdGVDaGFuZ2UoY2hhbmdlOiBDaGFuZ2UsIG1ldGFJbmZvOiBhbnkpIHtcbiAgICAgICAgY2hhbmdlLnBhcmFtcyA9IEpTT04ucGFyc2UoY2hhbmdlLnBhcmFtcyk7XG4gICAgICAgIGlmIChjaGFuZ2Uuc2VydmljZSA9PT0gJ09mZmxpbmVGaWxlVXBsb2FkU2VydmljZSdcbiAgICAgICAgICAgICYmIGNoYW5nZS5vcGVyYXRpb24gPT09ICd1cGxvYWRUb1NlcnZlcicpIHtcbiAgICAgICAgICAgIGNoYW5nZS5wYXJhbXMuZmlsZSA9IF8ucmVwbGFjZShjaGFuZ2UucGFyYW1zLmZpbGUsIG1ldGFJbmZvLnVwbG9hZERpciwgdGhpcy51cGxvYWREaXIpO1xuICAgICAgICAgICAgY2hhbmdlLnBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KGNoYW5nZS5wYXJhbXMpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hhbmdlTG9nU2VydmljZS5nZXRTdG9yZSgpLnRoZW4oIHN0b3JlID0+IHN0b3JlLnNhdmUoY2hhbmdlKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNoYW5nZS5zZXJ2aWNlID09PSAnRGF0YWJhc2VTZXJ2aWNlJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlREJDaGFuZ2UoY2hhbmdlLCBtZXRhSW5mby51cGxvYWREaXIsIHRoaXMudXBsb2FkRGlyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgZnVuY3Rpb24gd2lsbCB2aXNpdCBhbGwgdGhlIGNoYW5nZXMgYW5kIG1vZGlmeSB0aGVtLCBpZiBuZWNlc3NhcnkuXG4gICAgICogQHBhcmFtIG1ldGFJbmZvXG4gICAgICogQHBhcmFtIHBhZ2VcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZUNoYW5nZXMobWV0YUluZm86IGFueSwgcGFnZSA9IDEpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBjb25zdCBzaXplID0gMTA7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENoYW5nZXMocGFnZSwgc2l6ZSlcbiAgICAgICAgICAgIC50aGVuKGNoYW5nZXMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaGFuZ2VzICYmIGNoYW5nZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoY2hhbmdlcy5tYXAoY2hhbmdlID0+IHRoaXMudXBkYXRlQ2hhbmdlKGNoYW5nZSwgbWV0YUluZm8pKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lmxlbmd0aCA9PT0gc2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVDaGFuZ2VzKG1ldGFJbmZvLCBwYWdlICsgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgfVxufVxuIl19