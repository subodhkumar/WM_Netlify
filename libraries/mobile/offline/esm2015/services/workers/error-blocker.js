const STORE_KEY = 'errorBlockerStore';
export class ErrorBlocker {
    constructor(localDBManagementService) {
        this.localDBManagementService = localDBManagementService;
    }
    preFlush(context) {
        this.errorStore = context.get(STORE_KEY);
    }
    // block all calls related to the error entities
    preCall(change) {
        if (change && change.service === 'DatabaseService') {
            const entityName = change.params.entityName;
            const dataModelName = change.params.dataModelName;
            switch (change.operation) {
                case 'insertTableData':
                case 'insertMultiPartTableData':
                case 'updateTableData':
                case 'updateMultiPartTableData':
                    return this.localDBManagementService.getStore(dataModelName, entityName).then(store => {
                        this.blockCall(store, change, dataModelName, entityName, change.params.data);
                    });
                case 'deleteTableData':
                    return this.localDBManagementService.getStore(dataModelName, entityName).then(store => {
                        this.blockCall(store, change, dataModelName, entityName, change.params);
                    });
            }
        }
    }
    // store error entity id
    postCallSuccess(change) {
        if (change && change.service === 'DatabaseService') {
            const entityName = change.params.entityName;
            const dataModelName = change.params.dataModelName;
            return this.localDBManagementService.getStore(dataModelName, entityName).then(store => {
                const id = change['dataLocalId'] || change.params.data[store.primaryKeyName];
                if (!(_.isUndefined(id) || _.isNull(id))) {
                    this.removeError(dataModelName, entityName, id);
                }
            });
        }
    }
    // store error entity id
    postCallError(change) {
        if (change && change.service === 'DatabaseService') {
            const entityName = change.params.entityName;
            const dataModelName = change.params.dataModelName;
            return this.localDBManagementService.getStore(dataModelName, entityName).then(store => {
                const id = change['dataLocalId'] || (change.params.data && change.params.data[store.primaryKeyName]) || change.params[store.primaryKeyName] || change.params.id;
                if (!(_.isUndefined(id) || _.isNull(id))) {
                    this.recordError(dataModelName, entityName, id);
                }
            });
        }
    }
    /**
     * If there is an earlier call of the object or its relations that got failed, then this call will be
     * marked for discard.
     *
     * @param store LocalDBStore
     * @param change change to block
     * @param dataModelName
     * @param entityName
     * @param data
     */
    blockCall(store, change, dataModelName, entityName, data) {
        if (change.hasError === 0) {
            this.checkForPreviousError(store, change, dataModelName, entityName, data);
            store.entitySchema.columns.forEach(col => {
                if (col.foreignRelations) {
                    col.foreignRelations.some(foreignRelation => {
                        if (data[foreignRelation.sourceFieldName]) {
                            this.blockCall(store, change, dataModelName, foreignRelation.targetEntity, data[foreignRelation.sourceFieldName]);
                        }
                        else if (data[col.fieldName]) {
                            this.checkForPreviousError(store, change, dataModelName, foreignRelation.targetEntity, data, col.fieldName);
                        }
                        return change.hasError === 1;
                    });
                }
            });
        }
    }
    // A helper function to check for earlier failures.
    checkForPreviousError(store, change, dataModelName, entityName, data, key) {
        const primaryKey = key || store.primaryKeyName;
        if (this.hasError(dataModelName, entityName, data[primaryKey])) {
            change.hasError = 1;
            change.errorMessage = `Blocked call due to error in previous call of entity [ ${entityName} ] with id [ ${data[primaryKey]} ]`;
        }
    }
    hasError(dataModelName, entityName, id) {
        if (this.errorStore[dataModelName]
            && this.errorStore[dataModelName][entityName]
            && this.errorStore[dataModelName][entityName][id]) {
            return true;
        }
        return false;
    }
    // Removes entity identifier from error list.
    removeError(dataModelName, entityName, id) {
        if (this.errorStore[dataModelName]
            && this.errorStore[dataModelName][entityName]
            && this.errorStore[dataModelName][entityName][id]) {
            delete this.errorStore[dataModelName][entityName][id];
        }
    }
    // Save error entity identifier.
    recordError(dataModelName, entityName, id) {
        this.errorStore[dataModelName] = this.errorStore[dataModelName] || {};
        this.errorStore[dataModelName][entityName] = this.errorStore[dataModelName][entityName] || {};
        this.errorStore[dataModelName][entityName][id] = true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItYmxvY2tlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9tb2JpbGUvb2ZmbGluZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3dvcmtlcnMvZXJyb3ItYmxvY2tlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxNQUFNLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQztBQUV0QyxNQUFNLE9BQU8sWUFBWTtJQUlyQixZQUFvQix3QkFBa0Q7UUFBbEQsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtJQUN0RSxDQUFDO0lBRU0sUUFBUSxDQUFDLE9BQXFCO1FBQ2pDLElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZ0RBQWdEO0lBQ3pDLE9BQU8sQ0FBQyxNQUFjO1FBQ3pCLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssaUJBQWlCLEVBQUU7WUFDaEQsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUM7WUFDNUMsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7WUFDbEQsUUFBUSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUN0QixLQUFLLGlCQUFpQixDQUFDO2dCQUN2QixLQUFLLDBCQUEwQixDQUFDO2dCQUNoQyxLQUFLLGlCQUFpQixDQUFDO2dCQUN2QixLQUFLLDBCQUEwQjtvQkFDM0IsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUUsS0FBSyxDQUFDLEVBQUU7d0JBQ25GLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2pGLENBQUMsQ0FBQyxDQUFDO2dCQUNQLEtBQUssaUJB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IjpbImltcG9ydCB7IENoYW5nZSwgRmx1c2hDb250ZXh0LCBXb3JrZXIgfSBmcm9tICcuLi9jaGFuZ2UtbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9jYWxEQlN0b3JlIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2xvY2FsLWRiLXN0b3JlJztcbmltcG9ydCB7IExvY2FsREJNYW5hZ2VtZW50U2VydmljZSB9IGZyb20gJy4uL2xvY2FsLWRiLW1hbmFnZW1lbnQuc2VydmljZSc7XG5cbmRlY2xhcmUgY29uc3QgXztcblxuY29uc3QgU1RPUkVfS0VZID0gJ2Vycm9yQmxvY2tlclN0b3JlJztcblxuZXhwb3J0IGNsYXNzIEVycm9yQmxvY2tlciBpbXBsZW1lbnRzIFdvcmtlciB7XG5cbiAgICBwcml2YXRlIGVycm9yU3RvcmU7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2FsREJNYW5hZ2VtZW50U2VydmljZTogTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgcHVibGljIHByZUZsdXNoKGNvbnRleHQ6IEZsdXNoQ29udGV4dCkge1xuICAgICAgICB0aGlzLmVycm9yU3RvcmUgPSBjb250ZXh0LmdldChTVE9SRV9LRVkpO1xuICAgIH1cblxuICAgIC8vIGJsb2NrIGFsbCBjYWxscyByZWxhdGVkIHRvIHRoZSBlcnJvciBlbnRpdGllc1xuICAgIHB1YmxpYyBwcmVDYWxsKGNoYW5nZTogQ2hhbmdlKSB7XG4gICAgICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnNlcnZpY2UgPT09ICdEYXRhYmFzZVNlcnZpY2UnKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gY2hhbmdlLnBhcmFtcy5lbnRpdHlOYW1lO1xuICAgICAgICAgICAgY29uc3QgZGF0YU1vZGVsTmFtZSA9IGNoYW5nZS5wYXJhbXMuZGF0YU1vZGVsTmFtZTtcbiAgICAgICAgICAgIHN3aXRjaCAoY2hhbmdlLm9wZXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGNhc2UgJ2luc2VydFRhYmxlRGF0YSc6XG4gICAgICAgICAgICAgICAgY2FzZSAnaW5zZXJ0TXVsdGlQYXJ0VGFibGVEYXRhJzpcbiAgICAgICAgICAgICAgICBjYXNlICd1cGRhdGVUYWJsZURhdGEnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ3VwZGF0ZU11bHRpUGFydFRhYmxlRGF0YSc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5nZXRTdG9yZShkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lKS50aGVuKCBzdG9yZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrQ2FsbChzdG9yZSwgY2hhbmdlLCBkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lLCBjaGFuZ2UucGFyYW1zLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjYXNlICdkZWxldGVUYWJsZURhdGEnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbERCTWFuYWdlbWVudFNlcnZpY2UuZ2V0U3RvcmUoZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSkudGhlbiggc3RvcmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ibG9ja0NhbGwoc3RvcmUsIGNoYW5nZSwgZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSwgY2hhbmdlLnBhcmFtcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gc3RvcmUgZXJyb3IgZW50aXR5IGlkXG4gICAgcHVibGljIHBvc3RDYWxsU3VjY2VzcyhjaGFuZ2U6IENoYW5nZSkge1xuICAgICAgICBpZiAoY2hhbmdlICYmIGNoYW5nZS5zZXJ2aWNlID09PSAnRGF0YWJhc2VTZXJ2aWNlJykge1xuICAgICAgICAgICAgY29uc3QgZW50aXR5TmFtZSA9IGNoYW5nZS5wYXJhbXMuZW50aXR5TmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGFNb2RlbE5hbWUgPSBjaGFuZ2UucGFyYW1zLmRhdGFNb2RlbE5hbWU7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbERCTWFuYWdlbWVudFNlcnZpY2UuZ2V0U3RvcmUoZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSkudGhlbiggc3RvcmUgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gY2hhbmdlWydkYXRhTG9jYWxJZCddIHx8IGNoYW5nZS5wYXJhbXMuZGF0YVtzdG9yZS5wcmltYXJ5S2V5TmFtZV07XG4gICAgICAgICAgICAgICAgaWYgKCEoXy5pc1VuZGVmaW5lZChpZCkgfHwgXy5pc051bGwoaWQpKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUVycm9yKGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUsIGlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIHN0b3JlIGVycm9yIGVudGl0eSBpZFxuICAgIHB1YmxpYyBwb3N0Q2FsbEVycm9yKGNoYW5nZTogQ2hhbmdlKSB7XG4gICAgICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnNlcnZpY2UgPT09ICdEYXRhYmFzZVNlcnZpY2UnKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gY2hhbmdlLnBhcmFtcy5lbnRpdHlOYW1lO1xuICAgICAgICAgICAgY29uc3QgZGF0YU1vZGVsTmFtZSA9IGNoYW5nZS5wYXJhbXMuZGF0YU1vZGVsTmFtZTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5nZXRTdG9yZShkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lKS50aGVuKCBzdG9yZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSBjaGFuZ2VbJ2RhdGFMb2NhbElkJ10gfHwgKGNoYW5nZS5wYXJhbXMuZGF0YSAmJiBjaGFuZ2UucGFyYW1zLmRhdGFbc3RvcmUucHJpbWFyeUtleU5hbWVdKSB8fCBjaGFuZ2UucGFyYW1zW3N0b3JlLnByaW1hcnlLZXlOYW1lXSB8fCBjaGFuZ2UucGFyYW1zLmlkO1xuICAgICAgICAgICAgICAgIGlmICghKF8uaXNVbmRlZmluZWQoaWQpIHx8IF8uaXNOdWxsKGlkKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRFcnJvcihkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lLCBpZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJZiB0aGVyZSBpcyBhbiBlYXJsaWVyIGNhbGwgb2YgdGhlIG9iamVjdCBvciBpdHMgcmVsYXRpb25zIHRoYXQgZ290IGZhaWxlZCwgdGhlbiB0aGlzIGNhbGwgd2lsbCBiZVxuICAgICAqIG1hcmtlZCBmb3IgZGlzY2FyZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBzdG9yZSBMb2NhbERCU3RvcmVcbiAgICAgKiBAcGFyYW0gY2hhbmdlIGNoYW5nZSB0byBibG9ja1xuICAgICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lXG4gICAgICogQHBhcmFtIGVudGl0eU5hbWVcbiAgICAgKiBAcGFyYW0gZGF0YVxuICAgICAqL1xuICAgIHByaXZhdGUgYmxvY2tDYWxsKHN0b3JlOiBMb2NhbERCU3RvcmUsIGNoYW5nZTogQ2hhbmdlLCBkYXRhTW9kZWxOYW1lOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZywgZGF0YTogYW55KSB7XG4gICAgICAgIGlmIChjaGFuZ2UuaGFzRXJyb3IgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tGb3JQcmV2aW91c0Vycm9yKHN0b3JlLCBjaGFuZ2UsIGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUsIGRhdGEpO1xuICAgICAgICAgICAgc3RvcmUuZW50aXR5U2NoZW1hLmNvbHVtbnMuZm9yRWFjaChjb2wgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb2wuZm9yZWlnblJlbGF0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBjb2wuZm9yZWlnblJlbGF0aW9ucy5zb21lKGZvcmVpZ25SZWxhdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtmb3JlaWduUmVsYXRpb24uc291cmNlRmllbGROYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tDYWxsKHN0b3JlLCBjaGFuZ2UsIGRhdGFNb2RlbE5hbWUsIGZvcmVpZ25SZWxhdGlvbi50YXJnZXRFbnRpdHksIGRhdGFbZm9yZWlnblJlbGF0aW9uLnNvdXJjZUZpZWxkTmFtZV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW2NvbC5maWVsZE5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVja0ZvclByZXZpb3VzRXJyb3Ioc3RvcmUsIGNoYW5nZSwgZGF0YU1vZGVsTmFtZSwgZm9yZWlnblJlbGF0aW9uLnRhcmdldEVudGl0eSwgZGF0YSwgY29sLmZpZWxkTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlLmhhc0Vycm9yID09PSAxO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEEgaGVscGVyIGZ1bmN0aW9uIHRvIGNoZWNrIGZvciBlYXJsaWVyIGZhaWx1cmVzLlxuICAgIHByaXZhdGUgY2hlY2tGb3JQcmV2aW91c0Vycm9yKHN0b3JlOiBMb2NhbERCU3RvcmUsIGNoYW5nZTogQ2hhbmdlLCBkYXRhTW9kZWxOYW1lOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZywgZGF0YTogYW55LCBrZXk/OiBhbnkpIHtcbiAgICAgICAgY29uc3QgcHJpbWFyeUtleSA9IGtleSB8fCBzdG9yZS5wcmltYXJ5S2V5TmFtZTtcbiAgICAgICAgaWYgKHRoaXMuaGFzRXJyb3IoZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSwgZGF0YVtwcmltYXJ5S2V5XSkpIHtcbiAgICAgICAgICAgIGNoYW5nZS5oYXNFcnJvciA9IDE7XG4gICAgICAgICAgICBjaGFuZ2UuZXJyb3JNZXNzYWdlID0gYEJsb2NrZWQgY2FsbCBkdWUgdG8gZXJyb3IgaW4gcHJldmlvdXMgY2FsbCBvZiBlbnRpdHkgWyAke2VudGl0eU5hbWV9IF0gd2l0aCBpZCBbICR7ZGF0YVtwcmltYXJ5S2V5XX0gXWA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc0Vycm9yKGRhdGFNb2RlbE5hbWU6IHN0cmluZywgZW50aXR5TmFtZTogc3RyaW5nLCBpZDogYW55KSB7XG4gICAgICAgIGlmICh0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1cbiAgICAgICAgICAgICYmIHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVtlbnRpdHlOYW1lXVxuICAgICAgICAgICAgJiYgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdW2lkXSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFJlbW92ZXMgZW50aXR5IGlkZW50aWZpZXIgZnJvbSBlcnJvciBsaXN0LlxuICAgIHByaXZhdGUgcmVtb3ZlRXJyb3IoZGF0YU1vZGVsTmFtZTogc3RyaW5nLCBlbnRpdHlOYW1lOiBzdHJpbmcsIGlkOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVxuICAgICAgICAgICAgJiYgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdXG4gICAgICAgICAgICAmJiB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1bZW50aXR5TmFtZV1baWRdKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdW2lkXTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNhdmUgZXJyb3IgZW50aXR5IGlkZW50aWZpZXIuXG4gICAgcHJpdmF0ZSByZWNvcmRFcnJvcihkYXRhTW9kZWxOYW1lOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZywgaWQ6IGFueSkge1xuICAgICAgICB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV0gPSB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV0gfHwge307XG4gICAgICAgIHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVtlbnRpdHlOYW1lXSA9IHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVtlbnRpdHlOYW1lXSB8fCB7fTtcbiAgICAgICAgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdW2lkXSA9IHRydWU7XG4gICAgfVxufVxuIl19