var STORE_KEY = 'errorBlockerStore';
var ErrorBlocker = /** @class */ (function () {
    function ErrorBlocker(localDBManagementService) {
        this.localDBManagementService = localDBManagementService;
    }
    ErrorBlocker.prototype.preFlush = function (context) {
        this.errorStore = context.get(STORE_KEY);
    };
    // block all calls related to the error entities
    ErrorBlocker.prototype.preCall = function (change) {
        var _this = this;
        if (change && change.service === 'DatabaseService') {
            var entityName_1 = change.params.entityName;
            var dataModelName_1 = change.params.dataModelName;
            switch (change.operation) {
                case 'insertTableData':
                case 'insertMultiPartTableData':
                case 'updateTableData':
                case 'updateMultiPartTableData':
                    return this.localDBManagementService.getStore(dataModelName_1, entityName_1).then(function (store) {
                        _this.blockCall(store, change, dataModelName_1, entityName_1, change.params.data);
                    });
                case 'deleteTableData':
                    return this.localDBManagementService.getStore(dataModelName_1, entityName_1).then(function (store) {
                        _this.blockCall(store, change, dataModelName_1, entityName_1, change.params);
                    });
            }
        }
    };
    // store error entity id
    ErrorBlocker.prototype.postCallSuccess = function (change) {
        var _this = this;
        if (change && change.service === 'DatabaseService') {
            var entityName_2 = change.params.entityName;
            var dataModelName_2 = change.params.dataModelName;
            return this.localDBManagementService.getStore(dataModelName_2, entityName_2).then(function (store) {
                var id = change['dataLocalId'] || change.params.data[store.primaryKeyName];
                if (!(_.isUndefined(id) || _.isNull(id))) {
                    _this.removeError(dataModelName_2, entityName_2, id);
                }
            });
        }
    };
    // store error entity id
    ErrorBlocker.prototype.postCallError = function (change) {
        var _this = this;
        if (change && change.service === 'DatabaseService') {
            var entityName_3 = change.params.entityName;
            var dataModelName_3 = change.params.dataModelName;
            return this.localDBManagementService.getStore(dataModelName_3, entityName_3).then(function (store) {
                var id = change['dataLocalId'] || (change.params.data && change.params.data[store.primaryKeyName]) || change.params[store.primaryKeyName] || change.params.id;
                if (!(_.isUndefined(id) || _.isNull(id))) {
                    _this.recordError(dataModelName_3, entityName_3, id);
                }
            });
        }
    };
    /**
     * If there is an earlier call of the object or its relations that got failed, then this call will be
     * marked for discard.
     *
     * @param store LocalDBStore
     * @param change change to block
     * @param dataModelName
     * @param entityName
     * @param data
     */
    ErrorBlocker.prototype.blockCall = function (store, change, dataModelName, entityName, data) {
        var _this = this;
        if (change.hasError === 0) {
            this.checkForPreviousError(store, change, dataModelName, entityName, data);
            store.entitySchema.columns.forEach(function (col) {
                if (col.foreignRelations) {
                    col.foreignRelations.some(function (foreignRelation) {
                        if (data[foreignRelation.sourceFieldName]) {
                            _this.blockCall(store, change, dataModelName, foreignRelation.targetEntity, data[foreignRelation.sourceFieldName]);
                        }
                        else if (data[col.fieldName]) {
                            _this.checkForPreviousError(store, change, dataModelName, foreignRelation.targetEntity, data, col.fieldName);
                        }
                        return change.hasError === 1;
                    });
                }
            });
        }
    };
    // A helper function to check for earlier failures.
    ErrorBlocker.prototype.checkForPreviousError = function (store, change, dataModelName, entityName, data, key) {
        var primaryKey = key || store.primaryKeyName;
        if (this.hasError(dataModelName, entityName, data[primaryKey])) {
            change.hasError = 1;
            change.errorMessage = "Blocked call due to error in previous call of entity [ " + entityName + " ] with id [ " + data[primaryKey] + " ]";
        }
    };
    ErrorBlocker.prototype.hasError = function (dataModelName, entityName, id) {
        if (this.errorStore[dataModelName]
            && this.errorStore[dataModelName][entityName]
            && this.errorStore[dataModelName][entityName][id]) {
            return true;
        }
        return false;
    };
    // Removes entity identifier from error list.
    ErrorBlocker.prototype.removeError = function (dataModelName, entityName, id) {
        if (this.errorStore[dataModelName]
            && this.errorStore[dataModelName][entityName]
            && this.errorStore[dataModelName][entityName][id]) {
            delete this.errorStore[dataModelName][entityName][id];
        }
    };
    // Save error entity identifier.
    ErrorBlocker.prototype.recordError = function (dataModelName, entityName, id) {
        this.errorStore[dataModelName] = this.errorStore[dataModelName] || {};
        this.errorStore[dataModelName][entityName] = this.errorStore[dataModelName][entityName] || {};
        this.errorStore[dataModelName][entityName][id] = true;
    };
    return ErrorBlocker;
}());
export { ErrorBlocker };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItYmxvY2tlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9tb2JpbGUvb2ZmbGluZS8iLCJzb3VyY2VzIjpbInNlcnZpY2VzL3dvcmtlcnMvZXJyb3ItYmxvY2tlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxJQUFNLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQztBQUV0QztJQUlJLHNCQUFvQix3QkFBa0Q7UUFBbEQsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtJQUN0RSxDQUFDO0lBRU0sK0JBQVEsR0FBZixVQUFnQixPQUFxQjtRQUNqQyxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELGdEQUFnRDtJQUN6Qyw4QkFBTyxHQUFkLFVBQWUsTUFBYztRQUE3QixpQkFrQkM7UUFqQkcsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxpQkFBaUIsRUFBRTtZQUNoRCxJQUFNLFlBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUM1QyxJQUFNLGVBQWEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQztZQUNsRCxRQUFRLE1BQU0sQ0FBQyxTQUFTLEVBQUU7Z0JBQ3RCLEtBQUssaUJBQWlCLENBQUM7Z0JBQ3ZCLEtBQUssMEJBQTBCLENBQUM7Z0JBQ2hDLEtBQUssaUJBQWlCLENBQUM7Z0JBQ3ZCLEtBQUssMEJBQTBCO29CQUMzQixPQUFPLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsZUFBYSxFQUFFLFlBQVUsQ0FBQyxDQUFDLElBQUksQ0FBRSxVQUFBLEtBQUs7d0JBQ2hGLEtBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxlQUFhLEVBQUUsWUFBVSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2pGLENBQUMsQ0FBQyxDQUFDO2dCQUNQLEtB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QVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUMxRCxDQUFDO0lBQ0wsbUJBQUM7QUFBRCxDQUFDLEFBekhELElBeUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlLCBGbHVzaENvbnRleHQsIFdvcmtlciB9IGZyb20gJy4uL2NoYW5nZS1sb2cuc2VydmljZSc7XG5pbXBvcnQgeyBMb2NhbERCU3RvcmUgfSBmcm9tICcuLi8uLi9tb2RlbHMvbG9jYWwtZGItc3RvcmUnO1xuaW1wb3J0IHsgTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vbG9jYWwtZGItbWFuYWdlbWVudC5zZXJ2aWNlJztcblxuZGVjbGFyZSBjb25zdCBfO1xuXG5jb25zdCBTVE9SRV9LRVkgPSAnZXJyb3JCbG9ja2VyU3RvcmUnO1xuXG5leHBvcnQgY2xhc3MgRXJyb3JCbG9ja2VyIGltcGxlbWVudHMgV29ya2VyIHtcblxuICAgIHByaXZhdGUgZXJyb3JTdG9yZTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlOiBMb2NhbERCTWFuYWdlbWVudFNlcnZpY2UpIHtcbiAgICB9XG5cbiAgICBwdWJsaWMgcHJlRmx1c2goY29udGV4dDogRmx1c2hDb250ZXh0KSB7XG4gICAgICAgIHRoaXMuZXJyb3JTdG9yZSA9IGNvbnRleHQuZ2V0KFNUT1JFX0tFWSk7XG4gICAgfVxuXG4gICAgLy8gYmxvY2sgYWxsIGNhbGxzIHJlbGF0ZWQgdG8gdGhlIGVycm9yIGVudGl0aWVzXG4gICAgcHVibGljIHByZUNhbGwoY2hhbmdlOiBDaGFuZ2UpIHtcbiAgICAgICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2Uuc2VydmljZSA9PT0gJ0RhdGFiYXNlU2VydmljZScpIHtcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eU5hbWUgPSBjaGFuZ2UucGFyYW1zLmVudGl0eU5hbWU7XG4gICAgICAgICAgICBjb25zdCBkYXRhTW9kZWxOYW1lID0gY2hhbmdlLnBhcmFtcy5kYXRhTW9kZWxOYW1lO1xuICAgICAgICAgICAgc3dpdGNoIChjaGFuZ2Uub3BlcmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAnaW5zZXJ0VGFibGVEYXRhJzpcbiAgICAgICAgICAgICAgICBjYXNlICdpbnNlcnRNdWx0aVBhcnRUYWJsZURhdGEnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ3VwZGF0ZVRhYmxlRGF0YSc6XG4gICAgICAgICAgICAgICAgY2FzZSAndXBkYXRlTXVsdGlQYXJ0VGFibGVEYXRhJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlLmdldFN0b3JlKGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUpLnRoZW4oIHN0b3JlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tDYWxsKHN0b3JlLCBjaGFuZ2UsIGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUsIGNoYW5nZS5wYXJhbXMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2RlbGV0ZVRhYmxlRGF0YSc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5nZXRTdG9yZShkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lKS50aGVuKCBzdG9yZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrQ2FsbChzdG9yZSwgY2hhbmdlLCBkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lLCBjaGFuZ2UucGFyYW1zKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBzdG9yZSBlcnJvciBlbnRpdHkgaWRcbiAgICBwdWJsaWMgcG9zdENhbGxTdWNjZXNzKGNoYW5nZTogQ2hhbmdlKSB7XG4gICAgICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnNlcnZpY2UgPT09ICdEYXRhYmFzZVNlcnZpY2UnKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlOYW1lID0gY2hhbmdlLnBhcmFtcy5lbnRpdHlOYW1lO1xuICAgICAgICAgICAgY29uc3QgZGF0YU1vZGVsTmFtZSA9IGNoYW5nZS5wYXJhbXMuZGF0YU1vZGVsTmFtZTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5nZXRTdG9yZShkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lKS50aGVuKCBzdG9yZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSBjaGFuZ2VbJ2RhdGFMb2NhbElkJ10gfHwgY2hhbmdlLnBhcmFtcy5kYXRhW3N0b3JlLnByaW1hcnlLZXlOYW1lXTtcbiAgICAgICAgICAgICAgICBpZiAoIShfLmlzVW5kZWZpbmVkKGlkKSB8fCBfLmlzTnVsbChpZCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRXJyb3IoZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSwgaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gc3RvcmUgZXJyb3IgZW50aXR5IGlkXG4gICAgcHVibGljIHBvc3RDYWxsRXJyb3IoY2hhbmdlOiBDaGFuZ2UpIHtcbiAgICAgICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2Uuc2VydmljZSA9PT0gJ0RhdGFiYXNlU2VydmljZScpIHtcbiAgICAgICAgICAgIGNvbnN0IGVudGl0eU5hbWUgPSBjaGFuZ2UucGFyYW1zLmVudGl0eU5hbWU7XG4gICAgICAgICAgICBjb25zdCBkYXRhTW9kZWxOYW1lID0gY2hhbmdlLnBhcmFtcy5kYXRhTW9kZWxOYW1lO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlLmdldFN0b3JlKGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUpLnRoZW4oIHN0b3JlID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGNoYW5nZVsnZGF0YUxvY2FsSWQnXSB8fCAoY2hhbmdlLnBhcmFtcy5kYXRhICYmIGNoYW5nZS5wYXJhbXMuZGF0YVtzdG9yZS5wcmltYXJ5S2V5TmFtZV0pIHx8IGNoYW5nZS5wYXJhbXNbc3RvcmUucHJpbWFyeUtleU5hbWVdIHx8IGNoYW5nZS5wYXJhbXMuaWQ7XG4gICAgICAgICAgICAgICAgaWYgKCEoXy5pc1VuZGVmaW5lZChpZCkgfHwgXy5pc051bGwoaWQpKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29yZEVycm9yKGRhdGFNb2RlbE5hbWUsIGVudGl0eU5hbWUsIGlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIElmIHRoZXJlIGlzIGFuIGVhcmxpZXIgY2FsbCBvZiB0aGUgb2JqZWN0IG9yIGl0cyByZWxhdGlvbnMgdGhhdCBnb3QgZmFpbGVkLCB0aGVuIHRoaXMgY2FsbCB3aWxsIGJlXG4gICAgICogbWFya2VkIGZvciBkaXNjYXJkLlxuICAgICAqXG4gICAgICogQHBhcmFtIHN0b3JlIExvY2FsREJTdG9yZVxuICAgICAqIEBwYXJhbSBjaGFuZ2UgY2hhbmdlIHRvIGJsb2NrXG4gICAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWVcbiAgICAgKiBAcGFyYW0gZW50aXR5TmFtZVxuICAgICAqIEBwYXJhbSBkYXRhXG4gICAgICovXG4gICAgcHJpdmF0ZSBibG9ja0NhbGwoc3RvcmU6IExvY2FsREJTdG9yZSwgY2hhbmdlOiBDaGFuZ2UsIGRhdGFNb2RlbE5hbWU6IHN0cmluZywgZW50aXR5TmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpIHtcbiAgICAgICAgaWYgKGNoYW5nZS5oYXNFcnJvciA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5jaGVja0ZvclByZXZpb3VzRXJyb3Ioc3RvcmUsIGNoYW5nZSwgZGF0YU1vZGVsTmFtZSwgZW50aXR5TmFtZSwgZGF0YSk7XG4gICAgICAgICAgICBzdG9yZS5lbnRpdHlTY2hlbWEuY29sdW1ucy5mb3JFYWNoKGNvbCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbC5mb3JlaWduUmVsYXRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5mb3JlaWduUmVsYXRpb25zLnNvbWUoZm9yZWlnblJlbGF0aW9uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhW2ZvcmVpZ25SZWxhdGlvbi5zb3VyY2VGaWVsZE5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ibG9ja0NhbGwoc3RvcmUsIGNoYW5nZSwgZGF0YU1vZGVsTmFtZSwgZm9yZWlnblJlbGF0aW9uLnRhcmdldEVudGl0eSwgZGF0YVtmb3JlaWduUmVsYXRpb24uc291cmNlRmllbGROYW1lXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGFbY29sLmZpZWxkTmFtZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrRm9yUHJldmlvdXNFcnJvcihzdG9yZSwgY2hhbmdlLCBkYXRhTW9kZWxOYW1lLCBmb3JlaWduUmVsYXRpb24udGFyZ2V0RW50aXR5LCBkYXRhLCBjb2wuZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGFuZ2UuaGFzRXJyb3IgPT09IDE7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQSBoZWxwZXIgZnVuY3Rpb24gdG8gY2hlY2sgZm9yIGVhcmxpZXIgZmFpbHVyZXMuXG4gICAgcHJpdmF0ZSBjaGVja0ZvclByZXZpb3VzRXJyb3Ioc3RvcmU6IExvY2FsREJTdG9yZSwgY2hhbmdlOiBDaGFuZ2UsIGRhdGFNb2RlbE5hbWU6IHN0cmluZywgZW50aXR5TmFtZTogc3RyaW5nLCBkYXRhOiBhbnksIGtleT86IGFueSkge1xuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0ga2V5IHx8IHN0b3JlLnByaW1hcnlLZXlOYW1lO1xuICAgICAgICBpZiAodGhpcy5oYXNFcnJvcihkYXRhTW9kZWxOYW1lLCBlbnRpdHlOYW1lLCBkYXRhW3ByaW1hcnlLZXldKSkge1xuICAgICAgICAgICAgY2hhbmdlLmhhc0Vycm9yID0gMTtcbiAgICAgICAgICAgIGNoYW5nZS5lcnJvck1lc3NhZ2UgPSBgQmxvY2tlZCBjYWxsIGR1ZSB0byBlcnJvciBpbiBwcmV2aW91cyBjYWxsIG9mIGVudGl0eSBbICR7ZW50aXR5TmFtZX0gXSB3aXRoIGlkIFsgJHtkYXRhW3ByaW1hcnlLZXldfSBdYDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFzRXJyb3IoZGF0YU1vZGVsTmFtZTogc3RyaW5nLCBlbnRpdHlOYW1lOiBzdHJpbmcsIGlkOiBhbnkpIHtcbiAgICAgICAgaWYgKHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVxuICAgICAgICAgICAgJiYgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdXG4gICAgICAgICAgICAmJiB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1bZW50aXR5TmFtZV1baWRdKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlcyBlbnRpdHkgaWRlbnRpZmllciBmcm9tIGVycm9yIGxpc3QuXG4gICAgcHJpdmF0ZSByZW1vdmVFcnJvcihkYXRhTW9kZWxOYW1lOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZywgaWQ6IGFueSkge1xuICAgICAgICBpZiAodGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdXG4gICAgICAgICAgICAmJiB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1bZW50aXR5TmFtZV1cbiAgICAgICAgICAgICYmIHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXVtlbnRpdHlOYW1lXVtpZF0pIHtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1bZW50aXR5TmFtZV1baWRdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2F2ZSBlcnJvciBlbnRpdHkgaWRlbnRpZmllci5cbiAgICBwcml2YXRlIHJlY29yZEVycm9yKGRhdGFNb2RlbE5hbWU6IHN0cmluZywgZW50aXR5TmFtZTogc3RyaW5nLCBpZDogYW55KSB7XG4gICAgICAgIHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXSA9IHRoaXMuZXJyb3JTdG9yZVtkYXRhTW9kZWxOYW1lXSB8fCB7fTtcbiAgICAgICAgdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdID0gdGhpcy5lcnJvclN0b3JlW2RhdGFNb2RlbE5hbWVdW2VudGl0eU5hbWVdIHx8IHt9O1xuICAgICAgICB0aGlzLmVycm9yU3RvcmVbZGF0YU1vZGVsTmFtZV1bZW50aXR5TmFtZV1baWRdID0gdHJ1ZTtcbiAgICB9XG59XG4iXX0=