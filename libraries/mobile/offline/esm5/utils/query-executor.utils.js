import { from } from 'rxjs';
import { WM_LOCAL_OFFLINE_CALL } from './utils';
var NUMBER_REGEX = /^\d+(\.\d+)?$/;
var isOfflineBehaviourAdded = false;
var NamedQueryExecutionOfflineBehaviour = /** @class */ (function () {
    function NamedQueryExecutionOfflineBehaviour(changeLogService, httpService, localDBManagementService, networkService) {
        this.changeLogService = changeLogService;
        this.httpService = httpService;
        this.localDBManagementService = localDBManagementService;
        this.networkService = networkService;
    }
    NamedQueryExecutionOfflineBehaviour.prototype.add = function () {
        var _this = this;
        if (isOfflineBehaviourAdded) {
            return;
        }
        isOfflineBehaviourAdded = true;
        var orig = this.httpService.sendCallAsObservable;
        this.httpService.sendCallAsObservable = function (reqParams, params) {
            if (!params && _.get(reqParams, 'url')) {
                params = { url: reqParams.url };
            }
            if (!_this.networkService.isConnected() && params.url.indexOf('/queryExecutor/') > 0) {
                return from(_this.executeLocally(params));
            }
            else {
                return orig.call(_this.httpService, reqParams, params);
            }
        };
    };
    NamedQueryExecutionOfflineBehaviour.prototype.executeLocally = function (params) {
        var _this = this;
        var url = params.url, hasUrlParams = url.indexOf('?') > 0, dbName = this.substring(url, 'services/', '/queryExecutor'), queryName = this.substring(url, 'queries/', hasUrlParams ? '?' : undefined), urlParams = hasUrlParams ? this.getHttpParamMap(this.substring(url, '?', undefined)) : {}, dataParams = this.getHttpParamMap(params.dataParams), queryParams = _.extend(urlParams, dataParams);
        return this.localDBManagementService.executeNamedQuery(dbName, queryName, queryParams)
            .then(function (result) {
            var rows = result.rows;
            if (result.rowsAffected) {
                return _this.changeLogService.add('WebService', 'invokeJavaService', params)
                    .then(function () { return result.rowsAffected; });
            }
            else {
                return {
                    type: WM_LOCAL_OFFLINE_CALL,
                    body: {
                        totalPages: rows && rows.length > 0 ? 1 : 0,
                        totalElements: rows.length,
                        first: true,
                        sort: null,
                        numberOfElements: rows.length,
                        last: true,
                        size: params.size,
                        number: 0,
                        content: rows
                    }
                };
            }
        });
    };
    NamedQueryExecutionOfflineBehaviour.prototype.substring = function (source, start, end) {
        if (start) {
            var startIndex = source.indexOf(start) + start.length, endIndex = end ? source.indexOf(end) : undefined;
            return source.substring(startIndex, endIndex);
        }
        return undefined;
    };
    NamedQueryExecutionOfflineBehaviour.prototype.getHttpParamMap = function (str) {
        var result = {};
        if (str) {
            str = decodeURIComponent(str);
            str.split('&').forEach(function (c) {
                var csplits = c.split('=');
                if (_.isEmpty(_.trim(csplits[1])) || !NUMBER_REGEX.test(csplits[1])) {
                    result[csplits[0]] = csplits[1];
                }
                else {
                    result[csplits[0]] = parseInt(csplits[1], 10);
                }
            });
        }
        return result;
    };
    return NamedQueryExecutionOfflineBehaviour;
}());
export { NamedQueryExecutionOfflineBehaviour };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZXhlY3V0b3IudXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vbW9iaWxlL29mZmxpbmUvIiwic291cmNlcyI6WyJ1dGlscy9xdWVyeS1leGVjdXRvci51dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBT3hDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUdoRCxJQUFNLFlBQVksR0FBRyxlQUFlLENBQUM7QUFDckMsSUFBSSx1QkFBdUIsR0FBRyxLQUFLLENBQUM7QUFDcEM7SUFFSSw2Q0FDWSxnQkFBa0MsRUFDbEMsV0FBZ0MsRUFDaEMsd0JBQWtELEVBQ2xELGNBQThCO1FBSDlCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBQ2hDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBRzFDLENBQUM7SUFFTSxpREFBRyxHQUFWO1FBQUEsaUJBZ0JDO1FBZkcsSUFBSSx1QkFBdUIsRUFBRTtZQUN6QixPQUFPO1NBQ1Y7UUFDRCx1QkFBdUIsR0FBRyxJQUFJLENBQUM7UUFDL0IsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQztRQUNuRCxJQUFJLENBQUMsV0FBVyxDQUFDLG9CQUFvQixHQUFHLFVBQUMsU0FBYyxFQUFFLE1BQVk7WUFDakUsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsRUFBRTtnQkFDcEMsTUFBTSxHQUFHLEVBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxHQUFHLEVBQUMsQ0FBQzthQUNqQztZQUNELElBQUksQ0FBQyxLQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUMs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QVMsQ0FBQztJQUNyQixDQUFDO0lBRU8sNkRBQWUsR0FBdkIsVUFBd0IsR0FBVztRQUMvQixJQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxHQUFHLEVBQUU7WUFDTCxHQUFHLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDO2dCQUNwQixJQUFNLE9BQU8sR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM3QixJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtvQkFDakUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDbkM7cUJBQU07b0JBQ0gsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ2pEO1lBQ0wsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFDTCwwQ0FBQztBQUFELENBQUMsQUF0RkQsSUFzRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEFic3RyYWN0SHR0cFNlcnZpY2UgfSBmcm9tICdAd20vY29yZSc7XG5pbXBvcnQgeyBOZXR3b3JrU2VydmljZSB9IGZyb20gJ0B3bS9tb2JpbGUvY29yZSc7XG5cbmltcG9ydCB7IENoYW5nZUxvZ1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9jaGFuZ2UtbG9nLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbG9jYWwtZGItbWFuYWdlbWVudC5zZXJ2aWNlJztcbmltcG9ydCB7IFdNX0xPQ0FMX09GRkxJTkVfQ0FMTCB9IGZyb20gJy4vdXRpbHMnO1xuXG5kZWNsYXJlIGNvbnN0IF87XG5jb25zdCBOVU1CRVJfUkVHRVggPSAvXlxcZCsoXFwuXFxkKyk/JC87XG5sZXQgaXNPZmZsaW5lQmVoYXZpb3VyQWRkZWQgPSBmYWxzZTtcbmV4cG9ydCBjbGFzcyBOYW1lZFF1ZXJ5RXhlY3V0aW9uT2ZmbGluZUJlaGF2aW91ciB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBjaGFuZ2VMb2dTZXJ2aWNlOiBDaGFuZ2VMb2dTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGh0dHBTZXJ2aWNlOiBBYnN0cmFjdEh0dHBTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvY2FsREJNYW5hZ2VtZW50U2VydmljZTogTG9jYWxEQk1hbmFnZW1lbnRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG5ldHdvcmtTZXJ2aWNlOiBOZXR3b3JrU2VydmljZVxuICAgICkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGFkZCAoKSB7XG4gICAgICAgIGlmIChpc09mZmxpbmVCZWhhdmlvdXJBZGRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlzT2ZmbGluZUJlaGF2aW91ckFkZGVkID0gdHJ1ZTtcbiAgICAgICAgY29uc3Qgb3JpZyA9IHRoaXMuaHR0cFNlcnZpY2Uuc2VuZENhbGxBc09ic2VydmFibGU7XG4gICAgICAgIHRoaXMuaHR0cFNlcnZpY2Uuc2VuZENhbGxBc09ic2VydmFibGUgPSAocmVxUGFyYW1zOiBhbnksIHBhcmFtcz86IGFueSk6IE9ic2VydmFibGU8YW55PiA9PiB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtcyAmJiBfLmdldChyZXFQYXJhbXMsICd1cmwnKSkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IHt1cmw6IHJlcVBhcmFtcy51cmx9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLm5ldHdvcmtTZXJ2aWNlLmlzQ29ubmVjdGVkKCkgJiYgcGFyYW1zLnVybC5pbmRleE9mKCcvcXVlcnlFeGVjdXRvci8nKSA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZnJvbSh0aGlzLmV4ZWN1dGVMb2NhbGx5KHBhcmFtcykpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JpZy5jYWxsKHRoaXMuaHR0cFNlcnZpY2UsIHJlcVBhcmFtcywgcGFyYW1zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGV4ZWN1dGVMb2NhbGx5KHBhcmFtczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgdXJsID0gcGFyYW1zLnVybCxcbiAgICAgICAgICAgIGhhc1VybFBhcmFtcyA9IHVybC5pbmRleE9mKCc/JykgPiAwLFxuICAgICAgICAgICAgZGJOYW1lID0gdGhpcy5zdWJzdHJpbmcodXJsLCAnc2VydmljZXMvJywgJy9xdWVyeUV4ZWN1dG9yJyksXG4gICAgICAgICAgICBxdWVyeU5hbWUgPSB0aGlzLnN1YnN0cmluZyh1cmwsICdxdWVyaWVzLycsIGhhc1VybFBhcmFtcyA/ICc/JyA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICB1cmxQYXJhbXMgPSBoYXNVcmxQYXJhbXMgPyB0aGlzLmdldEh0dHBQYXJhbU1hcCh0aGlzLnN1YnN0cmluZyh1cmwsICc/JywgdW5kZWZpbmVkKSkgOiB7fSxcbiAgICAgICAgICAgIGRhdGFQYXJhbXMgPSB0aGlzLmdldEh0dHBQYXJhbU1hcChwYXJhbXMuZGF0YVBhcmFtcyksXG4gICAgICAgICAgICBxdWVyeVBhcmFtcyA9IF8uZXh0ZW5kKHVybFBhcmFtcywgZGF0YVBhcmFtcyk7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsREJNYW5hZ2VtZW50U2VydmljZS5leGVjdXRlTmFtZWRRdWVyeShkYk5hbWUsIHF1ZXJ5TmFtZSwgcXVlcnlQYXJhbXMpXG4gICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvd3MgPSByZXN1bHQucm93cztcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnJvd3NBZmZlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VMb2dTZXJ2aWNlLmFkZCgnV2ViU2VydmljZScsICdpbnZva2VKYXZhU2VydmljZScsIHBhcmFtcylcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHJlc3VsdC5yb3dzQWZmZWN0ZWQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBXTV9MT0NBTF9PRkZMSU5FX0NBTEwsXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxQYWdlczogcm93cyAmJiByb3dzLmxlbmd0aCA+IDAgPyAxIDogMCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbEVsZW1lbnRzOiByb3dzLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0OiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bWJlck9mRWxlbWVudHM6IHJvd3MubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Q6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZTogcGFyYW1zLnNpemUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVtYmVyOiAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHJvd3NcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN1YnN0cmluZyhzb3VyY2U6IHN0cmluZywgc3RhcnQ6IHN0cmluZywgZW5kOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAoc3RhcnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBzb3VyY2UuaW5kZXhPZihzdGFydCkgKyBzdGFydC5sZW5ndGgsXG4gICAgICAgICAgICAgICAgZW5kSW5kZXggPSBlbmQgPyBzb3VyY2UuaW5kZXhPZihlbmQpIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzdHJpbmcoc3RhcnRJbmRleCwgZW5kSW5kZXgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRIdHRwUGFyYW1NYXAoc3RyOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICAgICAgaWYgKHN0cikge1xuICAgICAgICAgICAgc3RyID0gZGVjb2RlVVJJQ29tcG9uZW50KHN0cik7XG4gICAgICAgICAgICBzdHIuc3BsaXQoJyYnKS5mb3JFYWNoKGMgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNzcGxpdHMgPSBjLnNwbGl0KCc9Jyk7XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNFbXB0eShfLnRyaW0oY3NwbGl0c1sxXSkpIHx8ICFOVU1CRVJfUkVHRVgudGVzdChjc3BsaXRzWzFdKSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRbY3NwbGl0c1swXV0gPSBjc3BsaXRzWzFdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtjc3BsaXRzWzBdXSA9IHBhcnNlSW50KGNzcGxpdHNbMV0sIDEwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbn1cbiJdfQ==