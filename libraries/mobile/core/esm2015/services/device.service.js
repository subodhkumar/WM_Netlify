import { Injectable } from '@angular/core';
import { File } from '@ionic-native/file';
import { $appDigest, hasCordova, noop } from '@wm/core';
import * as i0 from "@angular/core";
import * as i1 from "@ionic-native/file";
const REGISTRY_FILE_NAME = 'registry.info';
export class DeviceService {
    constructor(file) {
        this.file = file;
        this._registry = {};
        this._isReady = false;
        this._whenReadyPromises = [];
        this._backBtnTapListeners = [];
        this._startUpServices = [];
        const maxWaitTime = 10;
        setTimeout(() => {
            if (!this._isReady) {
                console.warn(`Device is not ready even after ${maxWaitTime} seconds`);
                console.warn('Waiting For %O', this._startUpServices.map(i => i.serviceName));
            }
        }, maxWaitTime * 1000);
        document.addEventListener('backbutton', this.executeBackTapListeners.bind(this));
    }
    executeBackTapListeners($event) {
        _.forEach(this._backBtnTapListeners, fn => {
            return fn($event) !== false;
        });
        // explicitly applying the digest cycle as the backbutton listener is not rendering the page content.
        // This is because zone is not run (there is no change detection)
        // https://weblogs.thinktecture.com/thomas/2017/02/cordova-vs-zonejs-or-why-is-angulars-document-event-listener-not-in-a-zone.html
        $appDigest();
    }
    addStartUpService(service) {
        this._startUpServices.push(service);
    }
    onBackButtonTap(fn) {
        this._backBtnTapListeners.unshift(fn);
        return () => {
            const i = this._backBtnTapListeners.indexOf(fn);
            if (i >= 0) {
                this._backBtnTapListeners.splice(i, 1);
            }
        };
    }
    start() {
        if (this._isReady || this._startUpServices.length === 0) {
            this._isReady = true;
            return Promise.resolve();
        }
        else {
            return new Promise((resolve) => {
                if (hasCordova()) {
                    document.addEventListener('deviceready', () => resolve(), false);
                }
                else {
                    resolve();
                }
            }).then(() => {
                if (window['cordova']) {
                    return this.file.readAsText(cordova.file.dataDirectory, REGISTRY_FILE_NAME)
                        .then(content => this._registry = JSON.parse(content), noop);
                }
            }).then(() => {
                return Promise.all(this._startUpServices.map(s => {
                    return s.start().catch((error) => {
                        console.error('%s failed to start due to: %O', s.serviceName, error);
                        return Promise.reject(error);
                    });
                }));
            }).then(() => {
                window['wmDeviceReady'] = true;
                document.dispatchEvent(new CustomEvent('wmDeviceReady'));
                this._startUpServices.length = 0;
                this._whenReadyPromises.forEach(fn => fn());
                this._isReady = true;
            });
        }
    }
    whenReady() {
        if (this._isReady) {
            return Promise.resolve();
        }
        else {
            return new Promise((resolve) => {
                this._whenReadyPromises.push(resolve);
            });
        }
    }
    /**
     * @returns {Promise<number>} promise resolved with the app build time
     */
    getAppBuildTime() {
        return this.file.readAsText(cordova.file.applicationDirectory + 'www', 'config.json')
            .then(appConfig => (JSON.parse(appConfig).buildTime));
    }
    /**
     * Stores an entry that survives app restarts and updates.
     *
     * @param {string} key
     * @param {Object} value
     * @returns {Promise<any>}
     */
    storeEntry(key, value) {
        this._registry[key] = value;
        return this.file.writeFile(cordova.file.dataDirectory, REGISTRY_FILE_NAME, JSON.stringify(this._registry), { replace: true });
    }
    /**
     * @param {string} key
     * @returns {any} entry corresponding to the key
     */
    getEntry(key) {
        return this._registry[key];
    }
}
DeviceService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
DeviceService.ctorParameters = () => [
    { type: File }
];
DeviceService.ngInjectableDef = i0.defineInjectable({ factory: function DeviceService_Factory() { return new DeviceService(i0.inject(i1.File)); }, token: DeviceService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vbW9iaWxlL2NvcmUvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9kZXZpY2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxVQUFVLENBQUM7OztBQU14RCxNQUFNLGtCQUFrQixHQUFHLGVBQWUsQ0FBQztBQUczQyxNQUFNLE9BQU8sYUFBYTtJQVF0QixZQUEyQixJQUFVO1FBQVYsU0FBSSxHQUFKLElBQUksQ0FBTTtRQU43QixjQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ2YsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQix1QkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDeEIseUJBQW9CLEdBQUcsRUFBRSxDQUFDO1FBQzFCLHFCQUFnQixHQUE0QixFQUFFLENBQUM7UUFHbkQsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsT0FBTyxDQUFDLElBQUksQ0FBQyxrQ0FBa0MsV0FBVyxVQUFVLENBQUMsQ0FBQztnQkFDdEUsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7YUFDakY7UUFDTCxDQUFDLEVBQUUsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FB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QUMsR0FBVztRQUN2QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQzs7O1lBcEhKLFVBQVUsU0FBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7Ozs7WUFWekIsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJ0Bpb25pYy1uYXRpdmUvZmlsZSc7XG5cbmltcG9ydCB7ICRhcHBEaWdlc3QsIGhhc0NvcmRvdmEsIG5vb3AgfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IElEZXZpY2VTdGFydFVwU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLXN0YXJ0LXVwLXNlcnZpY2UnO1xuXG5kZWNsYXJlIGNvbnN0IGNvcmRvdmEsIF87XG5cbmNvbnN0IFJFR0lTVFJZX0ZJTEVfTkFNRSA9ICdyZWdpc3RyeS5pbmZvJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBEZXZpY2VTZXJ2aWNlIHtcblxuICAgIHByaXZhdGUgX3JlZ2lzdHJ5ID0ge307XG4gICAgcHJpdmF0ZSBfaXNSZWFkeSA9IGZhbHNlO1xuICAgIHByaXZhdGUgX3doZW5SZWFkeVByb21pc2VzID0gW107XG4gICAgcHJpdmF0ZSBfYmFja0J0blRhcExpc3RlbmVycyA9IFtdO1xuICAgIHByaXZhdGUgX3N0YXJ0VXBTZXJ2aWNlczogSURldmljZVN0YXJ0VXBTZXJ2aWNlW10gPSBbXTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGZpbGU6IEZpbGUpIHtcbiAgICAgICAgY29uc3QgbWF4V2FpdFRpbWUgPSAxMDtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX2lzUmVhZHkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYERldmljZSBpcyBub3QgcmVhZHkgZXZlbiBhZnRlciAke21heFdhaXRUaW1lfSBzZWNvbmRzYCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdXYWl0aW5nIEZvciAlTycsIHRoaXMuX3N0YXJ0VXBTZXJ2aWNlcy5tYXAoaSA9PiBpLnNlcnZpY2VOYW1lKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIG1heFdhaXRUaW1lICogMTAwMCk7XG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2JhY2tidXR0b24nLCB0aGlzLmV4ZWN1dGVCYWNrVGFwTGlzdGVuZXJzLmJpbmQodGhpcykpO1xuICAgIH1cblxuICAgIHB1YmxpYyBleGVjdXRlQmFja1RhcExpc3RlbmVycygkZXZlbnQpIHtcbiAgICAgICAgXy5mb3JFYWNoKHRoaXMuX2JhY2tCdG5UYXBMaXN0ZW5lcnMsIGZuID0+IHtcbiAgICAgICAgICAgIHJldHVybiBmbigkZXZlbnQpICE9PSBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIGV4cGxpY2l0bHkgYXBwbHlpbmcgdGhlIGRpZ2VzdCBjeWNsZSBhcyB0aGUgYmFja2J1dHRvbiBsaXN0ZW5lciBpcyBub3QgcmVuZGVyaW5nIHRoZSBwYWdlIGNvbnRlbnQuXG4gICAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB6b25lIGlzIG5vdCBydW4gKHRoZXJlIGlzIG5vIGNoYW5nZSBkZXRlY3Rpb24pXG4gICAgICAgIC8vIGh0dHBzOi8vd2VibG9ncy50aGlua3RlY3R1cmUuY29tL3Rob21hcy8yMDE3LzAyL2NvcmRvdmEtdnMtem9uZWpzLW9yLXdoeS1pcy1hbmd1bGFycy1kb2N1bWVudC1ldmVudC1saXN0ZW5lci1ub3QtaW4tYS16b25lLmh0bWxcbiAgICAgICAgJGFwcERpZ2VzdCgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRTdGFydFVwU2VydmljZShzZXJ2aWNlOiBJRGV2aWNlU3RhcnRVcFNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5fc3RhcnRVcFNlcnZpY2VzLnB1c2goc2VydmljZSk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uQmFja0J1dHRvblRhcChmbjogKCRldmVudCkgPT4gYm9vbGVhbikge1xuICAgICAgICB0aGlzLl9iYWNrQnRuVGFwTGlzdGVuZXJzLnVuc2hpZnQoZm4pO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaSA9IHRoaXMuX2JhY2tCdG5UYXBMaXN0ZW5lcnMuaW5kZXhPZihmbik7XG4gICAgICAgICAgICBpZiAoaSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYmFja0J0blRhcExpc3RlbmVycy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXJ0KCkge1xuICAgICAgICBpZiAodGhpcy5faXNSZWFkeSB8fCB0aGlzLl9zdGFydFVwU2VydmljZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLl9pc1JlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChoYXNDb3Jkb3ZhKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCAoKSA9PiByZXNvbHZlKCksIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGUucmVhZEFzVGV4dChjb3Jkb3ZhLmZpbGUuZGF0YURpcmVjdG9yeSwgUkVHSVNUUllfRklMRV9OQU1FKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oY29udGVudCA9PiAgdGhpcy5fcmVnaXN0cnkgPSBKU09OLnBhcnNlKGNvbnRlbnQpLCBub29wKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwodGhpcy5fc3RhcnRVcFNlcnZpY2VzLm1hcChzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHMuc3RhcnQoKS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzIGZhaWxlZCB0byBzdGFydCBkdWUgdG86ICVPJywgcy5zZXJ2aWNlTmFtZSwgZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgd2luZG93Wyd3bURldmljZVJlYWR5J10gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd3bURldmljZVJlYWR5JykpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0VXBTZXJ2aWNlcy5sZW5ndGggPSAwO1xuICAgICAgICAgICAgICAgIHRoaXMuX3doZW5SZWFkeVByb21pc2VzLmZvckVhY2goZm4gPT4gZm4oKSk7XG4gICAgICAgICAgICAgICAgdGhpcy5faXNSZWFkeSA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyB3aGVuUmVhZHkoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICh0aGlzLl9pc1JlYWR5KSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl93aGVuUmVhZHlQcm9taXNlcy5wdXNoKHJlc29sdmUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxudW1iZXI+fSBwcm9taXNlIHJlc29sdmVkIHdpdGggdGhlIGFwcCBidWlsZCB0aW1lXG4gICAgICovXG4gICAgcHVibGljIGdldEFwcEJ1aWxkVGltZSgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5maWxlLnJlYWRBc1RleHQoY29yZG92YS5maWxlLmFwcGxpY2F0aW9uRGlyZWN0b3J5ICsgJ3d3dycsICdjb25maWcuanNvbicpXG4gICAgICAgICAgICAudGhlbihhcHBDb25maWcgPT4gKEpTT04ucGFyc2UoYXBwQ29uZmlnKS5idWlsZFRpbWUpIGFzIG51bWJlcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcmVzIGFuIGVudHJ5IHRoYXQgc3Vydml2ZXMgYXBwIHJlc3RhcnRzIGFuZCB1cGRhdGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGtleVxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59XG4gICAgICovXG4gICAgcHVibGljIHN0b3JlRW50cnkoa2V5OiBzdHJpbmcsIHZhbHVlOiBPYmplY3QpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICB0aGlzLl9yZWdpc3RyeVtrZXldID0gdmFsdWU7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbGUud3JpdGVGaWxlKGNvcmRvdmEuZmlsZS5kYXRhRGlyZWN0b3J5LFxuICAgICAgICAgICAgUkVHSVNUUllfRklMRV9OQU1FLFxuICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5fcmVnaXN0cnkpLFxuICAgICAgICAgICAgeyByZXBsYWNlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXlcbiAgICAgKiBAcmV0dXJucyB7YW55fSBlbnRyeSBjb3JyZXNwb25kaW5nIHRvIHRoZSBrZXlcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0RW50cnkoa2V5OiBzdHJpbmcpOiBhbnkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcmVnaXN0cnlba2V5XTtcbiAgICB9XG59XG4iXX0=