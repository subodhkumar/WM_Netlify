import { Injectable } from '@angular/core';
import { File } from '@ionic-native/file';
import { convertToBlob } from '@wm/core';
import * as i0 from "@angular/core";
import * as i1 from "@ionic-native/file";
export class UploadRequest {
    constructor(url, cordovaFile) {
        this.url = url;
        this.cordovaFile = cordovaFile;
        this._files = [];
        this._params = [];
        this._headers = [];
    }
    addFile(name, path, filename) {
        this._files.push({
            name: name,
            path: path,
            fileName: filename
        });
        return this;
    }
    addHeader(name, value) {
        this._headers.push({
            name: name,
            value: value
        });
        return this;
    }
    addParam(name, value) {
        this._params.push({
            name: name,
            value: value
        });
        return this;
    }
    post() {
        const formData = new FormData();
        this._params.forEach(e => formData.append(e.name, e.value));
        return Promise.all(this._files.map(e => {
            if (e.path) {
                return convertToBlob(e.path)
                    .then(result => {
                    return {
                        name: e.name,
                        fileName: e.fileName,
                        blob: result.blob
                    };
                });
            }
            return e;
        })).then(params => {
            params.forEach(e => formData.append(e.name, e.blob || e.path, e.fileName));
            return new Promise((resolve, reject) => {
                const request = new XMLHttpRequest();
                request.open('POST', this.url);
                this._headers.forEach(e => request.setRequestHeader(e.name, e.value));
                request.onload = () => {
                    resolve({
                        headers: (name) => request.getResponseHeader(name),
                        response: request.response,
                        text: request.responseText
                    });
                };
                request.onerror = reject;
                request.onabort = reject;
                request.send(formData);
            });
        });
    }
}
export class DeviceFileUploadService {
    constructor(cordovaFile) {
        this.cordovaFile = cordovaFile;
    }
    upload(url, fileParamName, path, fileName, params, headers) {
        const req = new UploadRequest(url, this.cordovaFile)
            .addFile(fileParamName, path, fileName);
        _.forEach(params, (k, v) => req.addParam(k, v));
        _.forEach(headers, (k, v) => req.addHeader(k, v));
        return req.post();
    }
}
DeviceFileUploadService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
DeviceFileUploadService.ctorParameters = () => [
    { type: File }
];
DeviceFileUploadService.ngInjectableDef = i0.defineInjectable({ factory: function DeviceFileUploadService_Factory() { return new DeviceFileUploadService(i0.inject(i1.File)); }, token: DeviceFileUploadService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWZpbGUtdXBsb2FkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vbW9iaWxlL2NvcmUvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9kZXZpY2UtZmlsZS11cGxvYWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDOzs7QUFVekMsTUFBTSxPQUFPLGFBQWE7SUFNdEIsWUFBcUIsR0FBVyxFQUFVLFdBQWlCO1FBQXRDLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBTTtRQUpuRCxXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1osWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLGFBQVEsR0FBRyxFQUFFLENBQUM7SUFJdEIsQ0FBQztJQUVNLE9BQU8sQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLFFBQWdCO1FBQ3ZELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2IsSUFBSSxFQUFFLElBQUk7WUFDVixJQUFJLEVBQUUsSUFBSTtZQUNWLFFBQVEsRUFBRSxRQUFRO1NBQ3JCLENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxTQUFTLENBQUMsSUFBWSxFQUFFLEtBQWE7UUFDeEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDZixJQUFJLEVBQUUsSUFBSTtZQUNWLEtBQUssRUFBRSxLQUFLO1NBQ2YsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVNLFFBQVEsQ0FBQyxJQUFZLEVBQUUsS0FBYTtRQUN2QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztZQUNkLElBQUksRUFBRSxJQUFJ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RUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdEIsQ0FBQzs7O1lBWEosVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7OztZQW5GekIsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgRmlsZSB9IGZyb20gJ0Bpb25pYy1uYXRpdmUvZmlsZSc7XG5cbmltcG9ydCB7IGNvbnZlcnRUb0Jsb2IgfSBmcm9tICdAd20vY29yZSc7XG5cbmRlY2xhcmUgY29uc3QgXztcblxuZXhwb3J0IGludGVyZmFjZSBJVXBsb2FkUmVzcG9uc2Uge1xuICAgIHRleHQ6IHN0cmluZztcbiAgICByZXNwb25zZTogYW55O1xuICAgIGhlYWRlcnM6IChzdHJpbmcpID0+IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFVwbG9hZFJlcXVlc3Qge1xuXG4gICAgcHJpdmF0ZSBfZmlsZXMgPSBbXTtcbiAgICBwcml2YXRlIF9wYXJhbXMgPSBbXTtcbiAgICBwcml2YXRlIF9oZWFkZXJzID0gW107XG5cbiAgICBjb25zdHJ1Y3RvciAocHJpdmF0ZSB1cmw6IHN0cmluZywgcHJpdmF0ZSBjb3Jkb3ZhRmlsZTogRmlsZSkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGFkZEZpbGUobmFtZTogc3RyaW5nLCBwYXRoOiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcpOiBVcGxvYWRSZXF1ZXN0IHtcbiAgICAgICAgdGhpcy5fZmlsZXMucHVzaCh7XG4gICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICAgIGZpbGVOYW1lOiBmaWxlbmFtZVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEhlYWRlcihuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBVcGxvYWRSZXF1ZXN0IHtcbiAgICAgICAgdGhpcy5faGVhZGVycy5wdXNoKHtcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRQYXJhbShuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBVcGxvYWRSZXF1ZXN0IHtcbiAgICAgICAgdGhpcy5fcGFyYW1zLnB1c2goe1xuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHBvc3QoKTogUHJvbWlzZTxJVXBsb2FkUmVzcG9uc2U+IHtcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgdGhpcy5fcGFyYW1zLmZvckVhY2goIGUgPT4gZm9ybURhdGEuYXBwZW5kKGUubmFtZSwgZS52YWx1ZSkpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwodGhpcy5fZmlsZXMubWFwKCBlID0+IHtcbiAgICAgICAgICAgIGlmIChlLnBhdGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29udmVydFRvQmxvYihlLnBhdGgpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IGUubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogZS5maWxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9iOiByZXN1bHQuYmxvYlxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZTtcbiAgICAgICAgfSkpLnRoZW4ocGFyYW1zID0+IHtcbiAgICAgICAgICAgIHBhcmFtcy5mb3JFYWNoKGUgPT4gZm9ybURhdGEuYXBwZW5kKGUubmFtZSwgZS5ibG9iIHx8IGUucGF0aCwgZS5maWxlTmFtZSkpO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElVcGxvYWRSZXNwb25zZT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Lm9wZW4oJ1BPU1QnLCB0aGlzLnVybCk7XG4gICAgICAgICAgICAgICAgdGhpcy5faGVhZGVycy5mb3JFYWNoKGUgPT4gcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKGUubmFtZSwgZS52YWx1ZSkpO1xuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IChuYW1lOiBzdHJpbmcpID0+IHJlcXVlc3QuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZTogcmVxdWVzdC5yZXNwb25zZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHJlcXVlc3QucmVzcG9uc2VUZXh0IGFzIHN0cmluZ1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9IHJlamVjdDtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Lm9uYWJvcnQgPSByZWplY3Q7XG4gICAgICAgICAgICAgICAgcmVxdWVzdC5zZW5kKGZvcm1EYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgRGV2aWNlRmlsZVVwbG9hZFNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjb3Jkb3ZhRmlsZTogRmlsZSkge31cblxuICAgIHB1YmxpYyB1cGxvYWQodXJsOiBzdHJpbmcsIGZpbGVQYXJhbU5hbWU6IHN0cmluZywgcGF0aDogc3RyaW5nLCBmaWxlTmFtZT86IHN0cmluZywgcGFyYW1zPzogYW55LCBoZWFkZXJzPzogYW55KTogUHJvbWlzZTxJVXBsb2FkUmVzcG9uc2U+IHtcbiAgICAgICAgY29uc3QgcmVxID0gbmV3IFVwbG9hZFJlcXVlc3QodXJsLCB0aGlzLmNvcmRvdmFGaWxlKVxuICAgICAgICAgICAgLmFkZEZpbGUoZmlsZVBhcmFtTmFtZSwgcGF0aCwgZmlsZU5hbWUpO1xuICAgICAgICBfLmZvckVhY2gocGFyYW1zLCAoaywgdikgPT4gcmVxLmFkZFBhcmFtKGssIHYpKTtcbiAgICAgICAgXy5mb3JFYWNoKGhlYWRlcnMsIChrLCB2KSA9PiByZXEuYWRkSGVhZGVyKGssIHYpKTtcbiAgICAgICAgcmV0dXJuIHJlcS5wb3N0KCk7XG4gICAgfVxuXG59XG4iXX0=