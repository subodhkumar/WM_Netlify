import * as tslib_1 from "tslib";
import { Directive, Injector } from '@angular/core';
import { App, addClass, removeClass, switchClass, toggleClass } from '@wm/core';
import { APPLY_STYLES_TYPE, styler } from '../../framework/styler';
import { StylableComponent } from '../base/stylable.component';
import { registerProps } from './left-panel.props';
import { LeftPanelAnimator } from './left-panel.animator';
import { PageDirective } from '../page/page.directive';
import { provideAsWidgetRef } from '../../../utils/widget-utils';
var DEFAULT_CLS = 'app-left-panel left-panel-collapsed';
var WIDGET_CONFIG = {
    widgetType: 'wm-left-panel',
    hostClass: DEFAULT_CLS
};
export var AnimationType;
(function (AnimationType) {
    AnimationType["SLIDE_IN"] = "slide-in";
    AnimationType["SLIDE_OVER"] = "slide-over";
})(AnimationType || (AnimationType = {}));
var LeftPanelDirective = /** @class */ (function (_super) {
    tslib_1.__extends(LeftPanelDirective, _super);
    function LeftPanelDirective(app, page, inj) {
        var _this = _super.call(this, inj, WIDGET_CONFIG) || this;
        _this.app = app;
        _this.page = page;
        styler(_this.nativeElement, _this, APPLY_STYLES_TYPE.CONTAINER);
        _this.$ele = _this.$element;
        _this.$page = page.$element;
        addClass(_this.$page[0], 'left-panel-collapsed-container');
        if (_this.columnwidth) {
            _this.setLeftPanelWidth(['md', 'sm'], _this.columnwidth);
        }
        if (_this.app.isTabletApplicationType) {
            addClass(_this.nativeElement, 'wm-tablet-app-left-panel');
        }
        return _this;
    }
    LeftPanelDirective.prototype.collapse = function () {
        addClass(this.nativeElement, 'swipee-transition');
        switchClass(this.nativeElement, 'left-panel-collapsed', 'left-panel-expanded');
        this.expanded = false;
        switchClass(this.$page[0], 'left-panel-collapsed-container', 'left-panel-expanded-container');
        if (this.animation === AnimationType.SLIDE_IN) {
            this.setPageWidthAndPosition(['md', 'sm'], null, this.columnwidth);
            this.setPageWidthAndPosition(['xs'], null, this.xscolumnwidth);
        }
        if (this._destroyCollapseActionListener) {
            this._destroyCollapseActionListener();
        }
        this.page.notify('wmLeftPanel:collapse');
    };
    LeftPanelDirective.prototype.expand = function () {
        removeClass(this.nativeElement, 'swipee-transition');
        switchClass(this.nativeElement, 'left-panel-expanded', 'left-panel-collapsed');
        this.expanded = true;
        if (!(this.app.isTabletApplicationType && this.animation === AnimationType.SLIDE_IN)) {
            this._destroyCollapseActionListener = this.listenForCollapseAction();
        }
        switchClass(this.$page[0], 'left-panel-expanded-container', 'left-panel-collapsed-container');
        if (this.animation === AnimationType.SLIDE_IN) {
            this.setPageWidthAndPosition(['md', 'sm'], this.columnwidth);
            this.setPageWidthAndPosition(['xs'], this.xscolumnwidth);
        }
        this.page.notify('wmLeftPanel:expand');
    };
    LeftPanelDirective.prototype.isGesturesEnabled = function () {
        return this.gestures === 'on';
    };
    LeftPanelDirective.prototype.isVisible = function () {
        return this.expanded;
    };
    LeftPanelDirective.prototype.onPropertyChange = function (key, nv, ov) {
        switch (key) {
            case 'animation':
                if (nv === AnimationType.SLIDE_IN) {
                    removeClass(this.$page[0], 'slide-over-left-panel-container');
                    addClass(this.$page[0], 'slide-in-left-panel-container');
                    this.setPageWidthAndPosition(['md', 'sm'], this.columnwidth);
                    this.setPageWidthAndPosition(['xs'], this.xscolumnwidth);
                }
                else if (nv === AnimationType.SLIDE_OVER) {
                    removeClass(this.$page[0], 'slide-in-left-panel-container');
                    addClass(this.$page[0], 'slide-over-left-panel-container');
                }
                this._leftPanelAnimator = new LeftPanelAnimator(this);
                switchClass(this.nativeElement, nv, ov);
                break;
            case 'columnwidth':
                this.setLeftPanelWidth(['md', 'sm'], nv, ov);
                if (this.animation === AnimationType.SLIDE_IN) {
                    this.setPageWidthAndPosition(['md', 'sm'], nv, ov);
                }
                break;
            case 'expanded':
                toggleClass(this.nativeElement, 'left-panel-expanded', nv);
                toggleClass(this.nativeElement, 'left-panel-collapsed', !nv);
                break;
            case 'xscolumnwidth':
                this.setLeftPanelWidth(['xs'], nv, ov);
                if (this.animation === AnimationType.SLIDE_IN) {
                    this.setPageWidthAndPosition(['xs'], nv, ov);
                }
                break;
            default:
                _super.prototype.onPropertyChange.call(this, key, nv, ov);
        }
    };
    LeftPanelDirective.prototype.toggle = function () {
        var _this = this;
        if (this.app.isTabletApplicationType) {
            setTimeout(function () {
                _this.expanded ? _this.collapse() : _this.expand();
            }, 50);
        }
        else {
            this.$ele.swipeAnimation(this.expanded ? 'gotoLower' : 'gotoUpper');
        }
    };
    LeftPanelDirective.prototype.listenForCollapseAction = function () {
        var _this = this;
        var eventName = 'click.leftNavToggle';
        var skipEvent = false;
        this.$ele.on(eventName, function () {
            skipEvent = true;
        });
        this.$page.on(eventName, function () {
            if (!skipEvent) {
                _this.toggle();
            }
            skipEvent = false;
        });
        return function () {
            _this.$ele.off(eventName);
            _this.$page.off(eventName);
        };
    };
    LeftPanelDirective.prototype.setLeftPanelWidth = function (devices, newVal, oldVal) {
        var _this = this;
        devices.forEach(function (device) {
            if (newVal) {
                addClass(_this.nativeElement, "col-" + device + "-" + newVal);
            }
            if (oldVal) {
                removeClass(_this.nativeElement, "col-" + device + "-" + oldVal);
            }
        });
    };
    LeftPanelDirective.prototype.setPageWidthAndPosition = function (devices, newVal, oldVal) {
        var _this = this;
        devices.forEach(function (device) {
            if (newVal) {
                addClass(_this.$page[0], "left-panel-container-" + device + "-" + (12 - newVal));
            }
            if (oldVal) {
                removeClass(_this.$page[0], "left-panel-container-" + device + "-" + (12 - oldVal));
            }
        });
    };
    LeftPanelDirective.initializeProps = registerProps();
    LeftPanelDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[wmLeftPanel]',
                    providers: [
                        provideAsWidgetRef(LeftPanelDirective)
                    ]
                },] }
    ];
    /** @nocollapse */
    LeftPanelDirective.ctorParameters = function () { return [
        { type: App },
        { type: PageDirective },
        { type: Injector }
    ]; };
    return LeftPanelDirective;
}(StylableComponent));
export { LeftPanelDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVmdC1wYW5lbC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbIndpZGdldHMvY29tbW9uL2xlZnQtcGFuZWwvbGVmdC1wYW5lbC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXBELE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWhGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVuRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRWpFLElBQU0sV0FBVyxHQUFHLHFDQUFxQyxDQUFDO0FBQzFELElBQU0sYUFBYSxHQUFrQjtJQUNqQyxVQUFVLEVBQUUsZUFBZTtJQUMzQixTQUFTLEVBQUUsV0FBVztDQUN6QixDQUFDO0FBRUYsTUFBTSxDQUFOLElBQVksYUFHWDtBQUhELFdBQVksYUFBYTtJQUNyQixzQ0FBcUIsQ0FBQTtJQUNyQiwwQ0FBeUIsQ0FBQTtBQUM3QixDQUFDLEVBSFcsYUFBYSxLQUFiLGFBQWEsUUFHeEI7QUFFRDtJQU13Qyw4Q0FBaUI7SUFlckQsNEJBQW1CLEdBQVEsRUFBVSxJQUFtQixFQUFFLEdBQWE7UUFBdkUsWUFDSSxrQkFBTSxHQUFHLEVBQUUsYUFBYSxDQUFDLFNBVzVCO1FB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QUFDO2FBQzlEO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sb0RBQXVCLEdBQS9CLFVBQWdDLE9BQWlCLEVBQUUsTUFBYyxFQUFFLE1BQWU7UUFBbEYsaUJBU0M7UUFSRyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTTtZQUNsQixJQUFJLE1BQU0sRUFBRTtnQkFDUixRQUFRLENBQUMsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSwwQkFBd0IsTUFBTSxVQUFJLEVBQUUsR0FBRyxNQUFNLENBQUUsQ0FBQyxDQUFDO2FBQzVFO1lBQ0QsSUFBSSxNQUFNLEVBQUU7Z0JBQ1IsV0FBVyxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsMEJBQXdCLE1BQU0sVUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFFLENBQUMsQ0FBQzthQUMvRTtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQXRKTSxrQ0FBZSxHQUFHLGFBQWEsRUFBRSxDQUFDOztnQkFQNUMsU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxlQUFlO29CQUN6QixTQUFTLEVBQUU7d0JBQ1Asa0JBQWtCLENBQUMsa0JBQWtCLENBQUM7cUJBQ3pDO2lCQUNKOzs7O2dCQTFCUSxHQUFHO2dCQU9ILGFBQWE7Z0JBVEYsUUFBUTs7SUFxTDVCLHlCQUFDO0NBQUEsQUE5SkQsQ0FNd0MsaUJBQWlCLEdBd0p4RDtTQXhKWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEFwcCwgYWRkQ2xhc3MsIHJlbW92ZUNsYXNzLCBzd2l0Y2hDbGFzcywgdG9nZ2xlQ2xhc3MgfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IEFQUExZX1NUWUxFU19UWVBFLCBzdHlsZXIgfSBmcm9tICcuLi8uLi9mcmFtZXdvcmsvc3R5bGVyJztcbmltcG9ydCB7IElXaWRnZXRDb25maWcgfSBmcm9tICcuLi8uLi9mcmFtZXdvcmsvdHlwZXMnO1xuaW1wb3J0IHsgU3R5bGFibGVDb21wb25lbnQgfSBmcm9tICcuLi9iYXNlL3N0eWxhYmxlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyByZWdpc3RlclByb3BzIH0gZnJvbSAnLi9sZWZ0LXBhbmVsLnByb3BzJztcbmltcG9ydCB7IExlZnRQYW5lbEFuaW1hdG9yIH0gZnJvbSAnLi9sZWZ0LXBhbmVsLmFuaW1hdG9yJztcbmltcG9ydCB7IFBhZ2VEaXJlY3RpdmUgfSBmcm9tICcuLi9wYWdlL3BhZ2UuZGlyZWN0aXZlJztcbmltcG9ydCB7IHByb3ZpZGVBc1dpZGdldFJlZiB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3dpZGdldC11dGlscyc7XG5cbmNvbnN0IERFRkFVTFRfQ0xTID0gJ2FwcC1sZWZ0LXBhbmVsIGxlZnQtcGFuZWwtY29sbGFwc2VkJztcbmNvbnN0IFdJREdFVF9DT05GSUc6IElXaWRnZXRDb25maWcgPSB7XG4gICAgd2lkZ2V0VHlwZTogJ3dtLWxlZnQtcGFuZWwnLFxuICAgIGhvc3RDbGFzczogREVGQVVMVF9DTFNcbn07XG5cbmV4cG9ydCBlbnVtIEFuaW1hdGlvblR5cGUge1xuICAgIFNMSURFX0lOID0gJ3NsaWRlLWluJyxcbiAgICBTTElERV9PVkVSID0gJ3NsaWRlLW92ZXInXG59XG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW3dtTGVmdFBhbmVsXScsXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHByb3ZpZGVBc1dpZGdldFJlZihMZWZ0UGFuZWxEaXJlY3RpdmUpXG4gICAgXVxufSlcbmV4cG9ydCBjbGFzcyBMZWZ0UGFuZWxEaXJlY3RpdmUgZXh0ZW5kcyBTdHlsYWJsZUNvbXBvbmVudCB7XG4gICAgc3RhdGljIGluaXRpYWxpemVQcm9wcyA9IHJlZ2lzdGVyUHJvcHMoKTtcblxuICAgIHB1YmxpYyBhbmltYXRpb246IEFuaW1hdGlvblR5cGU7XG4gICAgcHVibGljIGNvbHVtbndpZHRoOiBudW1iZXI7XG4gICAgcHVibGljIGV4cGFuZGVkOiBib29sZWFuO1xuICAgIHB1YmxpYyBnZXN0dXJlczogc3RyaW5nO1xuICAgIHB1YmxpYyB4c2NvbHVtbndpZHRoOiBudW1iZXI7XG5cbiAgICBwdWJsaWMgJGVsZTtcbiAgICBwdWJsaWMgJHBhZ2U7XG5cbiAgICBwcml2YXRlIF9kZXN0cm95Q29sbGFwc2VBY3Rpb25MaXN0ZW5lcjogKCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIF9sZWZ0UGFuZWxBbmltYXRvcjtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBhcHA6IEFwcCwgcHJpdmF0ZSBwYWdlOiBQYWdlRGlyZWN0aXZlLCBpbmo6IEluamVjdG9yKSB7XG4gICAgICAgIHN1cGVyKGluaiwgV0lER0VUX0NPTkZJRyk7XG4gICAgICAgIHN0eWxlcih0aGlzLm5hdGl2ZUVsZW1lbnQsIHRoaXMsIEFQUExZX1NUWUxFU19UWVBFLkNPTlRBSU5FUik7XG4gICAgICAgIHRoaXMuJGVsZSA9IHRoaXMuJGVsZW1lbnQ7XG4gICAgICAgIHRoaXMuJHBhZ2UgPSBwYWdlLiRlbGVtZW50O1xuICAgICAgICBhZGRDbGFzcyh0aGlzLiRwYWdlWzBdLCAnbGVmdC1wYW5lbC1jb2xsYXBzZWQtY29udGFpbmVyJyk7XG4gICAgICAgIGlmICh0aGlzLmNvbHVtbndpZHRoKSB7XG4gICAgICAgICAgICB0aGlzLnNldExlZnRQYW5lbFdpZHRoKFsnbWQnLCAnc20nXSwgdGhpcy5jb2x1bW53aWR0aCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuYXBwLmlzVGFibGV0QXBwbGljYXRpb25UeXBlKSB7XG4gICAgICAgICAgICBhZGRDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsICd3bS10YWJsZXQtYXBwLWxlZnQtcGFuZWwnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBjb2xsYXBzZSgpOiB2b2lkIHtcbiAgICAgICAgYWRkQ2xhc3ModGhpcy5uYXRpdmVFbGVtZW50LCAnc3dpcGVlLXRyYW5zaXRpb24nKTtcbiAgICAgICAgc3dpdGNoQ2xhc3ModGhpcy5uYXRpdmVFbGVtZW50LCAnbGVmdC1wYW5lbC1jb2xsYXBzZWQnLCAnbGVmdC1wYW5lbC1leHBhbmRlZCcpO1xuICAgICAgICB0aGlzLmV4cGFuZGVkID0gZmFsc2U7XG4gICAgICAgIHN3aXRjaENsYXNzKHRoaXMuJHBhZ2VbMF0sICdsZWZ0LXBhbmVsLWNvbGxhcHNlZC1jb250YWluZXInLCAnbGVmdC1wYW5lbC1leHBhbmRlZC1jb250YWluZXInKTtcbiAgICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uID09PSBBbmltYXRpb25UeXBlLlNMSURFX0lOKSB7XG4gICAgICAgICAgICB0aGlzLnNldFBhZ2VXaWR0aEFuZFBvc2l0aW9uKFsnbWQnLCAnc20nXSwgbnVsbCwgdGhpcy5jb2x1bW53aWR0aCk7XG4gICAgICAgICAgICB0aGlzLnNldFBhZ2VXaWR0aEFuZFBvc2l0aW9uKFsneHMnXSwgbnVsbCwgdGhpcy54c2NvbHVtbndpZHRoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5fZGVzdHJveUNvbGxhcHNlQWN0aW9uTGlzdGVuZXIpIHtcbiAgICAgICAgICAgIHRoaXMuX2Rlc3Ryb3lDb2xsYXBzZUFjdGlvbkxpc3RlbmVyKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wYWdlLm5vdGlmeSgnd21MZWZ0UGFuZWw6Y29sbGFwc2UnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXhwYW5kKCk6IHZvaWQge1xuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsICdzd2lwZWUtdHJhbnNpdGlvbicpO1xuICAgICAgICBzd2l0Y2hDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsICdsZWZ0LXBhbmVsLWV4cGFuZGVkJywgJ2xlZnQtcGFuZWwtY29sbGFwc2VkJyk7XG4gICAgICAgIHRoaXMuZXhwYW5kZWQgPSB0cnVlO1xuICAgICAgICBpZiAoISh0aGlzLmFwcC5pc1RhYmxldEFwcGxpY2F0aW9uVHlwZSAmJiB0aGlzLmFuaW1hdGlvbiA9PT0gQW5pbWF0aW9uVHlwZS5TTElERV9JTikpIHtcbiAgICAgICAgICAgIHRoaXMuX2Rlc3Ryb3lDb2xsYXBzZUFjdGlvbkxpc3RlbmVyID0gdGhpcy5saXN0ZW5Gb3JDb2xsYXBzZUFjdGlvbigpO1xuICAgICAgICB9XG4gICAgICAgIHN3aXRjaENsYXNzKHRoaXMuJHBhZ2VbMF0sICdsZWZ0LXBhbmVsLWV4cGFuZGVkLWNvbnRhaW5lcicsICdsZWZ0LXBhbmVsLWNvbGxhcHNlZC1jb250YWluZXInKTtcbiAgICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uID09PSBBbmltYXRpb25UeXBlLlNMSURFX0lOKSB7XG4gICAgICAgICAgICB0aGlzLnNldFBhZ2VXaWR0aEFuZFBvc2l0aW9uKFsnbWQnLCAnc20nXSwgdGhpcy5jb2x1bW53aWR0aCk7XG4gICAgICAgICAgICB0aGlzLnNldFBhZ2VXaWR0aEFuZFBvc2l0aW9uKFsneHMnXSwgdGhpcy54c2NvbHVtbndpZHRoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBhZ2Uubm90aWZ5KCd3bUxlZnRQYW5lbDpleHBhbmQnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNHZXN0dXJlc0VuYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmdlc3R1cmVzID09PSAnb24nO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1Zpc2libGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmV4cGFuZGVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblByb3BlcnR5Q2hhbmdlKGtleSwgbnYsIG92KSB7XG4gICAgICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICAgICAgICBjYXNlICdhbmltYXRpb24nIDpcbiAgICAgICAgICAgICAgICBpZiAobnYgPT09IEFuaW1hdGlvblR5cGUuU0xJREVfSU4pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3ModGhpcy4kcGFnZVswXSwgJ3NsaWRlLW92ZXItbGVmdC1wYW5lbC1jb250YWluZXInKTtcbiAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3ModGhpcy4kcGFnZVswXSwgJ3NsaWRlLWluLWxlZnQtcGFuZWwtY29udGFpbmVyJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0UGFnZVdpZHRoQW5kUG9zaXRpb24oWydtZCcsICdzbSddLCB0aGlzLmNvbHVtbndpZHRoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRQYWdlV2lkdGhBbmRQb3NpdGlvbihbJ3hzJ10sIHRoaXMueHNjb2x1bW53aWR0aCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChudiA9PT0gQW5pbWF0aW9uVHlwZS5TTElERV9PVkVSKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHRoaXMuJHBhZ2VbMF0sICdzbGlkZS1pbi1sZWZ0LXBhbmVsLWNvbnRhaW5lcicpO1xuICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyh0aGlzLiRwYWdlWzBdLCAnc2xpZGUtb3Zlci1sZWZ0LXBhbmVsLWNvbnRhaW5lcicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLl9sZWZ0UGFuZWxBbmltYXRvciA9IG5ldyBMZWZ0UGFuZWxBbmltYXRvcih0aGlzKTtcbiAgICAgICAgICAgICAgICBzd2l0Y2hDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsIG52LCBvdik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdjb2x1bW53aWR0aCc6XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRMZWZ0UGFuZWxXaWR0aChbJ21kJywgJ3NtJ10sIG52LCBvdik7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYW5pbWF0aW9uID09PSBBbmltYXRpb25UeXBlLlNMSURFX0lOKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0UGFnZVdpZHRoQW5kUG9zaXRpb24oWydtZCcsICdzbSddLCBudiwgb3YpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2V4cGFuZGVkJzpcbiAgICAgICAgICAgICAgICB0b2dnbGVDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsICdsZWZ0LXBhbmVsLWV4cGFuZGVkJywgbnYpO1xuICAgICAgICAgICAgICAgIHRvZ2dsZUNsYXNzKHRoaXMubmF0aXZlRWxlbWVudCwgJ2xlZnQtcGFuZWwtY29sbGFwc2VkJywgIW52KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3hzY29sdW1ud2lkdGgnOlxuICAgICAgICAgICAgICAgIHRoaXMuc2V0TGVmdFBhbmVsV2lkdGgoWyd4cyddLCBudiwgb3YpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmFuaW1hdGlvbiA9PT0gQW5pbWF0aW9uVHlwZS5TTElERV9JTikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFBhZ2VXaWR0aEFuZFBvc2l0aW9uKFsneHMnXSwgbnYsIG92KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHN1cGVyLm9uUHJvcGVydHlDaGFuZ2Uoa2V5LCBudiwgb3YpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljICB0b2dnbGUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmFwcC5pc1RhYmxldEFwcGxpY2F0aW9uVHlwZSkge1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5leHBhbmRlZCA/IHRoaXMuY29sbGFwc2UoKSA6IHRoaXMuZXhwYW5kKCk7XG4gICAgICAgICAgICB9LCA1MCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLiRlbGUuc3dpcGVBbmltYXRpb24odGhpcy5leHBhbmRlZCA/ICdnb3RvTG93ZXInIDogJ2dvdG9VcHBlcicpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsaXN0ZW5Gb3JDb2xsYXBzZUFjdGlvbigpOiAoKSA9PiB2b2lkIHtcbiAgICAgICAgY29uc3QgZXZlbnROYW1lID0gJ2NsaWNrLmxlZnROYXZUb2dnbGUnO1xuICAgICAgICBsZXQgc2tpcEV2ZW50ID0gZmFsc2U7XG4gICAgICAgIHRoaXMuJGVsZS5vbihldmVudE5hbWUsICgpID0+IHtcbiAgICAgICAgICAgIHNraXBFdmVudCA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLiRwYWdlLm9uKGV2ZW50TmFtZSwgKCkgPT4gIHtcbiAgICAgICAgICAgIGlmICghc2tpcEV2ZW50KSB7XG4gICAgICAgICAgICAgICAgdGhpcy50b2dnbGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNraXBFdmVudCA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuJGVsZS5vZmYoZXZlbnROYW1lKTtcbiAgICAgICAgICAgIHRoaXMuJHBhZ2Uub2ZmKGV2ZW50TmFtZSk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRMZWZ0UGFuZWxXaWR0aChkZXZpY2VzOiBzdHJpbmdbXSwgbmV3VmFsOiBudW1iZXIsIG9sZFZhbD86IG51bWJlcikge1xuICAgICAgICBkZXZpY2VzLmZvckVhY2goZGV2aWNlID0+IHtcbiAgICAgICAgICAgIGlmIChuZXdWYWwpIHtcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsIGBjb2wtJHtkZXZpY2V9LSR7bmV3VmFsfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9sZFZhbCkge1xuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHRoaXMubmF0aXZlRWxlbWVudCwgYGNvbC0ke2RldmljZX0tJHtvbGRWYWx9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0UGFnZVdpZHRoQW5kUG9zaXRpb24oZGV2aWNlczogc3RyaW5nW10sIG5ld1ZhbDogbnVtYmVyLCBvbGRWYWw/OiBudW1iZXIpIHtcbiAgICAgICAgZGV2aWNlcy5mb3JFYWNoKGRldmljZSA9PiB7XG4gICAgICAgICAgICBpZiAobmV3VmFsKSB7XG4gICAgICAgICAgICAgICAgYWRkQ2xhc3ModGhpcy4kcGFnZVswXSwgYGxlZnQtcGFuZWwtY29udGFpbmVyLSR7ZGV2aWNlfS0kezEyIC0gbmV3VmFsfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9sZFZhbCkge1xuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKHRoaXMuJHBhZ2VbMF0sIGBsZWZ0LXBhbmVsLWNvbnRhaW5lci0ke2RldmljZX0tJHsxMiAtIG9sZFZhbH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19