import { Component, ElementRef, HostListener, Input, Optional } from '@angular/core';
import { $parseEvent, addClass, getRouteNameFromLink, getUrlParams, openLink, UserDefinedExecutionContext } from '@wm/core';
import { KEYBOARD_MOVEMENTS, MENU_POSITION, MenuComponent } from '../menu.component';
import { isActiveNavItem } from '../../../../utils/widget-utils';
import { NavComponent } from '../../nav/nav.component';
var menuAlignClass = {
    'pull-right': 'fa-caret-left',
    'dropinline-menu': 'fa-caret-down',
    'pull-left': 'fa-caret-right'
};
var MENU_LAYOUT_TYPE = {
    HORIZONTAL: 'horizontal',
    VERTICAL: 'vertical'
};
var MenuDropdownItemComponent = /** @class */ (function () {
    function MenuDropdownItemComponent(menuRef, userDefinedExecutionContext, parentNav, elRef) {
        var _this = this;
        this.menuRef = menuRef;
        this.userDefinedExecutionContext = userDefinedExecutionContext;
        this.parentNav = parentNav;
        this.onSelect = function ($event, item) {
            if (_this.nativeElement !== $($event.target).closest('.app-menu-item').get(0)) {
                return;
            }
            // prevent event event propagation if auto close is outside click.
            if (_this.menuRef.autoclose === 'outsideClick') {
                $event.stopPropagation();
            }
            $event.preventDefault();
            var args = { $event: $event, $item: item };
            var linkTarget = item.target || _this.menuRef.linktarget;
            var itemAction = item.action;
            var menuLink = item.link;
            _this.menuRef.onMenuItemSelect(args);
            if (itemAction) {
                if (!_this.itemActionFn) {
                    _this.itemActionFn = $parseEvent(itemAction);
                }
                _this.itemActionFn(_this.userDefinedExecutionContext, Object.create(item));
            }
            if (menuLink) {
                if (menuLink.startsWith('#/') && (!linkTarget || linkTarget === '_self')) {
                    var queryParams = getUrlParams(menuLink);
                    menuLink = getRouteNameFromLink(menuLink);
                    _this.menuRef.route.navigate([menuLink], { queryParams: queryParams });
                }
                else {
                    openLink(menuLink, linkTarget);
                }
            }
        };
        this.nativeElement = elRef.nativeElement;
        addClass(this.nativeElement, 'app-menu-item');
        this.menualign = menuAlignClass[this.menuRef.menualign] || menuAlignClass['pull-left'];
    }
    MenuDropdownItemComponent.prototype.ngOnInit = function () {
        // add active class to the item only if it is in nav component.
        if (this.parentNav) {
            if (isActiveNavItem(this.item.link, this.menuRef.route.url)) {
                // add active class to the li, if the menu item's link is same as the current page name.
                addClass(this.nativeElement, 'active');
            }
        }
    };
    MenuDropdownItemComponent.prototype.getInitialKeyMovements = function () {
        var KEY_MOVEMENTS = _.clone(KEYBOARD_MOVEMENTS);
        if (this.menuRef.menulayout === MENU_LAYOUT_TYPE.HORIZONTAL) {
            KEY_MOVEMENTS.MOVE_UP = 'LEFT-ARROW';
            KEY_MOVEMENTS.MOVE_LEFT = 'UP-ARROW';
            KEY_MOVEMENTS.MOVE_RIGHT = 'DOWN-ARROW';
            KEY_MOVEMENTS.MOVE_DOWN = 'RIGHT-ARROW';
        }
        else {
            if (this.menuRef.menuposition === MENU_POSITION.DOWN_LEFT || this.menuRef.menuposition === MENU_POSITION.UP_LEFT) {
                KEY_MOVEMENTS.MOVE_LEFT = 'RIGHT-ARROW';
                KEY_MOVEMENTS.MOVE_RIGHT = 'LEFT-ARROW';
            }
            else if (this.menuRef.menuposition === 'inline') {
                KEY_MOVEMENTS.MOVE_UP = 'LEFT-ARROW';
                KEY_MOVEMENTS.MOVE_LEFT = 'UP-ARROW';
                KEY_MOVEMENTS.MOVE_RIGHT = 'DOWN-ARROW';
                KEY_MOVEMENTS.MOVE_DOWN = 'RIGHT-ARROW';
            }
        }
        return KEY_MOVEMENTS;
    };
    MenuDropdownItemComponent.prototype.onKeyDown = function ($event, eventAction) {
        var $li = $(this.nativeElement);
        var $ul = $(this.nativeElement).closest('ul.dropdown-menu');
        var $parentUl = this.menuRef.$element.find('> ul.dropdown-menu');
        var ARROW_KEYS = ['LEFT-ARROW', 'RIGHT-ARROW', 'UP-ARROW', 'DOWN-ARROW'];
        var KEY_MOVEMENTS = this.getInitialKeyMovements();
        if (_.includes(ARROW_KEYS, eventAction)) {
            // preventing from page scroll when up/down arrow is pressed, in case of menu is opened.
            $event.preventDefault();
        }
        if ((eventAction === KEY_MOVEMENTS.ON_TAB && $parentUl.children().last()[0] === this.nativeElement) || eventAction === KEY_MOVEMENTS.ON_ESCAPE) {
            /*closing all the children elements when
            * 1. Tab is clicked on the last $element
            * 2. When Escape key is clicked*/
            $event.preventDefault();
            this.menuRef.bsDropdown.hide();
        }
        else if ((eventAction === KEY_MOVEMENTS.ON_ENTER && !this.item.link) || eventAction === KEY_MOVEMENTS.MOVE_RIGHT) {
            // when there is no link for the menu, on enter open the inner child elements and focus the first $element
            $event.stopPropagation();
            if (this.item.children.length) {
                $li.toggleClass('open');
                $li.find('li:first > a').focus();
            }
            else {
                $li.find('> a').focus();
            }
        }
        else if (eventAction === KEY_MOVEMENTS.MOVE_LEFT || (eventAction === KEY_MOVEMENTS.ON_TAB && $ul.children().last()[0] === this.nativeElement)) {
            if ($parentUl[0] !== $ul[0]) {
                var $parentItem = $ul.parent();
                $parentItem.toggleClass('open').find('li.open').removeClass('open');
                $parentItem.find('> a').focus();
                $event.preventDefault();
                $event.stopPropagation();
            }
        }
        else if (eventAction === KEY_MOVEMENTS.MOVE_UP) {
            if ($parentUl[0] !== $ul[0] || $parentUl.find('> li:first')[0] !== this.nativeElement) {
                $event.stopPropagation();
                $li.prev().find('> a').focus();
            }
        }
        else if (eventAction === KEY_MOVEMENTS.MOVE_DOWN) {
            $event.stopPropagation();
            if ($parentUl.find('> li:last')[0] === this.nativeElement && (this.menuRef.menulayout !== MENU_LAYOUT_TYPE.HORIZONTAL && this.menuRef.menuposition === MENU_POSITION.UP_RIGHT || this.menuRef.menuposition === MENU_POSITION.UP_LEFT)) {
                this.menuRef.bsDropdown.hide();
            }
            else {
                $li.next().find('> a').focus();
            }
        }
        else if (eventAction === KEY_MOVEMENTS.ON_ENTER) {
            this.onSelect($event, this.item);
        }
        else {
            $event.stopPropagation();
        }
    };
    MenuDropdownItemComponent.decorators = [
        { type: Component, args: [{
                    selector: 'li[wmMenuDropdownItem]',
                    template: "<a href=\"javascript:void(0);\" [title]=\"item.label\" [wmNavigationControl]=\"item.link\" [disableMenuContext]=\"menuRef.disableMenuContext || !!item.action\">\n    <span *ngIf=\"item.children.length\" class=\"pull-right fa caret {{menualign}}\"></span>\n    <i class=\"app-icon {{item.icon}}\"></i>\n    <span class=\"anchor-caption\">{{item.label}}</span>\n\n</a>\n<ng-container [ngTemplateOutlet]=\"nestedMenuDropdown\" *ngIf=\"item.children.length\" [ngTemplateOutletContext]=\"{item: item}\"></ng-container>\n\n<ng-template #nestedMenuDropdown let-item=\"item\">\n    <ul wmMenuDropdown [items]=\"item.children\"></ul>\n</ng-template>\n"
                }] }
    ];
    /** @nocollapse */
    MenuDropdownItemComponent.ctorParameters = function () { return [
        { type: MenuComponent },
        { type: UserDefinedExecutionContext },
        { type: NavComponent, decorators: [{ type: Optional }] },
        { type: ElementRef }
    ]; };
    MenuDropdownItemComponent.propDecorators = {
        item: [{ type: Input }],
        onKeyDown: [{ type: HostListener, args: ['keydown.tab', ['$event', '"TAB"'],] }, { type: HostListener, args: ['keydown.escape', ['$event', '"ESC"'],] }, { type: HostListener, args: ['keydown.enter', ['$event', '"ENTER"'],] }, { type: HostListener, args: ['keydown.arrowup', ['$event', '"UP-ARROW"'],] }, { type: HostListener, args: ['keydown.arrowdown', ['$event', '"DOWN-ARROW"'],] }, { type: HostListener, args: ['keydown.arrowright', ['$event', '"RIGHT-ARROW"'],] }, { type: HostListener, args: ['keydown.arrowleft', ['$event', '"LEFT-ARROW"'],] }],
        onSelect: [{ type: HostListener, args: ['click', ['$event', 'item'],] }]
    };
    return MenuDropdownItemComponent;
}());
export { MenuDropdownItemComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS1kcm9wZG93bi1pdGVtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsid2lkZ2V0cy9jb21tb24vbWVudS9tZW51LWRyb3Bkb3duLWl0ZW0vbWVudS1kcm9wZG93bi1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3RixPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLDJCQUEyQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTVILE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUl2RCxJQUFNLGNBQWMsR0FBRztJQUNuQixZQUFZLEVBQUcsZUFBZTtJQUM5QixpQkFBaUIsRUFBRyxlQUFlO0lBQ25DLFdBQVcsRUFBRyxnQkFBZ0I7Q0FDakMsQ0FBQztBQUVGLElBQU0sZ0JBQWdCLEdBQUc7SUFDckIsVUFBVSxFQUFFLFlBQVk7SUFDeEIsUUFBUSxFQUFFLFVBQVU7Q0FDdkIsQ0FBQztBQUVGO0lBY0ksbUNBQ1csT0FBc0IsRUFDckIsMkJBQXdELEVBQzVDLFNBQXVCLEVBQzNDLEtBQWlCO1FBSnJCLGlCQVVDO1FBVFUsWUFBTyxHQUFQLE9BQU8sQ0FBZTtRQUNyQixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQzVDLGNBQVMsR0FBVCxTQUFTLENBQWM7UUFzRy9DLGFBQVEsR0FBRyxVQUFDLE1BQU0sRUFBRSxJQUFJO1lBQ3BCLElBQUks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SlkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBIb3N0TGlzdGVuZXIsIElucHV0LCBPbkluaXQsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7ICRwYXJzZUV2ZW50LCBhZGRDbGFzcywgZ2V0Um91dGVOYW1lRnJvbUxpbmssIGdldFVybFBhcmFtcywgb3BlbkxpbmssIFVzZXJEZWZpbmVkRXhlY3V0aW9uQ29udGV4dCB9IGZyb20gJ0B3bS9jb3JlJztcblxuaW1wb3J0IHsgS0VZQk9BUkRfTU9WRU1FTlRTLCBNRU5VX1BPU0lUSU9OLCBNZW51Q29tcG9uZW50IH0gZnJvbSAnLi4vbWVudS5jb21wb25lbnQnO1xuaW1wb3J0IHsgaXNBY3RpdmVOYXZJdGVtIH0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvd2lkZ2V0LXV0aWxzJztcbmltcG9ydCB7IE5hdkNvbXBvbmVudCB9IGZyb20gJy4uLy4uL25hdi9uYXYuY29tcG9uZW50JztcblxuZGVjbGFyZSBjb25zdCBfLCAkO1xuXG5jb25zdCBtZW51QWxpZ25DbGFzcyA9IHtcbiAgICAncHVsbC1yaWdodCcgOiAnZmEtY2FyZXQtbGVmdCcsXG4gICAgJ2Ryb3BpbmxpbmUtbWVudScgOiAnZmEtY2FyZXQtZG93bicsXG4gICAgJ3B1bGwtbGVmdCcgOiAnZmEtY2FyZXQtcmlnaHQnXG59O1xuXG5jb25zdCBNRU5VX0xBWU9VVF9UWVBFID0ge1xuICAgIEhPUklaT05UQUw6ICdob3Jpem9udGFsJyxcbiAgICBWRVJUSUNBTDogJ3ZlcnRpY2FsJ1xufTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdsaVt3bU1lbnVEcm9wZG93bkl0ZW1dJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vbWVudS1kcm9wZG93bi1pdGVtLmNvbXBvbmVudC5odG1sJyxcbn0pXG5leHBvcnQgY2xhc3MgTWVudURyb3Bkb3duSXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cbiAgICBwdWJsaWMgbWVudWFsaWduOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIGl0ZW1BY3Rpb25GbjogRnVuY3Rpb247XG5cbiAgICBASW5wdXQoKSBpdGVtO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBuYXRpdmVFbGVtZW50O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHB1YmxpYyBtZW51UmVmOiBNZW51Q29tcG9uZW50LFxuICAgICAgICBwcml2YXRlIHVzZXJEZWZpbmVkRXhlY3V0aW9uQ29udGV4dDogVXNlckRlZmluZWRFeGVjdXRpb25Db250ZXh0LFxuICAgICAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHBhcmVudE5hdjogTmF2Q29tcG9uZW50LFxuICAgICAgICBlbFJlZjogRWxlbWVudFJlZixcbiAgICApIHtcbiAgICAgICAgdGhpcy5uYXRpdmVFbGVtZW50ID0gZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgICAgICAgYWRkQ2xhc3ModGhpcy5uYXRpdmVFbGVtZW50LCAnYXBwLW1lbnUtaXRlbScpO1xuXG4gICAgICAgIHRoaXMubWVudWFsaWduID0gbWVudUFsaWduQ2xhc3NbdGhpcy5tZW51UmVmLm1lbnVhbGlnbl0gfHwgbWVudUFsaWduQ2xhc3NbJ3B1bGwtbGVmdCddO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICAvLyBhZGQgYWN0aXZlIGNsYXNzIHRvIHRoZSBpdGVtIG9ubHkgaWYgaXQgaXMgaW4gbmF2IGNvbXBvbmVudC5cbiAgICAgICAgaWYgKHRoaXMucGFyZW50TmF2KSB7XG4gICAgICAgICAgICBpZiAoaXNBY3RpdmVOYXZJdGVtKHRoaXMuaXRlbS5saW5rLCB0aGlzLm1lbnVSZWYucm91dGUudXJsKSkge1xuICAgICAgICAgICAgICAgIC8vIGFkZCBhY3RpdmUgY2xhc3MgdG8gdGhlIGxpLCBpZiB0aGUgbWVudSBpdGVtJ3MgbGluayBpcyBzYW1lIGFzIHRoZSBjdXJyZW50IHBhZ2UgbmFtZS5cbiAgICAgICAgICAgICAgICBhZGRDbGFzcyh0aGlzLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldEluaXRpYWxLZXlNb3ZlbWVudHMoKSB7XG4gICAgICAgIGNvbnN0IEtFWV9NT1ZFTUVOVFMgPSBfLmNsb25lKEtFWUJPQVJEX01PVkVNRU5UUyk7XG4gICAgICAgIGlmICh0aGlzLm1lbnVSZWYubWVudWxheW91dCA9PT0gTUVOVV9MQVlPVVRfVFlQRS5IT1JJWk9OVEFMKSB7XG4gICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfVVAgPSAnTEVGVC1BUlJPVyc7XG4gICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfTEVGVCA9ICdVUC1BUlJPVyc7XG4gICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfUklHSFQgPSAnRE9XTi1BUlJPVyc7XG4gICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfRE9XTiA9ICdSSUdIVC1BUlJPVyc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5tZW51UmVmLm1lbnVwb3NpdGlvbiA9PT0gTUVOVV9QT1NJVElPTi5ET1dOX0xFRlQgfHwgdGhpcy5tZW51UmVmLm1lbnVwb3NpdGlvbiA9PT0gTUVOVV9QT1NJVElPTi5VUF9MRUZUKSB7XG4gICAgICAgICAgICAgICAgS0VZX01PVkVNRU5UUy5NT1ZFX0xFRlQgPSAnUklHSFQtQVJST1cnO1xuICAgICAgICAgICAgICAgIEtFWV9NT1ZFTUVOVFMuTU9WRV9SSUdIVCA9ICdMRUZULUFSUk9XJztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5tZW51UmVmLm1lbnVwb3NpdGlvbiA9PT0gJ2lubGluZScpIHtcbiAgICAgICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfVVAgPSAnTEVGVC1BUlJPVyc7XG4gICAgICAgICAgICAgICAgS0VZX01PVkVNRU5UUy5NT1ZFX0xFRlQgPSAnVVAtQVJST1cnO1xuICAgICAgICAgICAgICAgIEtFWV9NT1ZFTUVOVFMuTU9WRV9SSUdIVCA9ICdET1dOLUFSUk9XJztcbiAgICAgICAgICAgICAgICBLRVlfTU9WRU1FTlRTLk1PVkVfRE9XTiA9ICdSSUdIVC1BUlJPVyc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEtFWV9NT1ZFTUVOVFM7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi50YWInLCBbJyRldmVudCcsICdcIlRBQlwiJ10pXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5lc2NhcGUnLCBbJyRldmVudCcsICdcIkVTQ1wiJ10pXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5lbnRlcicsIFsnJGV2ZW50JywgJ1wiRU5URVJcIiddKVxuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uYXJyb3d1cCcsIFsnJGV2ZW50JywgJ1wiVVAtQVJST1dcIiddKVxuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uYXJyb3dkb3duJywgWyckZXZlbnQnLCAnXCJET1dOLUFSUk9XXCInXSlcbiAgICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmFycm93cmlnaHQnLCBbJyRldmVudCcsICdcIlJJR0hULUFSUk9XXCInXSlcbiAgICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmFycm93bGVmdCcsIFsnJGV2ZW50JywgJ1wiTEVGVC1BUlJPV1wiJ10pXG4gICAgb25LZXlEb3duKCRldmVudCwgZXZlbnRBY3Rpb24pIHtcbiAgICAgICAgY29uc3QgJGxpID0gJCh0aGlzLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICBjb25zdCAkdWwgPSAkKHRoaXMubmF0aXZlRWxlbWVudCkuY2xvc2VzdCgndWwuZHJvcGRvd24tbWVudScpO1xuICAgICAgICBjb25zdCAkcGFyZW50VWwgPSB0aGlzLm1lbnVSZWYuJGVsZW1lbnQuZmluZCgnPiB1bC5kcm9wZG93bi1tZW51Jyk7XG4gICAgICAgIGNvbnN0IEFSUk9XX0tFWVMgPSBbJ0xFRlQtQVJST1cnLCAnUklHSFQtQVJST1cnLCAnVVAtQVJST1cnLCAnRE9XTi1BUlJPVyddO1xuICAgICAgICBjb25zdCBLRVlfTU9WRU1FTlRTID0gdGhpcy5nZXRJbml0aWFsS2V5TW92ZW1lbnRzKCk7XG5cbiAgICAgICAgaWYgKF8uaW5jbHVkZXMoQVJST1dfS0VZUywgZXZlbnRBY3Rpb24pKSB7XG4gICAgICAgICAgICAvLyBwcmV2ZW50aW5nIGZyb20gcGFnZSBzY3JvbGwgd2hlbiB1cC9kb3duIGFycm93IGlzIHByZXNzZWQsIGluIGNhc2Ugb2YgbWVudSBpcyBvcGVuZWQuXG4gICAgICAgICAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICgoZXZlbnRBY3Rpb24gPT09IEtFWV9NT1ZFTUVOVFMuT05fVEFCICYmICRwYXJlbnRVbC5jaGlsZHJlbigpLmxhc3QoKVswXSA9PT0gdGhpcy5uYXRpdmVFbGVtZW50KSB8fCBldmVudEFjdGlvbiA9PT0gS0VZX01PVkVNRU5UUy5PTl9FU0NBUEUpIHtcbiAgICAgICAgICAgIC8qY2xvc2luZyBhbGwgdGhlIGNoaWxkcmVuIGVsZW1lbnRzIHdoZW5cbiAgICAgICAgICAgICogMS4gVGFiIGlzIGNsaWNrZWQgb24gdGhlIGxhc3QgJGVsZW1lbnRcbiAgICAgICAgICAgICogMi4gV2hlbiBFc2NhcGUga2V5IGlzIGNsaWNrZWQqL1xuICAgICAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB0aGlzLm1lbnVSZWYuYnNEcm9wZG93bi5oaWRlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoKGV2ZW50QWN0aW9uID09PSBLRVlfTU9WRU1FTlRTLk9OX0VOVEVSICYmICF0aGlzLml0ZW0ubGluaykgfHwgZXZlbnRBY3Rpb24gPT09IEtFWV9NT1ZFTUVOVFMuTU9WRV9SSUdIVCkge1xuICAgICAgICAgICAgLy8gd2hlbiB0aGVyZSBpcyBubyBsaW5rIGZvciB0aGUgbWVudSwgb24gZW50ZXIgb3BlbiB0aGUgaW5uZXIgY2hpbGQgZWxlbWVudHMgYW5kIGZvY3VzIHRoZSBmaXJzdCAkZWxlbWVudFxuICAgICAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgaWYgKHRoaXMuaXRlbS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAkbGkudG9nZ2xlQ2xhc3MoJ29wZW4nKTtcbiAgICAgICAgICAgICAgICAkbGkuZmluZCgnbGk6Zmlyc3QgPiBhJykuZm9jdXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgJGxpLmZpbmQoJz4gYScpLmZvY3VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnRBY3Rpb24gPT09IEtFWV9NT1ZFTUVOVFMuTU9WRV9MRUZUIHx8IChldmVudEFjdGlvbiA9PT0gS0VZX01PVkVNRU5UUy5PTl9UQUIgJiYgJHVsLmNoaWxkcmVuKCkubGFzdCgpWzBdID09PSB0aGlzLm5hdGl2ZUVsZW1lbnQpKSB7XG4gICAgICAgICAgICBpZiAoJHBhcmVudFVsWzBdICE9PSAkdWxbMF0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCAkcGFyZW50SXRlbSA9ICR1bC5wYXJlbnQoKTtcbiAgICAgICAgICAgICAgICAkcGFyZW50SXRlbS50b2dnbGVDbGFzcygnb3BlbicpLmZpbmQoJ2xpLm9wZW4nKS5yZW1vdmVDbGFzcygnb3BlbicpO1xuICAgICAgICAgICAgICAgICRwYXJlbnRJdGVtLmZpbmQoJz4gYScpLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50QWN0aW9uID09PSBLRVlfTU9WRU1FTlRTLk1PVkVfVVApIHtcbiAgICAgICAgICAgIGlmICgkcGFyZW50VWxbMF0gIT09ICR1bFswXSB8fCAkcGFyZW50VWwuZmluZCgnPiBsaTpmaXJzdCcpWzBdICE9PSB0aGlzLm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgJGxpLnByZXYoKS5maW5kKCc+IGEnKS5mb2N1cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50QWN0aW9uID09PSBLRVlfTU9WRU1FTlRTLk1PVkVfRE9XTikge1xuICAgICAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgaWYgKCRwYXJlbnRVbC5maW5kKCc+IGxpOmxhc3QnKVswXSA9PT0gdGhpcy5uYXRpdmVFbGVtZW50ICYmICh0aGlzLm1lbnVSZWYubWVudWxheW91dCAhPT0gTUVOVV9MQVlPVVRfVFlQRS5IT1JJWk9OVEFMICYmIHRoaXMubWVudVJlZi5tZW51cG9zaXRpb24gPT09IE1FTlVfUE9TSVRJT04uVVBfUklHSFQgfHwgdGhpcy5tZW51UmVmLm1lbnVwb3NpdGlvbiA9PT0gTUVOVV9QT1NJVElPTi5VUF9MRUZUKSkge1xuICAgICAgICAgICAgICAgIHRoaXMubWVudVJlZi5ic0Ryb3Bkb3duLmhpZGUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgJGxpLm5leHQoKS5maW5kKCc+IGEnKS5mb2N1cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50QWN0aW9uID09PSBLRVlfTU9WRU1FTlRTLk9OX0VOVEVSKSB7XG4gICAgICAgICAgICB0aGlzLm9uU2VsZWN0KCRldmVudCwgdGhpcy5pdGVtKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnLCAnaXRlbSddKVxuICAgIG9uU2VsZWN0ID0gKCRldmVudCwgaXRlbSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5uYXRpdmVFbGVtZW50ICE9PSAkKCRldmVudC50YXJnZXQpLmNsb3Nlc3QoJy5hcHAtbWVudS1pdGVtJykuZ2V0KDApKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gcHJldmVudCBldmVudCBldmVudCBwcm9wYWdhdGlvbiBpZiBhdXRvIGNsb3NlIGlzIG91dHNpZGUgY2xpY2suXG4gICAgICAgIGlmICh0aGlzLm1lbnVSZWYuYXV0b2Nsb3NlID09PSAnb3V0c2lkZUNsaWNrJykge1xuICAgICAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB9XG5cbiAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGNvbnN0IGFyZ3MgPSB7JGV2ZW50LCAkaXRlbTogaXRlbX07XG4gICAgICAgIGNvbnN0IGxpbmtUYXJnZXQgPSBpdGVtLnRhcmdldCB8fCB0aGlzLm1lbnVSZWYubGlua3RhcmdldDtcbiAgICAgICAgY29uc3QgaXRlbUFjdGlvbiA9IGl0ZW0uYWN0aW9uO1xuXG4gICAgICAgIGxldCBtZW51TGluayA9IGl0ZW0ubGluaztcblxuICAgICAgICB0aGlzLm1lbnVSZWYub25NZW51SXRlbVNlbGVjdChhcmdzKTtcblxuICAgICAgICBpZiAoaXRlbUFjdGlvbikge1xuICAgICAgICAgICAgaWYgKCF0aGlzLml0ZW1BY3Rpb25Gbikge1xuICAgICAgICAgICAgICAgIHRoaXMuaXRlbUFjdGlvbkZuID0gJHBhcnNlRXZlbnQoaXRlbUFjdGlvbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaXRlbUFjdGlvbkZuKHRoaXMudXNlckRlZmluZWRFeGVjdXRpb25Db250ZXh0LCBPYmplY3QuY3JlYXRlKGl0ZW0pKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWVudUxpbmspIHtcbiAgICAgICAgICAgIGlmIChtZW51TGluay5zdGFydHNXaXRoKCcjLycpICYmICghbGlua1RhcmdldCB8fCBsaW5rVGFyZ2V0ID09PSAnX3NlbGYnKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gZ2V0VXJsUGFyYW1zKG1lbnVMaW5rKTtcbiAgICAgICAgICAgICAgICBtZW51TGluayA9IGdldFJvdXRlTmFtZUZyb21MaW5rKG1lbnVMaW5rKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1lbnVSZWYucm91dGUubmF2aWdhdGUoW21lbnVMaW5rXSwgeyBxdWVyeVBhcmFtc30pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcGVuTGluayhtZW51TGluaywgbGlua1RhcmdldCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=