import { Directive, Inject, Self } from '@angular/core';
import { AbstractDialogService, App, DataSource, triggerFn } from '@wm/core';
import { ListComponent } from '../../list/list.component';
import { Live_Operations, performDataOperation } from '../../../../utils/data-utils';
export class LiveActionsDirective {
    constructor(subscribedWidget, app, dialogService) {
        this.subscribedWidget = subscribedWidget;
        this.app = app;
        this.dialogService = dialogService;
        subscribedWidget.addRow = this.addRow.bind(this);
        subscribedWidget.updateRow = this.updateRow.bind(this);
        subscribedWidget.deleteRow = this.deleteRow.bind(this);
        subscribedWidget.call = this.call.bind(this);
    }
    addRow() {
        this.app.notify('wm-event', { eventName: Live_Operations.INSERT, widgetName: this.subscribedWidget.name, row: this.subscribedWidget.selecteditem });
    }
    updateRow() {
        this.app.notify('wm-event', { eventName: Live_Operations.UPDATE, widgetName: this.subscribedWidget.name, row: this.subscribedWidget.selecteditem });
    }
    deleteRow() {
        this.app.notify('wm-event', { eventName: Live_Operations.DELETE, widgetName: this.subscribedWidget.name, row: this.subscribedWidget.selecteditem });
    }
    successHandler(options, response) {
        triggerFn(options.success, response);
    }
    errorHandler(options, error) {
        this.app.notifyApp(error, 'error', 'ERROR');
        triggerFn(options.error, error);
    }
    getRecords(options, operation) {
        let index;
        let dataNavigator;
        if (this.subscribedWidget.navigation !== 'None' && this.subscribedWidget.dataNavigator) {
            dataNavigator = this.subscribedWidget.dataNavigator;
            // If operation is delete, decrease the data size and check if navigation to previous page is required
            if (operation === Live_Operations.DELETE) {
                dataNavigator.dataSize -= 1;
                dataNavigator.calculatePagingValues();
                index = dataNavigator.pageCount < dataNavigator.dn.currentPage ? 'prev' : undefined;
            }
            else {
                // If operation is insert, go to last page. If update operation, stay on current page
                index = operation === Live_Operations.INSERT ? 'last' : 'current';
                if (index === 'last') {
                    dataNavigator.dataSize += 1;
                }
                dataNavigator.calculatePagingValues();
            }
            dataNavigator.navigatePage(index, null, true, response => {
                this.successHandler(options, response);
            });
        }
        else {
            this.subscribedWidget.datasource.execute(DataSource.Operation.LIST_RECORDS, {
                'skipToggleState': true
            }).then(response => {
                this.successHandler(options, response);
            }, err => {
                this.errorHandler(options, err);
            });
        }
    }
    performCUDOperation(requestData, operation, options) {
        performDataOperation(this.subscribedWidget.datasource, requestData, {
            operationType: operation
        }).then(response => {
            if (response.error) {
                this.errorHandler(options, response.error);
                return;
            }
            this.getRecords(options, operation);
            // show delete success toaster
            if (operation === 'delete') {
                this.app.notifyApp(this.app.appLocale.MESSAGE_DELETE_RECORD_SUCCESS, 'success');
            }
        }, (error) => {
            this.errorHandler(options, error);
        });
    }
    insertRecord(requestData, operation, options) {
        this.performCUDOperation(requestData, operation, options);
    }
    updateRecord(requestData, operation, options) {
        this.performCUDOperation(requestData, operation, options);
    }
    deleteRecord(requestData, operation, options) {
        // Show the delete confirmation dialog. On Ok, delete the record.
        this.dialogService.showAppConfirmDialog({
            title: this.app.appLocale.MESSAGE_DELETE_RECORD || 'Delete Record',
            iconclass: 'wi wi-delete fa-lg',
            message: this.subscribedWidget.confirmdelete || 'Are you sure you want to delete this?',
            oktext: this.subscribedWidget.deleteoktext || 'Ok',
            canceltext: this.subscribedWidget.deletecanceltext || 'Cancel',
            onOk: () => {
                this.performCUDOperation(requestData, operation, options);
                this.dialogService.closeAppConfirmDialog();
            },
            onCancel: () => {
                triggerFn(options.cancelDeleteCallback);
                this.dialogService.closeAppConfirmDialog();
            }
        });
    }
    performOperation(operation, options) {
        const requestData = {
            row: options.row,
            prevData: {},
            rowData: {},
            transform: true,
            skipNotification: true
        };
        if (operation === Live_Operations.UPDATE) {
            requestData.rowData = options.rowData;
            requestData.prevData = options.prevData;
        }
        /* decide routine based on CRUD operation to be performed */
        switch (operation) {
            case Live_Operations.INSERT:
                this.insertRecord(requestData, operation, options);
                break;
            case Live_Operations.UPDATE:
                this.updateRecord(requestData, operation, options);
                break;
            case Live_Operations.DELETE:
                this.deleteRecord(requestData, operation, options);
                break;
            case Live_Operations.READ:
                this.getRecords(options, operation);
                break;
        }
    }
    // API exposed to make CRUD operations
    call(operation, options, success, error) {
        options.success = success;
        options.error = error;
        this.performOperation(operation, options);
    }
}
LiveActionsDirective.decorators = [
    { type: Directive, args: [{
                selector: '[wmLiveActions]'
            },] }
];
/** @nocollapse */
LiveActionsDirective.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Self }, { type: Inject, args: [ListComponent,] }] },
    { type: App },
    { type: AbstractDialogService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGl2ZS1hY3Rpb25zLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsid2lkZ2V0cy9jb21tb24vZm9ybS9saXZlLWFjdGlvbnMvbGl2ZS1hY3Rpb25zLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFeEQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTdFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFLckYsTUFBTSxPQUFPLG9CQUFvQjtJQUU3QixZQUMyQyxnQkFBZ0IsRUFDL0MsR0FBUSxFQUNSLGFBQW9DO1FBRkwscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFBO1FBQy9DLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFDUixrQkFBYSxHQUFiLGFBQWEsQ0FBdUI7UUFFNUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELGdCQUFnQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RCxnQkFBZ0IsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsZ0JBQWdCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTSxNQUFNO1FBQ1QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFN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Q0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztZQUN0QyxXQUFXLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDM0M7UUFFRCw0REFBNEQ7UUFDNUQsUUFBUSxTQUFTLEVBQUU7WUFDZixLQUFLLGVBQWUsQ0FBQyxNQUFNO2dCQUN2QixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ25ELE1BQU07WUFDVixLQUFLLGVBQWUsQ0FBQyxNQUFNO2dCQUN2QixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ25ELE1BQU07WUFDVixLQUFLLGVBQWUsQ0FBQyxNQUFNO2dCQUN2QixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ25ELE1BQU07WUFDVixLQUFLLGVBQWUsQ0FBQyxJQUFJO2dCQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDcEMsTUFBTTtTQUNiO0lBQ0wsQ0FBQztJQUVELHNDQUFzQztJQUMvQixJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxPQUFRLEVBQUUsS0FBTTtRQUM1QyxPQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUMxQixPQUFPLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUV0QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUM7OztZQTFKSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGlCQUFpQjthQUM5Qjs7Ozs0Q0FJUSxJQUFJLFlBQUksTUFBTSxTQUFDLGFBQWE7WUFYTCxHQUFHO1lBQTFCLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5qZWN0LCBTZWxmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IEFic3RyYWN0RGlhbG9nU2VydmljZSwgQXBwLCBEYXRhU291cmNlLCB0cmlnZ2VyRm4gfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IExpc3RDb21wb25lbnQgfSBmcm9tICcuLi8uLi9saXN0L2xpc3QuY29tcG9uZW50JztcbmltcG9ydCB7IExpdmVfT3BlcmF0aW9ucywgcGVyZm9ybURhdGFPcGVyYXRpb24gfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy9kYXRhLXV0aWxzJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbd21MaXZlQWN0aW9uc10nXG59KVxuZXhwb3J0IGNsYXNzIExpdmVBY3Rpb25zRGlyZWN0aXZlIHtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBAU2VsZigpIEBJbmplY3QoTGlzdENvbXBvbmVudCkgcHJpdmF0ZSBzdWJzY3JpYmVkV2lkZ2V0LFxuICAgICAgICBwcml2YXRlIGFwcDogQXBwLFxuICAgICAgICBwcml2YXRlIGRpYWxvZ1NlcnZpY2U6IEFic3RyYWN0RGlhbG9nU2VydmljZVxuICAgICkge1xuICAgICAgICBzdWJzY3JpYmVkV2lkZ2V0LmFkZFJvdyA9IHRoaXMuYWRkUm93LmJpbmQodGhpcyk7XG4gICAgICAgIHN1YnNjcmliZWRXaWRnZXQudXBkYXRlUm93ID0gdGhpcy51cGRhdGVSb3cuYmluZCh0aGlzKTtcbiAgICAgICAgc3Vic2NyaWJlZFdpZGdldC5kZWxldGVSb3cgPSB0aGlzLmRlbGV0ZVJvdy5iaW5kKHRoaXMpO1xuICAgICAgICBzdWJzY3JpYmVkV2lkZ2V0LmNhbGwgPSB0aGlzLmNhbGwuYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUm93KCkge1xuICAgICAgICB0aGlzLmFwcC5ub3RpZnkoJ3dtLWV2ZW50Jywge2V2ZW50TmFtZTogTGl2ZV9PcGVyYXRpb25zLklOU0VSVCwgd2lkZ2V0TmFtZTogdGhpcy5zdWJzY3JpYmVkV2lkZ2V0Lm5hbWUsIHJvdzogdGhpcy5zdWJzY3JpYmVkV2lkZ2V0LnNlbGVjdGVkaXRlbX0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVSb3coKSB7XG4gICAgICAgIHRoaXMuYXBwLm5vdGlmeSgnd20tZXZlbnQnLCB7ZXZlbnROYW1lOiBMaXZlX09wZXJhdGlvbnMuVVBEQVRFLCB3aWRnZXROYW1lOiB0aGlzLnN1YnNjcmliZWRXaWRnZXQubmFtZSwgcm93OiB0aGlzLnN1YnNjcmliZWRXaWRnZXQuc2VsZWN0ZWRpdGVtfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZVJvdygpIHtcbiAgICAgICAgdGhpcy5hcHAubm90aWZ5KCd3bS1ldmVudCcsIHtldmVudE5hbWU6IExpdmVfT3BlcmF0aW9ucy5ERUxFVEUsIHdpZGdldE5hbWU6IHRoaXMuc3Vic2NyaWJlZFdpZGdldC5uYW1lLCByb3c6IHRoaXMuc3Vic2NyaWJlZFdpZGdldC5zZWxlY3RlZGl0ZW19KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN1Y2Nlc3NIYW5kbGVyKG9wdGlvbnMsIHJlc3BvbnNlKSB7XG4gICAgICAgIHRyaWdnZXJGbihvcHRpb25zLnN1Y2Nlc3MsIHJlc3BvbnNlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGVycm9ySGFuZGxlcihvcHRpb25zLCBlcnJvcikge1xuICAgICAgICB0aGlzLmFwcC5ub3RpZnlBcHAoZXJyb3IsICdlcnJvcicsICdFUlJPUicpO1xuICAgICAgICB0cmlnZ2VyRm4ob3B0aW9ucy5lcnJvciwgZXJyb3IpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRSZWNvcmRzKG9wdGlvbnMsIG9wZXJhdGlvbikge1xuICAgICAgICBsZXQgaW5kZXg7XG4gICAgICAgIGxldCBkYXRhTmF2aWdhdG9yO1xuXG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmliZWRXaWRnZXQubmF2aWdhdGlvbiAhPT0gJ05vbmUnICYmIHRoaXMuc3Vic2NyaWJlZFdpZGdldC5kYXRhTmF2aWdhdG9yKSB7XG4gICAgICAgICAgICBkYXRhTmF2aWdhdG9yID0gdGhpcy5zdWJzY3JpYmVkV2lkZ2V0LmRhdGFOYXZpZ2F0b3I7XG5cbiAgICAgICAgICAgIC8vIElmIG9wZXJhdGlvbiBpcyBkZWxldGUsIGRlY3JlYXNlIHRoZSBkYXRhIHNpemUgYW5kIGNoZWNrIGlmIG5hdmlnYXRpb24gdG8gcHJldmlvdXMgcGFnZSBpcyByZXF1aXJlZFxuICAgICAgICAgICAgaWYgKG9wZXJhdGlvbiA9PT0gTGl2ZV9PcGVyYXRpb25zLkRFTEVURSkge1xuICAgICAgICAgICAgICAgIGRhdGFOYXZpZ2F0b3IuZGF0YVNpemUgLT0gMTtcbiAgICAgICAgICAgICAgICBkYXRhTmF2aWdhdG9yLmNhbGN1bGF0ZVBhZ2luZ1ZhbHVlcygpO1xuICAgICAgICAgICAgICAgIGluZGV4ID0gZGF0YU5hdmlnYXRvci5wYWdlQ291bnQgPCBkYXRhTmF2aWdhdG9yLmRuLmN1cnJlbnRQYWdlID8gJ3ByZXYnIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBJZiBvcGVyYXRpb24gaXMgaW5zZXJ0LCBnbyB0byBsYXN0IHBhZ2UuIElmIHVwZGF0ZSBvcGVyYXRpb24sIHN0YXkgb24gY3VycmVudCBwYWdlXG4gICAgICAgICAgICAgICAgaW5kZXggPSBvcGVyYXRpb24gPT09IExpdmVfT3BlcmF0aW9ucy5JTlNFUlQgPyAnbGFzdCcgOiAnY3VycmVudCc7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAnbGFzdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YU5hdmlnYXRvci5kYXRhU2l6ZSArPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkYXRhTmF2aWdhdG9yLmNhbGN1bGF0ZVBhZ2luZ1ZhbHVlcygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkYXRhTmF2aWdhdG9yLm5hdmlnYXRlUGFnZShpbmRleCwgbnVsbCwgdHJ1ZSwgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc3VjY2Vzc0hhbmRsZXIob3B0aW9ucywgcmVzcG9uc2UpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN1YnNjcmliZWRXaWRnZXQuZGF0YXNvdXJjZS5leGVjdXRlKERhdGFTb3VyY2UuT3BlcmF0aW9uLkxJU1RfUkVDT1JEUywge1xuICAgICAgICAgICAgICAgICdza2lwVG9nZ2xlU3RhdGUnOiB0cnVlXG4gICAgICAgICAgICB9KS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnN1Y2Nlc3NIYW5kbGVyKG9wdGlvbnMsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgIH0sIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lcnJvckhhbmRsZXIob3B0aW9ucywgZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwZXJmb3JtQ1VET3BlcmF0aW9uKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgcGVyZm9ybURhdGFPcGVyYXRpb24odGhpcy5zdWJzY3JpYmVkV2lkZ2V0LmRhdGFzb3VyY2UsIHJlcXVlc3REYXRhLCB7XG4gICAgICAgICAgICBvcGVyYXRpb25UeXBlOiBvcGVyYXRpb25cbiAgICAgICAgfSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlcihvcHRpb25zLCByZXNwb25zZS5lcnJvcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5nZXRSZWNvcmRzKG9wdGlvbnMsIG9wZXJhdGlvbik7XG4gICAgICAgICAgICAvLyBzaG93IGRlbGV0ZSBzdWNjZXNzIHRvYXN0ZXJcbiAgICAgICAgICAgIGlmIChvcGVyYXRpb24gPT09ICdkZWxldGUnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHAubm90aWZ5QXBwKHRoaXMuYXBwLmFwcExvY2FsZS5NRVNTQUdFX0RFTEVURV9SRUNPUkRfU1VDQ0VTUywgJ3N1Y2Nlc3MnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlcihvcHRpb25zLCBlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5zZXJ0UmVjb3JkKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5wZXJmb3JtQ1VET3BlcmF0aW9uKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlUmVjb3JkKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5wZXJmb3JtQ1VET3BlcmF0aW9uKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVsZXRlUmVjb3JkKHJlcXVlc3REYXRhLCBvcGVyYXRpb24sIG9wdGlvbnMpIHtcbiAgICAgICAgLy8gU2hvdyB0aGUgZGVsZXRlIGNvbmZpcm1hdGlvbiBkaWFsb2cuIE9uIE9rLCBkZWxldGUgdGhlIHJlY29yZC5cbiAgICAgICAgdGhpcy5kaWFsb2dTZXJ2aWNlLnNob3dBcHBDb25maXJtRGlhbG9nKHtcbiAgICAgICAgICAgIHRpdGxlOiAgdGhpcy5hcHAuYXBwTG9jYWxlLk1FU1NBR0VfREVMRVRFX1JFQ09SRCB8fCAnRGVsZXRlIFJlY29yZCcsXG4gICAgICAgICAgICBpY29uY2xhc3M6ICd3aSB3aS1kZWxldGUgZmEtbGcnLFxuICAgICAgICAgICAgbWVzc2FnZTogdGhpcy5zdWJzY3JpYmVkV2lkZ2V0LmNvbmZpcm1kZWxldGUgfHwgJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgdGhpcz8nLFxuICAgICAgICAgICAgb2t0ZXh0OiB0aGlzLnN1YnNjcmliZWRXaWRnZXQuZGVsZXRlb2t0ZXh0IHx8ICdPaycsXG4gICAgICAgICAgICBjYW5jZWx0ZXh0OiB0aGlzLnN1YnNjcmliZWRXaWRnZXQuZGVsZXRlY2FuY2VsdGV4dCB8fCAnQ2FuY2VsJyxcbiAgICAgICAgICAgIG9uT2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcmZvcm1DVURPcGVyYXRpb24ocmVxdWVzdERhdGEsIG9wZXJhdGlvbiwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaWFsb2dTZXJ2aWNlLmNsb3NlQXBwQ29uZmlybURpYWxvZygpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uQ2FuY2VsOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdHJpZ2dlckZuKG9wdGlvbnMuY2FuY2VsRGVsZXRlQ2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIHRoaXMuZGlhbG9nU2VydmljZS5jbG9zZUFwcENvbmZpcm1EaWFsb2coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwZXJmb3JtT3BlcmF0aW9uKG9wZXJhdGlvbiwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCByZXF1ZXN0RGF0YSA9IHtcbiAgICAgICAgICAgIHJvdzogb3B0aW9ucy5yb3csXG4gICAgICAgICAgICBwcmV2RGF0YToge30sXG4gICAgICAgICAgICByb3dEYXRhOiB7fSxcbiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJ1ZSxcbiAgICAgICAgICAgIHNraXBOb3RpZmljYXRpb246IHRydWVcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAob3BlcmF0aW9uID09PSBMaXZlX09wZXJhdGlvbnMuVVBEQVRFKSB7XG4gICAgICAgICAgICByZXF1ZXN0RGF0YS5yb3dEYXRhID0gb3B0aW9ucy5yb3dEYXRhO1xuICAgICAgICAgICAgcmVxdWVzdERhdGEucHJldkRhdGEgPSBvcHRpb25zLnByZXZEYXRhO1xuICAgICAgICB9XG5cbiAgICAgICAgLyogZGVjaWRlIHJvdXRpbmUgYmFzZWQgb24gQ1JVRCBvcGVyYXRpb24gdG8gYmUgcGVyZm9ybWVkICovXG4gICAgICAgIHN3aXRjaCAob3BlcmF0aW9uKSB7XG4gICAgICAgICAgICBjYXNlIExpdmVfT3BlcmF0aW9ucy5JTlNFUlQ6XG4gICAgICAgICAgICAgICAgdGhpcy5pbnNlcnRSZWNvcmQocmVxdWVzdERhdGEsIG9wZXJhdGlvbiwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIExpdmVfT3BlcmF0aW9ucy5VUERBVEU6XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVSZWNvcmQocmVxdWVzdERhdGEsIG9wZXJhdGlvbiwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIExpdmVfT3BlcmF0aW9ucy5ERUxFVEU6XG4gICAgICAgICAgICAgICAgdGhpcy5kZWxldGVSZWNvcmQocmVxdWVzdERhdGEsIG9wZXJhdGlvbiwgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIExpdmVfT3BlcmF0aW9ucy5SRUFEOlxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0UmVjb3JkcyhvcHRpb25zLCBvcGVyYXRpb24pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQVBJIGV4cG9zZWQgdG8gbWFrZSBDUlVEIG9wZXJhdGlvbnNcbiAgICBwdWJsaWMgY2FsbChvcGVyYXRpb24sIG9wdGlvbnMsIHN1Y2Nlc3M/LCBlcnJvcj8pIHtcbiAgICAgICAgb3B0aW9ucy5zdWNjZXNzID0gc3VjY2VzcztcbiAgICAgICAgb3B0aW9ucy5lcnJvciA9IGVycm9yO1xuXG4gICAgICAgIHRoaXMucGVyZm9ybU9wZXJhdGlvbihvcGVyYXRpb24sIG9wdGlvbnMpO1xuICAgIH1cbn1cbiJdfQ==