import { Component, Injector, NgZone, SecurityContext } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { provideAsNgValueAccessor, provideAsWidgetRef } from '../../../utils/widget-utils';
import { APPLY_STYLES_TYPE, styler } from '../../framework/styler';
import { registerProps } from './rich-text-editor.props';
import { BaseFormCustomComponent } from '../base/base-form-custom.component';
const WIDGET_INFO = { widgetType: 'wm-richtexteditor', hostClass: 'app-richtexteditor clearfix' };
const getChangeEvt = () => {
    let changeEvt;
    // for IE the event constructor doesn't work so use the createEvent proto
    if (typeof (Event) === 'function') {
        changeEvt = new Event('change');
    }
    else {
        changeEvt = document.createEvent('Event');
        changeEvt.initEvent('change', true, true);
    }
    return changeEvt;
};
const ɵ0 = getChangeEvt;
// override summernote methods
const origFn = $.summernote.ui.button.bind($.summernote);
$.summernote.ui.button = (...args) => {
    const retVal = origFn(...args);
    const origCallback = retVal.callback;
    retVal.callback = ($node, options) => {
        // add bs3 btn class to the buttons
        $node.addClass('btn');
        return origCallback($node, options);
    };
    return retVal;
};
//
export class RichTextEditorComponent extends BaseFormCustomComponent {
    constructor(inj, domSanitizer, ngZone) {
        super(inj, WIDGET_INFO);
        this.domSanitizer = domSanitizer;
        this.ngZone = ngZone;
        this._operationStack = [];
        this.isEditorLoaded = false;
        this.EDITOR_DEFAULT_OPTIONS = {
            toolbar: [
                // [groupName, [list of button]]
                ['misc', ['undo', 'redo']],
                ['style', ['style']],
                ['fontname', ['fontname']],
                ['fontsize', ['fontsize']],
                ['height', ['height']],
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['color', ['color']],
                ['insert', ['table', 'picture', 'link', 'video', 'hr']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['misc', ['codeview', 'fullscreen', 'help']]
            ],
            callbacks: {
                onInit: () => {
                    this.isEditorLoaded = true;
                    if (this._operationStack.length) {
                        this._operationStack.forEach(operationParam => {
                            const key = Array.from(operationParam.keys())[0], val = operationParam.get(key);
                            this.performEditorOperation(key, val);
                        });
                        this._operationStack = [];
                    }
                },
                onChange: (contents, editable) => {
                    this.proxyModel = this.domSanitizer.sanitize(SecurityContext.HTML, contents.toString());
                    this.invokeOnChange(contents, getChangeEvt(), true);
                    this.invokeOnTouched();
                }
            },
            fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Merriweather'],
            placeholder: '',
            height: 100,
            disableResizeEditor: true
        };
        styler(this.nativeElement, this, APPLY_STYLES_TYPE.CONTAINER, ['height']);
    }
    get htmlcontent() {
        return this.performEditorOperation('code');
    }
    get datavalue() {
        return this.htmlcontent;
    }
    set datavalue(nv) {
        if (nv !== undefined && nv !== null) {
            this.$hiddenInputEle.val(nv);
            this.performEditorOperation('reset');
            this.performEditorOperation('insertText', nv);
        }
    }
    ngOnInit() {
        this.$richTextEditor = $(this.nativeElement.querySelector('[richTextEditor]'));
        this.$hiddenInputEle = $(this.nativeElement.querySelector('input.model-holder'));
        super.ngOnInit();
        this.initEditor();
    }
    initEditor() {
        this.ngZone.runOutsideAngular(() => {
            this.$richTextEditor.summernote(this.EDITOR_DEFAULT_OPTIONS);
        });
    }
    onPropertyChange(key, nv, ov) {
        if (key === 'placeholder') {
            this.EDITOR_DEFAULT_OPTIONS.placeholder = nv;
            this.performEditorOperation({
                placeholder: nv
            });
        }
        else if (key === 'disabled' || key === 'readonly') {
            this.performEditorOperation(nv ? 'disable' : 'enable');
        }
        else {
            super.onPropertyChange(key, nv, ov);
        }
    }
    onStyleChange(key, nv, ov) {
        if (key === 'height') {
            this.EDITOR_DEFAULT_OPTIONS.height = nv;
            this.performEditorOperation({
                height: nv
            });
        }
    }
    performEditorOperation(key, value) {
        if (this.isEditorLoaded) {
            return this.$richTextEditor.summernote(key, value);
        }
        else {
            const op = new Map();
            op.set(key, value);
            this._operationStack.push(op);
            return;
        }
    }
    getCurrentPosition() {
        return this.performEditorOperation('createRange');
    }
    undo() {
        this.performEditorOperation('undo');
    }
    focus() {
        this.performEditorOperation('focus');
    }
    ngOnDestroy() {
        this.performEditorOperation('destroy');
        super.ngOnDestroy();
    }
}
RichTextEditorComponent.initializeProps = registerProps();
RichTextEditorComponent.decorators = [
    { type: Component, args: [{
                selector: 'div[wmRichTextEditor]',
                template: "<div richTextEditor></div>\n<div [innerHTML]=\"proxyModel\" class=\"ta-preview\" *ngIf=\"showpreview\"></div>\n<input class=\"model-holder\" [disabled]=\"disabled\" hidden>\n",
                providers: [
                    provideAsNgValueAccessor(RichTextEditorComponent),
                    provideAsWidgetRef(RichTextEditorComponent)
                ]
            }] }
];
/** @nocollapse */
RichTextEditorComponent.ctorParameters = () => [
    { type: Injector },
    { type: DomSanitizer },
    { type: NgZone }
];
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmljaC10ZXh0LWVkaXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Ad20vY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbIndpZGdldHMvY29tbW9uL3JpY2gtdGV4dC1lZGl0b3IvcmljaC10ZXh0LWVkaXRvci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFxQixlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzNGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFN0UsTUFBTSxXQUFXLEdBQUcsRUFBQyxVQUFVLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLDZCQUE2QixFQUFDLENBQUM7QUFFaEcsTUFBTSxZQUFZLEdBQUcsR0FBRyxFQUFFO0lBQ3RCLElBQUksU0FBUyxDQUFDO0lBQ2QseUVBQXlFO0lBQ3pFLElBQUksT0FBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLFVBQVUsRUFBRTtRQUM5QixTQUFTLEdBQUcsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDbkM7U0FBTTtRQUNILFNBQVMsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztLQUM3QztJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ3JCLENBQUMsQ0FBQzs7QUFL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WTtZQURTLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEluamVjdG9yLCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBTZWN1cml0eUNvbnRleHQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERvbVNhbml0aXplciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xuXG5pbXBvcnQgeyBwcm92aWRlQXNOZ1ZhbHVlQWNjZXNzb3IsIHByb3ZpZGVBc1dpZGdldFJlZiB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3dpZGdldC11dGlscyc7XG5pbXBvcnQgeyBBUFBMWV9TVFlMRVNfVFlQRSwgc3R5bGVyIH0gZnJvbSAnLi4vLi4vZnJhbWV3b3JrL3N0eWxlcic7XG5pbXBvcnQgeyByZWdpc3RlclByb3BzIH0gZnJvbSAnLi9yaWNoLXRleHQtZWRpdG9yLnByb3BzJztcbmltcG9ydCB7IEJhc2VGb3JtQ3VzdG9tQ29tcG9uZW50IH0gZnJvbSAnLi4vYmFzZS9iYXNlLWZvcm0tY3VzdG9tLmNvbXBvbmVudCc7XG5cbmNvbnN0IFdJREdFVF9JTkZPID0ge3dpZGdldFR5cGU6ICd3bS1yaWNodGV4dGVkaXRvcicsIGhvc3RDbGFzczogJ2FwcC1yaWNodGV4dGVkaXRvciBjbGVhcmZpeCd9O1xuXG5jb25zdCBnZXRDaGFuZ2VFdnQgPSAoKSA9PiB7XG4gICAgbGV0IGNoYW5nZUV2dDtcbiAgICAvLyBmb3IgSUUgdGhlIGV2ZW50IGNvbnN0cnVjdG9yIGRvZXNuJ3Qgd29yayBzbyB1c2UgdGhlIGNyZWF0ZUV2ZW50IHByb3RvXG4gICAgaWYgKHR5cGVvZihFdmVudCkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY2hhbmdlRXZ0ID0gbmV3IEV2ZW50KCdjaGFuZ2UnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBjaGFuZ2VFdnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKTtcbiAgICAgICAgY2hhbmdlRXZ0LmluaXRFdmVudCgnY2hhbmdlJywgdHJ1ZSwgdHJ1ZSk7XG4gICAgfVxuICAgIHJldHVybiBjaGFuZ2VFdnQ7XG59O1xuXG5kZWNsYXJlIGNvbnN0IF8sICQ7XG5cblxuLy8gb3ZlcnJpZGUgc3VtbWVybm90ZSBtZXRob2RzXG5cbmNvbnN0IG9yaWdGbiA9ICQuc3VtbWVybm90ZS51aS5idXR0b24uYmluZCgkLnN1bW1lcm5vdGUpO1xuXG4kLnN1bW1lcm5vdGUudWkuYnV0dG9uID0gKC4uLmFyZ3MpID0+IHtcblxuICAgIGNvbnN0IHJldFZhbCA9IG9yaWdGbiguLi5hcmdzKTtcbiAgICBjb25zdCBvcmlnQ2FsbGJhY2sgPSByZXRWYWwuY2FsbGJhY2s7XG5cbiAgICByZXRWYWwuY2FsbGJhY2sgPSAoJG5vZGUsIG9wdGlvbnMpID0+IHtcbiAgICAgICAgLy8gYWRkIGJzMyBidG4gY2xhc3MgdG8gdGhlIGJ1dHRvbnNcbiAgICAgICAgJG5vZGUuYWRkQ2xhc3MoJ2J0bicpO1xuICAgICAgICByZXR1cm4gb3JpZ0NhbGxiYWNrKCRub2RlLCBvcHRpb25zKTtcbiAgICB9O1xuICAgIHJldHVybiByZXRWYWw7XG59O1xuLy9cblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdkaXZbd21SaWNoVGV4dEVkaXRvcl0nLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9yaWNoLXRleHQtZWRpdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgcHJvdmlkZUFzTmdWYWx1ZUFjY2Vzc29yKFJpY2hUZXh0RWRpdG9yQ29tcG9uZW50KSxcbiAgICAgICAgcHJvdmlkZUFzV2lkZ2V0UmVmKFJpY2hUZXh0RWRpdG9yQ29tcG9uZW50KVxuICAgIF1cbn0pXG5leHBvcnQgY2xhc3MgUmljaFRleHRFZGl0b3JDb21wb25lbnQgZXh0ZW5kcyBCYXNlRm9ybUN1c3RvbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgICBzdGF0aWMgaW5pdGlhbGl6ZVByb3BzID0gcmVnaXN0ZXJQcm9wcygpO1xuXG4gICAgJHJpY2hUZXh0RWRpdG9yO1xuICAgICRoaWRkZW5JbnB1dEVsZTtcblxuICAgIHByb3h5TW9kZWw7XG4gICAgX29wZXJhdGlvblN0YWNrID0gW107XG4gICAgaXNFZGl0b3JMb2FkZWQgPSBmYWxzZTtcblxuICAgIHB1YmxpYyBzaG93cHJldmlldzogYW55O1xuICAgIHB1YmxpYyBkaXNhYmxlZDogYm9vbGVhbjtcblxuICAgIEVESVRPUl9ERUZBVUxUX09QVElPTlMgPSB7XG4gICAgICAgIHRvb2xiYXI6IFtcbiAgICAgICAgICAgIC8vIFtncm91cE5hbWUsIFtsaXN0IG9mIGJ1dHRvbl1dXG4gICAgICAgICAgICBbJ21pc2MnLCBbJ3VuZG8nLCAncmVkbyddXSxcbiAgICAgICAgICAgIFsnc3R5bGUnLCBbJ3N0eWxlJ11dLFxuICAgICAgICAgICAgWydmb250bmFtZScsIFsnZm9udG5hbWUnXV0sXG4gICAgICAgICAgICBbJ2ZvbnRzaXplJywgWydmb250c2l6ZSddXSxcbiAgICAgICAgICAgIFsnaGVpZ2h0JywgWydoZWlnaHQnXV0sXG4gICAgICAgICAgICBbJ3N0eWxlJywgWydib2xkJywgJ2l0YWxpYycsICd1bmRlcmxpbmUnLCAnY2xlYXInXV0sXG4gICAgICAgICAgICBbJ2ZvbnQnLCBbJ3N0cmlrZXRocm91Z2gnLCAnc3VwZXJzY3JpcHQnLCAnc3Vic2NyaXB0J11dLFxuICAgICAgICAgICAgWydjb2xvcicsIFsnY29sb3InXV0sXG4gICAgICAgICAgICBbJ2luc2VydCcsIFsndGFibGUnLCAncGljdHVyZScsICdsaW5rJywgJ3ZpZGVvJywgJ2hyJ11dLFxuICAgICAgICAgICAgWydwYXJhJywgWyd1bCcsICdvbCcsICdwYXJhZ3JhcGgnXV0sXG4gICAgICAgICAgICBbJ21pc2MnLCBbJ2NvZGV2aWV3JywgJ2Z1bGxzY3JlZW4nLCAnaGVscCddXVxuICAgICAgICBdLFxuICAgICAgICBjYWxsYmFja3M6IHtcbiAgICAgICAgICAgIG9uSW5pdDogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaXNFZGl0b3JMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9vcGVyYXRpb25TdGFjay5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3BlcmF0aW9uU3RhY2suZm9yRWFjaChvcGVyYXRpb25QYXJhbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBBcnJheS5mcm9tKG9wZXJhdGlvblBhcmFtLmtleXMoKSlbMF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gb3BlcmF0aW9uUGFyYW0uZ2V0KGtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oa2V5LCB2YWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3BlcmF0aW9uU3RhY2sgPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25DaGFuZ2U6IChjb250ZW50cywgZWRpdGFibGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb3h5TW9kZWwgPSB0aGlzLmRvbVNhbml0aXplci5zYW5pdGl6ZShTZWN1cml0eUNvbnRleHQuSFRNTCwgY29udGVudHMudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnZva2VPbkNoYW5nZShjb250ZW50cywgZ2V0Q2hhbmdlRXZ0KCksIHRydWUpO1xuICAgICAgICAgICAgICAgIHRoaXMuaW52b2tlT25Ub3VjaGVkKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGZvbnROYW1lczogWydBcmlhbCcsICdBcmlhbCBCbGFjaycsICdDb21pYyBTYW5zIE1TJywgJ0NvdXJpZXIgTmV3JywgJ01lcnJpd2VhdGhlciddLFxuICAgICAgICBwbGFjZWhvbGRlcjogJycsXG4gICAgICAgIGhlaWdodDogMTAwLFxuICAgICAgICBkaXNhYmxlUmVzaXplRWRpdG9yOiB0cnVlXG4gICAgfTtcblxuICAgIGdldCBodG1sY29udGVudCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyZm9ybUVkaXRvck9wZXJhdGlvbignY29kZScpO1xuICAgIH1cblxuICAgIGdldCBkYXRhdmFsdWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0bWxjb250ZW50O1xuICAgIH1cblxuICAgIHNldCBkYXRhdmFsdWUobnYpIHtcbiAgICAgICAgaWYgKG52ICE9PSB1bmRlZmluZWQgJiYgbnYgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMuJGhpZGRlbklucHV0RWxlLnZhbChudik7XG4gICAgICAgICAgICB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oJ3Jlc2V0Jyk7XG4gICAgICAgICAgICB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oJ2luc2VydFRleHQnLCBudik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihpbmo6IEluamVjdG9yLCBwcml2YXRlIGRvbVNhbml0aXplcjogRG9tU2FuaXRpemVyLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7XG4gICAgICAgIHN1cGVyKGluaiwgV0lER0VUX0lORk8pO1xuICAgICAgICBzdHlsZXIodGhpcy5uYXRpdmVFbGVtZW50LCB0aGlzLCBBUFBMWV9TVFlMRVNfVFlQRS5DT05UQUlORVIsIFsnaGVpZ2h0J10pO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLiRyaWNoVGV4dEVkaXRvciA9ICQodGhpcy5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tyaWNoVGV4dEVkaXRvcl0nKSk7XG4gICAgICAgIHRoaXMuJGhpZGRlbklucHV0RWxlID0gJCh0aGlzLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignaW5wdXQubW9kZWwtaG9sZGVyJykpO1xuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xuICAgICAgICB0aGlzLmluaXRFZGl0b3IoKTtcbiAgICB9XG5cbiAgICBpbml0RWRpdG9yKCkge1xuICAgICAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLiRyaWNoVGV4dEVkaXRvci5zdW1tZXJub3RlKHRoaXMuRURJVE9SX0RFRkFVTFRfT1BUSU9OUyk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgb25Qcm9wZXJ0eUNoYW5nZShrZXk6IHN0cmluZywgbnY6IGFueSwgb3Y/OiBhbnkpIHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ3BsYWNlaG9sZGVyJykge1xuICAgICAgICAgICAgdGhpcy5FRElUT1JfREVGQVVMVF9PUFRJT05TLnBsYWNlaG9sZGVyID0gbnY7XG4gICAgICAgICAgICB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oe1xuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBudlxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnZGlzYWJsZWQnIHx8IGtleSA9PT0gJ3JlYWRvbmx5Jykge1xuICAgICAgICAgICAgdGhpcy5wZXJmb3JtRWRpdG9yT3BlcmF0aW9uKG52ID8gJ2Rpc2FibGUnIDogJ2VuYWJsZScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIub25Qcm9wZXJ0eUNoYW5nZShrZXksIG52LCBvdik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvblN0eWxlQ2hhbmdlKGtleSwgbnYsIG92KSB7XG4gICAgICAgIGlmIChrZXkgPT09ICdoZWlnaHQnKSB7XG4gICAgICAgICAgICB0aGlzLkVESVRPUl9ERUZBVUxUX09QVElPTlMuaGVpZ2h0ID0gbnY7XG4gICAgICAgICAgICB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oe1xuICAgICAgICAgICAgICAgIGhlaWdodDogbnZcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcGVyZm9ybUVkaXRvck9wZXJhdGlvbihrZXksIHZhbHVlPykge1xuICAgICAgICBpZiAodGhpcy5pc0VkaXRvckxvYWRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHJpY2hUZXh0RWRpdG9yLnN1bW1lcm5vdGUoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBvcDogYW55ID0gbmV3IE1hcCgpO1xuICAgICAgICAgICAgb3Auc2V0KGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5fb3BlcmF0aW9uU3RhY2sucHVzaChvcCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRDdXJyZW50UG9zaXRpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcmZvcm1FZGl0b3JPcGVyYXRpb24oJ2NyZWF0ZVJhbmdlJyk7XG4gICAgfVxuXG4gICAgdW5kbygpIHtcbiAgICAgICAgdGhpcy5wZXJmb3JtRWRpdG9yT3BlcmF0aW9uKCd1bmRvJyk7XG4gICAgfVxuXG4gICAgZm9jdXMoKSB7XG4gICAgICAgIHRoaXMucGVyZm9ybUVkaXRvck9wZXJhdGlvbignZm9jdXMnKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5wZXJmb3JtRWRpdG9yT3BlcmF0aW9uKCdkZXN0cm95Jyk7XG4gICAgICAgIHN1cGVyLm5nT25EZXN0cm95KCk7XG4gICAgfVxufVxuIl19