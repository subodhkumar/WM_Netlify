import { $appDigest, findValueOf, isObject, validateAccessRoles } from '@wm/core';
import { SecurityService } from '@wm/security';
import { createArrayFrom } from '../../../utils/data-utils';
import { getEvaluatedData } from '../../../utils/widget-utils';
import { getOrderedDataset } from '../../../utils/form-utils';
import { StylableComponent } from './stylable.component';
const getValidLink = (link) => {
    const routRegex = /^(\/|#\/|#)(?!\W).*/;
    if (link) {
        if (routRegex.test(link)) {
            link = _.first(link.match(/[\w]+.*/g)) || '';
            return `#/${link}`;
        }
        if (_.startsWith(link, 'www.')) {
            return `//${link}`;
        }
        return link;
    }
};
const ɵ0 = getValidLink;
export class DatasetAwareNavComponent extends StylableComponent {
    constructor(inj, WIDGET_CONFIG) {
        super(inj, WIDGET_CONFIG);
        this.nodes = [];
        // debounce function for reset nodes functions.
        this._resetNodes = _.debounce(this.resetNodes, 50);
        this.securityService = this.inj.get(SecurityService);
        this.binditemlabel = this.nativeElement.getAttribute('itemlabel.bind');
        this.binditemicon = this.nativeElement.getAttribute('itemicon.bind');
        this.binditemaction = this.nativeElement.getAttribute('itemaction.bind');
        this.binditembadge = this.nativeElement.getAttribute('itembadge.bind');
        this.binditemchildren = this.nativeElement.getAttribute('itemchildren.bind');
        this.binditemid = this.nativeElement.getAttribute('itemid.bind');
        this.binditemlink = this.nativeElement.getAttribute('itemlink.bind');
        this.binditemtarget = this.nativeElement.getAttribute('itemtarget.bind');
        this.binduserrole = this.nativeElement.getAttribute('userrole.bind');
    }
    /**
     * constructs individual node for the widget model.
     * @param fields
     * @param node
     */
    getNode(fields, node) {
        const context = this.viewParent.pageScope || this.viewParent;
        const children = getEvaluatedData(node, { expression: 'itemchildren', bindExpression: this.binditemchildren }, context) || _.get(node, fields.childrenField);
        const navNode = {
            action: getEvaluatedData(node, { expression: 'itemaction', bindExpression: this.binditemaction }, context) || _.get(node, fields.actionField),
            badge: getEvaluatedData(node, { expression: 'itembadge', bindExpression: this.binditembadge }, context) || _.get(node, fields.badgeField),
            children: Array.isArray(children) ? this.getNodes(children) : [],
            class: _.get(node, fields.classField),
            disabled: node.disabled,
            icon: getEvaluatedData(node, { expression: 'itemicon', bindExpression: this.binditemicon }, context) || _.get(node, fields.iconField),
            id: getEvaluatedData(node, { expression: 'itemid', bindExpression: this.binditemid }, context) || _.get(node, fields.idField),
            label: getEvaluatedData(node, { expression: 'itemlabel', bindExpression: this.binditemlabel }, context) || _.get(node, fields.labelField),
            link: getValidLink(getEvaluatedData(node, { expression: 'itemlink', bindExpression: this.binditemlink }, context) || _.get(node, fields.linkField)),
            target: getValidLink(getEvaluatedData(node, { expression: 'itemtarget', bindExpression: this.binditemtarget }, context) || _.get(node, fields.targetField)),
            role: getEvaluatedData(node, { expression: 'userrole', bindExpression: this.binduserrole }, context),
            // older projects have display field & data field property for menu.
            value: this.datafield ? (this.datafield === 'All Fields' ? node : findValueOf(node, this.datafield)) : node
        };
        return _.omitBy(navNode, _.isUndefined);
    }
    resetItemFieldMap() {
        this._itemFieldMap = null;
    }
    getItemFieldsMap() {
        if (!this._itemFieldMap) {
            this._itemFieldMap = {
                idField: this.itemid || 'itemid',
                iconField: this.itemicon || 'icon',
                labelField: this.itemlabel || 'label',
                linkField: this.itemlink || 'link',
                targetField: this.itemtarget || 'target',
                badgeField: this.itembadge || 'badge',
                childrenField: this.itemchildren || 'children',
                classField: this.itemclass || 'class',
                actionField: this.itemaction || 'action'
            };
        }
        return this._itemFieldMap;
    }
    /**
     * returns array for the value passed as nv.
     * nv: 'a,b' => [{label:a, value:a}, {label:b, value:b}]
     * nv: [1,2] => [{label:1, value:1}, {label:2, value:2}]
     * nv: [{obj}, {obj}] => [{obj}, {obj}]
     * @param nv
     */
    prepareNodeDataSet(nv) {
        nv = createArrayFrom(nv);
        return nv.map((val) => {
            if (!isObject(val)) {
                return {
                    label: val,
                    value: val
                };
            }
            return val;
        });
    }
    /**
     * constructs dataset form the nav elements.
     */
    getNodes(nv = this.dataset || {}) {
        let nodes = getOrderedDataset(this.prepareNodeDataSet(nv), this.orderby) || [];
        if (nodes.length) {
            const userRole = this.userrole;
            const nodeFields = this.getItemFieldsMap();
            nodes = nodes.reduce((result, node) => {
                if (validateAccessRoles(node[userRole], this.securityService.loggedInUser)) {
                    result.push(this.getNode(nodeFields, node));
                }
                return result;
            }, []);
        }
        return nodes;
    }
    // enable the inherited class to extend this method.
    resetNodes() {
        this.resetItemFieldMap();
        this.nodes = this.getNodes();
        $appDigest();
    }
    onPropertyChange(key, nv, ov) {
        switch (key) {
            case 'dataset':
            case 'itemicon':
            case 'itemlabel':
            case 'itemlink':
            case 'itemtarget':
            case 'itemclass':
            case 'itemchildren':
            case 'orderby':
                // calls resetnodes method after 50ms. any calls within 50ms will be ignored.
                this._resetNodes();
                break;
        }
        super.onPropertyChange(key, nv, ov);
    }
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXNldC1hd2FyZS1uYXYuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL2NvbXBvbmVudHMvIiwic291cmNlcyI6WyJ3aWRnZXRzL2NvbW1vbi9iYXNlL2RhdGFzZXQtYXdhcmUtbmF2LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUUvQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFJekQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRTtJQUMxQixNQUFNLFNBQVMsR0FBRyxxQkFBcUIsQ0FBQztJQUN4QyxJQUFJLElBQUksRUFBRTtRQUNOLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN0QixJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzdDLE9BQU8sS0FBSyxJQUFJLEVBQUUsQ0FBQztTQUN0QjtRQUNELElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDNUIsT0FBTyxLQUFLLElBQUksRUFBRSxDQUFDO1NBQ3RCO1FBQ0QsT0FBTyxJQUFJLENBQUM7S0FDZjtBQUNMLENBQUMsQ0FBQzs7QUFFRixNQUFNLE9BQU8sd0JBQXlCLFNBQVEsaUJBQWlCO0lB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QUFDO1FBQ3pCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzdCLFVBQVUsRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFLRCxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUU7UUFDeEIsUUFBUSxHQUFHLEVBQUU7WUFDVCxLQUFLLFNBQVMsQ0FBQztZQUNmLEtBQUssVUFBVSxDQUFDO1lBQ2hCLEtBQUssV0FBVyxDQUFDO1lBQ2pCLEtBQUssVUFBVSxDQUFDO1lBQ2hCLEtBQUssWUFBWSxDQUFDO1lBQ2xCLEtBQUssV0FBVyxDQUFDO1lBQ2pCLEtBQUssY0FBYyxDQUFDO1lBQ3BCLEtBQUssU0FBUztnQkFDViw2RUFBNkU7Z0JBQzdFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQkFDbkIsTUFBTTtTQUNiO1FBQ0QsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgJGFwcERpZ2VzdCwgZmluZFZhbHVlT2YsIGlzT2JqZWN0LCB2YWxpZGF0ZUFjY2Vzc1JvbGVzIH0gZnJvbSAnQHdtL2NvcmUnO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXJ2aWNlIH0gZnJvbSAnQHdtL3NlY3VyaXR5JztcblxuaW1wb3J0IHsgY3JlYXRlQXJyYXlGcm9tIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvZGF0YS11dGlscyc7XG5pbXBvcnQgeyBnZXRFdmFsdWF0ZWREYXRhIH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvd2lkZ2V0LXV0aWxzJztcbmltcG9ydCB7IGdldE9yZGVyZWREYXRhc2V0IH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvZm9ybS11dGlscyc7XG5pbXBvcnQgeyBTdHlsYWJsZUNvbXBvbmVudCB9IGZyb20gJy4vc3R5bGFibGUuY29tcG9uZW50JztcblxuZGVjbGFyZSBjb25zdCBfO1xuXG5jb25zdCBnZXRWYWxpZExpbmsgPSAobGluaykgPT4ge1xuICAgIGNvbnN0IHJvdXRSZWdleCA9IC9eKFxcL3wjXFwvfCMpKD8hXFxXKS4qLztcbiAgICBpZiAobGluaykge1xuICAgICAgICBpZiAocm91dFJlZ2V4LnRlc3QobGluaykpIHtcbiAgICAgICAgICAgIGxpbmsgPSBfLmZpcnN0KGxpbmsubWF0Y2goL1tcXHddKy4qL2cpKSB8fCAnJztcbiAgICAgICAgICAgIHJldHVybiBgIy8ke2xpbmt9YDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXy5zdGFydHNXaXRoKGxpbmssICd3d3cuJykpIHtcbiAgICAgICAgICAgIHJldHVybiBgLy8ke2xpbmt9YDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGluaztcbiAgICB9XG59O1xuXG5leHBvcnQgY2xhc3MgRGF0YXNldEF3YXJlTmF2Q29tcG9uZW50IGV4dGVuZHMgU3R5bGFibGVDb21wb25lbnQge1xuXG4gICAgcHVibGljIG5vZGVzOiBBcnJheTxOYXZOb2RlPiA9IFtdO1xuICAgIHB1YmxpYyBkYXRhc2V0OiBhbnk7XG4gICAgcHVibGljIGl0ZW1pY29uOiBzdHJpbmc7XG4gICAgcHVibGljIGl0ZW1sYWJlbDogc3RyaW5nO1xuICAgIHB1YmxpYyBpdGVtbGluazogc3RyaW5nO1xuICAgIHB1YmxpYyBpdGVtdGFyZ2V0OiBzdHJpbmc7XG4gICAgcHVibGljIGl0ZW1iYWRnZTogc3RyaW5nO1xuICAgIHB1YmxpYyBpdGVtY2hpbGRyZW46IHN0cmluZztcbiAgICBwdWJsaWMgaXRlbWFjdGlvbjogc3RyaW5nO1xuICAgIHB1YmxpYyBpdGVtY2xhc3M6IHN0cmluZztcbiAgICBwdWJsaWMgaXRlbWlkOiBzdHJpbmc7XG4gICAgcHVibGljIHVzZXJyb2xlOiBzdHJpbmc7XG4gICAgcHVibGljIG9yZGVyYnk6IHN0cmluZztcbiAgICBwdWJsaWMgZGF0YWZpZWxkOiBzdHJpbmc7XG4gICAgcHVibGljIGRpc3BsYXlmaWVsZDogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBfaXRlbUZpZWxkTWFwO1xuICAgIHByaXZhdGUgYmluZGl0ZW1sYWJlbDogc3RyaW5nIHwgbnVsbDtcbiAgICBwcml2YXRlIGJpbmRpdGVtaWNvbjogc3RyaW5nIHwgbnVsbDtcbiAgICBwcml2YXRlIGJpbmRpdGVtYWN0aW9uOiBzdHJpbmcgfCBudWxsO1xuICAgIHByaXZhdGUgYmluZGl0ZW1iYWRnZTogc3RyaW5nIHwgbnVsbDtcbiAgICBwcml2YXRlIGJpbmRpdGVtY2hpbGRyZW46IHN0cmluZyB8IG51bGw7XG4gICAgcHJpdmF0ZSBiaW5kaXRlbWxpbms6IHN0cmluZyB8IG51bGw7XG4gICAgcHJpdmF0ZSBiaW5kaXRlbXRhcmdldDogc3RyaW5nIHwgbnVsbDtcbiAgICBwcml2YXRlIGJpbmR1c2Vycm9sZTogc3RyaW5nIHwgbnVsbDtcbiAgICBwcml2YXRlIHNlY3VyaXR5U2VydmljZTogYW55O1xuXG4gICAgcHJvdGVjdGVkIGJpbmRpdGVtaWQ6IHN0cmluZyB8IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihpbmo6IEluamVjdG9yLCBXSURHRVRfQ09ORklHKSB7XG4gICAgICAgIHN1cGVyKGluaiwgV0lER0VUX0NPTkZJRyk7XG4gICAgICAgIHRoaXMuc2VjdXJpdHlTZXJ2aWNlID0gdGhpcy5pbmouZ2V0KFNlY3VyaXR5U2VydmljZSk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1sYWJlbCA9IHRoaXMubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2l0ZW1sYWJlbC5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1pY29uID0gdGhpcy5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgnaXRlbWljb24uYmluZCcpO1xuICAgICAgICB0aGlzLmJpbmRpdGVtYWN0aW9uID0gdGhpcy5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgnaXRlbWFjdGlvbi5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1iYWRnZSA9IHRoaXMubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2l0ZW1iYWRnZS5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1jaGlsZHJlbiA9IHRoaXMubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2l0ZW1jaGlsZHJlbi5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1pZCA9IHRoaXMubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2l0ZW1pZC5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZGl0ZW1saW5rID0gdGhpcy5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgnaXRlbWxpbmsuYmluZCcpO1xuICAgICAgICB0aGlzLmJpbmRpdGVtdGFyZ2V0ID0gdGhpcy5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgnaXRlbXRhcmdldC5iaW5kJyk7XG4gICAgICAgIHRoaXMuYmluZHVzZXJyb2xlID0gdGhpcy5uYXRpdmVFbGVtZW50LmdldEF0dHJpYnV0ZSgndXNlcnJvbGUuYmluZCcpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGNvbnN0cnVjdHMgaW5kaXZpZHVhbCBub2RlIGZvciB0aGUgd2lkZ2V0IG1vZGVsLlxuICAgICAqIEBwYXJhbSBmaWVsZHNcbiAgICAgKiBAcGFyYW0gbm9kZVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0Tm9kZShmaWVsZHMsIG5vZGUpOiBOYXZOb2RlIHtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMudmlld1BhcmVudC5wYWdlU2NvcGUgfHwgdGhpcy52aWV3UGFyZW50O1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IGdldEV2YWx1YXRlZERhdGEobm9kZSwge2V4cHJlc3Npb246ICdpdGVtY2hpbGRyZW4nLCBiaW5kRXhwcmVzc2lvbjogdGhpcy5iaW5kaXRlbWNoaWxkcmVufSwgY29udGV4dCkgfHwgXy5nZXQobm9kZSwgZmllbGRzLmNoaWxkcmVuRmllbGQpO1xuICAgICAgICBjb25zdCBuYXZOb2RlID0ge1xuICAgICAgICAgICAgYWN0aW9uOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWFjdGlvbicsIGJpbmRFeHByZXNzaW9uOiB0aGlzLmJpbmRpdGVtYWN0aW9ufSwgY29udGV4dCkgfHwgXy5nZXQobm9kZSwgZmllbGRzLmFjdGlvbkZpZWxkKSxcbiAgICAgICAgICAgIGJhZGdlOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWJhZGdlJywgYmluZEV4cHJlc3Npb246IHRoaXMuYmluZGl0ZW1iYWRnZX0sIGNvbnRleHQpIHx8IF8uZ2V0KG5vZGUsIGZpZWxkcy5iYWRnZUZpZWxkKSxcbiAgICAgICAgICAgIGNoaWxkcmVuOiBBcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IHRoaXMuZ2V0Tm9kZXMoY2hpbGRyZW4pIDogW10sXG4gICAgICAgICAgICBjbGFzczogXy5nZXQobm9kZSwgZmllbGRzLmNsYXNzRmllbGQpLFxuICAgICAgICAgICAgZGlzYWJsZWQ6IG5vZGUuZGlzYWJsZWQsXG4gICAgICAgICAgICBpY29uOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWljb24nLCBiaW5kRXhwcmVzc2lvbjogdGhpcy5iaW5kaXRlbWljb259LCBjb250ZXh0KSB8fCBfLmdldChub2RlLCBmaWVsZHMuaWNvbkZpZWxkKSxcbiAgICAgICAgICAgIGlkOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWlkJywgYmluZEV4cHJlc3Npb246IHRoaXMuYmluZGl0ZW1pZH0sIGNvbnRleHQpIHx8IF8uZ2V0KG5vZGUsIGZpZWxkcy5pZEZpZWxkKSxcbiAgICAgICAgICAgIGxhYmVsOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWxhYmVsJywgYmluZEV4cHJlc3Npb246IHRoaXMuYmluZGl0ZW1sYWJlbH0sIGNvbnRleHQpIHx8IF8uZ2V0KG5vZGUsIGZpZWxkcy5sYWJlbEZpZWxkKSxcbiAgICAgICAgICAgIGxpbms6IGdldFZhbGlkTGluayhnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbWxpbmsnLCBiaW5kRXhwcmVzc2lvbjogdGhpcy5iaW5kaXRlbWxpbmt9LCBjb250ZXh0KSB8fCBfLmdldChub2RlLCBmaWVsZHMubGlua0ZpZWxkKSksXG4gICAgICAgICAgICB0YXJnZXQ6IGdldFZhbGlkTGluayhnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAnaXRlbXRhcmdldCcsIGJpbmRFeHByZXNzaW9uOiB0aGlzLmJpbmRpdGVtdGFyZ2V0fSwgY29udGV4dCkgfHwgXy5nZXQobm9kZSwgZmllbGRzLnRhcmdldEZpZWxkKSksXG4gICAgICAgICAgICByb2xlOiBnZXRFdmFsdWF0ZWREYXRhKG5vZGUsIHtleHByZXNzaW9uOiAndXNlcnJvbGUnLCBiaW5kRXhwcmVzc2lvbjogdGhpcy5iaW5kdXNlcnJvbGV9LCBjb250ZXh0KSxcbiAgICAgICAgICAgIC8vIG9sZGVyIHByb2plY3RzIGhhdmUgZGlzcGxheSBmaWVsZCAmIGRhdGEgZmllbGQgcHJvcGVydHkgZm9yIG1lbnUuXG4gICAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhZmllbGQgPyAodGhpcy5kYXRhZmllbGQgPT09ICdBbGwgRmllbGRzJyA/IG5vZGUgOiBmaW5kVmFsdWVPZihub2RlLCB0aGlzLmRhdGFmaWVsZCkpIDogbm9kZVxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gXy5vbWl0QnkobmF2Tm9kZSwgXy5pc1VuZGVmaW5lZCk7XG4gICAgfVxuXG4gICAgcmVzZXRJdGVtRmllbGRNYXAoKSB7XG4gICAgICAgIHRoaXMuX2l0ZW1GaWVsZE1hcCA9IG51bGw7XG4gICAgfVxuXG4gICAgZ2V0SXRlbUZpZWxkc01hcCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pdGVtRmllbGRNYXApIHtcbiAgICAgICAgICAgIHRoaXMuX2l0ZW1GaWVsZE1hcCA9IHtcbiAgICAgICAgICAgICAgICBpZEZpZWxkOiB0aGlzLml0ZW1pZCB8fCAnaXRlbWlkJyxcbiAgICAgICAgICAgICAgICBpY29uRmllbGQ6IHRoaXMuaXRlbWljb24gfHwgJ2ljb24nLFxuICAgICAgICAgICAgICAgIGxhYmVsRmllbGQ6IHRoaXMuaXRlbWxhYmVsIHx8ICdsYWJlbCcsXG4gICAgICAgICAgICAgICAgbGlua0ZpZWxkOiB0aGlzLml0ZW1saW5rIHx8ICdsaW5rJyxcbiAgICAgICAgICAgICAgICB0YXJnZXRGaWVsZDogdGhpcy5pdGVtdGFyZ2V0IHx8ICd0YXJnZXQnLFxuICAgICAgICAgICAgICAgIGJhZGdlRmllbGQ6IHRoaXMuaXRlbWJhZGdlIHx8ICdiYWRnZScsXG4gICAgICAgICAgICAgICAgY2hpbGRyZW5GaWVsZDogdGhpcy5pdGVtY2hpbGRyZW4gfHwgJ2NoaWxkcmVuJyxcbiAgICAgICAgICAgICAgICBjbGFzc0ZpZWxkOiB0aGlzLml0ZW1jbGFzcyB8fCAnY2xhc3MnLFxuICAgICAgICAgICAgICAgIGFjdGlvbkZpZWxkOiB0aGlzLml0ZW1hY3Rpb24gfHwgJ2FjdGlvbidcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1GaWVsZE1hcDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiByZXR1cm5zIGFycmF5IGZvciB0aGUgdmFsdWUgcGFzc2VkIGFzIG52LlxuICAgICAqIG52OiAnYSxiJyA9PiBbe2xhYmVsOmEsIHZhbHVlOmF9LCB7bGFiZWw6YiwgdmFsdWU6Yn1dXG4gICAgICogbnY6IFsxLDJdID0+IFt7bGFiZWw6MSwgdmFsdWU6MX0sIHtsYWJlbDoyLCB2YWx1ZToyfV1cbiAgICAgKiBudjogW3tvYmp9LCB7b2JqfV0gPT4gW3tvYmp9LCB7b2JqfV1cbiAgICAgKiBAcGFyYW0gbnZcbiAgICAgKi9cbiAgICBwcml2YXRlIHByZXBhcmVOb2RlRGF0YVNldChudikge1xuICAgICAgICBudiA9ICBjcmVhdGVBcnJheUZyb20obnYpO1xuICAgICAgICByZXR1cm4gbnYubWFwKCh2YWwpID0+IHtcbiAgICAgICAgICAgaWYgKCFpc09iamVjdCh2YWwpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHZhbCxcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgIH1cbiAgICAgICAgICAgcmV0dXJuIHZhbDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY29uc3RydWN0cyBkYXRhc2V0IGZvcm0gdGhlIG5hdiBlbGVtZW50cy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGdldE5vZGVzKG52ID0gdGhpcy5kYXRhc2V0IHx8IHt9KTogQXJyYXk8TmF2Tm9kZT4ge1xuICAgICAgICBsZXQgbm9kZXM6IEFycmF5PGFueT4gPSBnZXRPcmRlcmVkRGF0YXNldCh0aGlzLnByZXBhcmVOb2RlRGF0YVNldChudiksIHRoaXMub3JkZXJieSkgfHwgW107XG5cbiAgICAgICAgaWYgKG5vZGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgdXNlclJvbGUgPSB0aGlzLnVzZXJyb2xlO1xuICAgICAgICAgICAgY29uc3Qgbm9kZUZpZWxkcyA9IHRoaXMuZ2V0SXRlbUZpZWxkc01hcCgpO1xuXG4gICAgICAgICAgICBub2RlcyA9IG5vZGVzLnJlZHVjZSgocmVzdWx0LCBub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRlQWNjZXNzUm9sZXMobm9kZVt1c2VyUm9sZV0sIHRoaXMuc2VjdXJpdHlTZXJ2aWNlLmxvZ2dlZEluVXNlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godGhpcy5nZXROb2RlKG5vZGVGaWVsZHMsIG5vZGUpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0sIFtdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbm9kZXM7XG4gICAgfVxuXG4gICAgLy8gZW5hYmxlIHRoZSBpbmhlcml0ZWQgY2xhc3MgdG8gZXh0ZW5kIHRoaXMgbWV0aG9kLlxuICAgIHByb3RlY3RlZCByZXNldE5vZGVzKCkge1xuICAgICAgICB0aGlzLnJlc2V0SXRlbUZpZWxkTWFwKCk7XG4gICAgICAgIHRoaXMubm9kZXMgPSB0aGlzLmdldE5vZGVzKCk7XG4gICAgICAgICRhcHBEaWdlc3QoKTtcbiAgICB9XG5cbiAgICAvLyBkZWJvdW5jZSBmdW5jdGlvbiBmb3IgcmVzZXQgbm9kZXMgZnVuY3Rpb25zLlxuICAgIHByaXZhdGUgX3Jlc2V0Tm9kZXMgPSBfLmRlYm91bmNlKHRoaXMucmVzZXROb2RlcywgNTApO1xuXG4gICAgb25Qcm9wZXJ0eUNoYW5nZShrZXksIG52LCBvdikge1xuICAgICAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgICAgICAgY2FzZSAnZGF0YXNldCc6XG4gICAgICAgICAgICBjYXNlICdpdGVtaWNvbic6XG4gICAgICAgICAgICBjYXNlICdpdGVtbGFiZWwnOlxuICAgICAgICAgICAgY2FzZSAnaXRlbWxpbmsnOlxuICAgICAgICAgICAgY2FzZSAnaXRlbXRhcmdldCc6XG4gICAgICAgICAgICBjYXNlICdpdGVtY2xhc3MnOlxuICAgICAgICAgICAgY2FzZSAnaXRlbWNoaWxkcmVuJzpcbiAgICAgICAgICAgIGNhc2UgJ29yZGVyYnknOlxuICAgICAgICAgICAgICAgIC8vIGNhbGxzIHJlc2V0bm9kZXMgbWV0aG9kIGFmdGVyIDUwbXMuIGFueSBjYWxscyB3aXRoaW4gNTBtcyB3aWxsIGJlIGlnbm9yZWQuXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVzZXROb2RlcygpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyLm9uUHJvcGVydHlDaGFuZ2Uoa2V5LCBudiwgb3YpO1xuICAgIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBOYXZOb2RlIHtcbiAgICBsYWJlbDogc3RyaW5nO1xuICAgIGFjdGlvbj86IGFueTtcbiAgICBiYWRnZT86IHN0cmluZztcbiAgICBjaGlsZHJlbj86IEFycmF5PE5hdk5vZGU+O1xuICAgIGNsYXNzPzogc3RyaW5nO1xuICAgIGRpc2FibGVkPzogYm9vbGVhbjtcbiAgICBpY29uPzogc3RyaW5nO1xuICAgIGlkPzogc3RyaW5nO1xuICAgIGxpbms/OiBzdHJpbmc7XG4gICAgcm9sZT86IHN0cmluZztcbiAgICB2YWx1ZT86IGFueTtcbn1cbiJdfQ==