import { triggerFn } from '@wm/core';
import { NotifyPromise } from './notify-promise';
import { httpService } from './variable/variables.utils';
var HTTP_EVENT_TYPE;
(function (HTTP_EVENT_TYPE) {
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["Sent"] = 0] = "Sent";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["UploadProgress"] = 1] = "UploadProgress";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["ResponseHeader"] = 2] = "ResponseHeader";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["DownloadProgress"] = 3] = "DownloadProgress";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["Response"] = 4] = "Response";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["User"] = 5] = "User";
})(HTTP_EVENT_TYPE || (HTTP_EVENT_TYPE = {}));
var UPLOAD_STATUS;
(function (UPLOAD_STATUS) {
    UPLOAD_STATUS["QUEUED"] = "queued";
    UPLOAD_STATUS["IN_PROGRESS"] = "inprogress";
    UPLOAD_STATUS["SUCCESS"] = "success";
    UPLOAD_STATUS["ERROR"] = "error";
    UPLOAD_STATUS["ABORTED"] = "abort";
})(UPLOAD_STATUS || (UPLOAD_STATUS = {}));
function transformEvent(event) {
    event.target = event.target || {
        status: event.responseCode,
        response: event.response
    };
    return event;
}
class FileTransferObject {
    constructor(file, transferFn, promise, abortFn) {
        this.name = file.name;
        this.size = file.size || '';
        this.status = UPLOAD_STATUS.QUEUED;
        this.transferFn = transferFn;
        this.promise = promise;
        this.abortFn = abortFn;
    }
    start() {
        if (this.status === UPLOAD_STATUS.QUEUED) {
            this.status = UPLOAD_STATUS.IN_PROGRESS;
            triggerFn(this.transferFn);
        }
    }
    then(onSuccess, onError, onProgress) {
        const self = this;
        this.promise.then(function (event) {
            self.status = UPLOAD_STATUS.SUCCESS;
            triggerFn(onSuccess, event);
        }, function (event) {
            self.status = UPLOAD_STATUS.ERROR;
            triggerFn(onError, event);
        }, function (event) {
            self.progress = Math.round(event.loaded / event.total * 100);
            triggerFn(onProgress, event);
        });
        return this;
    }
    finally(onFinal) {
        this.promise.finally(onFinal);
    }
    /* aborts the file upload */
    abort() {
        this.status = UPLOAD_STATUS.ABORTED;
        triggerFn(this.abortFn);
        this.finally();
    }
}
class AjaxFileTransferObject extends FileTransferObject {
    constructor(file, transferFn, promise, abortFn) {
        super(file, transferFn, promise, abortFn);
    }
}
/* upload file using fileTransfer */
function uploadWithFileTransfer(file, url, options) { }
function appendFileToFormData(file, fd, options) {
    /* append file to form data */
    if (_.isArray(file)) {
        _.forEach(file, function (fileObject) {
            fd.append(options.paramName, fileObject.content || fileObject, fileObject.name);
        });
    }
    else if (_.isObject(file)) {
        fd.append(options.paramName, file.content || file, file.name);
    }
}
/* upload file with ajax calling */
function uploadWithAjax(file, fd, url, options) {
    const cloneFD = new FormData();
    const iterate = (value, key) => {
        const fileObject = (_.isArray(value) ? value[0] : value);
        if (!(fileObject instanceof File || fileObject instanceof Blob)) {
            cloneFD.append(key, value);
        }
    };
    // The foreeach method on form data doesn't exist in IE. Hence we check if it exists
    // or else use the lodash forEach
    if (fd.forEach) {
        fd.forEach(iterate);
    }
    else {
        _.forEach(fd, iterate);
    }
    appendFileToFormData(file, cloneFD, options);
    const promise = new NotifyPromise((resolve, reject, notify) => {
        const request = httpService.upload(url, cloneFD).subscribe(event => {
            if (event.type === HTTP_EVENT_TYPE.UploadProgress) {
                const uploadProgress = Math.round(100 * event.loaded / event.total);
                notify(uploadProgress);
            }
            if (event.type === HTTP_EVENT_TYPE.Response) {
                resolve(event.body);
            }
        });
        file._uploadProgress = request;
    });
    return promise;
}
/* upload the file - IE9 support */
function uploadWithIframe(file, url, options) { }
/* upload the next file depending on the status */
function starNextFileTransfer(fts) {
    const ft = _.find(fts, function (f) {
        return f.status === UPLOAD_STATUS.QUEUED;
    });
    if (ft) {
        ft.start();
        ft.finally(starNextFileTransfer.bind(undefined, fts));
    }
}
/* upload the max no of files at once i.e. two at once based on max*/
function startFileTransfers(fts, max) {
    let i = 0;
    const len = fts.length;
    while (i < max && i < len) {
        starNextFileTransfer(fts);
        i++;
    }
}
function isMobileApp() {
    return false;
}
/**
 * This function uploads the file to the given url endpoint.
 *
 * @param file file to upload
 * @param url http endpoint to which the file has to be submitted.
 * @param options
 * @returns a promise to listen for success, event, onProgress.
 *  One can also abort the upload by simply calling abort function.
 */
export function upload(files, fd, config, options) {
    options = _.extend({
        'paramName': config.fileParamName
    }, options);
    return uploadWithAjax(files, fd, config.url, options);
    // let fileTransfers = [],
    //     url = config.uploadUrl;
    // options = _.extend({
    //     'paramName' : config.fileParamName
    // }, options);
    //
    // if (isMobileApp()) {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithFileTransfer(file, url, options));
    //     });
    // } else if ((window as any).FormData) {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithAjax(file, url, options));
    //     });
    // } else {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithIframe(file, url, options));
    //     });
    // }
    // startFileTransfers(fileTransfers, 2);
    // return fileTransfers;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQudXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS92YXJpYWJsZXMvIiwic291cmNlcyI6WyJ1dGlsL2ZpbGUtdXBsb2FkLnV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVyQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBSXpELElBQUssZUFPSjtBQVBELFdBQUssZUFBZTtJQUNoQixxREFBUSxDQUFBO0lBQ1IseUVBQWtCLENBQUE7SUFDbEIseUVBQWtCLENBQUE7SUFDbEIsNkVBQW9CLENBQUE7SUFDcEIsNkRBQVcsQ0FBQTtJQUNYLHFEQUFRLENBQUE7QUFDWixDQUFDLEVBUEksZUFBZSxLQUFmLGVBQWUsUUFPbkI7QUFFRCxJQUFLLGFBTUo7QUFORCxXQUFLLGFBQWE7SUFDZCxrQ0FBd0IsQ0FBQTtJQUN4QiwyQ0FBNEIsQ0FBQTtJQUM1QixvQ0FBeUIsQ0FBQTtJQUN6QixnQ0FBdUIsQ0FBQTtJQUN2QixrQ0FBdUIsQ0FBQTtBQUMzQixDQUFDLEVBTkksYUFBYSxLQUFiLGFBQWEsUUFNakI7QUFFRCxTQUFTLGNBQWMsQ0FBQyxLQUFLO0lBQ3pCLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSTtRQUMzQixNQUFNLEVBQUUsS0FBSyxDQUFDLFlBQVk7UUFDMUIsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO0tBQzNCLENBQUM7SUFDRixPQUFPLEtBQUssQ0FBQztBQUNqQixDQUFDO0FBRUQsTUFBTSxrQkFBa0I7SUFTcEIsWUFBWSxJQUFJLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxPQUFPO1FBQzFDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsSUFBSSxHQUFH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S0FDUDtBQUNMLENBQUM7QUFFRCxTQUFTLFdBQVc7SUFDaEIsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVEOzs7Ozs7OztHQVFHO0FBQ0gsTUFBTSxVQUFVLE1BQU0sQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFRO0lBQzlDLE9BQU8sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2YsV0FBVyxFQUFHLE1BQU0sQ0FBQyxhQUFhO0tBQ3JDLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDWixPQUFPLGNBQWMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdEQsMEJBQTBCO0lBQzFCLDhCQUE4QjtJQUM5Qix1QkFBdUI7SUFDdkIseUNBQXlDO0lBQ3pDLGVBQWU7SUFDZixFQUFFO0lBQ0YsdUJBQXVCO0lBQ3ZCLHlDQUF5QztJQUN6QywwRUFBMEU7SUFDMUUsVUFBVTtJQUNWLHlDQUF5QztJQUN6Qyx5Q0FBeUM7SUFDekMsa0VBQWtFO0lBQ2xFLFVBQVU7SUFDVixXQUFXO0lBQ1gseUNBQXlDO0lBQ3pDLG9FQUFvRTtJQUNwRSxVQUFVO0lBQ1YsSUFBSTtJQUNKLHdDQUF3QztJQUN4Qyx3QkFBd0I7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRyaWdnZXJGbiB9IGZyb20gJ0B3bS9jb3JlJztcblxuaW1wb3J0IHsgTm90aWZ5UHJvbWlzZSB9IGZyb20gJy4vbm90aWZ5LXByb21pc2UnO1xuaW1wb3J0IHsgaHR0cFNlcnZpY2UgfSBmcm9tICcuL3ZhcmlhYmxlL3ZhcmlhYmxlcy51dGlscyc7XG5cbmRlY2xhcmUgY29uc3QgXztcblxuZW51bSBIVFRQX0VWRU5UX1RZUEUge1xuICAgIFNlbnQgPSAwLFxuICAgIFVwbG9hZFByb2dyZXNzID0gMSxcbiAgICBSZXNwb25zZUhlYWRlciA9IDIsXG4gICAgRG93bmxvYWRQcm9ncmVzcyA9IDMsXG4gICAgUmVzcG9uc2U9IDQsXG4gICAgVXNlciA9IDVcbn1cblxuZW51bSBVUExPQURfU1RBVFVTIHtcbiAgICBRVUVVRUQgICAgICAgID0gJ3F1ZXVlZCcsXG4gICAgSU5fUFJPR1JFU1MgICA9ICdpbnByb2dyZXNzJyxcbiAgICBTVUNDRVNTICAgICAgID0gJ3N1Y2Nlc3MnLFxuICAgIEVSUk9SICAgICAgICAgPSAnZXJyb3InLFxuICAgIEFCT1JURUQgICAgICAgPSAnYWJvcnQnXG59XG5cbmZ1bmN0aW9uIHRyYW5zZm9ybUV2ZW50KGV2ZW50KSB7XG4gICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IHtcbiAgICAgICAgc3RhdHVzOiBldmVudC5yZXNwb25zZUNvZGUsXG4gICAgICAgIHJlc3BvbnNlOiBldmVudC5yZXNwb25zZVxuICAgIH07XG4gICAgcmV0dXJuIGV2ZW50O1xufVxuXG5jbGFzcyBGaWxlVHJhbnNmZXJPYmplY3Qge1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBzaXplOiBzdHJpbmc7XG4gICAgc3RhdHVzOiBzdHJpbmc7XG4gICAgdHJhbnNmZXJGbjogRnVuY3Rpb247XG4gICAgYWJvcnRGbjogRnVuY3Rpb247XG4gICAgcHJvbWlzZTogYW55O1xuICAgIHByb2dyZXNzOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihmaWxlLCB0cmFuc2ZlckZuLCBwcm9taXNlLCBhYm9ydEZuKSB7XG4gICAgICAgIHRoaXMubmFtZSA9IGZpbGUubmFtZTtcbiAgICAgICAgdGhpcy5zaXplID0gZmlsZS5zaXplIHx8ICcnO1xuICAgICAgICB0aGlzLnN0YXR1cyA9IFVQTE9BRF9TVEFUVVMuUVVFVUVEO1xuICAgICAgICB0aGlzLnRyYW5zZmVyRm4gPSB0cmFuc2ZlckZuO1xuICAgICAgICB0aGlzLnByb21pc2UgPSBwcm9taXNlO1xuICAgICAgICB0aGlzLmFib3J0Rm4gPSBhYm9ydEZuO1xuICAgIH1cblxuICAgIHN0YXJ0KCkge1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMgPT09IFVQTE9BRF9TVEFUVVMuUVVFVUVEKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFVQTE9BRF9TVEFUVVMuSU5fUFJPR1JFU1M7XG4gICAgICAgICAgICB0cmlnZ2VyRm4odGhpcy50cmFuc2ZlckZuKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHRoZW4ob25TdWNjZXNzLCBvbkVycm9yLCBvblByb2dyZXNzKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICB0aGlzLnByb21pc2UudGhlbihmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHNlbGYuc3RhdHVzID0gVVBMT0FEX1NUQVRVUy5TVUNDRVNTO1xuICAgICAgICAgICAgdHJpZ2dlckZuKG9uU3VjY2VzcywgZXZlbnQpO1xuICAgICAgICB9LCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHNlbGYuc3RhdHVzID0gVVBMT0FEX1NUQVRVUy5FUlJPUjtcbiAgICAgICAgICAgIHRyaWdnZXJGbihvbkVycm9yLCBldmVudCk7XG4gICAgICAgIH0sIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgc2VsZi5wcm9ncmVzcyA9IE1hdGgucm91bmQoZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwgKiAxMDApO1xuICAgICAgICAgICAgdHJpZ2dlckZuKG9uUHJvZ3Jlc3MsIGV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGZpbmFsbHkob25GaW5hbD8pIHtcbiAgICAgICAgdGhpcy5wcm9taXNlLmZpbmFsbHkob25GaW5hbCk7XG4gICAgfVxuXG4gICAgLyogYWJvcnRzIHRoZSBmaWxlIHVwbG9hZCAqL1xuICAgIGFib3J0KCkge1xuICAgICAgICB0aGlzLnN0YXR1cyA9IFVQTE9BRF9TVEFUVVMuQUJPUlRFRDtcbiAgICAgICAgdHJpZ2dlckZuKHRoaXMuYWJvcnRGbik7XG4gICAgICAgIHRoaXMuZmluYWxseSgpO1xuICAgIH1cblxufVxuXG5jbGFzcyBBamF4RmlsZVRyYW5zZmVyT2JqZWN0IGV4dGVuZHMgRmlsZVRyYW5zZmVyT2JqZWN0IHtcbiAgICBjb25zdHJ1Y3RvcihmaWxlLCB0cmFuc2ZlckZuLCBwcm9taXNlLCBhYm9ydEZuKSB7XG4gICAgICAgIHN1cGVyKGZpbGUsIHRyYW5zZmVyRm4sIHByb21pc2UsIGFib3J0Rm4pO1xuICAgIH1cbn1cblxuLyogdXBsb2FkIGZpbGUgdXNpbmcgZmlsZVRyYW5zZmVyICovXG5mdW5jdGlvbiB1cGxvYWRXaXRoRmlsZVRyYW5zZmVyKGZpbGUsIHVybCwgb3B0aW9ucykge31cblxuZnVuY3Rpb24gYXBwZW5kRmlsZVRvRm9ybURhdGEoZmlsZSwgZmQsIG9wdGlvbnMpIHtcbiAgICAvKiBhcHBlbmQgZmlsZSB0byBmb3JtIGRhdGEgKi9cbiAgICBpZiAoXy5pc0FycmF5KGZpbGUpKSB7XG4gICAgICAgIF8uZm9yRWFjaChmaWxlLCBmdW5jdGlvbiAoZmlsZU9iamVjdCkge1xuICAgICAgICAgICAgZmQuYXBwZW5kKG9wdGlvbnMucGFyYW1OYW1lLCBmaWxlT2JqZWN0LmNvbnRlbnQgfHwgZmlsZU9iamVjdCwgZmlsZU9iamVjdC5uYW1lKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KGZpbGUpKSB7XG4gICAgICAgIGZkLmFwcGVuZChvcHRpb25zLnBhcmFtTmFtZSwgZmlsZS5jb250ZW50IHx8IGZpbGUsIGZpbGUubmFtZSk7XG4gICAgfVxufVxuXG4vKiB1cGxvYWQgZmlsZSB3aXRoIGFqYXggY2FsbGluZyAqL1xuZnVuY3Rpb24gdXBsb2FkV2l0aEFqYXgoZmlsZSwgZmQsIHVybCwgb3B0aW9ucykge1xuICAgIGNvbnN0IGNsb25lRkQgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBjb25zdCBpdGVyYXRlID0gKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgY29uc3QgZmlsZU9iamVjdCA9IChfLmlzQXJyYXkodmFsdWUpID8gdmFsdWVbMF0gOiB2YWx1ZSk7XG4gICAgICAgIGlmICghKGZpbGVPYmplY3QgaW5zdGFuY2VvZiBGaWxlIHx8IGZpbGVPYmplY3QgaW5zdGFuY2VvZiBCbG9iKSkge1xuICAgICAgICAgICAgY2xvbmVGRC5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIC8vIFRoZSBmb3JlZWFjaCBtZXRob2Qgb24gZm9ybSBkYXRhIGRvZXNuJ3QgZXhpc3QgaW4gSUUuIEhlbmNlIHdlIGNoZWNrIGlmIGl0IGV4aXN0c1xuICAgIC8vIG9yIGVsc2UgdXNlIHRoZSBsb2Rhc2ggZm9yRWFjaFxuICAgIGlmIChmZC5mb3JFYWNoKSB7XG4gICAgICAgIGZkLmZvckVhY2goaXRlcmF0ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgXy5mb3JFYWNoKGZkLCBpdGVyYXRlKTtcbiAgICB9XG4gICAgYXBwZW5kRmlsZVRvRm9ybURhdGEoZmlsZSwgY2xvbmVGRCwgb3B0aW9ucyk7XG5cbiAgICBjb25zdCBwcm9taXNlID0gbmV3IE5vdGlmeVByb21pc2UoKHJlc29sdmUsIHJlamVjdCwgbm90aWZ5KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBodHRwU2VydmljZS51cGxvYWQodXJsLCBjbG9uZUZEKS5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IEhUVFBfRVZFTlRfVFlQRS5VcGxvYWRQcm9ncmVzcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVwbG9hZFByb2dyZXNzID0gTWF0aC5yb3VuZCgxMDAgKiBldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCk7XG4gICAgICAgICAgICAgICAgbm90aWZ5KHVwbG9hZFByb2dyZXNzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09IEhUVFBfRVZFTlRfVFlQRS5SZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoZXZlbnQuYm9keSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBmaWxlLl91cGxvYWRQcm9ncmVzcyA9IHJlcXVlc3Q7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbn1cblxuLyogdXBsb2FkIHRoZSBmaWxlIC0gSUU5IHN1cHBvcnQgKi9cbmZ1bmN0aW9uIHVwbG9hZFdpdGhJZnJhbWUoZmlsZSwgdXJsLCBvcHRpb25zKSB7fVxuXG4vKiB1cGxvYWQgdGhlIG5leHQgZmlsZSBkZXBlbmRpbmcgb24gdGhlIHN0YXR1cyAqL1xuZnVuY3Rpb24gc3Rhck5leHRGaWxlVHJhbnNmZXIoZnRzKSB7XG4gICAgY29uc3QgZnQgPSBfLmZpbmQoZnRzLCBmdW5jdGlvbiAoZikge1xuICAgICAgICByZXR1cm4gZi5zdGF0dXMgPT09IFVQTE9BRF9TVEFUVVMuUVVFVUVEO1xuICAgIH0pO1xuICAgIGlmIChmdCkge1xuICAgICAgICBmdC5zdGFydCgpO1xuICAgICAgICBmdC5maW5hbGx5KHN0YXJOZXh0RmlsZVRyYW5zZmVyLmJpbmQodW5kZWZpbmVkLCBmdHMpKTtcbiAgICB9XG59XG5cbi8qIHVwbG9hZCB0aGUgbWF4IG5vIG9mIGZpbGVzIGF0IG9uY2UgaS5lLiB0d28gYXQgb25jZSBiYXNlZCBvbiBtYXgqL1xuZnVuY3Rpb24gc3RhcnRGaWxlVHJhbnNmZXJzKGZ0cywgbWF4KSB7XG4gICAgbGV0IGkgPSAwO1xuICAgIGNvbnN0IGxlbiA9IGZ0cy5sZW5ndGg7XG4gICAgd2hpbGUgKGkgPCBtYXggJiYgaSA8IGxlbikge1xuICAgICAgICBzdGFyTmV4dEZpbGVUcmFuc2ZlcihmdHMpO1xuICAgICAgICBpKys7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBpc01vYmlsZUFwcCgpIHtcbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiB1cGxvYWRzIHRoZSBmaWxlIHRvIHRoZSBnaXZlbiB1cmwgZW5kcG9pbnQuXG4gKlxuICogQHBhcmFtIGZpbGUgZmlsZSB0byB1cGxvYWRcbiAqIEBwYXJhbSB1cmwgaHR0cCBlbmRwb2ludCB0byB3aGljaCB0aGUgZmlsZSBoYXMgdG8gYmUgc3VibWl0dGVkLlxuICogQHBhcmFtIG9wdGlvbnNcbiAqIEByZXR1cm5zIGEgcHJvbWlzZSB0byBsaXN0ZW4gZm9yIHN1Y2Nlc3MsIGV2ZW50LCBvblByb2dyZXNzLlxuICogIE9uZSBjYW4gYWxzbyBhYm9ydCB0aGUgdXBsb2FkIGJ5IHNpbXBseSBjYWxsaW5nIGFib3J0IGZ1bmN0aW9uLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdXBsb2FkKGZpbGVzLCBmZCwgY29uZmlnLCBvcHRpb25zPykge1xuICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7XG4gICAgICAgICdwYXJhbU5hbWUnIDogY29uZmlnLmZpbGVQYXJhbU5hbWVcbiAgICB9LCBvcHRpb25zKTtcbiAgICByZXR1cm4gdXBsb2FkV2l0aEFqYXgoZmlsZXMsIGZkLCBjb25maWcudXJsLCBvcHRpb25zKTtcbiAgICAvLyBsZXQgZmlsZVRyYW5zZmVycyA9IFtdLFxuICAgIC8vICAgICB1cmwgPSBjb25maWcudXBsb2FkVXJsO1xuICAgIC8vIG9wdGlvbnMgPSBfLmV4dGVuZCh7XG4gICAgLy8gICAgICdwYXJhbU5hbWUnIDogY29uZmlnLmZpbGVQYXJhbU5hbWVcbiAgICAvLyB9LCBvcHRpb25zKTtcbiAgICAvL1xuICAgIC8vIGlmIChpc01vYmlsZUFwcCgpKSB7XG4gICAgLy8gICAgIF8uZm9yRWFjaChmaWxlcywgZnVuY3Rpb24gKGZpbGUpIHtcbiAgICAvLyAgICAgICAgIGZpbGVUcmFuc2ZlcnMucHVzaCh1cGxvYWRXaXRoRmlsZVRyYW5zZmVyKGZpbGUsIHVybCwgb3B0aW9ucykpO1xuICAgIC8vICAgICB9KTtcbiAgICAvLyB9IGVsc2UgaWYgKCh3aW5kb3cgYXMgYW55KS5Gb3JtRGF0YSkge1xuICAgIC8vICAgICBfLmZvckVhY2goZmlsZXMsIGZ1bmN0aW9uIChmaWxlKSB7XG4gICAgLy8gICAgICAgICBmaWxlVHJhbnNmZXJzLnB1c2godXBsb2FkV2l0aEFqYXgoZmlsZSwgdXJsLCBvcHRpb25zKSk7XG4gICAgLy8gICAgIH0pO1xuICAgIC8vIH0gZWxzZSB7XG4gICAgLy8gICAgIF8uZm9yRWFjaChmaWxlcywgZnVuY3Rpb24gKGZpbGUpIHtcbiAgICAvLyAgICAgICAgIGZpbGVUcmFuc2ZlcnMucHVzaCh1cGxvYWRXaXRoSWZyYW1lKGZpbGUsIHVybCwgb3B0aW9ucykpO1xuICAgIC8vICAgICB9KTtcbiAgICAvLyB9XG4gICAgLy8gc3RhcnRGaWxlVHJhbnNmZXJzKGZpbGVUcmFuc2ZlcnMsIDIpO1xuICAgIC8vIHJldHVybiBmaWxlVHJhbnNmZXJzO1xufVxuIl19