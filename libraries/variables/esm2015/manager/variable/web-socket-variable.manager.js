import { $WebSocket } from 'angular2-websocket/angular2-websocket';
import { getValidJSON, isDefined, isInsecureContentRequest, isObject, triggerFn, xmlToJson } from '@wm/core';
import { BaseVariableManager } from './base-variable.manager';
import { initiateCallback, metadataService } from '../../util/variable/variables.utils';
import { CONSTANTS, VARIABLE_CONSTANTS } from '../../constants/variables.constants';
import { ServiceVariableUtils } from '../../util/variable/service-variable.utils';
export class WebSocketVariableManager extends BaseVariableManager {
    constructor() {
        super(...arguments);
        this.scope_var_socket_map = new Map();
        this.PROPERTY = {
            'SERVICE': 'service',
            'DATA_UPDATE_STRATEGY': 'dataUpdateStrategy',
            'DATA_LIMIT': 'dataLimit'
        };
        this.DATA_UPDATE_STRATEGY = {
            'REFRESH': 'refresh',
            'PREPEND': 'prepend',
            'APPEND': 'append'
        };
    }
    /**
     * returns the state of property to decide weather to append new messages to dataSet or not
     * @param variable
     * @returns boolean
     */
    shouldAppendData(variable) {
        variable = variable || this;
        return variable[this.PROPERTY.DATA_UPDATE_STRATEGY] !== this.DATA_UPDATE_STRATEGY.REFRESH;
    }
    /**
     * returns the state of property to decide weather to APPEND or PREPEND new messages to dataSet
     * @param variable
     * @returns boolean
     */
    shouldAppendLast(variable) {
        return variable[this.PROPERTY.DATA_UPDATE_STRATEGY] === this.DATA_UPDATE_STRATEGY.APPEND;
    }
    /**
     * returns upper limit on number of records to be in dataSet
     * this is applicable only when appendData is true
     * @param variable
     * @returns {dataLimit}
     */
    getDataLimit(variable) {
        return variable.dataLimit;
    }
    /**
     * get url from wmServiceOperationInfo
     * @param variable
     * @returns {*}
     */
    getURL(variable) {
        const prefabName = variable.getPrefabName();
        const opInfo = prefabName ? _.get(metadataService.getByOperationId(variable.operationId, prefabName), 'wmServiceOperationInfo') : _.get(metadataService.getByOperationId(variable.operationId), 'wmServiceOperationInfo');
        const inputFields = variable.dataBinding;
        let config;
        // add sample values to the params (url and path)
        _.forEach(opInfo.parameters, function (param) {
            param.sampleValue = inputFields[param.name];
        });
        // although, no header params will be present, keeping 'skipCloakHeaders' flag if support provided later
        $.extend(opInfo, {
            skipCloakHeaders: true
        });
        // call common method to prepare config for the service operation info.
        config = ServiceVariableUtils.constructRequestParams(variable, opInfo, inputFields);
        /* if error found, return */
        if (config.error && config.error.message) {
            this._onSocketError(variable, { data: config.error.message });
            return;
        }
        return config.url;
    }
    /**
     * handler for onMessage event on a socket connection for a variable
     * the data returned is converted to JSON from string/xml and assigned to dataSet of variable
     * If not able to do so, message is simply assigned to the dataSet of variable
     * If appendData property is set, the message is appended to the dataSet, else it replaces the existing value of dataSet
     * @param variable
     * @param evt
     * @private
     */
    _onSocketMessage(variable, evt) {
        let data = _.get(evt, 'data'), value, dataLength, dataLimit, shouldAddToLast, insertIdx;
        data = getValidJSON(data) || xmlToJson(data) || data;
        // EVENT: ON_MESSAGE
        value = initiateCallback(VARIABLE_CONSTANTS.EVENT.MESSAGE_RECEIVE, variable, data, evt);
        data = isDefined(value) ? value : data;
        if (this.shouldAppendData(variable)) {
            variable.dataSet = variable.dataSet || [];
            dataLength = variable.dataSet.length;
            dataLimit = this.getDataLimit(variable);
            shouldAddToLast = this.shouldAppendLast(variable);
            if (dataLimit && (dataLength >= dataLimit)) {
                if (shouldAddToLast) {
                    variable.dataSet.shift();
                }
                else {
                    variable.dataSet.pop();
                }
            }
            insertIdx = shouldAddToLast ? dataLength : 0;
            variable.dataSet.splice(insertIdx, 0, data);
        }
        else {
            variable.dataSet = isDefined(value) ? value : data;
        }
    }
    /**
     * calls the ON_BEFORE_SEND callback on the variable
     * @param variable
     * @param message
     * @returns {*}
     * @private
     */
    _onBeforeSend(variable, message) {
        // EVENT: ON_BEFORE_SEND
        return initiateCallback(VARIABLE_CONSTANTS.EVENT.BEFORE_SEND, variable, message);
    }
    /**
     * calls the ON_BEFORE_CLOSE callback assigned to the variable
     * @param variable
     * @param evt
     * @returns {*}
     * @private
     */
    _onBeforeSocketClose(variable, evt) {
        // EVENT: ON_BEFORE_CLOSE
        return initiateCallback(VARIABLE_CONSTANTS.EVENT.BEFORE_CLOSE, variable, _.get(evt, 'data'), evt);
    }
    /**
     * calls the ON_BEFORE_OPEN callback assigned
     * called just before the connection is open
     * @param variable
     * @param evt
     * @returns {*}
     * @private
     */
    _onBeforeSocketOpen(variable, evt) {
        // EVENT: ON_BEFORE_OPEN
        return initiateCallback(VARIABLE_CONSTANTS.EVENT.BEFORE_OPEN, variable, _.get(evt, 'data'), evt);
    }
    /**
     * calls the ON_OPEN event on the variable
     * this is called once the connection is established by the variable with the target WebSocket service
     * @param variable
     * @param evt
     * @private
     */
    _onSocketOpen(variable, evt) {
        variable._socketConnected = true;
        // EVENT: ON_OPEN
        initiateCallback(VARIABLE_CONSTANTS.EVENT.OPEN, variable, _.get(evt, 'data'), evt);
    }
    /**
     * clears the socket variable against the variable in a scope
     * @param variable
     */
    freeSocket(variable) {
        this.scope_var_socket_map.set(variable, undefined);
    }
    /**
     * calls the ON_CLOSE event on the variable
     * this is called on close of an existing connection on a variable
     * @param variable
     * @param evt
     * @private
     */
    _onSocketClose(variable, evt) {
        variable._socketConnected = false;
        this.freeSocket(variable);
        // EVENT: ON_CLOSE
        initiateCallback(VARIABLE_CONSTANTS.EVENT.CLOSE, variable, _.get(evt, 'data'), evt);
    }
    /**
     * calls the ON_ERROR event on the variable
     * this is called if an error occurs while connecting to the socket service
     * @param variable
     * @param evt
     * @private
     */
    _onSocketError(variable, evt) {
        variable._socketConnected = false;
        this.freeSocket(variable);
        // EVENT: ON_ERROR
        initiateCallback(VARIABLE_CONSTANTS.EVENT.ERROR, variable, _.get(evt, 'data') || 'Error while connecting with ' + variable.service, evt);
    }
    /**
     * returns an existing socket connection on the variable
     * if not present, make the connection and return it
     * @param variable
     * @returns {*}
     */
    getSocket(variable) {
        const url = this.getURL(variable);
        let _socket = this.scope_var_socket_map.get(variable);
        if (_socket) {
            return _socket;
        }
        // Trigger error if unsecured webSocket is used in secured domain, ignore in mobile device
        if (!CONSTANTS.hasCordova && isInsecureContentRequest(url)) {
            triggerFn(this._onSocketError.bind(this, variable));
            return;
        }
        _socket = new $WebSocket(url);
        _socket.onOpen(this._onSocketOpen.bind(this, variable));
        _socket.onError(this._onSocketError.bind(this, variable));
        _socket.onMessage(this._onSocketMessage.bind(this, variable));
        _socket.onClose(this._onSocketClose.bind(this, variable));
        this.scope_var_socket_map.set(variable, _socket);
        variable._socket = _socket;
        return _socket;
    }
    /**
     * opens a socket connection on the variable.
     * URL & other meta data is fetched from wmServiceOperationInfo
     * @returns {*}
     */
    open(variable, success, error) {
        const shouldOpen = this._onBeforeSocketOpen(variable);
        let socket;
        if (shouldOpen === false) {
            triggerFn(error);
            return;
        }
        socket = this.getSocket(variable);
        triggerFn(success);
        return socket;
    }
    /**
     * closes an existing socket connection on variable
     */
    close(variable) {
        const shouldClose = this._onBeforeSocketClose(variable), socket = this.getSocket(variable);
        if (shouldClose === false) {
            return;
        }
        socket.close();
    }
    /**
     * sends a message to the existing socket connection on the variable
     * If socket connection not open yet, open a connections and then send
     * if message provide, it is sent, else the one present in RequestBody param is sent
     * @param message
     */
    send(variable, message) {
        const socket = this.getSocket(variable);
        let response;
        message = message || _.get(variable, 'dataBinding.RequestBody');
        response = this._onBeforeSend(variable, message);
        if (response === false) {
            return;
        }
        message = isDefined(response) ? response : message;
        message = isObject(message) ? JSON.stringify(message) : message;
        socket.send(message, 0);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViLXNvY2tldC12YXJpYWJsZS5tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL3ZhcmlhYmxlcy8iLCJzb3VyY2VzIjpbIm1hbmFnZXIvdmFyaWFibGUvd2ViLXNvY2tldC12YXJpYWJsZS5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUVuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSx3QkFBd0IsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUU3RyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDeEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBSWxGLE1BQU0sT0FBTyx3QkFBeUIsU0FBUSxtQkFBbUI7SUFBakU7O1FBRUkseUJBQW9CLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNqQyxhQUFRLEdBQUc7WUFDUCxTQUFTLEVBQUUsU0FBUztZQUNwQixzQkFBc0IsRUFBRSxvQkFBb0I7WUFDNUMsWUFBWSxFQUFFLFdBQVc7U0FDNUIsQ0FBQztRQUNGLHlCQUFvQixHQUFHO1lBQ25CLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxRQUFRO1NBQ3JCLENBQUM7SUFrUU4sQ0FBQztJQWhRRzs7OztPQUlHO0lBQ0ssZ0JBQWdCLENBQUMsUUFBUTtRQUM3QixRQUFRLEdBQUcsUUFBUSxJQUFJLElBQUksQ0FBQztRQUM1QixPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFv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Q0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2pELElBQUksUUFBUSxLQUFLLEtBQUssRUFBRTtZQUNwQixPQUFPO1NBQ1Y7UUFDRCxPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNuRCxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDaEUsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDNUIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgJFdlYlNvY2tldCB9IGZyb20gJ2FuZ3VsYXIyLXdlYnNvY2tldC9hbmd1bGFyMi13ZWJzb2NrZXQnO1xuXG5pbXBvcnQgeyBnZXRWYWxpZEpTT04sIGlzRGVmaW5lZCwgaXNJbnNlY3VyZUNvbnRlbnRSZXF1ZXN0LCBpc09iamVjdCwgdHJpZ2dlckZuLCB4bWxUb0pzb24gfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IEJhc2VWYXJpYWJsZU1hbmFnZXIgfSBmcm9tICcuL2Jhc2UtdmFyaWFibGUubWFuYWdlcic7XG5pbXBvcnQgeyBXZWJTb2NrZXRWYXJpYWJsZSB9IGZyb20gJy4uLy4uL21vZGVsL3ZhcmlhYmxlL3dlYi1zb2NrZXQtdmFyaWFibGUnO1xuaW1wb3J0IHsgaW5pdGlhdGVDYWxsYmFjaywgbWV0YWRhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vdXRpbC92YXJpYWJsZS92YXJpYWJsZXMudXRpbHMnO1xuaW1wb3J0IHsgQ09OU1RBTlRTLCBWQVJJQUJMRV9DT05TVEFOVFMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMvdmFyaWFibGVzLmNvbnN0YW50cyc7XG5pbXBvcnQgeyBTZXJ2aWNlVmFyaWFibGVVdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvdmFyaWFibGUvc2VydmljZS12YXJpYWJsZS51dGlscyc7XG5cbmRlY2xhcmUgY29uc3QgXztcblxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFZhcmlhYmxlTWFuYWdlciBleHRlbmRzIEJhc2VWYXJpYWJsZU1hbmFnZXIge1xuXG4gICAgc2NvcGVfdmFyX3NvY2tldF9tYXAgPSBuZXcgTWFwKCk7XG4gICAgUFJPUEVSVFkgPSB7XG4gICAgICAgICdTRVJWSUNFJzogJ3NlcnZpY2UnLFxuICAgICAgICAnREFUQV9VUERBVEVfU1RSQVRFR1knOiAnZGF0YVVwZGF0ZVN0cmF0ZWd5JyxcbiAgICAgICAgJ0RBVEFfTElNSVQnOiAnZGF0YUxpbWl0J1xuICAgIH07XG4gICAgREFUQV9VUERBVEVfU1RSQVRFR1kgPSB7XG4gICAgICAgICdSRUZSRVNIJzogJ3JlZnJlc2gnLFxuICAgICAgICAnUFJFUEVORCc6ICdwcmVwZW5kJyxcbiAgICAgICAgJ0FQUEVORCc6ICdhcHBlbmQnXG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIHJldHVybnMgdGhlIHN0YXRlIG9mIHByb3BlcnR5IHRvIGRlY2lkZSB3ZWF0aGVyIHRvIGFwcGVuZCBuZXcgbWVzc2FnZXMgdG8gZGF0YVNldCBvciBub3RcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcmV0dXJucyBib29sZWFuXG4gICAgICovXG4gICAgcHJpdmF0ZSBzaG91bGRBcHBlbmREYXRhKHZhcmlhYmxlKSB7XG4gICAgICAgIHZhcmlhYmxlID0gdmFyaWFibGUgfHwgdGhpcztcbiAgICAgICAgcmV0dXJuIHZhcmlhYmxlW3RoaXMuUFJPUEVSVFkuREFUQV9VUERBVEVfU1RSQVRFR1ldICE9PSB0aGlzLkRBVEFfVVBEQVRFX1NUUkFURUdZLlJFRlJFU0g7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmV0dXJucyB0aGUgc3RhdGUgb2YgcHJvcGVydHkgdG8gZGVjaWRlIHdlYXRoZXIgdG8gQVBQRU5EIG9yIFBSRVBFTkQgbmV3IG1lc3NhZ2VzIHRvIGRhdGFTZXRcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcmV0dXJucyBib29sZWFuXG4gICAgICovXG4gICAgcHJpdmF0ZSBzaG91bGRBcHBlbmRMYXN0KHZhcmlhYmxlKSB7XG4gICAgICAgIHJldHVybiB2YXJpYWJsZVt0aGlzLlBST1BFUlRZLkRBVEFfVVBEQVRFX1NUUkFURUdZXSA9PT0gdGhpcy5EQVRBX1VQREFURV9TVFJBVEVHWS5BUFBFTkQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmV0dXJucyB1cHBlciBsaW1pdCBvbiBudW1iZXIgb2YgcmVjb3JkcyB0byBiZSBpbiBkYXRhU2V0XG4gICAgICogdGhpcyBpcyBhcHBsaWNhYmxlIG9ubHkgd2hlbiBhcHBlbmREYXRhIGlzIHRydWVcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcmV0dXJucyB7ZGF0YUxpbWl0fVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0RGF0YUxpbWl0KHZhcmlhYmxlKSB7XG4gICAgICAgIHJldHVybiB2YXJpYWJsZS5kYXRhTGltaXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogZ2V0IHVybCBmcm9tIHdtU2VydmljZU9wZXJhdGlvbkluZm9cbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcmV0dXJucyB7Kn1cbiAgICAgKi9cbiAgICBwcml2YXRlIGdldFVSTCh2YXJpYWJsZSkge1xuICAgICAgICBjb25zdCBwcmVmYWJOYW1lID0gdmFyaWFibGUuZ2V0UHJlZmFiTmFtZSgpO1xuICAgICAgICBjb25zdCBvcEluZm8gPSBwcmVmYWJOYW1lID8gXy5nZXQobWV0YWRhdGFTZXJ2aWNlLmdldEJ5T3BlcmF0aW9uSWQodmFyaWFibGUub3BlcmF0aW9uSWQsIHByZWZhYk5hbWUpLCAnd21TZXJ2aWNlT3BlcmF0aW9uSW5mbycpIDogXy5nZXQobWV0YWRhdGFTZXJ2aWNlLmdldEJ5T3BlcmF0aW9uSWQodmFyaWFibGUub3BlcmF0aW9uSWQpLCAnd21TZXJ2aWNlT3BlcmF0aW9uSW5mbycpO1xuICAgICAgICBjb25zdCBpbnB1dEZpZWxkcyA9IHZhcmlhYmxlLmRhdGFCaW5kaW5nO1xuICAgICAgICBsZXQgY29uZmlnO1xuXG4gICAgICAgIC8vIGFkZCBzYW1wbGUgdmFsdWVzIHRvIHRoZSBwYXJhbXMgKHVybCBhbmQgcGF0aClcbiAgICAgICAgXy5mb3JFYWNoKG9wSW5mby5wYXJhbWV0ZXJzLCBmdW5jdGlvbiAocGFyYW0pIHtcbiAgICAgICAgICAgIHBhcmFtLnNhbXBsZVZhbHVlID0gaW5wdXRGaWVsZHNbcGFyYW0ubmFtZV07XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBhbHRob3VnaCwgbm8gaGVhZGVyIHBhcmFtcyB3aWxsIGJlIHByZXNlbnQsIGtlZXBpbmcgJ3NraXBDbG9ha0hlYWRlcnMnIGZsYWcgaWYgc3VwcG9ydCBwcm92aWRlZCBsYXRlclxuICAgICAgICAkLmV4dGVuZChvcEluZm8sIHtcbiAgICAgICAgICAgIHNraXBDbG9ha0hlYWRlcnM6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gY2FsbCBjb21tb24gbWV0aG9kIHRvIHByZXBhcmUgY29uZmlnIGZvciB0aGUgc2VydmljZSBvcGVyYXRpb24gaW5mby5cbiAgICAgICAgY29uZmlnID0gU2VydmljZVZhcmlhYmxlVXRpbHMuY29uc3RydWN0UmVxdWVzdFBhcmFtcyh2YXJpYWJsZSwgb3BJbmZvLCBpbnB1dEZpZWxkcyk7XG4gICAgICAgIC8qIGlmIGVycm9yIGZvdW5kLCByZXR1cm4gKi9cbiAgICAgICAgaWYgKGNvbmZpZy5lcnJvciAmJiBjb25maWcuZXJyb3IubWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpcy5fb25Tb2NrZXRFcnJvcih2YXJpYWJsZSwge2RhdGE6IGNvbmZpZy5lcnJvci5tZXNzYWdlfSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbmZpZy51cmw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogaGFuZGxlciBmb3Igb25NZXNzYWdlIGV2ZW50IG9uIGEgc29ja2V0IGNvbm5lY3Rpb24gZm9yIGEgdmFyaWFibGVcbiAgICAgKiB0aGUgZGF0YSByZXR1cm5lZCBpcyBjb252ZXJ0ZWQgdG8gSlNPTiBmcm9tIHN0cmluZy94bWwgYW5kIGFzc2lnbmVkIHRvIGRhdGFTZXQgb2YgdmFyaWFibGVcbiAgICAgKiBJZiBub3QgYWJsZSB0byBkbyBzbywgbWVzc2FnZSBpcyBzaW1wbHkgYXNzaWduZWQgdG8gdGhlIGRhdGFTZXQgb2YgdmFyaWFibGVcbiAgICAgKiBJZiBhcHBlbmREYXRhIHByb3BlcnR5IGlzIHNldCwgdGhlIG1lc3NhZ2UgaXMgYXBwZW5kZWQgdG8gdGhlIGRhdGFTZXQsIGVsc2UgaXQgcmVwbGFjZXMgdGhlIGV4aXN0aW5nIHZhbHVlIG9mIGRhdGFTZXRcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcGFyYW0gZXZ0XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9vblNvY2tldE1lc3NhZ2UodmFyaWFibGUsIGV2dCkge1xuICAgICAgICBsZXQgZGF0YSA9IF8uZ2V0KGV2dCwgJ2RhdGEnKSwgdmFsdWUsIGRhdGFMZW5ndGgsIGRhdGFMaW1pdCwgc2hvdWxkQWRkVG9MYXN0LCBpbnNlcnRJZHg7XG4gICAgICAgIGRhdGEgPSBnZXRWYWxpZEpTT04oZGF0YSkgfHwgeG1sVG9Kc29uKGRhdGEpIHx8IGRhdGE7XG4gICAgICAgIC8vIEVWRU5UOiBPTl9NRVNTQUdFXG4gICAgICAgIHZhbHVlID0gaW5pdGlhdGVDYWxsYmFjayhWQVJJQUJMRV9DT05TVEFOVFMuRVZFTlQuTUVTU0FHRV9SRUNFSVZFLCB2YXJpYWJsZSwgZGF0YSwgZXZ0KTtcbiAgICAgICAgZGF0YSA9IGlzRGVmaW5lZCh2YWx1ZSkgPyB2YWx1ZSA6IGRhdGE7XG4gICAgICAgIGlmICh0aGlzLnNob3VsZEFwcGVuZERhdGEodmFyaWFibGUpKSB7XG4gICAgICAgICAgICB2YXJpYWJsZS5kYXRhU2V0ID0gdmFyaWFibGUuZGF0YVNldCB8fCBbXTtcbiAgICAgICAgICAgIGRhdGFMZW5ndGggPSB2YXJpYWJsZS5kYXRhU2V0Lmxlbmd0aDtcbiAgICAgICAgICAgIGRhdGFMaW1pdCA9IHRoaXMuZ2V0RGF0YUxpbWl0KHZhcmlhYmxlKTtcbiAgICAgICAgICAgIHNob3VsZEFkZFRvTGFzdCA9IHRoaXMuc2hvdWxkQXBwZW5kTGFzdCh2YXJpYWJsZSk7XG4gICAgICAgICAgICBpZiAoZGF0YUxpbWl0ICYmIChkYXRhTGVuZ3RoID49IGRhdGFMaW1pdCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkQWRkVG9MYXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlLmRhdGFTZXQuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZS5kYXRhU2V0LnBvcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc2VydElkeCA9IHNob3VsZEFkZFRvTGFzdCA/IGRhdGFMZW5ndGggOiAwO1xuICAgICAgICAgICAgdmFyaWFibGUuZGF0YVNldC5zcGxpY2UoaW5zZXJ0SWR4LCAwLCBkYXRhKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhcmlhYmxlLmRhdGFTZXQgPSBpc0RlZmluZWQodmFsdWUpID8gdmFsdWUgOiBkYXRhO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2FsbHMgdGhlIE9OX0JFRk9SRV9TRU5EIGNhbGxiYWNrIG9uIHRoZSB2YXJpYWJsZVxuICAgICAqIEBwYXJhbSB2YXJpYWJsZVxuICAgICAqIEBwYXJhbSBtZXNzYWdlXG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9vbkJlZm9yZVNlbmQodmFyaWFibGUsIG1lc3NhZ2UpIHtcbiAgICAgICAgLy8gRVZFTlQ6IE9OX0JFRk9SRV9TRU5EXG4gICAgICAgIHJldHVybiBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5CRUZPUkVfU0VORCwgdmFyaWFibGUsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGNhbGxzIHRoZSBPTl9CRUZPUkVfQ0xPU0UgY2FsbGJhY2sgYXNzaWduZWQgdG8gdGhlIHZhcmlhYmxlXG4gICAgICogQHBhcmFtIHZhcmlhYmxlXG4gICAgICogQHBhcmFtIGV2dFxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBfb25CZWZvcmVTb2NrZXRDbG9zZSh2YXJpYWJsZSwgZXZ0Pykge1xuICAgICAgICAvLyBFVkVOVDogT05fQkVGT1JFX0NMT1NFXG4gICAgICAgIHJldHVybiBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5CRUZPUkVfQ0xPU0UsIHZhcmlhYmxlLCBfLmdldChldnQsICdkYXRhJyksIGV2dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2FsbHMgdGhlIE9OX0JFRk9SRV9PUEVOIGNhbGxiYWNrIGFzc2lnbmVkXG4gICAgICogY2FsbGVkIGp1c3QgYmVmb3JlIHRoZSBjb25uZWN0aW9uIGlzIG9wZW5cbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcGFyYW0gZXZ0XG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9vbkJlZm9yZVNvY2tldE9wZW4odmFyaWFibGUsIGV2dD8pIHtcbiAgICAgICAgLy8gRVZFTlQ6IE9OX0JFRk9SRV9PUEVOXG4gICAgICAgIHJldHVybiBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5CRUZPUkVfT1BFTiwgdmFyaWFibGUsIF8uZ2V0KGV2dCwgJ2RhdGEnKSwgZXZ0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBjYWxscyB0aGUgT05fT1BFTiBldmVudCBvbiB0aGUgdmFyaWFibGVcbiAgICAgKiB0aGlzIGlzIGNhbGxlZCBvbmNlIHRoZSBjb25uZWN0aW9uIGlzIGVzdGFibGlzaGVkIGJ5IHRoZSB2YXJpYWJsZSB3aXRoIHRoZSB0YXJnZXQgV2ViU29ja2V0IHNlcnZpY2VcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcGFyYW0gZXZ0XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9vblNvY2tldE9wZW4odmFyaWFibGUsIGV2dCkge1xuICAgICAgICB2YXJpYWJsZS5fc29ja2V0Q29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgLy8gRVZFTlQ6IE9OX09QRU5cbiAgICAgICAgaW5pdGlhdGVDYWxsYmFjayhWQVJJQUJMRV9DT05TVEFOVFMuRVZFTlQuT1BFTiwgdmFyaWFibGUsIF8uZ2V0KGV2dCwgJ2RhdGEnKSwgZXZ0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBjbGVhcnMgdGhlIHNvY2tldCB2YXJpYWJsZSBhZ2FpbnN0IHRoZSB2YXJpYWJsZSBpbiBhIHNjb3BlXG4gICAgICogQHBhcmFtIHZhcmlhYmxlXG4gICAgICovXG4gICAgcHJpdmF0ZSBmcmVlU29ja2V0KHZhcmlhYmxlKSB7XG4gICAgICAgIHRoaXMuc2NvcGVfdmFyX3NvY2tldF9tYXAuc2V0KHZhcmlhYmxlLCB1bmRlZmluZWQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGNhbGxzIHRoZSBPTl9DTE9TRSBldmVudCBvbiB0aGUgdmFyaWFibGVcbiAgICAgKiB0aGlzIGlzIGNhbGxlZCBvbiBjbG9zZSBvZiBhbiBleGlzdGluZyBjb25uZWN0aW9uIG9uIGEgdmFyaWFibGVcbiAgICAgKiBAcGFyYW0gdmFyaWFibGVcbiAgICAgKiBAcGFyYW0gZXZ0XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9vblNvY2tldENsb3NlKHZhcmlhYmxlLCBldnQpIHtcbiAgICAgICAgdmFyaWFibGUuX3NvY2tldENvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmZyZWVTb2NrZXQodmFyaWFibGUpO1xuICAgICAgICAvLyBFVkVOVDogT05fQ0xPU0VcbiAgICAgICAgaW5pdGlhdGVDYWxsYmFjayhWQVJJQUJMRV9DT05TVEFOVFMuRVZFTlQuQ0xPU0UsIHZhcmlhYmxlLCBfLmdldChldnQsICdkYXRhJyksIGV2dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogY2FsbHMgdGhlIE9OX0VSUk9SIGV2ZW50IG9uIHRoZSB2YXJpYWJsZVxuICAgICAqIHRoaXMgaXMgY2FsbGVkIGlmIGFuIGVycm9yIG9jY3VycyB3aGlsZSBjb25uZWN0aW5nIHRvIHRoZSBzb2NrZXQgc2VydmljZVxuICAgICAqIEBwYXJhbSB2YXJpYWJsZVxuICAgICAqIEBwYXJhbSBldnRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgX29uU29ja2V0RXJyb3IodmFyaWFibGUsIGV2dCkge1xuICAgICAgICB2YXJpYWJsZS5fc29ja2V0Q29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZnJlZVNvY2tldCh2YXJpYWJsZSk7XG4gICAgICAgIC8vIEVWRU5UOiBPTl9FUlJPUlxuICAgICAgICBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5FUlJPUiwgdmFyaWFibGUsIF8uZ2V0KGV2dCwgJ2RhdGEnKSB8fCAnRXJyb3Igd2hpbGUgY29ubmVjdGluZyB3aXRoICcgKyB2YXJpYWJsZS5zZXJ2aWNlLCBldnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHJldHVybnMgYW4gZXhpc3Rpbmcgc29ja2V0IGNvbm5lY3Rpb24gb24gdGhlIHZhcmlhYmxlXG4gICAgICogaWYgbm90IHByZXNlbnQsIG1ha2UgdGhlIGNvbm5lY3Rpb24gYW5kIHJldHVybiBpdFxuICAgICAqIEBwYXJhbSB2YXJpYWJsZVxuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0U29ja2V0KHZhcmlhYmxlKSB7XG4gICAgICAgIGNvbnN0IHVybCAgICAgPSB0aGlzLmdldFVSTCh2YXJpYWJsZSk7XG4gICAgICAgIGxldCBfc29ja2V0ID0gdGhpcy5zY29wZV92YXJfc29ja2V0X21hcC5nZXQodmFyaWFibGUpO1xuICAgICAgICBpZiAoX3NvY2tldCkge1xuICAgICAgICAgICAgcmV0dXJuIF9zb2NrZXQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUcmlnZ2VyIGVycm9yIGlmIHVuc2VjdXJlZCB3ZWJTb2NrZXQgaXMgdXNlZCBpbiBzZWN1cmVkIGRvbWFpbiwgaWdub3JlIGluIG1vYmlsZSBkZXZpY2VcbiAgICAgICAgaWYgKCFDT05TVEFOVFMuaGFzQ29yZG92YSAmJiBpc0luc2VjdXJlQ29udGVudFJlcXVlc3QodXJsKSkge1xuICAgICAgICAgICAgdHJpZ2dlckZuKHRoaXMuX29uU29ja2V0RXJyb3IuYmluZCh0aGlzLCB2YXJpYWJsZSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIF9zb2NrZXQgPSBuZXcgJFdlYlNvY2tldCh1cmwpO1xuICAgICAgICBfc29ja2V0Lm9uT3Blbih0aGlzLl9vblNvY2tldE9wZW4uYmluZCh0aGlzLCB2YXJpYWJsZSkpO1xuICAgICAgICBfc29ja2V0Lm9uRXJyb3IodGhpcy5fb25Tb2NrZXRFcnJvci5iaW5kKHRoaXMsIHZhcmlhYmxlKSk7XG4gICAgICAgIF9zb2NrZXQub25NZXNzYWdlKHRoaXMuX29uU29ja2V0TWVzc2FnZS5iaW5kKHRoaXMsIHZhcmlhYmxlKSk7XG4gICAgICAgIF9zb2NrZXQub25DbG9zZSh0aGlzLl9vblNvY2tldENsb3NlLmJpbmQodGhpcywgdmFyaWFibGUpKTtcblxuICAgICAgICB0aGlzLnNjb3BlX3Zhcl9zb2NrZXRfbWFwLnNldCh2YXJpYWJsZSwgX3NvY2tldCk7XG4gICAgICAgIHZhcmlhYmxlLl9zb2NrZXQgPSBfc29ja2V0O1xuICAgICAgICByZXR1cm4gX3NvY2tldDtcbn1cblxuICAgIC8qKlxuICAgICAqIG9wZW5zIGEgc29ja2V0IGNvbm5lY3Rpb24gb24gdGhlIHZhcmlhYmxlLlxuICAgICAqIFVSTCAmIG90aGVyIG1ldGEgZGF0YSBpcyBmZXRjaGVkIGZyb20gd21TZXJ2aWNlT3BlcmF0aW9uSW5mb1xuICAgICAqIEByZXR1cm5zIHsqfVxuICAgICAqL1xuICAgIHB1YmxpYyBvcGVuKHZhcmlhYmxlOiBXZWJTb2NrZXRWYXJpYWJsZSwgc3VjY2Vzcz8sIGVycm9yPykge1xuICAgICAgICBjb25zdCBzaG91bGRPcGVuID0gdGhpcy5fb25CZWZvcmVTb2NrZXRPcGVuKHZhcmlhYmxlKTtcbiAgICAgICAgbGV0IHNvY2tldDtcbiAgICAgICAgaWYgKHNob3VsZE9wZW4gPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB0cmlnZ2VyRm4oZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHNvY2tldCA9IHRoaXMuZ2V0U29ja2V0KHZhcmlhYmxlKTtcbiAgICAgICAgdHJpZ2dlckZuKHN1Y2Nlc3MpO1xuICAgICAgICByZXR1cm4gc29ja2V0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGNsb3NlcyBhbiBleGlzdGluZyBzb2NrZXQgY29ubmVjdGlvbiBvbiB2YXJpYWJsZVxuICAgICAqL1xuICAgIHB1YmxpYyBjbG9zZSh2YXJpYWJsZTogV2ViU29ja2V0VmFyaWFibGUpIHtcbiAgICAgICAgY29uc3Qgc2hvdWxkQ2xvc2UgPSB0aGlzLl9vbkJlZm9yZVNvY2tldENsb3NlKHZhcmlhYmxlKSxcbiAgICAgICAgICAgIHNvY2tldCAgICAgID0gdGhpcy5nZXRTb2NrZXQodmFyaWFibGUpO1xuICAgICAgICBpZiAoc2hvdWxkQ2xvc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgc29ja2V0LmNsb3NlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogc2VuZHMgYSBtZXNzYWdlIHRvIHRoZSBleGlzdGluZyBzb2NrZXQgY29ubmVjdGlvbiBvbiB0aGUgdmFyaWFibGVcbiAgICAgKiBJZiBzb2NrZXQgY29ubmVjdGlvbiBub3Qgb3BlbiB5ZXQsIG9wZW4gYSBjb25uZWN0aW9ucyBhbmQgdGhlbiBzZW5kXG4gICAgICogaWYgbWVzc2FnZSBwcm92aWRlLCBpdCBpcyBzZW50LCBlbHNlIHRoZSBvbmUgcHJlc2VudCBpbiBSZXF1ZXN0Qm9keSBwYXJhbSBpcyBzZW50XG4gICAgICogQHBhcmFtIG1lc3NhZ2VcbiAgICAgKi9cbiAgICBwdWJsaWMgc2VuZCh2YXJpYWJsZTogV2ViU29ja2V0VmFyaWFibGUsIG1lc3NhZ2U/OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3Qgc29ja2V0ICAgICAgPSB0aGlzLmdldFNvY2tldCh2YXJpYWJsZSk7XG4gICAgICAgIGxldCByZXNwb25zZTtcblxuICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSB8fCBfLmdldCh2YXJpYWJsZSwgJ2RhdGFCaW5kaW5nLlJlcXVlc3RCb2R5Jyk7XG4gICAgICAgIHJlc3BvbnNlID0gdGhpcy5fb25CZWZvcmVTZW5kKHZhcmlhYmxlLCBtZXNzYWdlKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSBmYWxzZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIG1lc3NhZ2UgPSBpc0RlZmluZWQocmVzcG9uc2UpID8gcmVzcG9uc2UgOiBtZXNzYWdlO1xuICAgICAgICBtZXNzYWdlID0gaXNPYmplY3QobWVzc2FnZSkgPyBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSA6IG1lc3NhZ2U7XG4gICAgICAgIHNvY2tldC5zZW5kKG1lc3NhZ2UsIDApO1xuICAgIH1cbn1cbiJdfQ==