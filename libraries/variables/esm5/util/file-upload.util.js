import * as tslib_1 from "tslib";
import { triggerFn } from '@wm/core';
import { NotifyPromise } from './notify-promise';
import { httpService } from './variable/variables.utils';
var HTTP_EVENT_TYPE;
(function (HTTP_EVENT_TYPE) {
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["Sent"] = 0] = "Sent";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["UploadProgress"] = 1] = "UploadProgress";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["ResponseHeader"] = 2] = "ResponseHeader";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["DownloadProgress"] = 3] = "DownloadProgress";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["Response"] = 4] = "Response";
    HTTP_EVENT_TYPE[HTTP_EVENT_TYPE["User"] = 5] = "User";
})(HTTP_EVENT_TYPE || (HTTP_EVENT_TYPE = {}));
var UPLOAD_STATUS;
(function (UPLOAD_STATUS) {
    UPLOAD_STATUS["QUEUED"] = "queued";
    UPLOAD_STATUS["IN_PROGRESS"] = "inprogress";
    UPLOAD_STATUS["SUCCESS"] = "success";
    UPLOAD_STATUS["ERROR"] = "error";
    UPLOAD_STATUS["ABORTED"] = "abort";
})(UPLOAD_STATUS || (UPLOAD_STATUS = {}));
function transformEvent(event) {
    event.target = event.target || {
        status: event.responseCode,
        response: event.response
    };
    return event;
}
var FileTransferObject = /** @class */ (function () {
    function FileTransferObject(file, transferFn, promise, abortFn) {
        this.name = file.name;
        this.size = file.size || '';
        this.status = UPLOAD_STATUS.QUEUED;
        this.transferFn = transferFn;
        this.promise = promise;
        this.abortFn = abortFn;
    }
    FileTransferObject.prototype.start = function () {
        if (this.status === UPLOAD_STATUS.QUEUED) {
            this.status = UPLOAD_STATUS.IN_PROGRESS;
            triggerFn(this.transferFn);
        }
    };
    FileTransferObject.prototype.then = function (onSuccess, onError, onProgress) {
        var self = this;
        this.promise.then(function (event) {
            self.status = UPLOAD_STATUS.SUCCESS;
            triggerFn(onSuccess, event);
        }, function (event) {
            self.status = UPLOAD_STATUS.ERROR;
            triggerFn(onError, event);
        }, function (event) {
            self.progress = Math.round(event.loaded / event.total * 100);
            triggerFn(onProgress, event);
        });
        return this;
    };
    FileTransferObject.prototype.finally = function (onFinal) {
        this.promise.finally(onFinal);
    };
    /* aborts the file upload */
    FileTransferObject.prototype.abort = function () {
        this.status = UPLOAD_STATUS.ABORTED;
        triggerFn(this.abortFn);
        this.finally();
    };
    return FileTransferObject;
}());
var AjaxFileTransferObject = /** @class */ (function (_super) {
    tslib_1.__extends(AjaxFileTransferObject, _super);
    function AjaxFileTransferObject(file, transferFn, promise, abortFn) {
        return _super.call(this, file, transferFn, promise, abortFn) || this;
    }
    return AjaxFileTransferObject;
}(FileTransferObject));
/* upload file using fileTransfer */
function uploadWithFileTransfer(file, url, options) { }
function appendFileToFormData(file, fd, options) {
    /* append file to form data */
    if (_.isArray(file)) {
        _.forEach(file, function (fileObject) {
            fd.append(options.paramName, fileObject.content || fileObject, fileObject.name);
        });
    }
    else if (_.isObject(file)) {
        fd.append(options.paramName, file.content || file, file.name);
    }
}
/* upload file with ajax calling */
function uploadWithAjax(file, fd, url, options) {
    var cloneFD = new FormData();
    var iterate = function (value, key) {
        var fileObject = (_.isArray(value) ? value[0] : value);
        if (!(fileObject instanceof File || fileObject instanceof Blob)) {
            cloneFD.append(key, value);
        }
    };
    // The foreeach method on form data doesn't exist in IE. Hence we check if it exists
    // or else use the lodash forEach
    if (fd.forEach) {
        fd.forEach(iterate);
    }
    else {
        _.forEach(fd, iterate);
    }
    appendFileToFormData(file, cloneFD, options);
    var promise = new NotifyPromise(function (resolve, reject, notify) {
        var request = httpService.upload(url, cloneFD).subscribe(function (event) {
            if (event.type === HTTP_EVENT_TYPE.UploadProgress) {
                var uploadProgress = Math.round(100 * event.loaded / event.total);
                notify(uploadProgress);
            }
            if (event.type === HTTP_EVENT_TYPE.Response) {
                resolve(event.body);
            }
        });
        file._uploadProgress = request;
    });
    return promise;
}
/* upload the file - IE9 support */
function uploadWithIframe(file, url, options) { }
/* upload the next file depending on the status */
function starNextFileTransfer(fts) {
    var ft = _.find(fts, function (f) {
        return f.status === UPLOAD_STATUS.QUEUED;
    });
    if (ft) {
        ft.start();
        ft.finally(starNextFileTransfer.bind(undefined, fts));
    }
}
/* upload the max no of files at once i.e. two at once based on max*/
function startFileTransfers(fts, max) {
    var i = 0;
    var len = fts.length;
    while (i < max && i < len) {
        starNextFileTransfer(fts);
        i++;
    }
}
function isMobileApp() {
    return false;
}
/**
 * This function uploads the file to the given url endpoint.
 *
 * @param file file to upload
 * @param url http endpoint to which the file has to be submitted.
 * @param options
 * @returns a promise to listen for success, event, onProgress.
 *  One can also abort the upload by simply calling abort function.
 */
export function upload(files, fd, config, options) {
    options = _.extend({
        'paramName': config.fileParamName
    }, options);
    return uploadWithAjax(files, fd, config.url, options);
    // let fileTransfers = [],
    //     url = config.uploadUrl;
    // options = _.extend({
    //     'paramName' : config.fileParamName
    // }, options);
    //
    // if (isMobileApp()) {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithFileTransfer(file, url, options));
    //     });
    // } else if ((window as any).FormData) {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithAjax(file, url, options));
    //     });
    // } else {
    //     _.forEach(files, function (file) {
    //         fileTransfers.push(uploadWithIframe(file, url, options));
    //     });
    // }
    // startFileTransfers(fileTransfers, 2);
    // return fileTransfers;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS11cGxvYWQudXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B3bS92YXJpYWJsZXMvIiwic291cmNlcyI6WyJ1dGlsL2ZpbGUtdXBsb2FkLnV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFckMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUl6RCxJQUFLLGVBT0o7QUFQRCxXQUFLLGVBQWU7SUFDaEIscURBQVEsQ0FBQTtJQUNSLHlFQUFrQixDQUFBO0lBQ2xCLHlFQUFrQixDQUFBO0lBQ2xCLDZFQUFvQixDQUFBO0lBQ3BCLDZEQUFXLENBQUE7SUFDWCxxREFBUSxDQUFBO0FBQ1osQ0FBQyxFQVBJLGVBQWUsS0FBZixlQUFlLFFBT25CO0FBRUQsSUFBSyxhQU1KO0FBTkQsV0FBSyxhQUFhO0lBQ2Qsa0NBQXdCLENBQUE7SUFDeEIsMkNBQTRCLENBQUE7SUFDNUIsb0NBQXlCLENBQUE7SUFDekIsZ0NBQXVCLENBQUE7SUFDdkIsa0NBQXVCLENBQUE7QUFDM0IsQ0FBQyxFQU5JLGFBQWEsS0FBYixhQUFhLFFBTWpCO0FBRUQsU0FBUyxjQUFjLENBQUMsS0FBSztJQUN6QixLQUFLLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUk7UUFDM0IsTUFBTSxFQUFFLEtBQUssQ0FBQyxZQUFZO1FBQzFCLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUTtLQUMzQixDQUFDO0lBQ0YsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVEO0lBU0ksNEJBQVksSUFBSSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsT0FBTztRQUMxQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMs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LEdBQUcsQ0FBQyxDQUFDO1FBQzFCLENBQUMsRUFBRSxDQUFDO0tBQ1A7QUFDTCxDQUFDO0FBRUQsU0FBUyxXQUFXO0lBQ2hCLE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUM7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILE1BQU0sVUFBVSxNQUFNLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBUTtJQUM5QyxPQUFPLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNmLFdBQVcsRUFBRyxNQUFNLENBQUMsYUFBYTtLQUNyQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ1osT0FBTyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RELDBCQUEwQjtJQUMxQiw4QkFBOEI7SUFDOUIsdUJBQXVCO0lBQ3ZCLHlDQUF5QztJQUN6QyxlQUFlO0lBQ2YsRUFBRTtJQUNGLHVCQUF1QjtJQUN2Qix5Q0FBeUM7SUFDekMsMEVBQTBFO0lBQzFFLFVBQVU7SUFDVix5Q0FBeUM7SUFDekMseUNBQXlDO0lBQ3pDLGtFQUFrRTtJQUNsRSxVQUFVO0lBQ1YsV0FBVztJQUNYLHlDQUF5QztJQUN6QyxvRUFBb0U7SUFDcEUsVUFBVTtJQUNWLElBQUk7SUFDSix3Q0FBd0M7SUFDeEMsd0JBQXdCO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0cmlnZ2VyRm4gfSBmcm9tICdAd20vY29yZSc7XG5cbmltcG9ydCB7IE5vdGlmeVByb21pc2UgfSBmcm9tICcuL25vdGlmeS1wcm9taXNlJztcbmltcG9ydCB7IGh0dHBTZXJ2aWNlIH0gZnJvbSAnLi92YXJpYWJsZS92YXJpYWJsZXMudXRpbHMnO1xuXG5kZWNsYXJlIGNvbnN0IF87XG5cbmVudW0gSFRUUF9FVkVOVF9UWVBFIHtcbiAgICBTZW50ID0gMCxcbiAgICBVcGxvYWRQcm9ncmVzcyA9IDEsXG4gICAgUmVzcG9uc2VIZWFkZXIgPSAyLFxuICAgIERvd25sb2FkUHJvZ3Jlc3MgPSAzLFxuICAgIFJlc3BvbnNlPSA0LFxuICAgIFVzZXIgPSA1XG59XG5cbmVudW0gVVBMT0FEX1NUQVRVUyB7XG4gICAgUVVFVUVEICAgICAgICA9ICdxdWV1ZWQnLFxuICAgIElOX1BST0dSRVNTICAgPSAnaW5wcm9ncmVzcycsXG4gICAgU1VDQ0VTUyAgICAgICA9ICdzdWNjZXNzJyxcbiAgICBFUlJPUiAgICAgICAgID0gJ2Vycm9yJyxcbiAgICBBQk9SVEVEICAgICAgID0gJ2Fib3J0J1xufVxuXG5mdW5jdGlvbiB0cmFuc2Zvcm1FdmVudChldmVudCkge1xuICAgIGV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCB7XG4gICAgICAgIHN0YXR1czogZXZlbnQucmVzcG9uc2VDb2RlLFxuICAgICAgICByZXNwb25zZTogZXZlbnQucmVzcG9uc2VcbiAgICB9O1xuICAgIHJldHVybiBldmVudDtcbn1cblxuY2xhc3MgRmlsZVRyYW5zZmVyT2JqZWN0IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgc2l6ZTogc3RyaW5nO1xuICAgIHN0YXR1czogc3RyaW5nO1xuICAgIHRyYW5zZmVyRm46IEZ1bmN0aW9uO1xuICAgIGFib3J0Rm46IEZ1bmN0aW9uO1xuICAgIHByb21pc2U6IGFueTtcbiAgICBwcm9ncmVzczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoZmlsZSwgdHJhbnNmZXJGbiwgcHJvbWlzZSwgYWJvcnRGbikge1xuICAgICAgICB0aGlzLm5hbWUgPSBmaWxlLm5hbWU7XG4gICAgICAgIHRoaXMuc2l6ZSA9IGZpbGUuc2l6ZSB8fCAnJztcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBVUExPQURfU1RBVFVTLlFVRVVFRDtcbiAgICAgICAgdGhpcy50cmFuc2ZlckZuID0gdHJhbnNmZXJGbjtcbiAgICAgICAgdGhpcy5wcm9taXNlID0gcHJvbWlzZTtcbiAgICAgICAgdGhpcy5hYm9ydEZuID0gYWJvcnRGbjtcbiAgICB9XG5cbiAgICBzdGFydCgpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSBVUExPQURfU1RBVFVTLlFVRVVFRCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXMgPSBVUExPQURfU1RBVFVTLklOX1BST0dSRVNTO1xuICAgICAgICAgICAgdHJpZ2dlckZuKHRoaXMudHJhbnNmZXJGbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB0aGVuKG9uU3VjY2Vzcywgb25FcnJvciwgb25Qcm9ncmVzcykge1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgdGhpcy5wcm9taXNlLnRoZW4oZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBzZWxmLnN0YXR1cyA9IFVQTE9BRF9TVEFUVVMuU1VDQ0VTUztcbiAgICAgICAgICAgIHRyaWdnZXJGbihvblN1Y2Nlc3MsIGV2ZW50KTtcbiAgICAgICAgfSwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBzZWxmLnN0YXR1cyA9IFVQTE9BRF9TVEFUVVMuRVJST1I7XG4gICAgICAgICAgICB0cmlnZ2VyRm4ob25FcnJvciwgZXZlbnQpO1xuICAgICAgICB9LCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHNlbGYucHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsICogMTAwKTtcbiAgICAgICAgICAgIHRyaWdnZXJGbihvblByb2dyZXNzLCBldmVudCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmaW5hbGx5KG9uRmluYWw/KSB7XG4gICAgICAgIHRoaXMucHJvbWlzZS5maW5hbGx5KG9uRmluYWwpO1xuICAgIH1cblxuICAgIC8qIGFib3J0cyB0aGUgZmlsZSB1cGxvYWQgKi9cbiAgICBhYm9ydCgpIHtcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBVUExPQURfU1RBVFVTLkFCT1JURUQ7XG4gICAgICAgIHRyaWdnZXJGbih0aGlzLmFib3J0Rm4pO1xuICAgICAgICB0aGlzLmZpbmFsbHkoKTtcbiAgICB9XG5cbn1cblxuY2xhc3MgQWpheEZpbGVUcmFuc2Zlck9iamVjdCBleHRlbmRzIEZpbGVUcmFuc2Zlck9iamVjdCB7XG4gICAgY29uc3RydWN0b3IoZmlsZSwgdHJhbnNmZXJGbiwgcHJvbWlzZSwgYWJvcnRGbikge1xuICAgICAgICBzdXBlcihmaWxlLCB0cmFuc2ZlckZuLCBwcm9taXNlLCBhYm9ydEZuKTtcbiAgICB9XG59XG5cbi8qIHVwbG9hZCBmaWxlIHVzaW5nIGZpbGVUcmFuc2ZlciAqL1xuZnVuY3Rpb24gdXBsb2FkV2l0aEZpbGVUcmFuc2ZlcihmaWxlLCB1cmwsIG9wdGlvbnMpIHt9XG5cbmZ1bmN0aW9uIGFwcGVuZEZpbGVUb0Zvcm1EYXRhKGZpbGUsIGZkLCBvcHRpb25zKSB7XG4gICAgLyogYXBwZW5kIGZpbGUgdG8gZm9ybSBkYXRhICovXG4gICAgaWYgKF8uaXNBcnJheShmaWxlKSkge1xuICAgICAgICBfLmZvckVhY2goZmlsZSwgZnVuY3Rpb24gKGZpbGVPYmplY3QpIHtcbiAgICAgICAgICAgIGZkLmFwcGVuZChvcHRpb25zLnBhcmFtTmFtZSwgZmlsZU9iamVjdC5jb250ZW50IHx8IGZpbGVPYmplY3QsIGZpbGVPYmplY3QubmFtZSk7XG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChmaWxlKSkge1xuICAgICAgICBmZC5hcHBlbmQob3B0aW9ucy5wYXJhbU5hbWUsIGZpbGUuY29udGVudCB8fCBmaWxlLCBmaWxlLm5hbWUpO1xuICAgIH1cbn1cblxuLyogdXBsb2FkIGZpbGUgd2l0aCBhamF4IGNhbGxpbmcgKi9cbmZ1bmN0aW9uIHVwbG9hZFdpdGhBamF4KGZpbGUsIGZkLCB1cmwsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBjbG9uZUZEID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgY29uc3QgaXRlcmF0ZSA9ICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVPYmplY3QgPSAoXy5pc0FycmF5KHZhbHVlKSA/IHZhbHVlWzBdIDogdmFsdWUpO1xuICAgICAgICBpZiAoIShmaWxlT2JqZWN0IGluc3RhbmNlb2YgRmlsZSB8fCBmaWxlT2JqZWN0IGluc3RhbmNlb2YgQmxvYikpIHtcbiAgICAgICAgICAgIGNsb25lRkQuYXBwZW5kKGtleSwgdmFsdWUpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICAvLyBUaGUgZm9yZWVhY2ggbWV0aG9kIG9uIGZvcm0gZGF0YSBkb2Vzbid0IGV4aXN0IGluIElFLiBIZW5jZSB3ZSBjaGVjayBpZiBpdCBleGlzdHNcbiAgICAvLyBvciBlbHNlIHVzZSB0aGUgbG9kYXNoIGZvckVhY2hcbiAgICBpZiAoZmQuZm9yRWFjaCkge1xuICAgICAgICBmZC5mb3JFYWNoKGl0ZXJhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIF8uZm9yRWFjaChmZCwgaXRlcmF0ZSk7XG4gICAgfVxuICAgIGFwcGVuZEZpbGVUb0Zvcm1EYXRhKGZpbGUsIGNsb25lRkQsIG9wdGlvbnMpO1xuXG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBOb3RpZnlQcm9taXNlKChyZXNvbHZlLCByZWplY3QsIG5vdGlmeSkgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gaHR0cFNlcnZpY2UudXBsb2FkKHVybCwgY2xvbmVGRCkuc3Vic2NyaWJlKGV2ZW50ID0+IHtcbiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSBIVFRQX0VWRU5UX1RZUEUuVXBsb2FkUHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGxvYWRQcm9ncmVzcyA9IE1hdGgucm91bmQoMTAwICogZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwpO1xuICAgICAgICAgICAgICAgIG5vdGlmeSh1cGxvYWRQcm9ncmVzcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSBIVFRQX0VWRU5UX1RZUEUuUmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGV2ZW50LmJvZHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZmlsZS5fdXBsb2FkUHJvZ3Jlc3MgPSByZXF1ZXN0O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHByb21pc2U7XG59XG5cbi8qIHVwbG9hZCB0aGUgZmlsZSAtIElFOSBzdXBwb3J0ICovXG5mdW5jdGlvbiB1cGxvYWRXaXRoSWZyYW1lKGZpbGUsIHVybCwgb3B0aW9ucykge31cblxuLyogdXBsb2FkIHRoZSBuZXh0IGZpbGUgZGVwZW5kaW5nIG9uIHRoZSBzdGF0dXMgKi9cbmZ1bmN0aW9uIHN0YXJOZXh0RmlsZVRyYW5zZmVyKGZ0cykge1xuICAgIGNvbnN0IGZ0ID0gXy5maW5kKGZ0cywgZnVuY3Rpb24gKGYpIHtcbiAgICAgICAgcmV0dXJuIGYuc3RhdHVzID09PSBVUExPQURfU1RBVFVTLlFVRVVFRDtcbiAgICB9KTtcbiAgICBpZiAoZnQpIHtcbiAgICAgICAgZnQuc3RhcnQoKTtcbiAgICAgICAgZnQuZmluYWxseShzdGFyTmV4dEZpbGVUcmFuc2Zlci5iaW5kKHVuZGVmaW5lZCwgZnRzKSk7XG4gICAgfVxufVxuXG4vKiB1cGxvYWQgdGhlIG1heCBubyBvZiBmaWxlcyBhdCBvbmNlIGkuZS4gdHdvIGF0IG9uY2UgYmFzZWQgb24gbWF4Ki9cbmZ1bmN0aW9uIHN0YXJ0RmlsZVRyYW5zZmVycyhmdHMsIG1heCkge1xuICAgIGxldCBpID0gMDtcbiAgICBjb25zdCBsZW4gPSBmdHMubGVuZ3RoO1xuICAgIHdoaWxlIChpIDwgbWF4ICYmIGkgPCBsZW4pIHtcbiAgICAgICAgc3Rhck5leHRGaWxlVHJhbnNmZXIoZnRzKTtcbiAgICAgICAgaSsrO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaXNNb2JpbGVBcHAoKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gdXBsb2FkcyB0aGUgZmlsZSB0byB0aGUgZ2l2ZW4gdXJsIGVuZHBvaW50LlxuICpcbiAqIEBwYXJhbSBmaWxlIGZpbGUgdG8gdXBsb2FkXG4gKiBAcGFyYW0gdXJsIGh0dHAgZW5kcG9pbnQgdG8gd2hpY2ggdGhlIGZpbGUgaGFzIHRvIGJlIHN1Ym1pdHRlZC5cbiAqIEBwYXJhbSBvcHRpb25zXG4gKiBAcmV0dXJucyBhIHByb21pc2UgdG8gbGlzdGVuIGZvciBzdWNjZXNzLCBldmVudCwgb25Qcm9ncmVzcy5cbiAqICBPbmUgY2FuIGFsc28gYWJvcnQgdGhlIHVwbG9hZCBieSBzaW1wbHkgY2FsbGluZyBhYm9ydCBmdW5jdGlvbi5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHVwbG9hZChmaWxlcywgZmQsIGNvbmZpZywgb3B0aW9ucz8pIHtcbiAgICBvcHRpb25zID0gXy5leHRlbmQoe1xuICAgICAgICAncGFyYW1OYW1lJyA6IGNvbmZpZy5maWxlUGFyYW1OYW1lXG4gICAgfSwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHVwbG9hZFdpdGhBamF4KGZpbGVzLCBmZCwgY29uZmlnLnVybCwgb3B0aW9ucyk7XG4gICAgLy8gbGV0IGZpbGVUcmFuc2ZlcnMgPSBbXSxcbiAgICAvLyAgICAgdXJsID0gY29uZmlnLnVwbG9hZFVybDtcbiAgICAvLyBvcHRpb25zID0gXy5leHRlbmQoe1xuICAgIC8vICAgICAncGFyYW1OYW1lJyA6IGNvbmZpZy5maWxlUGFyYW1OYW1lXG4gICAgLy8gfSwgb3B0aW9ucyk7XG4gICAgLy9cbiAgICAvLyBpZiAoaXNNb2JpbGVBcHAoKSkge1xuICAgIC8vICAgICBfLmZvckVhY2goZmlsZXMsIGZ1bmN0aW9uIChmaWxlKSB7XG4gICAgLy8gICAgICAgICBmaWxlVHJhbnNmZXJzLnB1c2godXBsb2FkV2l0aEZpbGVUcmFuc2ZlcihmaWxlLCB1cmwsIG9wdGlvbnMpKTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gfSBlbHNlIGlmICgod2luZG93IGFzIGFueSkuRm9ybURhdGEpIHtcbiAgICAvLyAgICAgXy5mb3JFYWNoKGZpbGVzLCBmdW5jdGlvbiAoZmlsZSkge1xuICAgIC8vICAgICAgICAgZmlsZVRyYW5zZmVycy5wdXNoKHVwbG9hZFdpdGhBamF4KGZpbGUsIHVybCwgb3B0aW9ucykpO1xuICAgIC8vICAgICB9KTtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgICBfLmZvckVhY2goZmlsZXMsIGZ1bmN0aW9uIChmaWxlKSB7XG4gICAgLy8gICAgICAgICBmaWxlVHJhbnNmZXJzLnB1c2godXBsb2FkV2l0aElmcmFtZShmaWxlLCB1cmwsIG9wdGlvbnMpKTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gfVxuICAgIC8vIHN0YXJ0RmlsZVRyYW5zZmVycyhmaWxlVHJhbnNmZXJzLCAyKTtcbiAgICAvLyByZXR1cm4gZmlsZVRyYW5zZmVycztcbn1cbiJdfQ==