import * as tslib_1 from "tslib";
import { getValidJSON, triggerFn } from '@wm/core';
import { BaseActionManager } from './base-action.manager';
import { CONSTANTS, VARIABLE_CONSTANTS } from '../../constants/variables.constants';
import { appManager, initiateCallback, securityService } from './../../util/variable/variables.utils';
import { routerService } from '../../util/variable/variables.utils';
var LogoutActionManager = /** @class */ (function (_super) {
    tslib_1.__extends(LogoutActionManager, _super);
    function LogoutActionManager() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    LogoutActionManager.prototype.logout = function (variable, options, success, error) {
        var _this = this;
        var handleError, redirectPage, output, newDataSet;
        handleError = function (msg, details, xhrObj) {
            /* if in RUN mode, trigger error events associated with the variable */
            if (!CONSTANTS.isStudioMode) {
                initiateCallback('onError', variable, msg, xhrObj);
            }
            triggerFn(error, msg, xhrObj);
        };
        // EVENT: ON_BEFORE_UPDATE
        output = initiateCallback(VARIABLE_CONSTANTS.EVENT.BEFORE_UPDATE, variable, null);
        if (output === false) {
            triggerFn(error);
            return;
        }
        securityService.isAuthenticated(function (isAuthenticated) {
            if (isAuthenticated) {
                _this.notifyInflight(variable, true);
                variable.promise = securityService.appLogout(function (response) {
                    var redirectUrl = response.body;
                    redirectUrl = getValidJSON(redirectUrl);
                    // Reset Security Config.
                    // $rootScope.isUserAuthenticated = false;
                    appManager.reloadAppData().
                        then(function () {
                        _this.notifyInflight(variable, false, redirectUrl);
                        // EVENT: ON_RESULT
                        initiateCallback(VARIABLE_CONSTANTS.EVENT.RESULT, variable, redirectUrl);
                        // EVENT: ON_PREPARESETDATA
                        newDataSet = initiateCallback(VARIABLE_CONSTANTS.EVENT.PREPARE_SETDATA, variable, redirectUrl);
                        if (newDataSet) {
                            // setting newDataSet as the response to service variable onPrepareSetData
                            redirectUrl = newDataSet;
                        }
                        setTimeout(function () {
                            // EVENT: ON_SUCCESS
                            initiateCallback(VARIABLE_CONSTANTS.EVENT.SUCCESS, variable, redirectUrl);
                            // EVENT: ON_CAN_UPDATE
                            initiateCallback(VARIABLE_CONSTANTS.EVENT.CAN_UPDATE, variable, redirectUrl);
                        });
                    });
                    // In case of CAS response will be the redirectUrl
                    if (redirectUrl && redirectUrl.result) {
                        window.location.href = redirectUrl.result;
                    }
                    else if (variable.useDefaultSuccessHandler) {
                        redirectPage = variable.redirectTo;
                        /* backward compatibility (index.html/login.html may be present in older projects) */
                        if (!redirectPage || redirectPage === 'login.html' || redirectPage === 'index.html') {
                            redirectPage = '';
                        }
                        routerService.navigate(["/" + redirectPage]);
                        // do not reload the mobile app.
                        if (!window['cordova']) {
                            setTimeout(function () {
                                // reloading in timeout as, firefox and safari are not updating the url before reload(WMS-7887)
                                window.location.reload();
                            });
                        }
                    }
                    triggerFn(success);
                }, handleError);
            }
            else {
                handleError('No authenticated user to logout.');
            }
        }, function (err) {
            _this.notifyInflight(variable, false, err);
            handleError(err);
        });
    };
    return LogoutActionManager;
}(BaseActionManager));
export { LogoutActionManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nb3V0LWFjdGlvbi5tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHdtL3ZhcmlhYmxlcy8iLCJzb3VyY2VzIjpbIm1hbmFnZXIvYWN0aW9uL2xvZ291dC1hY3Rpb24ubWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdEcsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBRXBFO0lBQXlDLCtDQUFpQjtJQUExRDs7SUE0RUEsQ0FBQztJQTNFRyxvQ0FBTSxHQUFOLFVBQU8sUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSztRQUF4QyxpQkEwRUM7UUF6RUcsSUFBSSxXQUFXLEVBQ1gsWUFBWSxFQUNaLE1BQU0sRUFDTixVQUFVLENBQUM7UUFFZixXQUFXLEdBQUcsVUFBVSxHQUFHLEVBQUUsT0FBTyxFQUFFLE1BQU07WUFDeEMsdUVBQXVFO1lBQ3ZFLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFO2dCQUN6QixnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQzthQUN0RDtZQUNELFNBQVMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQztRQUVGLDBCQUEwQjtRQUMxQixNQUFNLEdBQUcsZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEYsSUFBSSxNQUFNLEtBQUssS0FBSyxFQUFFO1lBQ2xCLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQixPQUFPO1NBQ1Y7UUFDRCxlQUFlLENBQUMsZUFBZSxDQUFDLFVBQUEsZUFBZTtZQUMzQyxJQUFJLGVBQWUsRUFBRTtnQkFDakIsS0FBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3BDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsZUFBZSxDQUFDLFNBQVMsQ0FBQyxVQUFBLFFBQVE7b0JBQ2pELElBQUksV0FBVyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7b0JBQ2hDLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQ3hDLHlCQUF5QjtvQkFDekIsMENBQTBDO29CQUMxQyxVQUFVLENBQUMsYUFBYSxFQUFFO3dCQUMxQixJQUFJLENBQUM7d0JBQ0QsS0FBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO3dCQUNsRCxtQkFBbUI7d0JBQ25CLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFDO3dCQUN6RSwyQkFBMkI7d0JBQzNCLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQzt3QkFDL0YsSUFBSSxVQUFVLEVBQUU7NEJBQ1IsMEVBQTBFOzRCQUMxRSxXQUFXLEdBQUcsVUFBVSxDQUFDO3lCQUNoQzt3QkFDRCxVQUFVLENBQUM7NEJBQ1Asb0JBQW9COzRCQUNwQixnQkFBZ0IsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQzs0QkFDMUUsdUJBQXVCOzRCQUN2QixnQkFBZ0IsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQzt3QkFDakYsQ0FBQyxDQUFDLENBQUE7b0JBQ04sQ0FBQyxDQUFDLENBQUM7b0JBRUgsa0RBQWtEO29CQUNsRCxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFFO3dCQUNuQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDO3FCQUM3Qzt5QkFBTSxJQUFJLFFBQVEsQ0FBQyx3QkFBd0IsRUFBRTt3QkFDMUMsWUFBWSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7d0JBQ25DLHFGQUFxRjt3QkFDckYsSUFBSSxDQUFDLFlBQVksSUFBSSxZQUFZLEtBQUssWUFBWSxJQUFJLFlBQVksS0FBSyxZQUFZLEVBQUU7NEJBQ2pGLFlBQVksR0FBRyxFQUFFLENBQUM7eUJBQ3JCO3dCQUNELGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFJLFlBQWMsQ0FBQyxDQUFDLENBQUM7d0JBQzdDLGdDQUFnQzt3QkFDaEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTs0QkFDcEIsVUFBVSxDQUFDO2dDQUNQLCtGQUErRjtnQ0FDL0YsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQzs0QkFDN0IsQ0FBQyxDQUFDLENBQUM7eUJBQ047cUJBQ0o7b0JBQ0QsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN2QixDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7YUFDbkI7aUJBQU07Z0JBQ0gsV0FBVyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7YUFDbkQ7UUFDTCxDQUFDLEVBQUUsVUFBQyxHQUFHO1lBQ0gsS0FBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDTCwwQkFBQztBQUFELENBQUMsQUE1RUQsQ0FBeUMsaUJBQWlCLEdBNEV6RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldFZhbGlkSlNPTiwgdHJpZ2dlckZuIH0gZnJvbSAnQHdtL2NvcmUnO1xuXG5pbXBvcnQgeyBCYXNlQWN0aW9uTWFuYWdlciB9IGZyb20gJy4vYmFzZS1hY3Rpb24ubWFuYWdlcic7XG5pbXBvcnQgeyBDT05TVEFOVFMsIFZBUklBQkxFX0NPTlNUQU5UUyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy92YXJpYWJsZXMuY29uc3RhbnRzJztcbmltcG9ydCB7IGFwcE1hbmFnZXIsIGluaXRpYXRlQ2FsbGJhY2ssIHNlY3VyaXR5U2VydmljZSB9IGZyb20gJy4vLi4vLi4vdXRpbC92YXJpYWJsZS92YXJpYWJsZXMudXRpbHMnO1xuaW1wb3J0IHsgcm91dGVyU2VydmljZSB9IGZyb20gJy4uLy4uL3V0aWwvdmFyaWFibGUvdmFyaWFibGVzLnV0aWxzJztcblxuZXhwb3J0IGNsYXNzIExvZ291dEFjdGlvbk1hbmFnZXIgZXh0ZW5kcyBCYXNlQWN0aW9uTWFuYWdlciB7XG4gICAgbG9nb3V0KHZhcmlhYmxlLCBvcHRpb25zLCBzdWNjZXNzLCBlcnJvcikge1xuICAgICAgICBsZXQgaGFuZGxlRXJyb3IsXG4gICAgICAgICAgICByZWRpcmVjdFBhZ2UsXG4gICAgICAgICAgICBvdXRwdXQsXG4gICAgICAgICAgICBuZXdEYXRhU2V0O1xuXG4gICAgICAgIGhhbmRsZUVycm9yID0gZnVuY3Rpb24gKG1zZywgZGV0YWlscywgeGhyT2JqKSB7XG4gICAgICAgICAgICAvKiBpZiBpbiBSVU4gbW9kZSwgdHJpZ2dlciBlcnJvciBldmVudHMgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YXJpYWJsZSAqL1xuICAgICAgICAgICAgaWYgKCFDT05TVEFOVFMuaXNTdHVkaW9Nb2RlKSB7XG4gICAgICAgICAgICAgICAgaW5pdGlhdGVDYWxsYmFjaygnb25FcnJvcicsIHZhcmlhYmxlLCBtc2csIHhock9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cmlnZ2VyRm4oZXJyb3IsIG1zZywgeGhyT2JqKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBFVkVOVDogT05fQkVGT1JFX1VQREFURVxuICAgICAgICBvdXRwdXQgPSBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5CRUZPUkVfVVBEQVRFLCB2YXJpYWJsZSwgbnVsbCk7XG4gICAgICAgIGlmIChvdXRwdXQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICB0cmlnZ2VyRm4oZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHNlY3VyaXR5U2VydmljZS5pc0F1dGhlbnRpY2F0ZWQoaXNBdXRoZW50aWNhdGVkID0+IHtcbiAgICAgICAgICAgIGlmIChpc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeUluZmxpZ2h0KHZhcmlhYmxlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB2YXJpYWJsZS5wcm9taXNlID0gc2VjdXJpdHlTZXJ2aWNlLmFwcExvZ291dChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZWRpcmVjdFVybCA9IHJlc3BvbnNlLmJvZHk7XG4gICAgICAgICAgICAgICAgICAgIHJlZGlyZWN0VXJsID0gZ2V0VmFsaWRKU09OKHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgU2VjdXJpdHkgQ29uZmlnLlxuICAgICAgICAgICAgICAgICAgICAvLyAkcm9vdFNjb3BlLmlzVXNlckF1dGhlbnRpY2F0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYXBwTWFuYWdlci5yZWxvYWRBcHBEYXRhKCkuXG4gICAgICAgICAgICAgICAgICAgIHRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlJbmZsaWdodCh2YXJpYWJsZSwgZmFsc2UsIHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVWRU5UOiBPTl9SRVNVTFRcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYXRlQ2FsbGJhY2soVkFSSUFCTEVfQ09OU1RBTlRTLkVWRU5ULlJFU1VMVCwgdmFyaWFibGUsIHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEVWRU5UOiBPTl9QUkVQQVJFU0VUREFUQVxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0YVNldCA9IGluaXRpYXRlQ2FsbGJhY2soVkFSSUFCTEVfQ09OU1RBTlRTLkVWRU5ULlBSRVBBUkVfU0VUREFUQSwgdmFyaWFibGUsIHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdEYXRhU2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldHRpbmcgbmV3RGF0YVNldCBhcyB0aGUgcmVzcG9uc2UgdG8gc2VydmljZSB2YXJpYWJsZSBvblByZXBhcmVTZXREYXRhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZGlyZWN0VXJsID0gbmV3RGF0YVNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFVkVOVDogT05fU1VDQ0VTU1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYXRlQ2FsbGJhY2soVkFSSUFCTEVfQ09OU1RBTlRTLkVWRU5ULlNVQ0NFU1MsIHZhcmlhYmxlLCByZWRpcmVjdFVybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRVZFTlQ6IE9OX0NBTl9VUERBVEVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0aWF0ZUNhbGxiYWNrKFZBUklBQkxFX0NPTlNUQU5UUy5FVkVOVC5DQU5fVVBEQVRFLCB2YXJpYWJsZSwgcmVkaXJlY3RVcmwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gSW4gY2FzZSBvZiBDQVMgcmVzcG9uc2Ugd2lsbCBiZSB0aGUgcmVkaXJlY3RVcmxcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlZGlyZWN0VXJsICYmIHJlZGlyZWN0VXJsLnJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSByZWRpcmVjdFVybC5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFyaWFibGUudXNlRGVmYXVsdFN1Y2Nlc3NIYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWRpcmVjdFBhZ2UgPSB2YXJpYWJsZS5yZWRpcmVjdFRvO1xuICAgICAgICAgICAgICAgICAgICAgICAgLyogYmFja3dhcmQgY29tcGF0aWJpbGl0eSAoaW5kZXguaHRtbC9sb2dpbi5odG1sIG1heSBiZSBwcmVzZW50IGluIG9sZGVyIHByb2plY3RzKSAqL1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWRpcmVjdFBhZ2UgfHwgcmVkaXJlY3RQYWdlID09PSAnbG9naW4uaHRtbCcgfHwgcmVkaXJlY3RQYWdlID09PSAnaW5kZXguaHRtbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWRpcmVjdFBhZ2UgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlclNlcnZpY2UubmF2aWdhdGUoW2AvJHtyZWRpcmVjdFBhZ2V9YF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG8gbm90IHJlbG9hZCB0aGUgbW9iaWxlIGFwcC5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd2luZG93Wydjb3Jkb3ZhJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVsb2FkaW5nIGluIHRpbWVvdXQgYXMsIGZpcmVmb3ggYW5kIHNhZmFyaSBhcmUgbm90IHVwZGF0aW5nIHRoZSB1cmwgYmVmb3JlIHJlbG9hZChXTVMtNzg4NylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRyaWdnZXJGbihzdWNjZXNzKTtcbiAgICAgICAgICAgICAgICB9LCBoYW5kbGVFcnJvcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhhbmRsZUVycm9yKCdObyBhdXRoZW50aWNhdGVkIHVzZXIgdG8gbG9nb3V0LicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeUluZmxpZ2h0KHZhcmlhYmxlLCBmYWxzZSwgZXJyKTtcbiAgICAgICAgICAgIGhhbmRsZUVycm9yKGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==