!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs"),require("@wm/core")):"function"==typeof define&&define.amd?define("@wm/oAuth",["exports","@angular/core","rxjs","@wm/core"],r):r((e.wm=e.wm||{},e.wm.oAuth={}),e.ng.core,e.rxjs,e.wm.core)}(this,function(e,r,t,d){"use strict";var c=".access_token",m=function(e){var r,t,o,n=e.urlParams;if(o={url:"services/oauth2/:providerId/authorizationUrl",method:"GET"},e.config)for(var i in o.url=(e.config.url||"")+o.url,o.method=e.config.method||o.method,o.headers=o.headers||{},e.config.headers)r=e.config.headers[i],o.headers[i]=r;if(n)for(t in n)n.hasOwnProperty(t)&&(r=n[t],_.isUndefined(r)||null===r||(o.url=o.url.replace(new RegExp(":"+t,"g"),r)));return e.params&&(o.params=e.params),_.isUndefined(e.data)||(o.data=e.data),e.dataParams&&(o.data.params=e.dataParams),e.headers&&(o.headers=e.headers),o.byPassResult=e.byPassResult,o.isDirectCall=e.isDirectCall,o.isExtURL=e.isExtURL,o.preventMultiple=e.preventMultiple,o.responseType=e.responseType,o},a={},o={STUDIO:"WM_STUDIO_",RUN:"WM_RUN_"},u="width=400,height=600",n=function(e){var r=i(e);sessionStorage.removeItem(r)};function i(e){return o.RUN+d._WM_APP_PROJECT.id+"_"+e+c}function f(e,r){var t=i(e);sessionStorage.setItem(t,r)}function p(e,r,t,o){var n=e+c,i=localStorage.getItem(n);o&&o.origin!==window.location.origin||i&&(t(e),localStorage.removeItem(n),f(e,i),window.removeEventListener("message",a[e]),setTimeout(function(){delete a[e],r&&r(i)}))}function v(e,r,t,o,n,i){!function u(){var e="dummy_key";localStorage.setItem(e,e),localStorage.removeItem(e)}();var s=moment.duration(moment().format("HH:mm"),"HH:mm").subtract(o),a=g(e,!0);a?(n.accesstoken_retrieved=!0,f(e,a),localStorage.removeItem(e+c),i(e),r&&r()):1<s.minutes()&&r&&!n.accesstoken_retrieved?r("error"):setTimeout(function(){v(e,r,t,o,n,i)},3e3)}function l(e,r,t,o,n){window.open(e,"_blank",u),v(r,t,o,moment.duration(moment().format("HH:mm"),"HH:mm"),{accesstoken_retrieved:!1},n)}function h(e,t,o,n){var r;d.hasCordova()?(window.open(e,"_system"),window.OAuthInMobile(t).then(function(e){var r=t+c;e?(localStorage.setItem(r,e),p(t,o,n,null)):o("error")})):(r=window.open(e,"_blank",u),function i(e,r,t){a[e]=p.bind(undefined,e,r,t),window.addEventListener("message",a[e],!1)}(t,o,n),function s(e,r,t){e&&a[r]&&(e.closed?(window.removeEventListener("message",a[r]),delete a[r],t&&t("error")):setTimeout(s.bind(undefined,e,r,t),3e3))}(r,t,o))}var g=function(e,r){var t=i(e);return r?localStorage.getItem(e+c):sessionStorage.getItem(t)},s=function(e,r,t,o,n,i,s){var a="WEB";if(!e)return d.hasCordova()&&(a="MOBILE"),function u(e,r){var t=m({target:"oauthConfiguration",action:"getAuthorizationUrl",urlParams:{projectId:d._WM_APP_PROJECT.id,providerId:e.providerId},params:{requestSourceType:e.requestSourceType}});return r.send(t)}({providerId:r,requestSourceType:a},n).then(function(e){i({name:r,url:e.body,invoke:function(){d.isIE()?l(e,r,t,o,s):h(e.body,r,t,s)}})});d.isIE()?l(e,r,t,o,s):h(e,r,t,s)},w=function(){function e(e){this.httpService=e,this.providers=new t.Subject,this.providersConfig=[]}return e.prototype.getOAuthProvidersAsObservable=function(){return this.providers.asObservable()},e.prototype.addProviderConfig=function(e){_.find(this.providersConfig,{name:e.name})||this.providersConfig.push(e),this.providers.next(this.providersConfig)},e.prototype.removeProviderConfig=function(r){_.remove(this.providersConfig,function(e){return e.name===r}),this.providers.next(this.providersConfig)},e.prototype.perfromOAuthorization=function(e,r,t,o){s(e,r,t,o,this.httpService,this.addProviderConfig.bind(this),this.removeProviderConfig.bind(this))},e.prototype.getAccessToken=function(e,r){return g(e,r)},e.prototype.removeAccessToken=function(e){n(e)},e.decorators=[{type:r.Injectable}],e.ctorParameters=function(){return[{type:d.AbstractHttpService}]},e}(),y=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:[w]}},e.decorators=[{type:r.NgModule,args:[{}]}],e}();e.OAuthModule=y,e.OAuthService=w,e.parseConfig=m,e.removeAccessToken=n,e.getAccessToken=g,e.performAuthorization=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.min.js.map